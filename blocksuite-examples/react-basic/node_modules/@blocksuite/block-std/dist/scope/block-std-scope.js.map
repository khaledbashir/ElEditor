{"version":3,"file":"block-std-scope.js","sourceRoot":"","sources":["../../src/scope/block-std-scope.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ServiceProvider } from '@blocksuite/global/di';\nimport type { Doc } from '@blocksuite/store';\n\nimport { Container } from '@blocksuite/global/di';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { BlockService, ExtensionType } from '../extension/index.js';\n\nimport { Clipboard } from '../clipboard/index.js';\nimport { CommandManager } from '../command/index.js';\nimport { UIEventDispatcher } from '../event/index.js';\nimport { GfxController } from '../gfx/controller.js';\nimport { GfxSelectionManager } from '../gfx/selection.js';\nimport { SurfaceMiddlewareExtension } from '../gfx/surface-middleware.js';\nimport { ViewManager } from '../gfx/view/view-manager.js';\nimport {\n  BlockServiceIdentifier,\n  BlockViewIdentifier,\n  ConfigIdentifier,\n  LifeCycleWatcherIdentifier,\n  StdIdentifier,\n} from '../identifier.js';\nimport { RangeManager } from '../range/index.js';\nimport {\n  BlockSelectionExtension,\n  CursorSelectionExtension,\n  SelectionManager,\n  SurfaceSelectionExtension,\n  TextSelectionExtension,\n} from '../selection/index.js';\nimport { ServiceManager } from '../service/index.js';\nimport { EditorHost } from '../view/element/index.js';\nimport { ViewStore } from '../view/view-store.js';\n\nexport interface BlockStdOptions {\n  doc: Doc;\n  extensions: ExtensionType[];\n}\n\nconst internalExtensions = [\n  ServiceManager,\n  CommandManager,\n  UIEventDispatcher,\n  SelectionManager,\n  RangeManager,\n  ViewStore,\n  Clipboard,\n  GfxController,\n  BlockSelectionExtension,\n  TextSelectionExtension,\n  SurfaceSelectionExtension,\n  CursorSelectionExtension,\n  GfxSelectionManager,\n  SurfaceMiddlewareExtension,\n  ViewManager,\n];\n\nexport class BlockStdScope {\n  static internalExtensions = internalExtensions;\n\n  private _getHost: () => EditorHost;\n\n  readonly container: Container;\n\n  readonly doc: Doc;\n\n  readonly provider: ServiceProvider;\n\n  readonly userExtensions: ExtensionType[];\n\n  private get _lifeCycleWatchers() {\n    return this.provider.getAll(LifeCycleWatcherIdentifier);\n  }\n\n  get clipboard() {\n    return this.get(Clipboard);\n  }\n\n  get collection() {\n    return this.doc.collection;\n  }\n\n  get command() {\n    return this.get(CommandManager);\n  }\n\n  get event() {\n    return this.get(UIEventDispatcher);\n  }\n\n  get get() {\n    return this.provider.get.bind(this.provider);\n  }\n\n  get getOptional() {\n    return this.provider.getOptional.bind(this.provider);\n  }\n\n  get host() {\n    return this._getHost();\n  }\n\n  get range() {\n    return this.get(RangeManager);\n  }\n\n  get selection() {\n    return this.get(SelectionManager);\n  }\n\n  get view() {\n    return this.get(ViewStore);\n  }\n\n  constructor(options: BlockStdOptions) {\n    this._getHost = () => {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        'Host is not ready to use, the `render` method should be called first'\n      );\n    };\n    this.doc = options.doc;\n    this.userExtensions = options.extensions;\n    this.container = new Container();\n    this.container.addImpl(StdIdentifier, () => this);\n\n    internalExtensions.forEach(ext => {\n      const container = this.container;\n      ext.setup(container);\n    });\n\n    this.userExtensions.forEach(ext => {\n      const container = this.container;\n      ext.setup(container);\n    });\n\n    this.provider = this.container.provider();\n\n    this._lifeCycleWatchers.forEach(watcher => {\n      watcher.created.call(watcher);\n    });\n  }\n\n  getConfig<Key extends BlockSuite.ConfigKeys>(\n    flavour: Key\n  ): BlockSuite.BlockConfigs[Key] | null;\n\n  getConfig(flavour: string) {\n    const config = this.provider.getOptional(ConfigIdentifier(flavour));\n    if (!config) {\n      return null;\n    }\n\n    return config;\n  }\n\n  /**\n   * @deprecated\n   * BlockService will be removed in the future.\n   */\n  getService<Key extends BlockSuite.ServiceKeys>(\n    flavour: Key\n  ): BlockSuite.BlockServices[Key] | null;\n  getService<Service extends BlockService>(flavour: string): Service | null;\n  getService(flavour: string): BlockService | null {\n    return this.getOptional(BlockServiceIdentifier(flavour));\n  }\n\n  getView(flavour: string) {\n    return this.getOptional(BlockViewIdentifier(flavour));\n  }\n\n  mount() {\n    this._lifeCycleWatchers.forEach(watcher => {\n      watcher.mounted.call(watcher);\n    });\n  }\n\n  render() {\n    const element = new EditorHost();\n    element.std = this;\n    element.doc = this.doc;\n    this._getHost = () => element;\n    this._lifeCycleWatchers.forEach(watcher => {\n      watcher.rendered.call(watcher);\n    });\n\n    return element;\n  }\n\n  unmount() {\n    this._lifeCycleWatchers.forEach(watcher => {\n      watcher.unmounted.call(watcher);\n    });\n    this._getHost = () => null as unknown as EditorHost;\n  }\n}\n\ndeclare global {\n  namespace BlockSuite {\n    interface BlockServices {}\n    interface BlockConfigs {}\n\n    type ServiceKeys = string & keyof BlockServices;\n    type ConfigKeys = string & keyof BlockConfigs;\n\n    type Std = BlockStdScope;\n  }\n}\n"]}