{"version":3,"file":"element-model.js","sourceRoot":"","sources":["../../../../src/gfx/model/surface/element-model.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type IVec,\n  type SerializedXYWH,\n  Slot,\n  type XYWH,\n} from '@blocksuite/global/utils';\nimport {\n  Bound,\n  deserializeXYWH,\n  DisposableGroup,\n  getBoundWithRotation,\n  getPointsFromBoundWithRotation,\n  isEqual,\n  linePolygonIntersects,\n  PointLocation,\n  polygonGetPointTangent,\n  polygonNearestPoint,\n  randomSeed,\n  rotatePoints,\n} from '@blocksuite/global/utils';\nimport { DocCollection, type Y } from '@blocksuite/store';\nimport { createMutex } from 'lib0/mutex';\n\nimport type { EditorHost } from '../../../view/index.js';\nimport type {\n  GfxCompatibleInterface,\n  GfxGroupCompatibleInterface,\n  PointTestOptions,\n} from '../base.js';\nimport type { GfxBlockElementModel } from '../gfx-block-model.js';\nimport type { GfxGroupModel, GfxModel } from '../model.js';\nimport type { SurfaceBlockModel } from './surface-model.js';\n\nimport {\n  descendantElementsImpl,\n  hasDescendantElementImpl,\n  isLockedByAncestorImpl,\n  isLockedBySelfImpl,\n  isLockedImpl,\n  lockElementImpl,\n  unlockElementImpl,\n} from '../../../utils/tree.js';\nimport { gfxGroupCompatibleSymbol } from '../base.js';\nimport {\n  convertProps,\n  field,\n  getDerivedProps,\n  getFieldPropsSet,\n  local,\n  updateDerivedProps,\n  watch,\n} from './decorators/index.js';\n\nexport type BaseElementProps = {\n  index: string;\n  seed: number;\n  lockedBySelf?: boolean;\n};\n\nexport type SerializedElement = Record<string, unknown> & {\n  type: string;\n  xywh: SerializedXYWH;\n  id: string;\n  index: string;\n  lockedBySelf?: boolean;\n  props: Record<string, unknown>;\n};\nexport abstract class GfxPrimitiveElementModel<\n  Props extends BaseElementProps = BaseElementProps,\n> implements GfxCompatibleInterface\n{\n  private _lastXYWH!: SerializedXYWH;\n\n  protected _disposable = new DisposableGroup();\n\n  protected _id: string;\n\n  protected _local = new Map<string | symbol, unknown>();\n\n  protected _onChange: (payload: {\n    props: Record<string, unknown>;\n    oldValues: Record<string, unknown>;\n    local: boolean;\n  }) => void;\n\n  /**\n   * Used to store a copy of data in the yMap.\n   */\n  protected _preserved = new Map<string, unknown>();\n\n  protected _stashed: Map<keyof Props | string, unknown>;\n\n  propsUpdated = new Slot<{ key: string }>();\n\n  abstract rotate: number;\n\n  surface!: SurfaceBlockModel;\n\n  abstract xywh: SerializedXYWH;\n\n  yMap: Y.Map<unknown>;\n\n  get connectable() {\n    return true;\n  }\n\n  get deserializedXYWH() {\n    if (!this._lastXYWH || this.xywh !== this._lastXYWH) {\n      const xywh = this.xywh;\n      this._local.set('deserializedXYWH', deserializeXYWH(xywh));\n      this._lastXYWH = xywh;\n    }\n\n    return (this._local.get('deserializedXYWH') as XYWH) ?? [0, 0, 0, 0];\n  }\n\n  /**\n   * The bound of the element after rotation.\n   * The bound without rotation should be created by `Bound.deserialize(this.xywh)`.\n   */\n  get elementBound() {\n    if (this.rotate) {\n      return Bound.from(getBoundWithRotation(this));\n    }\n\n    return Bound.deserialize(this.xywh);\n  }\n\n  get externalBound(): Bound | null {\n    if (!this._local.has('externalBound')) {\n      const bound = this.externalXYWH\n        ? Bound.deserialize(this.externalXYWH)\n        : null;\n\n      this._local.set('externalBound', bound);\n    }\n\n    return this._local.get('externalBound') as Bound | null;\n  }\n\n  get group(): GfxGroupModel | null {\n    return this.surface.getGroup(this.id);\n  }\n\n  /**\n   * Return the ancestor elements in order from the most recent to the earliest.\n   */\n  get groups(): GfxGroupModel[] {\n    return this.surface.getGroups(this.id);\n  }\n\n  get h() {\n    return this.deserializedXYWH[3];\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  get isConnected() {\n    return this.surface.hasElementById(this.id);\n  }\n\n  get responseBound() {\n    return this.elementBound.expand(this.responseExtension);\n  }\n\n  abstract get type(): string;\n\n  get w() {\n    return this.deserializedXYWH[2];\n  }\n\n  get x() {\n    return this.deserializedXYWH[0];\n  }\n\n  get y() {\n    return this.deserializedXYWH[1];\n  }\n\n  constructor(options: {\n    id: string;\n    yMap: Y.Map<unknown>;\n    model: SurfaceBlockModel;\n    stashedStore: Map<unknown, unknown>;\n    onChange: (payload: {\n      props: Record<string, unknown>;\n      oldValues: Record<string, unknown>;\n      local: boolean;\n    }) => void;\n  }) {\n    const { id, yMap, model, stashedStore, onChange } = options;\n\n    this._id = id;\n    this.yMap = yMap;\n    this.surface = model;\n    this._stashed = stashedStore as Map<keyof Props, unknown>;\n    this._onChange = onChange;\n\n    this.index = 'a0';\n    this.seed = randomSeed();\n  }\n\n  static propsToY(props: Record<string, unknown>) {\n    return props;\n  }\n\n  containsBound(bounds: Bound): boolean {\n    return getPointsFromBoundWithRotation(this).some(point =>\n      bounds.containsPoint(point)\n    );\n  }\n\n  getLineIntersections(start: IVec, end: IVec) {\n    const points = getPointsFromBoundWithRotation(this);\n    return linePolygonIntersects(start, end, points);\n  }\n\n  getNearestPoint(point: IVec) {\n    const points = getPointsFromBoundWithRotation(this);\n    return polygonNearestPoint(points, point);\n  }\n\n  getRelativePointLocation(relativePoint: IVec) {\n    const bound = Bound.deserialize(this.xywh);\n    const point = bound.getRelativePoint(relativePoint);\n    const rotatePoint = rotatePoints([point], bound.center, this.rotate)[0];\n    const points = rotatePoints(bound.points, bound.center, this.rotate);\n    const tangent = polygonGetPointTangent(points, rotatePoint);\n    return new PointLocation(rotatePoint, tangent);\n  }\n\n  includesPoint(\n    x: number,\n    y: number,\n    opt: PointTestOptions,\n    __: EditorHost\n  ): boolean {\n    const bound = opt.useElementBound ? this.elementBound : this.responseBound;\n    return bound.isPointInBound([x, y]);\n  }\n\n  intersectsBound(bound: Bound): boolean {\n    return (\n      this.containsBound(bound) ||\n      bound.points.some((point, i, points) =>\n        this.getLineIntersections(point, points[(i + 1) % points.length])\n      )\n    );\n  }\n\n  isLocked(): boolean {\n    return isLockedImpl(this);\n  }\n\n  isLockedByAncestor(): boolean {\n    return isLockedByAncestorImpl(this);\n  }\n\n  isLockedBySelf(): boolean {\n    return isLockedBySelfImpl(this);\n  }\n\n  lock() {\n    lockElementImpl(this.surface.doc, this);\n  }\n\n  onCreated() {}\n\n  onDestroyed() {\n    this._disposable.dispose();\n    this.propsUpdated.dispose();\n  }\n\n  pop(prop: keyof Props | string) {\n    if (!this._stashed.has(prop)) {\n      return;\n    }\n\n    const value = this._stashed.get(prop);\n    this._stashed.delete(prop);\n    // @ts-ignore\n    delete this[prop];\n\n    if (getFieldPropsSet(this).has(prop as string)) {\n      if (!isEqual(value, this.yMap.get(prop as string))) {\n        this.surface.doc.transact(() => {\n          this.yMap.set(prop as string, value);\n        });\n      }\n    } else {\n      console.warn('pop a prop that is not field or local:', prop);\n    }\n  }\n\n  serialize() {\n    const result = this.yMap.toJSON();\n    result.xywh = this.xywh;\n    return result as SerializedElement;\n  }\n\n  stash(prop: keyof Props | string) {\n    if (this._stashed.has(prop)) {\n      return;\n    }\n\n    if (!getFieldPropsSet(this).has(prop as string)) {\n      return;\n    }\n\n    const curVal = this[prop as unknown as keyof GfxPrimitiveElementModel];\n\n    this._stashed.set(prop, curVal);\n\n    Object.defineProperty(this, prop, {\n      configurable: true,\n      enumerable: true,\n      get: () => this._stashed.get(prop),\n      set: (original: unknown) => {\n        const value = convertProps(prop as string, original, this);\n        const oldValue = this._stashed.get(prop);\n        const derivedProps = getDerivedProps(\n          prop as string,\n          original,\n          this as unknown as GfxPrimitiveElementModel\n        );\n\n        this._stashed.set(prop, value);\n        this._onChange({\n          props: {\n            [prop]: value,\n          },\n          oldValues: {\n            [prop]: oldValue,\n          },\n          local: true,\n        });\n\n        updateDerivedProps(\n          derivedProps,\n          this as unknown as GfxPrimitiveElementModel\n        );\n      },\n    });\n  }\n\n  unlock() {\n    unlockElementImpl(this.surface.doc, this);\n  }\n\n  @local()\n  accessor display: boolean = true;\n\n  /**\n   * In some cases, you need to draw something related to the element, but it does not belong to the element itself.\n   * And it is also interactive, you can select element by clicking on it. E.g. the title of the group element.\n   * In this case, we need to store this kind of external xywh in order to do hit test. This property should not be synced to the doc.\n   * This property should be updated every time it gets rendered.\n   */\n  @watch((_, instance) => {\n    instance['_local'].delete('externalBound');\n  })\n  @local()\n  accessor externalXYWH: SerializedXYWH | undefined = undefined;\n\n  @field(false)\n  accessor hidden: boolean = false;\n\n  @field()\n  accessor index!: string;\n\n  @field()\n  accessor lockedBySelf: boolean | undefined = false;\n\n  @local()\n  accessor opacity: number = 1;\n\n  @local()\n  accessor responseExtension: [number, number] = [0, 0];\n\n  @field()\n  accessor seed!: number;\n}\n\nexport abstract class GfxGroupLikeElementModel<\n    Props extends BaseElementProps = BaseElementProps,\n  >\n  extends GfxPrimitiveElementModel<Props>\n  implements GfxGroupCompatibleInterface\n{\n  private _childIds: string[] = [];\n\n  private _mutex = createMutex();\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  abstract children: Y.Map<any>;\n\n  [gfxGroupCompatibleSymbol] = true as const;\n\n  get childElements() {\n    const elements: GfxModel[] = [];\n\n    for (const key of this.childIds) {\n      const element =\n        this.surface.getElementById(key) ||\n        (this.surface.doc.getBlockById(key) as GfxBlockElementModel);\n\n      element && elements.push(element);\n    }\n\n    return elements;\n  }\n\n  /**\n   * The ids of the children. Its role is to provide a unique way to access the children.\n   * You should update this field through `setChildIds` when the children are added or removed.\n   */\n  get childIds() {\n    return this._childIds;\n  }\n\n  get descendantElements(): GfxModel[] {\n    return descendantElementsImpl(this);\n  }\n\n  get xywh() {\n    this._mutex(() => {\n      const curXYWH =\n        (this._local.get('xywh') as SerializedXYWH) ?? '[0,0,0,0]';\n      const newXYWH = this._getXYWH().serialize();\n\n      if (curXYWH !== newXYWH || !this._local.has('xywh')) {\n        this._local.set('xywh', newXYWH);\n\n        if (curXYWH !== newXYWH) {\n          this._onChange({\n            props: {\n              xywh: newXYWH,\n            },\n            oldValues: {\n              xywh: curXYWH,\n            },\n            local: true,\n          });\n        }\n      }\n    });\n\n    return (this._local.get('xywh') as SerializedXYWH) ?? '[0,0,0,0]';\n  }\n\n  set xywh(_) {}\n\n  protected _getXYWH(): Bound {\n    let bound: Bound | undefined;\n\n    this.childElements.forEach(child => {\n      if (child instanceof GfxPrimitiveElementModel && child.hidden) {\n        return;\n      }\n\n      bound = bound ? bound.unite(child.elementBound) : child.elementBound;\n    });\n\n    if (bound) {\n      this._local.set('xywh', bound.serialize());\n    } else {\n      this._local.delete('xywh');\n    }\n\n    return bound ?? new Bound(0, 0, 0, 0);\n  }\n\n  abstract addChild(element: GfxModel): void;\n\n  /**\n   * The actual field that stores the children of the group.\n   * It should be a ymap decorated with `@field`.\n   */\n  hasChild(element: GfxCompatibleInterface) {\n    return this.childElements.includes(element as GfxModel);\n  }\n\n  /**\n   * Check if the group has the given descendant.\n   */\n  hasDescendant(element: GfxCompatibleInterface): boolean {\n    return hasDescendantElementImpl(this, element);\n  }\n\n  /**\n   * Remove the child from the group\n   */\n  abstract removeChild(element: GfxCompatibleInterface): void;\n\n  /**\n   * Set the new value of the childIds\n   * @param value the new value of the childIds\n   * @param fromLocal if true, the change is happened in the local\n   */\n  setChildIds(value: string[], fromLocal: boolean) {\n    const oldChildIds = this.childIds;\n    this._childIds = value;\n\n    this._onChange({\n      props: {\n        childIds: value,\n      },\n      oldValues: {\n        childIds: oldChildIds,\n      },\n      local: fromLocal,\n    });\n  }\n}\n\nexport function syncElementFromY(\n  model: GfxPrimitiveElementModel,\n  callback: (payload: {\n    props: Record<string, unknown>;\n    oldValues: Record<string, unknown>;\n    local: boolean;\n  }) => void\n) {\n  const disposables: Record<string, () => void> = {};\n  const observer = (\n    event: Y.YMapEvent<unknown>,\n    transaction: Y.Transaction\n  ) => {\n    const props: Record<string, unknown> = {};\n    const oldValues: Record<string, unknown> = {};\n\n    event.keysChanged.forEach(key => {\n      const type = event.changes.keys.get(key);\n      const oldValue = event.changes.keys.get(key)?.oldValue;\n\n      if (!type) {\n        return;\n      }\n\n      if (type.action === 'update' || type.action === 'add') {\n        const value = model.yMap.get(key);\n\n        if (value instanceof DocCollection.Y.Text) {\n          disposables[key]?.();\n          disposables[key] = watchText(key, value, callback);\n        }\n\n        model['_preserved'].set(key, value);\n        props[key] = value;\n        oldValues[key] = oldValue;\n      } else {\n        model['_preserved'].delete(key);\n        oldValues[key] = oldValue;\n      }\n    });\n\n    callback({\n      props,\n      oldValues,\n      local: transaction.local,\n    });\n  };\n\n  Array.from(model.yMap.entries()).forEach(([key, value]) => {\n    if (value instanceof DocCollection.Y.Text) {\n      disposables[key] = watchText(key, value, callback);\n    }\n\n    model['_preserved'].set(key, value);\n  });\n\n  model.yMap.observe(observer);\n  disposables['ymap'] = () => {\n    model.yMap.unobserve(observer);\n  };\n\n  return () => {\n    Object.values(disposables).forEach(fn => fn());\n  };\n}\n\nfunction watchText(\n  key: string,\n  value: Y.Text,\n  callback: (payload: {\n    props: Record<string, unknown>;\n    oldValues: Record<string, unknown>;\n    local: boolean;\n  }) => void\n) {\n  const fn = (_: Y.YTextEvent, transaction: Y.Transaction) => {\n    callback({\n      props: {\n        [key]: value,\n      },\n      oldValues: {},\n      local: transaction.local,\n    });\n  };\n\n  value.observe(fn);\n\n  return () => {\n    value.unobserve(fn);\n  };\n}\n"]}