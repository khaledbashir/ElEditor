{"version":3,"file":"viewport-element.js","sourceRoot":"","sources":["../../src/gfx/viewport-element.ts"],"names":[],"mappings":"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","sourcesContent":["import { WithDisposable } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nimport type { GfxBlockElementModel } from './model/gfx-block-model.js';\n\nimport { PropTypes, requiredProperties } from '../view/decorators/required.js';\nimport { type EditorHost, ShadowlessElement } from '../view/index.js';\nimport { Viewport } from './viewport.js';\n\n/**\n * A wrapper around `requestConnectedFrame` that only calls at most once in one frame\n */\nexport function requestThrottledConnectedFrame<\n  T extends (...args: unknown[]) => void,\n>(func: T, element?: HTMLElement): T {\n  let raqId: number | undefined = undefined;\n  let latestArgs: unknown[] = [];\n\n  return ((...args: unknown[]) => {\n    latestArgs = args;\n\n    if (raqId === undefined) {\n      raqId = requestAnimationFrame(() => {\n        raqId = undefined;\n\n        if (!element || element.isConnected) {\n          func(...latestArgs);\n        }\n      });\n    }\n  }) as T;\n}\n\n@requiredProperties({\n  viewport: PropTypes.instanceOf(Viewport),\n})\nexport class GfxViewportElement extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    gfx-viewport {\n      position: absolute;\n      left: 0;\n      top: 0;\n      contain: size layout style;\n      display: block;\n      transform: none;\n    }\n  `;\n\n  private _hideOutsideBlock = requestThrottledConnectedFrame(() => {\n    if (this.getModelsInViewport && this.host) {\n      const host = this.host;\n      const modelsInViewport = this.getModelsInViewport();\n\n      modelsInViewport.forEach(model => {\n        const view = host.std.view.getBlock(model.id);\n\n        if (view) {\n          view.style.display = '';\n        }\n\n        if (this._lastVisibleModels?.has(model)) {\n          this._lastVisibleModels!.delete(model);\n        }\n      });\n\n      this._lastVisibleModels?.forEach(model => {\n        const view = host.std.view.getBlock(model.id);\n\n        if (view) {\n          view.style.display = 'none';\n        }\n      });\n\n      this._lastVisibleModels = modelsInViewport;\n    }\n  }, this);\n\n  private _lastVisibleModels?: Set<GfxBlockElementModel>;\n\n  private _pendingChildrenUpdates: {\n    id: string;\n    resolve: () => void;\n  }[] = [];\n\n  private _refreshViewport = requestThrottledConnectedFrame(() => {\n    this._hideOutsideBlock();\n  }, this);\n\n  private _updatingChildrenFlag = false;\n\n  renderingBlocks = new Set<string>();\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const viewportUpdateCallback = () => {\n      this._refreshViewport();\n      this._hideOutsideBlock();\n    };\n\n    viewportUpdateCallback();\n    this.disposables.add(\n      this.viewport.viewportUpdated.on(() => viewportUpdateCallback())\n    );\n    this.disposables.add(\n      this.viewport.sizeUpdated.on(() => viewportUpdateCallback())\n    );\n  }\n\n  override render() {\n    return html``;\n  }\n\n  scheduleUpdateChildren(id: string) {\n    const { promise, resolve } = Promise.withResolvers<void>();\n\n    this._pendingChildrenUpdates.push({ id, resolve });\n\n    if (!this._updatingChildrenFlag) {\n      this._updatingChildrenFlag = true;\n      const schedule = () => {\n        if (this._pendingChildrenUpdates.length) {\n          const childToUpdates = this._pendingChildrenUpdates.splice(\n            0,\n            this.maxConcurrentRenders\n          );\n\n          childToUpdates.forEach(({ resolve }) => resolve());\n\n          if (this._pendingChildrenUpdates.length) {\n            requestAnimationFrame(() => {\n              this.isConnected && schedule();\n            });\n          } else {\n            this._updatingChildrenFlag = false;\n          }\n        }\n      };\n\n      requestAnimationFrame(() => {\n        this.isConnected && schedule();\n      });\n    }\n\n    return promise;\n  }\n\n  @property({ attribute: false })\n  accessor getModelsInViewport: undefined | (() => Set<GfxBlockElementModel>);\n\n  @property({ attribute: false })\n  accessor host: undefined | EditorHost;\n\n  @property({ type: Number })\n  accessor maxConcurrentRenders: number = 2;\n\n  @property({ attribute: false })\n  accessor viewport!: Viewport;\n}\n"]}