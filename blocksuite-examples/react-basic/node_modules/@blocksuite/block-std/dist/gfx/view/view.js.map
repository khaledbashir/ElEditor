{"version":3,"file":"view.js","sourceRoot":"","sources":["../../../src/gfx/view/view.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Container, createIdentifier } from '@blocksuite/global/di';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport {\n  type Bound,\n  DisposableGroup,\n  type IVec,\n} from '@blocksuite/global/utils';\n\nimport type { PointerEventState } from '../../event/index.js';\nimport type { Extension } from '../../extension/extension.js';\nimport type { EditorHost } from '../../view/index.js';\nimport type { GfxController } from '../index.js';\nimport type { GfxElementGeometry, PointTestOptions } from '../model/base.js';\nimport type { GfxPrimitiveElementModel } from '../model/surface/element-model.js';\nimport type { GfxLocalElementModel } from '../model/surface/local-element-model.js';\n\nexport type EventsHandlerMap = {\n  click: PointerEventState;\n  dblclick: PointerEventState;\n  pointerdown: PointerEventState;\n  pointerenter: PointerEventState;\n  pointerleave: PointerEventState;\n  pointermove: PointerEventState;\n  pointerup: PointerEventState;\n};\n\nexport type SupportedEvent = keyof EventsHandlerMap;\n\nexport const GfxElementModelViewExtIdentifier = createIdentifier<\n  typeof GfxElementModelView\n>('GfxElementModelView');\n\nexport class GfxElementModelView<\n    T extends GfxLocalElementModel | GfxPrimitiveElementModel =\n      | GfxPrimitiveElementModel\n      | GfxLocalElementModel,\n    RendererContext = object,\n  >\n  implements GfxElementGeometry, Extension\n{\n  static type: string;\n\n  private _handlers = new Map<\n    keyof EventsHandlerMap,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    ((evt: any) => void)[]\n  >();\n\n  private _isConnected = true;\n\n  protected disposable = new DisposableGroup();\n\n  readonly model: T;\n\n  get isConnected() {\n    return this._isConnected;\n  }\n\n  get rotate() {\n    return this.model.rotate;\n  }\n\n  get surface() {\n    return this.model.surface;\n  }\n\n  get type() {\n    return this.model.type;\n  }\n\n  constructor(\n    model: T,\n    readonly gfx: GfxController\n  ) {\n    this.model = model;\n    this.onCreated();\n  }\n\n  static setup(di: Container): void {\n    if (!this.type) {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        'The GfxElementModelView should have a static `type` property.'\n      );\n    }\n\n    di.addImpl(GfxElementModelViewExtIdentifier(this.type), () => this);\n  }\n\n  containsBound(bounds: Bound): boolean {\n    return this.model.containsBound(bounds);\n  }\n\n  dispatch<K extends keyof EventsHandlerMap>(\n    event: K,\n    evt: EventsHandlerMap[K]\n  ) {\n    this._handlers.get(event)?.forEach(callback => callback(evt));\n  }\n\n  getLineIntersections(start: IVec, end: IVec) {\n    return this.model.getLineIntersections(start, end);\n  }\n\n  getNearestPoint(point: IVec) {\n    return this.model.getNearestPoint(point);\n  }\n\n  getRelativePointLocation(relativePoint: IVec) {\n    return this.model.getRelativePointLocation(relativePoint);\n  }\n\n  includesPoint(\n    x: number,\n    y: number,\n    _: PointTestOptions,\n    __: EditorHost\n  ): boolean {\n    return this.model.includesPoint(x, y, _, __);\n  }\n\n  intersectsBound(bound: Bound): boolean {\n    return (\n      this.containsBound(bound) ||\n      bound.points.some((point, i, points) =>\n        this.getLineIntersections(point, points[(i + 1) % points.length])\n      )\n    );\n  }\n\n  off<K extends keyof EventsHandlerMap>(\n    event: K,\n    callback: (evt: EventsHandlerMap[K]) => void\n  ) {\n    if (!this._handlers.has(event)) {\n      return;\n    }\n\n    const callbacks = this._handlers.get(event)!;\n    const index = callbacks.indexOf(callback);\n\n    if (index !== -1) {\n      callbacks.splice(index, 1);\n    }\n  }\n\n  on<K extends keyof EventsHandlerMap>(\n    event: K,\n    callback: (evt: EventsHandlerMap[K]) => void\n  ) {\n    if (!this._handlers.has(event)) {\n      this._handlers.set(event, []);\n    }\n\n    this._handlers.get(event)!.push(callback);\n\n    return () => this.off(event, callback);\n  }\n\n  once<K extends keyof EventsHandlerMap>(\n    event: K,\n    callback: (evt: EventsHandlerMap[K]) => void\n  ) {\n    const off = this.on(event, evt => {\n      off();\n      callback(evt);\n    });\n\n    return off;\n  }\n\n  onCreated() {}\n\n  /**\n   * Called when the view is destroyed.\n   * Override this method requires calling `super.onDestroyed()`.\n   */\n  onDestroyed() {\n    this._isConnected = false;\n    this.disposable.dispose();\n    this._handlers.clear();\n  }\n\n  render(_: RendererContext) {}\n}\n"]}