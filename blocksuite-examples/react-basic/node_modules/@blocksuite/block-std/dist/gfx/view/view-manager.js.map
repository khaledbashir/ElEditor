{"version":3,"file":"view-manager.js","sourceRoot":"","sources":["../../../src/gfx/view/view-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { DisposableGroup } from '@blocksuite/global/utils';\n\nimport type { GfxController } from '../controller.js';\nimport type { GfxModel } from '../model/model.js';\nimport type { GfxLocalElementModel } from '../model/surface/local-element-model.js';\nimport type { SurfaceBlockModel } from '../model/surface/surface-model.js';\n\nimport { onSurfaceAdded } from '../../utils/gfx.js';\nimport { GfxExtension, GfxExtensionIdentifier } from '../extension.js';\nimport { GfxBlockElementModel } from '../model/gfx-block-model.js';\nimport {\n  GfxElementModelView,\n  GfxElementModelViewExtIdentifier,\n} from './view.js';\n\nexport class ViewManager extends GfxExtension {\n  static override key = 'viewManager';\n\n  private _disposable = new DisposableGroup();\n\n  private _viewCtorMap = new Map<string, typeof GfxElementModelView>();\n\n  private _viewMap = new Map<string, GfxElementModelView>();\n\n  constructor(gfx: GfxController) {\n    super(gfx);\n  }\n\n  static override extendGfx(gfx: GfxController): void {\n    Object.defineProperty(gfx, 'view', {\n      get() {\n        return this.std.get(GfxExtensionIdentifier('viewManager'));\n      },\n    });\n  }\n\n  get(model: GfxModel | GfxLocalElementModel | string) {\n    if (typeof model === 'string') {\n      if (this._viewMap.has(model)) {\n        return this._viewMap.get(model);\n      }\n\n      return this.std.view.getBlock(model) ?? null;\n    } else {\n      if (model instanceof GfxBlockElementModel) {\n        return this.std.view.getBlock(model.id) ?? null;\n      } else {\n        return this._viewMap.get(model.id) ?? null;\n      }\n    }\n  }\n\n  override mounted(): void {\n    this.std.provider\n      .getAll(GfxElementModelViewExtIdentifier)\n      .forEach(viewCtor => {\n        this._viewCtorMap.set(viewCtor.type, viewCtor);\n      });\n\n    const updateViewOnElementChange = (surface: SurfaceBlockModel) => {\n      this._disposable.add(\n        surface.elementAdded.on(payload => {\n          const model = surface.getElementById(payload.id)!;\n          const View = this._viewCtorMap.get(model.type) ?? GfxElementModelView;\n\n          this._viewMap.set(model.id, new View(model, this.gfx));\n        })\n      );\n\n      this._disposable.add(\n        surface.elementRemoved.on(elem => {\n          const view = this._viewMap.get(elem.id);\n          this._viewMap.delete(elem.id);\n          view?.onDestroyed();\n        })\n      );\n\n      this._disposable.add(\n        surface.localElementAdded.on(model => {\n          const View = this._viewCtorMap.get(model.type) ?? GfxElementModelView;\n\n          this._viewMap.set(model.id, new View(model, this.gfx));\n        })\n      );\n\n      this._disposable.add(\n        surface.localElementDeleted.on(model => {\n          const view = this._viewMap.get(model.id);\n          this._viewMap.delete(model.id);\n          view?.onDestroyed();\n        })\n      );\n\n      surface.localElementModels.forEach(model => {\n        const View = this._viewCtorMap.get(model.type) ?? GfxElementModelView;\n\n        this._viewMap.set(model.id, new View(model, this.gfx));\n      });\n\n      surface.elementModels.forEach(model => {\n        const View = this._viewCtorMap.get(model.type) ?? GfxElementModelView;\n\n        this._viewMap.set(model.id, new View(model, this.gfx));\n      });\n    };\n\n    if (this.gfx.surface) {\n      updateViewOnElementChange(this.gfx.surface);\n    } else {\n      this._disposable.add(\n        onSurfaceAdded(this.std.doc, surface => {\n          if (surface) {\n            updateViewOnElementChange(surface);\n          }\n        })\n      );\n    }\n  }\n\n  override unmounted(): void {\n    this._disposable.dispose();\n    this._viewMap.forEach(view => view.onDestroyed());\n    this._viewMap.clear();\n  }\n}\n\ndeclare module '../controller.js' {\n  interface GfxController {\n    readonly view: ViewManager;\n  }\n}\n"]}