{"version":3,"file":"tool-controller.js","sourceRoot":"","sources":["../../../src/gfx/tool/tool-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ServiceIdentifier } from '@blocksuite/global/di';\n\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport {\n  DisposableGroup,\n  type IBound,\n  type IPoint,\n  Slot,\n} from '@blocksuite/global/utils';\nimport { Signal } from '@preact/signals-core';\n\nimport type { PointerEventState } from '../../event/index.js';\nimport type { GfxController } from '../controller.js';\n\nimport { GfxExtension, GfxExtensionIdentifier } from '../extension.js';\nimport {\n  type BaseTool,\n  type GfxToolsFullOptionValue,\n  type GfxToolsMap,\n  type GfxToolsOption,\n  ToolIdentifier,\n} from './tool.js';\n\ntype BuiltInHookEvent<T> = {\n  data: T;\n  preventDefault(): void;\n};\n\ntype BuiltInEventMap = {\n  beforeToolUpdate: BuiltInHookEvent<{\n    toolName: keyof GfxToolsMap;\n  }>;\n  toolUpdate: BuiltInHookEvent<{ toolName: keyof GfxToolsMap }>;\n};\n\ntype BuiltInSlotContext = {\n  [K in keyof BuiltInEventMap]: { event: K } & BuiltInEventMap[K];\n}[SupportedHooks];\n\nexport type SupportedHooks = keyof BuiltInEventMap;\n\nconst supportedEvents = [\n  'dragStart',\n  'dragEnd',\n  'dragMove',\n  'pointerMove',\n  'contextMenu',\n  'pointerDown',\n  'pointerUp',\n  'click',\n  'doubleClick',\n  'tripleClick',\n  'pointerOut',\n] as const;\n\nexport type SupportedEvents = (typeof supportedEvents)[number];\n\nexport enum MouseButton {\n  FIFTH = 4,\n  FOURTH = 3,\n  MAIN = 0,\n  MIDDLE = 1,\n  SECONDARY = 2,\n}\n\nexport interface ToolEventTarget {\n  /**\n   * Add a hook before the event is handled by the tool.\n   * Return false to prevent the tool from handling the event.\n   * @param evtName\n   * @param handler\n   */\n  addHook<K extends SupportedHooks | SupportedEvents>(\n    evtName: K,\n    handler: (\n      evtState: K extends SupportedHooks\n        ? BuiltInEventMap[K]\n        : PointerEventState\n    ) => void | boolean\n  ): void;\n}\n\nexport const eventTarget = Symbol('eventTarget');\n\nexport class ToolController extends GfxExtension {\n  static override key = 'ToolController';\n\n  private _builtInHookSlot = new Slot<BuiltInSlotContext>();\n\n  private _disposableGroup = new DisposableGroup();\n\n  private _toolOption$ = new Signal<GfxToolsFullOptionValue>(\n    {} as GfxToolsFullOptionValue\n  );\n\n  private _tools = new Map<string, BaseTool>();\n\n  readonly currentToolName$ = new Signal<keyof GfxToolsMap>();\n\n  readonly dragging$ = new Signal<boolean>(false);\n\n  /**\n   * The area that is being dragged.\n   * The coordinates are in browser space.\n   */\n  readonly draggingViewArea$ = new Signal<\n    IBound & {\n      startX: number;\n      startY: number;\n      endX: number;\n      endY: number;\n    }\n  >({\n    startX: 0,\n    startY: 0,\n    x: 0,\n    y: 0,\n    w: 0,\n    h: 0,\n    endX: 0,\n    endY: 0,\n  });\n\n  /**\n   * The last mouse move position\n   * The coordinates are in browser space\n   */\n  readonly lastMousePos$ = new Signal<IPoint>({\n    x: 0,\n    y: 0,\n  });\n\n  get currentTool$() {\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const self = this;\n\n    return {\n      get value() {\n        return self._tools.get(self.currentToolName$.value);\n      },\n      peek() {\n        return self._tools.get(self.currentToolName$.peek());\n      },\n    };\n  }\n\n  get currentToolOption$() {\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const self = this;\n\n    return {\n      peek() {\n        const option = self._toolOption$.peek() as unknown as { type: string };\n\n        if (!option.type) {\n          option.type = '';\n        }\n\n        return option as GfxToolsFullOptionValue;\n      },\n\n      get value(): GfxToolsFullOptionValue {\n        const option = self._toolOption$.value as unknown as { type: string };\n\n        if (!option.type) {\n          option.type = '';\n        }\n\n        return option as GfxToolsFullOptionValue;\n      },\n    };\n  }\n\n  /**\n   * The area that is being dragged.\n   * The coordinates are in model space.\n   */\n  get draggingArea$() {\n    const compute = (peek: boolean) => {\n      const area = peek\n        ? this.draggingViewArea$.peek()\n        : this.draggingViewArea$.value;\n      const [startX, startY] = this.gfx.viewport.toModelCoord(\n        area.startX,\n        area.startY\n      );\n      const [endX, endY] = this.gfx.viewport.toModelCoord(area.endX, area.endY);\n\n      return {\n        x: Math.min(startX, endX),\n        y: Math.min(startY, endY),\n        w: Math.abs(endX - startX),\n        h: Math.abs(endY - startY),\n        startX,\n        startY,\n        endX,\n        endY,\n      };\n    };\n\n    return {\n      value() {\n        return compute(false);\n      },\n      peek() {\n        return compute(true);\n      },\n    };\n  }\n\n  static override extendGfx(gfx: GfxController) {\n    Object.defineProperty(gfx, 'tool', {\n      get() {\n        return this.std.provider.get(ToolControllerIdentifier);\n      },\n    });\n  }\n\n  private _createBuiltInHookCtx<K extends keyof BuiltInEventMap>(\n    eventName: K,\n    data: BuiltInEventMap[K]['data']\n  ): {\n    prevented: boolean;\n    slotCtx: BuiltInSlotContext;\n  } {\n    const ctx = {\n      prevented: false,\n      slotCtx: {\n        event: eventName,\n        data,\n        preventDefault() {\n          ctx.prevented = true;\n        },\n      } as BuiltInSlotContext,\n    };\n\n    return ctx;\n  }\n\n  private _initializeEvents() {\n    const hooks: Record<\n      string,\n      ((\n        evtState: PointerEventState | BuiltInSlotContext\n      ) => undefined | boolean)[]\n    > = {};\n    /**\n     * Invoke the hook and the tool handler.\n     * @returns false if the handler is prevented by the hook\n     */\n    const invokeToolHandler = (\n      evtName: SupportedEvents,\n      evt: PointerEventState,\n      tool?: BaseTool\n    ) => {\n      const evtHooks = hooks[evtName];\n      const stopHandler = evtHooks?.reduce((pre, hook) => {\n        return pre || hook(evt) === false;\n      }, false);\n\n      tool = tool ?? this.currentTool$.peek();\n\n      if (stopHandler) {\n        return false;\n      }\n\n      try {\n        tool?.[evtName](evt);\n        return true;\n      } catch (e) {\n        throw new BlockSuiteError(\n          ErrorCode.ExecutionError,\n          `Error occurred while executing ${evtName} handler of tool \"${tool?.toolName}\"`,\n          {\n            cause: e as Error,\n          }\n        );\n      }\n    };\n\n    /**\n     * Hook into the event lifecycle.\n     * All hooks will be executed despite the current active tool.\n     * This is useful for tools that need to perform some action before an event is handled.\n     * @param evtName\n     * @param handler\n     */\n    const addHook: ToolEventTarget['addHook'] = (evtName, handler) => {\n      hooks[evtName] = hooks[evtName] ?? [];\n      hooks[evtName].push(\n        handler as (\n          evtState: PointerEventState | BuiltInSlotContext\n        ) => undefined | boolean\n      );\n\n      return () => {\n        const idx = hooks[evtName].indexOf(\n          handler as (\n            evtState: PointerEventState | BuiltInSlotContext\n          ) => undefined | boolean\n        );\n        if (idx !== -1) {\n          hooks[evtName].splice(idx, 1);\n        }\n      };\n    };\n\n    let dragContext: {\n      tool: BaseTool;\n    } | null = null;\n\n    this._disposableGroup.add(\n      this.std.event.add('dragStart', ctx => {\n        const evt = ctx.get('pointerState');\n\n        if (\n          evt.button === MouseButton.SECONDARY &&\n          !this.currentTool$.peek()?.allowDragWithRightButton\n        ) {\n          return;\n        }\n\n        if (evt.button === MouseButton.MIDDLE) {\n          evt.raw.preventDefault();\n        }\n\n        this.dragging$.value = true;\n        this.draggingViewArea$.value = {\n          startX: evt.x,\n          startY: evt.y,\n          endX: evt.x,\n          endY: evt.y,\n          x: evt.x,\n          y: evt.y,\n          w: 0,\n          h: 0,\n        };\n\n        // this means the dragEnd event is not even fired\n        // so we need to manually call the dragEnd method\n        if (dragContext?.tool) {\n          dragContext.tool.dragEnd(evt);\n          dragContext = null;\n        }\n\n        if (invokeToolHandler('dragStart', evt)) {\n          dragContext = this.currentTool$.peek()\n            ? {\n                tool: this.currentTool$.peek()!,\n              }\n            : null;\n        }\n      })\n    );\n\n    this._disposableGroup.add(\n      this.std.event.add('dragMove', ctx => {\n        if (!this.dragging$.peek()) {\n          return;\n        }\n\n        const evt = ctx.get('pointerState');\n        const draggingStart = {\n          x: this.draggingArea$.peek().startX,\n          y: this.draggingArea$.peek().startY,\n          originX: this.draggingViewArea$.peek().startX,\n          originY: this.draggingViewArea$.peek().startY,\n        };\n\n        this.draggingViewArea$.value = {\n          ...this.draggingViewArea$.peek(),\n          w: Math.abs(evt.x - draggingStart.originX),\n          h: Math.abs(evt.y - draggingStart.originY),\n          x: Math.min(evt.x, draggingStart.originX),\n          y: Math.min(evt.y, draggingStart.originY),\n          endX: evt.x,\n          endY: evt.y,\n        };\n\n        invokeToolHandler('dragMove', evt, dragContext?.tool);\n      })\n    );\n\n    this._disposableGroup.add(\n      this.std.event.add('dragEnd', ctx => {\n        if (!this.dragging$.peek()) {\n          return;\n        }\n\n        this.dragging$.value = false;\n        const evt = ctx.get('pointerState');\n\n        if (!invokeToolHandler('dragEnd', evt, dragContext?.tool)) {\n          // if the tool dragEnd is prevented by the hook, call the dragEnd method manually\n          // this guarantee the dragStart and dragEnd events are always called together\n          if (dragContext?.tool) {\n            dragContext.tool.dragEnd(evt);\n          }\n        }\n\n        dragContext = null;\n        this.draggingViewArea$.value = {\n          x: 0,\n          y: 0,\n          startX: 0,\n          startY: 0,\n          endX: 0,\n          endY: 0,\n          w: 0,\n          h: 0,\n        };\n      })\n    );\n\n    this._disposableGroup.add(\n      this.std.event.add('pointerMove', ctx => {\n        const evt = ctx.get('pointerState');\n\n        this.lastMousePos$.value = {\n          x: evt.x,\n          y: evt.y,\n        };\n\n        invokeToolHandler('pointerMove', evt);\n      })\n    );\n\n    this._disposableGroup.add(\n      this.std.event.add('contextMenu', ctx => {\n        const evt = ctx.get('defaultState');\n\n        // when in editing mode, allow context menu to pop up\n        if (this.gfx.selection.editing) return;\n\n        evt.event.preventDefault();\n      })\n    );\n\n    supportedEvents.slice(5).forEach(evtName => {\n      this._disposableGroup.add(\n        this.std.event.add(evtName, ctx => {\n          const evt = ctx.get('pointerState');\n\n          invokeToolHandler(evtName, evt);\n        })\n      );\n    });\n\n    this._builtInHookSlot.on(evt => {\n      hooks[evt.event]?.forEach(hook => hook(evt));\n    });\n\n    return {\n      addHook,\n    };\n  }\n\n  private _register(tools: BaseTool) {\n    if (this._tools.has(tools.toolName)) {\n      this._tools.get(tools.toolName)?.unmounted();\n    }\n\n    this._tools.set(tools.toolName, tools);\n    tools.mounted();\n  }\n\n  get<K extends keyof GfxToolsMap>(key: K): GfxToolsMap[K] {\n    return this._tools.get(key) as GfxToolsMap[K];\n  }\n\n  override mounted(): void {\n    const { addHook } = this._initializeEvents();\n\n    const eventTarget: ToolEventTarget = {\n      addHook,\n    };\n\n    this.std.provider.getAll(ToolIdentifier).forEach(tool => {\n      // @ts-ignore\n      tool['eventTarget'] = eventTarget;\n      this._register(tool);\n    });\n  }\n\n  setTool(toolName: GfxToolsFullOptionValue, ...args: [void]): void;\n  setTool<K extends keyof GfxToolsMap>(\n    toolName: K,\n    ...args: K extends keyof GfxToolsOption\n      ? [option: GfxToolsOption[K]]\n      : [void]\n  ): void;\n  setTool<K extends keyof GfxToolsMap>(\n    toolName: K | GfxToolsFullOptionValue,\n    ...args: K extends keyof GfxToolsOption\n      ? [option: GfxToolsOption[K]]\n      : [void]\n  ): void {\n    const option = typeof toolName === 'string' ? args[0] : toolName;\n    const toolNameStr =\n      typeof toolName === 'string'\n        ? toolName\n        : ((toolName as { type: string }).type as K);\n\n    const beforeUpdateCtx = this._createBuiltInHookCtx('beforeToolUpdate', {\n      toolName: toolNameStr,\n    });\n    this._builtInHookSlot.emit(beforeUpdateCtx.slotCtx);\n\n    if (beforeUpdateCtx.prevented) {\n      return;\n    }\n\n    this.gfx.selection.set({ elements: [] });\n\n    this.currentTool$.peek()?.deactivate();\n    this.currentToolName$.value = toolNameStr;\n\n    const currentTool = this.currentTool$.peek();\n    if (!currentTool) {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        `Tool \"${this.currentToolName$.value}\" is not defined`\n      );\n    }\n\n    currentTool.activatedOption = option ?? {};\n    this._toolOption$.value = {\n      ...currentTool.activatedOption,\n      type: toolNameStr,\n    } as GfxToolsFullOptionValue;\n    currentTool.activate(currentTool.activatedOption);\n\n    const afterUpdateCtx = this._createBuiltInHookCtx('toolUpdate', {\n      toolName: toolNameStr,\n    });\n    this._builtInHookSlot.emit(afterUpdateCtx.slotCtx);\n  }\n\n  override unmounted(): void {\n    this.currentTool$.peek()?.deactivate();\n    this._tools.forEach(tool => {\n      tool.unmounted();\n      tool['disposable'].dispose();\n    });\n    this._builtInHookSlot.dispose();\n  }\n}\n\nexport const ToolControllerIdentifier = GfxExtensionIdentifier(\n  'ToolController'\n) as ServiceIdentifier<ToolController>;\n\ndeclare module '../controller.js' {\n  interface GfxController {\n    readonly tool: ToolController;\n  }\n}\n"]}