{"version":3,"file":"grid.js","sourceRoot":"","sources":["../../src/gfx/grid.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IBound } from '@blocksuite/global/utils';\nimport type { BlockModel, Doc } from '@blocksuite/store';\n\nimport {\n  Bound,\n  getBoundWithRotation,\n  intersects,\n} from '@blocksuite/global/utils';\n\nimport type { GfxModel } from './model/model.js';\n\nimport { compare } from '../utils/layer.js';\nimport { GfxBlockElementModel } from './model/gfx-block-model.js';\nimport { GfxPrimitiveElementModel } from './model/surface/element-model.js';\nimport { GfxLocalElementModel } from './model/surface/local-element-model.js';\nimport { SurfaceBlockModel } from './model/surface/surface-model.js';\n\nfunction getGridIndex(val: number) {\n  return Math.ceil(val / DEFAULT_GRID_SIZE) - 1;\n}\n\nfunction rangeFromBound(a: IBound): number[] {\n  if (a.rotate) a = getBoundWithRotation(a);\n  const minRow = getGridIndex(a.x);\n  const maxRow = getGridIndex(a.x + a.w);\n  const minCol = getGridIndex(a.y);\n  const maxCol = getGridIndex(a.y + a.h);\n  return [minRow, maxRow, minCol, maxCol];\n}\n\nfunction rangeFromElement(ele: GfxModel | GfxLocalElementModel): number[] {\n  const bound = ele.elementBound;\n\n  bound.w += ele.responseExtension[0] * 2;\n  bound.h += ele.responseExtension[1] * 2;\n  bound.x -= ele.responseExtension[0];\n  bound.y -= ele.responseExtension[1];\n\n  const minRow = getGridIndex(bound.x);\n  const maxRow = getGridIndex(bound.maxX);\n  const minCol = getGridIndex(bound.y);\n  const maxCol = getGridIndex(bound.maxY);\n  return [minRow, maxRow, minCol, maxCol];\n}\n\nfunction rangeFromElementExternal(ele: GfxModel): number[] | null {\n  if (!ele.externalXYWH) return null;\n\n  const bound = Bound.deserialize(ele.externalXYWH);\n  const minRow = getGridIndex(bound.x);\n  const maxRow = getGridIndex(bound.maxX);\n  const minCol = getGridIndex(bound.y);\n  const maxCol = getGridIndex(bound.maxY);\n  return [minRow, maxRow, minCol, maxCol];\n}\n\nexport const DEFAULT_GRID_SIZE = 3000;\n\nconst typeFilters = {\n  block: (model: GfxModel | GfxLocalElementModel) =>\n    model instanceof GfxBlockElementModel,\n  canvas: (model: GfxModel | GfxLocalElementModel) =>\n    model instanceof GfxPrimitiveElementModel,\n  local: (model: GfxModel | GfxLocalElementModel) =>\n    model instanceof GfxLocalElementModel,\n};\n\ntype FilterFunc = (model: GfxModel | GfxLocalElementModel) => boolean;\n\nexport class GridManager {\n  private _elementToGrids = new Map<\n    GfxModel | GfxLocalElementModel,\n    Set<Set<GfxModel | GfxLocalElementModel>>\n  >();\n\n  private _externalElementToGrids = new Map<GfxModel, Set<Set<GfxModel>>>();\n\n  private _externalGrids = new Map<string, Set<GfxModel>>();\n\n  private _grids = new Map<string, Set<GfxModel | GfxLocalElementModel>>();\n\n  get isEmpty() {\n    return this._grids.size === 0;\n  }\n\n  private _addToExternalGrids(element: GfxModel) {\n    const range = rangeFromElementExternal(element);\n\n    if (!range) {\n      this._removeFromExternalGrids(element);\n      return;\n    }\n\n    const [minRow, maxRow, minCol, maxCol] = range;\n    const grids = new Set<Set<GfxModel>>();\n    this._externalElementToGrids.set(element, grids);\n\n    for (let i = minRow; i <= maxRow; i++) {\n      for (let j = minCol; j <= maxCol; j++) {\n        let grid = this._getExternalGrid(i, j);\n        if (!grid) {\n          grid = this._createExternalGrid(i, j);\n        }\n        grid.add(element);\n        grids.add(grid);\n      }\n    }\n  }\n\n  private _createExternalGrid(row: number, col: number) {\n    const id = row + '|' + col;\n    const elements = new Set<GfxModel>();\n    this._externalGrids.set(id, elements);\n    return elements;\n  }\n\n  private _createGrid(row: number, col: number) {\n    const id = row + '|' + col;\n    const elements = new Set<GfxModel>();\n    this._grids.set(id, elements);\n    return elements;\n  }\n\n  private _getExternalGrid(row: number, col: number) {\n    const id = row + '|' + col;\n    return this._externalGrids.get(id);\n  }\n\n  private _getGrid(row: number, col: number) {\n    const id = row + '|' + col;\n    return this._grids.get(id);\n  }\n\n  private _removeFromExternalGrids(element: GfxModel) {\n    const grids = this._externalElementToGrids.get(element);\n    if (grids) {\n      for (const grid of grids) {\n        grid.delete(element);\n      }\n    }\n  }\n\n  private _searchExternal(\n    bound: IBound,\n    options: { filterFunc: FilterFunc; strict: boolean }\n  ): Set<GfxModel> {\n    const [minRow, maxRow, minCol, maxCol] = rangeFromBound(bound);\n    const results = new Set<GfxModel>();\n    const b = Bound.from(bound);\n\n    for (let i = minRow; i <= maxRow; i++) {\n      for (let j = minCol; j <= maxCol; j++) {\n        const gridElements = this._getExternalGrid(i, j);\n        if (!gridElements) continue;\n\n        for (const element of gridElements) {\n          const externalBound = element.externalBound;\n          if (\n            options.filterFunc(element) &&\n            externalBound &&\n            (options.strict\n              ? b.contains(externalBound)\n              : intersects(externalBound, bound))\n          ) {\n            results.add(element);\n          }\n        }\n      }\n    }\n\n    return results;\n  }\n\n  private _toFilterFunc(filters: (keyof typeof typeFilters | FilterFunc)[]) {\n    const filterFuncs: FilterFunc[] = filters.map(filter => {\n      if (typeof filter === 'function') {\n        return filter;\n      }\n      return typeFilters[filter];\n    });\n\n    return (model: GfxModel | GfxLocalElementModel) =>\n      filterFuncs.some(filter => filter(model));\n  }\n\n  add(element: GfxModel | GfxLocalElementModel) {\n    if (!(element instanceof GfxLocalElementModel)) {\n      this._addToExternalGrids(element);\n    }\n\n    const [minRow, maxRow, minCol, maxCol] = rangeFromElement(element);\n    const grids = new Set<Set<GfxModel | GfxLocalElementModel>>();\n    this._elementToGrids.set(element, grids);\n\n    for (let i = minRow; i <= maxRow; i++) {\n      for (let j = minCol; j <= maxCol; j++) {\n        let grid = this._getGrid(i, j);\n        if (!grid) {\n          grid = this._createGrid(i, j);\n        }\n        grid.add(element);\n        grids.add(grid);\n      }\n    }\n  }\n\n  boundHasChanged(a: IBound, b: IBound) {\n    const [minRow, maxRow, minCol, maxCol] = rangeFromBound(a);\n    const [minRow2, maxRow2, minCol2, maxCol2] = rangeFromBound(b);\n    return (\n      minRow !== minRow2 ||\n      maxRow !== maxRow2 ||\n      minCol !== minCol2 ||\n      maxCol !== maxCol2\n    );\n  }\n\n  /**\n   *\n   * @param bound\n   * @param strict\n   * @param reverseChecking If true, check if the bound is inside the elements instead of checking if the elements are inside the bound\n   * @returns\n   */\n  has(\n    bound: IBound,\n    strict: boolean = false,\n    reverseChecking: boolean = false,\n    filter?: (model: GfxModel | GfxLocalElementModel) => boolean\n  ) {\n    const [minRow, maxRow, minCol, maxCol] = rangeFromBound(bound);\n    const b = Bound.from(bound);\n    const check = reverseChecking\n      ? (target: Bound) => {\n          return strict ? target.contains(b) : intersects(b, target);\n        }\n      : (target: Bound) => {\n          return strict ? b.contains(target) : intersects(target, b);\n        };\n\n    for (let i = minRow; i <= maxRow; i++) {\n      for (let j = minCol; j <= maxCol; j++) {\n        const gridElements = this._getGrid(i, j);\n        if (!gridElements) continue;\n        for (const element of gridElements) {\n          if ((!filter || filter(element)) && check(element.elementBound)) {\n            return true;\n          }\n        }\n      }\n    }\n\n    return false;\n  }\n\n  remove(element: GfxModel | GfxLocalElementModel) {\n    const grids = this._elementToGrids.get(element);\n    if (grids) {\n      for (const grid of grids) {\n        grid.delete(element);\n      }\n    }\n    this._elementToGrids.delete(element);\n\n    if (!(element instanceof GfxLocalElementModel)) {\n      this._removeFromExternalGrids(element);\n    }\n  }\n\n  /**\n   * Search for elements in a bound.\n   * @param bound\n   * @param options\n   */\n  search<T extends keyof typeof typeFilters>(\n    bound: IBound,\n    options?: {\n      /**\n       * If true, only return elements that are completely inside the bound.\n       * Default is false.\n       */\n      strict?: boolean;\n      /**\n       * If true, return a set of elements instead of an array\n       */\n      useSet?: false;\n      /**\n       * Use this to filter the elements, if not provided, it will return blocks and canvas elements by default\n       */\n      filter?: (T | FilterFunc)[] | FilterFunc;\n    }\n  ): T extends 'local'[] ? (GfxModel | GfxLocalElementModel)[] : GfxModel[];\n  search<T extends keyof typeof typeFilters>(\n    bound: IBound,\n    options: {\n      strict?: boolean | undefined;\n      useSet: true;\n      filter?: (T | FilterFunc)[] | FilterFunc;\n    }\n  ): T extends 'local'[] ? Set<GfxModel | GfxLocalElementModel> : Set<GfxModel>;\n  search<T extends keyof typeof typeFilters>(\n    bound: IBound,\n    options: {\n      strict?: boolean;\n      useSet?: boolean;\n      filter?: (T | FilterFunc)[] | FilterFunc;\n    } = {\n      useSet: false,\n    }\n  ):\n    | (GfxModel | GfxLocalElementModel)[]\n    | Set<GfxModel | GfxLocalElementModel> {\n    const strict = options.strict ?? false;\n    const [minRow, maxRow, minCol, maxCol] = rangeFromBound(bound);\n    const b = Bound.from(bound);\n    const returnSet = options.useSet ?? false;\n    const filterFunc =\n      (Array.isArray(options.filter)\n        ? this._toFilterFunc(options.filter)\n        : options.filter) ?? this._toFilterFunc(['canvas', 'block']);\n    const results: Set<GfxModel | GfxLocalElementModel> = this._searchExternal(\n      bound,\n      {\n        filterFunc,\n        strict,\n      }\n    );\n\n    for (let i = minRow; i <= maxRow; i++) {\n      for (let j = minCol; j <= maxCol; j++) {\n        const gridElements = this._getGrid(i, j);\n        if (!gridElements) continue;\n        for (const element of gridElements) {\n          if (\n            !(element as GfxPrimitiveElementModel).hidden &&\n            filterFunc(element) &&\n            (strict\n              ? b.contains(element.elementBound)\n              : intersects(element.responseBound, b))\n          ) {\n            results.add(element);\n          }\n        }\n      }\n    }\n\n    if (returnSet) return results;\n\n    // sort elements in set based on index\n    const sorted = Array.from(results).sort(compare);\n\n    return sorted;\n  }\n\n  update(element: GfxModel | GfxLocalElementModel) {\n    this.remove(element);\n    this.add(element);\n  }\n\n  watch(blocks: { doc?: Doc; surface?: SurfaceBlockModel | null }) {\n    const disposables: { dispose: () => void }[] = [];\n    const { doc, surface } = blocks;\n    const isRenderableBlock = (\n      block: BlockModel\n    ): block is GfxBlockElementModel => {\n      return (\n        block instanceof GfxBlockElementModel &&\n        (block.parent?.role === 'root' ||\n          block.parent instanceof SurfaceBlockModel)\n      );\n    };\n\n    if (doc) {\n      disposables.push(\n        doc.slots.blockUpdated.on(payload => {\n          if (payload.type === 'add') {\n            if (isRenderableBlock(payload.model)) {\n              this.add(payload.model);\n            }\n          }\n\n          if (payload.type === 'update') {\n            const model = doc.getBlock(payload.id)\n              ?.model as GfxBlockElementModel;\n\n            if (!model) {\n              return;\n            }\n\n            if (this._elementToGrids.has(model) && !isRenderableBlock(model)) {\n              this.remove(model as GfxBlockElementModel);\n            } else if (\n              payload.props.key === 'xywh' &&\n              isRenderableBlock(model)\n            ) {\n              this.update(\n                doc.getBlock(payload.id)?.model as GfxBlockElementModel\n              );\n            }\n          }\n\n          if (payload.type === 'delete') {\n            if (payload.model instanceof GfxBlockElementModel) {\n              this.remove(payload.model);\n            }\n          }\n        })\n      );\n\n      Object.values(doc.blocks.peek()).forEach(block => {\n        if (isRenderableBlock(block.model)) {\n          this.add(block.model);\n        }\n      });\n    }\n\n    if (surface) {\n      disposables.push(\n        surface.elementAdded.on(payload => {\n          this.add(surface.getElementById(payload.id)!);\n        })\n      );\n\n      disposables.push(\n        surface.elementRemoved.on(payload => {\n          this.remove(payload.model);\n        })\n      );\n\n      disposables.push(\n        surface.elementUpdated.on(payload => {\n          if (\n            payload.props['xywh'] ||\n            payload.props['externalXYWH'] ||\n            payload.props['responseExtension']\n          ) {\n            this.update(surface.getElementById(payload.id)!);\n          }\n        })\n      );\n\n      disposables.push(\n        surface.localElementAdded.on(elm => {\n          this.add(elm);\n        })\n      );\n\n      disposables.push(\n        surface.localElementUpdated.on(payload => {\n          if (payload.props['xywh'] || payload.props['responseExtension']) {\n            this.update(payload.model);\n          }\n        })\n      );\n\n      disposables.push(\n        surface.localElementDeleted.on(elm => {\n          this.remove(elm);\n        })\n      );\n\n      surface.elementModels.forEach(model => {\n        this.add(model);\n      });\n      surface.localElementModels.forEach(model => {\n        this.add(model);\n      });\n    }\n\n    return () => {\n      disposables.forEach(d => d.dispose());\n    };\n  }\n}\n"]}