{"version":3,"file":"shadowless-element.js","sourceRoot":"","sources":["../../../src/view/element/shadowless-element.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,SAAS,EAAE,UAAU,EAAE,MAAM,KAAK,CAAC;AAE5C,MAAM,OAAO,iBAAkB,SAAQ,UAAU;IAC/C,mDAAmD;IACnD,iFAAiF;aAC1E,mBAAc,GAAG,IAAI,OAAO,EAGhC,CAAC;aAEG,sBAAiB,GAAG,IAAI,OAAO,EAGnC,CAAC;IAEJ,oEAAoE;IACpE,4CAA4C;IAClC,MAAM,CAAU,cAAc,CACtC,MAAuB;QAEvB,MAAM,aAAa,GAAG,KAAK,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;QACnD,+EAA+E;QAC/E,0CAA0C;QAC1C,aAAa,CAAC,OAAO,CAAC,CAAC,CAAoB,EAAE,EAAE;YAC7C,IAAI,CAAC,YAAY,SAAS,IAAI,OAAO,QAAQ,KAAK,WAAW,EAAE,CAAC;gBAC9D,MAAM,SAAS,GAAG,QAAQ,CAAC,IAAI,CAAC;gBAChC,MAAM,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;gBAC9C,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC,OAAO,CAAC;gBAC9B,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YAC1B,CAAC;QACH,CAAC,CAAC,CAAC;QACH,OAAO,aAAa,CAAC;IACvB,CAAC;IAEO,iBAAiB;QACvB,MAAM,EAAE,GAAG,IAAI,CAAC,WAAuC,CAAC;QACxD,OAAO,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC,IAAI,CAAC,CAAC;IACjE,CAAC;IAEO,iBAAiB,CAAC,KAAa;QACrC,MAAM,EAAE,GAAG,IAAI,CAAC,WAAuC,CAAC;QAExD,IAAI,CAAC,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC;YAC/B,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,EAAE,EAAE,IAAI,OAAO,EAAE,CAAC,CAAC;QAC3C,CAAC;QAED,EAAE,CAAC,cAAc,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,EAAE,KAAK,CAAC,CAAC;IAC5D,CAAC;IAEQ,iBAAiB;QACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;QAC1B,MAAM,UAAU,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QACtC,MAAM,EAAE,GAAG,IAAI,CAAC,WAAuC,CAAC;QACxD,MAAM,gBAAgB,GAAG,UAAU,YAAY,UAAU,CAAC;QAC1D,MAAM,kBAAkB,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAEpD,IAAI,kBAAkB,KAAK,CAAC,IAAI,gBAAgB,EAAE,CAAC;YACjD,MAAM,aAAa,GAAG,EAAE,CAAC,aAAa,CAAC;YACvC,MAAM,cAAc,GAAuB,EAAE,CAAC;YAC9C,aAAa,CAAC,OAAO,CAAC,CAAC,CAAoB,EAAE,EAAE;gBAC7C,IAAI,CAAC,YAAY,SAAS,IAAI,OAAO,QAAQ,KAAK,WAAW,EAAE,CAAC;oBAC9D,MAAM,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;oBAC9C,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC,OAAO,CAAC;oBAC9B,UAAU,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBAC1B,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;gBAC7B,CAAC;YACH,CAAC,CAAC,CAAC;YACH,EAAE,CAAC,iBAAiB,CAAC,GAAG,CAAC,EAAE,EAAE,GAAG,EAAE;gBAChC,cAAc,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,CAAC;YAClD,CAAC,CAAC,CAAC;QACL,CAAC;QACD,IAAI,CAAC,iBAAiB,CAAC,kBAAkB,GAAG,CAAC,CAAC,CAAC;IACjD,CAAC;IAEQ,gBAAgB;QACvB,OAAO,IAAI,CAAC;IACd,CAAC;IAEQ,oBAAoB;QAC3B,KAAK,CAAC,oBAAoB,EAAE,CAAC;QAC7B,MAAM,EAAE,GAAG,IAAI,CAAC,WAAuC,CAAC;QACxD,IAAI,kBAAkB,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAClD,kBAAkB,EAAE,CAAC;QACrB,IAAI,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC;QAE3C,IAAI,kBAAkB,KAAK,CAAC,EAAE,CAAC;YAC7B,EAAE,CAAC,iBAAiB,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;QACnC,CAAC;IACH,CAAC","sourcesContent":["import type { Constructor } from '@blocksuite/global/utils';\nimport type { CSSResultGroup, CSSResultOrNative } from 'lit';\n\nimport { CSSResult, LitElement } from 'lit';\n\nexport class ShadowlessElement extends LitElement {\n  // Map of the number of styles injected into a node\n  // A reference count of the number of ShadowlessElements that are still connected\n  static connectedCount = new WeakMap<\n    Constructor, // class\n    WeakMap<Node, number>\n  >();\n\n  static onDisconnectedMap = new WeakMap<\n    Constructor, // class\n    (() => void) | null\n  >();\n\n  // styles registered in ShadowlessElement will be available globally\n  // even if the element is not being rendered\n  protected static override finalizeStyles(\n    styles?: CSSResultGroup\n  ): CSSResultOrNative[] {\n    const elementStyles = super.finalizeStyles(styles);\n    // XXX: This breaks component encapsulation and applies styles to the document.\n    // These styles should be manually scoped.\n    elementStyles.forEach((s: CSSResultOrNative) => {\n      if (s instanceof CSSResult && typeof document !== 'undefined') {\n        const styleRoot = document.head;\n        const style = document.createElement('style');\n        style.textContent = s.cssText;\n        styleRoot.append(style);\n      }\n    });\n    return elementStyles;\n  }\n\n  private getConnectedCount() {\n    const SE = this.constructor as typeof ShadowlessElement;\n    return SE.connectedCount.get(SE)?.get(this.getRootNode()) ?? 0;\n  }\n\n  private setConnectedCount(count: number) {\n    const SE = this.constructor as typeof ShadowlessElement;\n\n    if (!SE.connectedCount.has(SE)) {\n      SE.connectedCount.set(SE, new WeakMap());\n    }\n\n    SE.connectedCount.get(SE)?.set(this.getRootNode(), count);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    const parentRoot = this.getRootNode();\n    const SE = this.constructor as typeof ShadowlessElement;\n    const insideShadowRoot = parentRoot instanceof ShadowRoot;\n    const styleInjectedCount = this.getConnectedCount();\n\n    if (styleInjectedCount === 0 && insideShadowRoot) {\n      const elementStyles = SE.elementStyles;\n      const injectedStyles: HTMLStyleElement[] = [];\n      elementStyles.forEach((s: CSSResultOrNative) => {\n        if (s instanceof CSSResult && typeof document !== 'undefined') {\n          const style = document.createElement('style');\n          style.textContent = s.cssText;\n          parentRoot.prepend(style);\n          injectedStyles.push(style);\n        }\n      });\n      SE.onDisconnectedMap.set(SE, () => {\n        injectedStyles.forEach(style => style.remove());\n      });\n    }\n    this.setConnectedCount(styleInjectedCount + 1);\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    const SE = this.constructor as typeof ShadowlessElement;\n    let styleInjectedCount = this.getConnectedCount();\n    styleInjectedCount--;\n    this.setConnectedCount(styleInjectedCount);\n\n    if (styleInjectedCount === 0) {\n      SE.onDisconnectedMap.get(SE)?.();\n    }\n  }\n}\n"]}