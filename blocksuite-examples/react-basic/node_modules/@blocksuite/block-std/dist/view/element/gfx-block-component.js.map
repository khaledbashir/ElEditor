{"version":3,"file":"gfx-block-component.js","sourceRoot":"","sources":["../../../src/view/element/gfx-block-component.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { Bound } from '@blocksuite/global/utils';\nimport { nothing } from 'lit';\n\nimport type { BlockService } from '../../extension/index.js';\nimport type { GfxBlockElementModel } from '../../gfx/index.js';\n\nimport { GfxControllerIdentifier } from '../../gfx/identifiers.js';\nimport { BlockComponent } from './block-component.js';\n\nexport function isGfxBlockComponent(\n  element: unknown\n): element is GfxBlockComponent {\n  return (element as GfxBlockComponent)?.[GfxElementSymbol] === true;\n}\n\nexport const GfxElementSymbol = Symbol('GfxElement');\n\nfunction updateTransform(element: GfxBlockComponent) {\n  element.style.transformOrigin = '0 0';\n  element.style.transform = element.getCSSTransform();\n}\n\nfunction handleGfxConnection(instance: GfxBlockComponent) {\n  instance.style.position = 'absolute';\n\n  instance.disposables.add(\n    instance.gfx.viewport.viewportUpdated.on(() => {\n      updateTransform(instance);\n    })\n  );\n\n  instance.disposables.add(\n    instance.doc.slots.blockUpdated.on(({ type, id }) => {\n      if (id === instance.model.id && type === 'update') {\n        updateTransform(instance);\n      }\n    })\n  );\n\n  updateTransform(instance);\n}\n\nexport abstract class GfxBlockComponent<\n  Model extends GfxBlockElementModel = GfxBlockElementModel,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends BlockComponent<Model, Service, WidgetName> {\n  [GfxElementSymbol] = true;\n\n  get gfx() {\n    return this.std.get(GfxControllerIdentifier);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    handleGfxConnection(this);\n  }\n\n  getCSSTransform() {\n    const viewport = this.gfx.viewport;\n    const { translateX, translateY, zoom } = viewport;\n    const bound = Bound.deserialize(this.model.xywh);\n\n    const scaledX = bound.x * zoom;\n    const scaledY = bound.y * zoom;\n    const deltaX = scaledX - bound.x;\n    const deltaY = scaledY - bound.y;\n\n    return `translate(${translateX + deltaX}px, ${translateY + deltaY}px) scale(${zoom})`;\n  }\n\n  getRenderingRect() {\n    const { xywh$ } = this.model;\n\n    if (!xywh$) {\n      throw new BlockSuiteError(\n        ErrorCode.GfxBlockElementError,\n        `Error on rendering '${this.model.flavour}': Gfx block's model should have 'xywh' property.`\n      );\n    }\n\n    const [x, y, w, h] = JSON.parse(xywh$.value);\n\n    return { x, y, w, h, zIndex: this.toZIndex() };\n  }\n\n  override renderBlock() {\n    const { x, y, w, h, zIndex } = this.getRenderingRect();\n\n    this.style.left = `${x}px`;\n    this.style.top = `${y}px`;\n    this.style.width = `${w}px`;\n    this.style.height = `${h}px`;\n    this.style.zIndex = zIndex;\n\n    return this.renderGfxBlock();\n  }\n\n  renderGfxBlock(): unknown {\n    return nothing;\n  }\n\n  renderPageContent(): unknown {\n    return nothing;\n  }\n\n  override async scheduleUpdate() {\n    const parent = this.parentElement;\n\n    if (this.hasUpdated || !parent || !('scheduleUpdateChildren' in parent)) {\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      super.scheduleUpdate();\n    } else {\n      await (parent.scheduleUpdateChildren as (id: string) => Promise<void>)(\n        this.model.id\n      );\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      super.scheduleUpdate();\n    }\n  }\n\n  toZIndex(): string {\n    return this.gfx.layer.getZIndex(this.model).toString() ?? '0';\n  }\n\n  updateZIndex(): void {\n    this.style.zIndex = this.toZIndex();\n  }\n}\n\nexport function toGfxBlockComponent<\n  Model extends GfxBlockElementModel,\n  Service extends BlockService,\n  WidgetName extends string,\n  B extends typeof BlockComponent<Model, Service, WidgetName>,\n>(CustomBlock: B) {\n  // @ts-ignore\n  return class extends CustomBlock {\n    [GfxElementSymbol] = true;\n\n    get gfx() {\n      return this.std.get(GfxControllerIdentifier);\n    }\n\n    override connectedCallback(): void {\n      super.connectedCallback();\n      handleGfxConnection(this);\n    }\n\n    getCSSTransform() {\n      const viewport = this.gfx.viewport;\n      const { translateX, translateY, zoom } = viewport;\n      const bound = Bound.deserialize(this.model.xywh);\n\n      const scaledX = bound.x * zoom;\n      const scaledY = bound.y * zoom;\n      const deltaX = scaledX - bound.x;\n      const deltaY = scaledY - bound.y;\n\n      return `translate(${translateX + deltaX}px, ${translateY + deltaY}px) scale(${zoom})`;\n    }\n\n    getRenderingRect(): {\n      x: number;\n      y: number;\n      w: number | string;\n      h: number | string;\n      zIndex: string;\n    } {\n      const { xywh$ } = this.model;\n\n      if (!xywh$) {\n        throw new BlockSuiteError(\n          ErrorCode.GfxBlockElementError,\n          `Error on rendering '${this.model.flavour}': Gfx block's model should have 'xywh' property.`\n        );\n      }\n\n      const [x, y, w, h] = JSON.parse(xywh$.value);\n\n      return { x, y, w, h, zIndex: this.toZIndex() };\n    }\n\n    override renderBlock() {\n      const { x, y, w, h, zIndex } = this.getRenderingRect();\n\n      this.style.left = `${x}px`;\n      this.style.top = `${y}px`;\n      this.style.width = typeof w === 'number' ? `${w}px` : w;\n      this.style.height = typeof h === 'number' ? `${h}px` : h;\n      this.style.zIndex = zIndex;\n\n      return this.renderGfxBlock();\n    }\n\n    renderGfxBlock(): unknown {\n      return this.renderPageContent();\n    }\n\n    renderPageContent() {\n      return super.renderBlock();\n    }\n\n    override async scheduleUpdate() {\n      const parent = this.parentElement;\n\n      if (this.hasUpdated || !parent || !('scheduleUpdateChildren' in parent)) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        super.scheduleUpdate();\n      } else {\n        await (parent.scheduleUpdateChildren as (id: string) => Promise<void>)(\n          this.model.id\n        );\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        super.scheduleUpdate();\n      }\n    }\n\n    toZIndex(): string {\n      return this.gfx.layer.getZIndex(this.model).toString() ?? '0';\n    }\n\n    updateZIndex(): void {\n      this.style.zIndex = this.toZIndex();\n    }\n  } as B & {\n    new (\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      ...args: any[]\n    ): GfxBlockComponent;\n  };\n}\n"]}