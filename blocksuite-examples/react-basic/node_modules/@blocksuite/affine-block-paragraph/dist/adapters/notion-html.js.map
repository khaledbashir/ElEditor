{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../src/adapters/notion-html.ts"],"names":[],"mappings":"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","sourcesContent":["import { ParagraphBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockNotionHtmlAdapterExtension,\n  type BlockNotionHtmlAdapterMatcher,\n  HastUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\n\nconst paragraphBlockMatchTags = [\n  'p',\n  'h1',\n  'h2',\n  'h3',\n  'h4',\n  'h5',\n  'h6',\n  'blockquote',\n  'div',\n  'span',\n  'figure',\n];\n\nconst NotionDatabaseTitleToken = '.collection-title';\nconst NotionPageLinkToken = '.link-to-page';\nconst NotionCalloutToken = '.callout';\nconst NotionCheckboxToken = '.checkbox';\n\nexport const paragraphBlockNotionHtmlAdapterMatcher: BlockNotionHtmlAdapterMatcher =\n  {\n    flavour: ParagraphBlockSchema.model.flavour,\n    toMatch: o =>\n      HastUtils.isElement(o.node) &&\n      paragraphBlockMatchTags.includes(o.node.tagName),\n    fromMatch: () => false,\n    toBlockSnapshot: {\n      enter: (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        const { walkerContext, deltaConverter, pageMap } = context;\n        switch (o.node.tagName) {\n          case 'blockquote': {\n            walkerContext.setGlobalContext('hast:blockquote', true);\n            walkerContext.openNode(\n              {\n                type: 'block',\n                id: nanoid(),\n                flavour: 'affine:paragraph',\n                props: {\n                  type: 'quote',\n                  text: {\n                    '$blocksuite:internal:text$': true,\n                    delta: deltaConverter.astToDelta(\n                      HastUtils.getInlineOnlyElementAST(o.node),\n                      { pageMap, removeLastBr: true }\n                    ),\n                  },\n                },\n                children: [],\n              },\n              'children'\n            );\n            break;\n          }\n          case 'p': {\n            // Workaround for Notion's bug\n            // https://html.spec.whatwg.org/multipage/grouping-content.html#the-p-element\n            if (!o.node.properties.id) {\n              break;\n            }\n            walkerContext.openNode(\n              {\n                type: 'block',\n                id: nanoid(),\n                flavour: 'affine:paragraph',\n                props: {\n                  type: walkerContext.getGlobalContext('hast:blockquote')\n                    ? 'quote'\n                    : 'text',\n                  text: {\n                    '$blocksuite:internal:text$': true,\n                    delta: deltaConverter.astToDelta(o.node, { pageMap }),\n                  },\n                },\n                children: [],\n              },\n              'children'\n            );\n            break;\n          }\n          case 'h1':\n          case 'h2':\n          case 'h3':\n          case 'h4':\n          case 'h5':\n          case 'h6': {\n            if (HastUtils.querySelector(o.node, NotionDatabaseTitleToken)) {\n              break;\n            }\n            walkerContext\n              .openNode(\n                {\n                  type: 'block',\n                  id: nanoid(),\n                  flavour: 'affine:paragraph',\n                  props: {\n                    type: o.node.tagName,\n                    text: {\n                      '$blocksuite:internal:text$': true,\n                      delta: deltaConverter.astToDelta(o.node, { pageMap }),\n                    },\n                  },\n                  children: [],\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'figure':\n            {\n              // Notion page link\n              if (HastUtils.querySelector(o.node, NotionPageLinkToken)) {\n                walkerContext\n                  .openNode(\n                    {\n                      type: 'block',\n                      id: nanoid(),\n                      flavour: 'affine:paragraph',\n                      props: {\n                        type: 'text',\n                        text: {\n                          '$blocksuite:internal:text$': true,\n                          delta: deltaConverter.astToDelta(o.node, { pageMap }),\n                        },\n                      },\n                      children: [],\n                    },\n                    'children'\n                  )\n                  .closeNode();\n                walkerContext.skipAllChildren();\n                break;\n              }\n            }\n\n            // Notion callout\n            if (HastUtils.querySelector(o.node, NotionCalloutToken)) {\n              const firstElementChild = HastUtils.getElementChildren(o.node)[0];\n              const secondElementChild = HastUtils.getElementChildren(\n                o.node\n              )[1];\n\n              const iconSpan = HastUtils.querySelector(\n                firstElementChild,\n                '.icon'\n              );\n              const iconText = iconSpan\n                ? HastUtils.getTextContent(iconSpan)\n                : '';\n              walkerContext\n                .openNode(\n                  {\n                    type: 'block',\n                    id: nanoid(),\n                    flavour: 'affine:paragraph',\n                    props: {\n                      type: 'quote',\n                      text: {\n                        '$blocksuite:internal:text$': true,\n                        delta: [\n                          { insert: iconText + '\\n' },\n                          ...deltaConverter.astToDelta(secondElementChild, {\n                            pageMap,\n                          }),\n                        ],\n                      },\n                    },\n                    children: [],\n                  },\n                  'children'\n                )\n                .closeNode();\n              walkerContext.skipAllChildren();\n              break;\n            }\n        }\n      },\n      leave: (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        const { walkerContext } = context;\n        switch (o.node.tagName) {\n          case 'div': {\n            if (\n              o.parent?.node.type === 'element' &&\n              !(\n                o.parent.node.tagName === 'li' &&\n                HastUtils.querySelector(o.parent.node, NotionCheckboxToken)\n              ) &&\n              Array.isArray(o.node.properties?.className)\n            ) {\n              if (o.node.properties.className.includes('indented')) {\n                walkerContext.closeNode();\n              }\n            }\n            break;\n          }\n          case 'blockquote': {\n            walkerContext.closeNode();\n            walkerContext.setGlobalContext('hast:blockquote', false);\n            break;\n          }\n          case 'p': {\n            if (!o.node.properties.id) {\n              break;\n            }\n            if (\n              o.next?.type === 'element' &&\n              o.next.tagName === 'div' &&\n              Array.isArray(o.next.properties?.className) &&\n              o.next.properties.className.includes('indented')\n            ) {\n              // Close the node when leaving div indented\n              break;\n            }\n            walkerContext.closeNode();\n            break;\n          }\n        }\n      },\n    },\n    fromBlockSnapshot: {},\n  };\n\nexport const ParagraphBlockNotionHtmlAdapterExtension =\n  BlockNotionHtmlAdapterExtension(paragraphBlockNotionHtmlAdapterMatcher);\n"]}