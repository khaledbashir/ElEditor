{"version":3,"file":"markdown.js","sourceRoot":"","sources":["../../src/adapters/markdown.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DeltaInsert } from '@blocksuite/inline';\nimport type { Heading } from 'mdast';\n\nimport { ParagraphBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockMarkdownAdapterExtension,\n  type BlockMarkdownAdapterMatcher,\n  type MarkdownAST,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\n\nconst PARAGRAPH_MDAST_TYPE = ['paragraph', 'html', 'heading', 'blockquote'];\n\nconst isParagraphMDASTType = (node: MarkdownAST) =>\n  PARAGRAPH_MDAST_TYPE.includes(node.type);\n\nexport const paragraphBlockMarkdownAdapterMatcher: BlockMarkdownAdapterMatcher =\n  {\n    flavour: ParagraphBlockSchema.model.flavour,\n    toMatch: o => isParagraphMDASTType(o.node),\n    fromMatch: o => o.node.flavour === ParagraphBlockSchema.model.flavour,\n    toBlockSnapshot: {\n      enter: (o, context) => {\n        const { walkerContext, deltaConverter } = context;\n        switch (o.node.type) {\n          case 'html': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'block',\n                  id: nanoid(),\n                  flavour: 'affine:paragraph',\n                  props: {\n                    type: 'text',\n                    text: {\n                      '$blocksuite:internal:text$': true,\n                      delta: [\n                        {\n                          insert: o.node.value,\n                        },\n                      ],\n                    },\n                  },\n                  children: [],\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'paragraph': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'block',\n                  id: nanoid(),\n                  flavour: 'affine:paragraph',\n                  props: {\n                    type: 'text',\n                    text: {\n                      '$blocksuite:internal:text$': true,\n                      delta: deltaConverter.astToDelta(o.node),\n                    },\n                  },\n                  children: [],\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'heading': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'block',\n                  id: nanoid(),\n                  flavour: 'affine:paragraph',\n                  props: {\n                    type: `h${o.node.depth}`,\n                    text: {\n                      '$blocksuite:internal:text$': true,\n                      delta: deltaConverter.astToDelta(o.node),\n                    },\n                  },\n                  children: [],\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'blockquote': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'block',\n                  id: nanoid(),\n                  flavour: 'affine:paragraph',\n                  props: {\n                    type: 'quote',\n                    text: {\n                      '$blocksuite:internal:text$': true,\n                      delta: deltaConverter.astToDelta(o.node),\n                    },\n                  },\n                  children: [],\n                },\n                'children'\n              )\n              .closeNode();\n            walkerContext.skipAllChildren();\n            break;\n          }\n        }\n      },\n    },\n    fromBlockSnapshot: {\n      enter: (o, context) => {\n        const { walkerContext, deltaConverter } = context;\n        const paragraphDepth = (walkerContext.getGlobalContext(\n          'affine:paragraph:depth'\n        ) ?? 0) as number;\n        const text = (o.node.props.text ?? { delta: [] }) as {\n          delta: DeltaInsert[];\n        };\n        switch (o.node.props.type) {\n          case 'h1':\n          case 'h2':\n          case 'h3':\n          case 'h4':\n          case 'h5':\n          case 'h6': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'heading',\n                  depth: parseInt(o.node.props.type[1]) as Heading['depth'],\n                  children: deltaConverter.deltaToAST(\n                    text.delta,\n                    paragraphDepth\n                  ),\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'text': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'paragraph',\n                  children: deltaConverter.deltaToAST(\n                    text.delta,\n                    paragraphDepth\n                  ),\n                },\n                'children'\n              )\n              .closeNode();\n            break;\n          }\n          case 'quote': {\n            walkerContext\n              .openNode(\n                {\n                  type: 'blockquote',\n                  children: [],\n                },\n                'children'\n              )\n              .openNode(\n                {\n                  type: 'paragraph',\n                  children: deltaConverter.deltaToAST(text.delta),\n                },\n                'children'\n              )\n              .closeNode()\n              .closeNode();\n            break;\n          }\n        }\n        walkerContext.setGlobalContext(\n          'affine:paragraph:depth',\n          paragraphDepth + 1\n        );\n      },\n      leave: (_, context) => {\n        const { walkerContext } = context;\n        walkerContext.setGlobalContext(\n          'affine:paragraph:depth',\n          (walkerContext.getGlobalContext('affine:paragraph:depth') as number) -\n            1\n        );\n      },\n    },\n  };\n\nexport const ParagraphBlockMarkdownAdapterExtension =\n  BlockMarkdownAdapterExtension(paragraphBlockMarkdownAdapterMatcher);\n"]}