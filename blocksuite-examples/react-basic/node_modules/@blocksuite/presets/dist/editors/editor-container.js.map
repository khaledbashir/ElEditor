{"version":3,"file":"editor-container.js","sourceRoot":"","sources":["../../src/editors/editor-container.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockModel, Doc } from '@blocksuite/store';\n\nimport {\n  BlockStdScope,\n  type ExtensionType,\n  ShadowlessElement,\n} from '@blocksuite/block-std';\nimport {\n  type AbstractEditor,\n  type DocMode,\n  EdgelessEditorBlockSpecs,\n  PageEditorBlockSpecs,\n  ThemeProvider,\n} from '@blocksuite/blocks';\nimport { SignalWatcher, Slot, WithDisposable } from '@blocksuite/global/utils';\nimport { computed, signal } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { keyed } from 'lit/directives/keyed.js';\nimport { when } from 'lit/directives/when.js';\n\nexport class AffineEditorContainer\n  extends SignalWatcher(WithDisposable(ShadowlessElement))\n  implements AbstractEditor\n{\n  static override styles = css`\n    .affine-page-viewport {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      overflow-x: hidden;\n      overflow-y: auto;\n      container-name: viewport;\n      container-type: inline-size;\n      font-family: var(--affine-font-family);\n    }\n    .affine-page-viewport * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .affine-page-viewport {\n        height: auto;\n      }\n    }\n\n    .playground-page-editor-container {\n      flex-grow: 1;\n      font-family: var(--affine-font-family);\n      display: block;\n    }\n\n    .playground-page-editor-container * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .playground-page-editor-container {\n        height: auto;\n      }\n    }\n\n    .edgeless-editor-container {\n      font-family: var(--affine-font-family);\n      background: var(--affine-background-primary-color);\n      display: block;\n      height: 100%;\n      position: relative;\n      overflow: clip;\n    }\n\n    .edgeless-editor-container * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .edgeless-editor-container {\n        height: auto;\n      }\n    }\n\n    .affine-edgeless-viewport {\n      display: block;\n      height: 100%;\n      position: relative;\n      overflow: clip;\n      container-name: viewport;\n      container-type: inline-size;\n    }\n  `;\n\n  private _doc = signal<Doc>();\n\n  private _edgelessSpecs = signal<ExtensionType[]>(EdgelessEditorBlockSpecs);\n\n  private _mode = signal<DocMode>('page');\n\n  private _pageSpecs = signal<ExtensionType[]>(PageEditorBlockSpecs);\n\n  private _specs = computed(() =>\n    this._mode.value === 'page'\n      ? this._pageSpecs.value\n      : this._edgelessSpecs.value\n  );\n\n  private _std = computed(() => {\n    return new BlockStdScope({\n      doc: this.doc,\n      extensions: this._specs.value,\n    });\n  });\n\n  private _editorTemplate = computed(() => {\n    return this._std.value.render();\n  });\n\n  /**\n   * @deprecated need to refactor\n   */\n  slots: AbstractEditor['slots'] = {\n    docUpdated: new Slot(),\n  };\n\n  get doc() {\n    return this._doc.value as Doc;\n  }\n\n  set doc(doc: Doc) {\n    this._doc.value = doc;\n  }\n\n  set edgelessSpecs(specs: ExtensionType[]) {\n    this._edgelessSpecs.value = specs;\n  }\n\n  get edgelessSpecs() {\n    return this._edgelessSpecs.value;\n  }\n\n  get host() {\n    try {\n      return this.std.host;\n    } catch {\n      return null;\n    }\n  }\n\n  get mode() {\n    return this._mode.value;\n  }\n\n  set mode(mode: DocMode) {\n    this._mode.value = mode;\n  }\n\n  set pageSpecs(specs: ExtensionType[]) {\n    this._pageSpecs.value = specs;\n  }\n\n  get pageSpecs() {\n    return this._pageSpecs.value;\n  }\n\n  get rootModel() {\n    return this.doc.root as BlockModel;\n  }\n\n  get std() {\n    return this._std.value;\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._disposables.add(\n      this.doc.slots.rootAdded.on(() => this.requestUpdate())\n    );\n  }\n\n  override firstUpdated() {\n    if (this.mode === 'page') {\n      setTimeout(() => {\n        if (this.autofocus) {\n          const richText = this.querySelector('rich-text');\n          const inlineEditor = richText?.inlineEditor;\n          inlineEditor?.focusEnd();\n        }\n      });\n    }\n  }\n\n  override render() {\n    const mode = this._mode.value;\n    const themeService = this.std.get(ThemeProvider);\n    const appTheme = themeService.app$.value;\n    const edgelessTheme = themeService.edgeless$.value;\n\n    return html`${keyed(\n      this.rootModel.id + mode,\n      html`\n        <div\n          data-theme=${mode === 'page' ? appTheme : edgelessTheme}\n          class=${mode === 'page'\n            ? 'affine-page-viewport'\n            : 'affine-edgeless-viewport'}\n        >\n          ${when(\n            mode === 'page',\n            () => html` <doc-title .doc=${this.doc}></doc-title> `\n          )}\n          <div\n            class=${mode === 'page'\n              ? 'page-editor playground-page-editor-container'\n              : 'edgeless-editor-container'}\n          >\n            ${this._editorTemplate.value}\n          </div>\n        </div>\n      `\n    )}`;\n  }\n\n  switchEditor(mode: DocMode) {\n    this._mode.value = mode;\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override updated(changedProperties: Map<string, unknown>) {\n    if (changedProperties.has('doc')) {\n      this.slots.docUpdated.emit({ newDocId: this.doc.id });\n    }\n\n    if (!changedProperties.has('doc') && !changedProperties.has('mode')) {\n      return;\n    }\n  }\n\n  @property({ attribute: false })\n  override accessor autofocus = false;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-editor-container': AffineEditorContainer;\n  }\n}\n"]}