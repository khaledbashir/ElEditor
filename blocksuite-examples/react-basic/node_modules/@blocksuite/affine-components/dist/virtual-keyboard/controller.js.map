{"version":3,"file":"controller.js","sourceRoot":"","sources":["../../src/virtual-keyboard/controller.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReactiveController, ReactiveControllerHost } from 'lit';\n\nimport { IS_IOS } from '@blocksuite/global/env';\nimport { DisposableGroup } from '@blocksuite/global/utils';\nimport { signal } from '@preact/signals-core';\n\nfunction notSupportedWarning() {\n  console.warn('VirtualKeyboard API and VisualViewport API are not supported');\n}\n\nexport type VirtualKeyboardControllerConfig = {\n  useScreenHeight: boolean;\n  inputElement: HTMLElement;\n};\n\nexport class VirtualKeyboardController implements ReactiveController {\n  private _disposables = new DisposableGroup();\n\n  private readonly _keyboardHeight$ = signal(0);\n\n  private readonly _keyboardOpened$ = signal(false);\n\n  private _storeInitialInputElementAttributes = () => {\n    const { inputElement } = this.config;\n    if (navigator.virtualKeyboard) {\n      const { overlaysContent } = navigator.virtualKeyboard;\n      const { virtualKeyboardPolicy } = inputElement;\n\n      this._disposables.add(() => {\n        if (!navigator.virtualKeyboard) return;\n        navigator.virtualKeyboard.overlaysContent = overlaysContent;\n        inputElement.virtualKeyboardPolicy = virtualKeyboardPolicy;\n      });\n    } else if (visualViewport) {\n      const { inputMode } = inputElement;\n      this._disposables.add(() => {\n        inputElement.inputMode = inputMode;\n      });\n    }\n  };\n\n  private readonly _updateKeyboardHeight = () => {\n    const { virtualKeyboard } = navigator;\n    if (virtualKeyboard) {\n      this._keyboardOpened$.value = virtualKeyboard.boundingRect.height > 0;\n      this._keyboardHeight$.value = virtualKeyboard.boundingRect.height;\n    } else if (visualViewport) {\n      const windowHeight = this.config.useScreenHeight\n        ? window.screen.height\n        : window.innerHeight;\n\n      /**\n       * ┌───────────────┐ - window top\n       * │               │\n       * │               │\n       * │               │\n       * │               │\n       * │               │\n       * └───────────────┘ - keyboard top        --\n       * │               │                       │ keyboard height in layout viewport\n       * └───────────────┘ - page(html) bottom   --\n       * │               │                       │ visualViewport.offsetTop\n       * └───────────────┘ - window bottom       --\n       */\n      this._keyboardOpened$.value = windowHeight - visualViewport.height > 0;\n      this._keyboardHeight$.value =\n        windowHeight -\n        visualViewport.height -\n        (IS_IOS ? 0 : visualViewport.offsetTop);\n    } else {\n      notSupportedWarning();\n    }\n  };\n\n  hide = () => {\n    if (navigator.virtualKeyboard) {\n      navigator.virtualKeyboard.hide();\n    } else {\n      this.config.inputElement.inputMode = 'none';\n    }\n  };\n\n  host: ReactiveControllerHost & {\n    virtualKeyboardControllerConfig: VirtualKeyboardControllerConfig;\n    hasUpdated: boolean;\n  };\n\n  show = () => {\n    if (navigator.virtualKeyboard) {\n      navigator.virtualKeyboard.show();\n    } else {\n      this.config.inputElement.inputMode = '';\n    }\n  };\n\n  toggle = () => {\n    if (this.opened) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  };\n\n  get config() {\n    return this.host.virtualKeyboardControllerConfig;\n  }\n\n  /**\n   * Return the height of keyboard in layout viewport\n   * see comment in the `_updateKeyboardHeight` method\n   */\n  get keyboardHeight() {\n    return this._keyboardHeight$.value;\n  }\n\n  get opened() {\n    return this._keyboardOpened$.value;\n  }\n\n  constructor(host: VirtualKeyboardController['host']) {\n    (this.host = host).addController(this);\n  }\n\n  hostConnected() {\n    this._storeInitialInputElementAttributes();\n\n    const { inputElement } = this.config;\n\n    if (navigator.virtualKeyboard) {\n      navigator.virtualKeyboard.overlaysContent = true;\n      this.config.inputElement.virtualKeyboardPolicy = 'manual';\n\n      this._disposables.addFromEvent(\n        navigator.virtualKeyboard,\n        'geometrychange',\n        this._updateKeyboardHeight\n      );\n    } else if (visualViewport) {\n      this._disposables.addFromEvent(\n        visualViewport,\n        'resize',\n        this._updateKeyboardHeight\n      );\n      this._disposables.addFromEvent(\n        visualViewport,\n        'scroll',\n        this._updateKeyboardHeight\n      );\n    } else {\n      notSupportedWarning();\n    }\n\n    this._disposables.addFromEvent(inputElement, 'focus', this.show);\n    this._disposables.addFromEvent(inputElement, 'blur', this.hide);\n\n    this._updateKeyboardHeight();\n  }\n\n  hostDisconnected() {\n    this._disposables.dispose();\n  }\n}\n"]}