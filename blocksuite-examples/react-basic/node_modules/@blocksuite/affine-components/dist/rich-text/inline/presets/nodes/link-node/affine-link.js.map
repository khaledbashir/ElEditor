{"version":3,"file":"affine-link.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/link-node/affine-link.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReferenceInfo } from '@blocksuite/affine-model';\nimport type { AffineTextAttributes } from '@blocksuite/affine-shared/types';\nimport type { BlockComponent } from '@blocksuite/block-std';\n\nimport { ParseDocUrlProvider } from '@blocksuite/affine-shared/services';\nimport { BLOCK_ID_ATTR, ShadowlessElement } from '@blocksuite/block-std';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_SPACE,\n} from '@blocksuite/inline';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { type StyleInfo, styleMap } from 'lit/directives/style-map.js';\n\nimport { HoverController } from '../../../../../hover/index.js';\nimport { RefNodeSlotsProvider } from '../../../../extension/index.js';\nimport { affineTextStyles } from '../affine-text.js';\nimport { toggleLinkPopup } from './link-popup/toggle-link-popup.js';\n\nexport class AffineLink extends ShadowlessElement {\n  static override styles = css`\n    affine-link a:hover [data-v-text='true'] {\n      text-decoration: underline;\n    }\n  `;\n\n  // The link has been identified.\n  private _identified: boolean = false;\n\n  // see https://github.com/toeverything/AFFiNE/issues/1540\n  private _onMouseUp = () => {\n    const anchorElement = this.querySelector('a');\n    if (!anchorElement || !anchorElement.isContentEditable) return;\n    anchorElement.contentEditable = 'false';\n    setTimeout(() => {\n      anchorElement.removeAttribute('contenteditable');\n    }, 0);\n  };\n\n  private _referenceInfo: ReferenceInfo | null = null;\n\n  openLink = (e?: MouseEvent) => {\n    if (!this._identified) {\n      this._identified = true;\n      this._identify();\n    }\n\n    const referenceInfo = this._referenceInfo;\n    if (!referenceInfo) return;\n\n    const refNodeSlotsProvider = this.std?.getOptional(RefNodeSlotsProvider);\n    if (!refNodeSlotsProvider) return;\n\n    e?.preventDefault();\n\n    refNodeSlotsProvider.docLinkClicked.emit(referenceInfo);\n  };\n\n  private _whenHover = new HoverController(\n    this,\n    ({ abortController }) => {\n      if (this.block?.doc.readonly) {\n        return null;\n      }\n      if (!this.inlineEditor || !this.selfInlineRange) {\n        return null;\n      }\n\n      const selection = this.std?.selection;\n      const textSelection = selection?.find('text');\n      if (!!textSelection && !textSelection.isCollapsed()) {\n        return null;\n      }\n\n      const blockSelections = selection?.filter('block');\n      if (blockSelections?.length) {\n        return null;\n      }\n\n      return {\n        template: toggleLinkPopup(\n          this.inlineEditor,\n          'view',\n          this.selfInlineRange,\n          abortController,\n          (e?: MouseEvent) => {\n            this.openLink(e);\n            abortController.abort();\n          }\n        ),\n      };\n    },\n    { enterDelay: 500 }\n  );\n\n  // Workaround for links not working in contenteditable div\n  // see also https://stackoverflow.com/questions/12059211/how-to-make-clickable-anchor-in-contenteditable-div\n  //\n  // Note: We cannot use JS to directly open a new page as this may be blocked by the browser.\n  //\n  // Please also note that when readonly mode active,\n  // this workaround is not necessary and links work normally.\n  get block() {\n    const block = this.inlineEditor?.rootElement.closest<BlockComponent>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    return block;\n  }\n\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    return inlineRoot?.inlineEditor;\n  }\n\n  get link() {\n    return this.delta.attributes?.link ?? '';\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor?.getInlineRangeFromElement(this);\n    return selfInlineRange;\n  }\n\n  get std() {\n    const std = this.block?.std;\n    return std;\n  }\n\n  // Identify if url is an internal link\n  private _identify() {\n    const link = this.link;\n    if (!link) return;\n\n    const result = this.std\n      ?.getOptional(ParseDocUrlProvider)\n      ?.parseDocUrl(link);\n    if (!result) return;\n\n    const { docId: pageId, ...params } = result;\n\n    this._referenceInfo = { pageId, params };\n  }\n\n  private _renderLink(style: StyleInfo) {\n    return html`<a\n      ${ref(this._whenHover.setReference)}\n      href=${this.link}\n      rel=\"noopener noreferrer\"\n      target=\"_blank\"\n      style=${styleMap(style)}\n      @click=${this.openLink}\n      @mouseup=${this._onMouseUp}\n      ><v-text .str=${this.delta.insert}></v-text\n    ></a>`;\n  }\n\n  override render() {\n    const linkStyle = {\n      color: 'var(--affine-link-color)',\n      fill: 'var(--affine-link-color)',\n      'text-decoration': 'none',\n      cursor: 'pointer',\n    };\n\n    if (this.delta.attributes && this.delta.attributes?.code) {\n      const codeStyle = affineTextStyles(this.delta.attributes);\n      return html`<code style=${styleMap(codeStyle)}>\n        ${this._renderLink(linkStyle)}\n      </code>`;\n    }\n\n    const style = this.delta.attributes\n      ? affineTextStyles(this.delta.attributes, linkStyle)\n      : {};\n\n    return this._renderLink(style);\n  }\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n}\n"]}