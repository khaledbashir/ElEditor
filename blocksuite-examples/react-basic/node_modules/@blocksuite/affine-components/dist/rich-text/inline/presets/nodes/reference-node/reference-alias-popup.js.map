{"version":3,"file":"reference-alias-popup.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/reference-node/reference-alias-popup.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReferenceInfo } from '@blocksuite/affine-model';\nimport type { AffineTextAttributes } from '@blocksuite/affine-shared/types';\nimport type { DeltaInsert, InlineRange } from '@blocksuite/inline';\n\nimport {\n  type LinkEventType,\n  type TelemetryEvent,\n  TelemetryProvider,\n} from '@blocksuite/affine-shared/services';\nimport { FONT_XS, PANEL_BASE } from '@blocksuite/affine-shared/styles';\nimport { type BlockStdScope, ShadowlessElement } from '@blocksuite/block-std';\nimport {\n  assertExists,\n  SignalWatcher,\n  WithDisposable,\n} from '@blocksuite/global/utils';\nimport { DoneIcon, ResetIcon } from '@blocksuite/icons/lit';\nimport { computePosition, inline, offset, shift } from '@floating-ui/dom';\nimport { signal } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property, query } from 'lit/decorators.js';\nimport { live } from 'lit/directives/live.js';\n\nimport type { EditorIconButton } from '../../../../../toolbar/index.js';\nimport type { AffineInlineEditor } from '../../affine-inline-specs.js';\n\nimport { REFERENCE_NODE } from '../consts.js';\n\nexport class ReferenceAliasPopup extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    :host {\n      box-sizing: border-box;\n    }\n\n    .overlay-mask {\n      position: fixed;\n      z-index: var(--affine-z-index-popover);\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: 100vh;\n    }\n\n    .alias-form-popup {\n      ${PANEL_BASE};\n      position: absolute;\n      display: flex;\n      width: 321px;\n      height: 37px;\n      gap: 8px;\n      box-sizing: content-box;\n      justify-content: space-between;\n      align-items: center;\n      animation: affine-popover-fade-in 0.2s ease;\n      z-index: var(--affine-z-index-popover);\n    }\n\n    @keyframes affine-popover-fade-in {\n      from {\n        opacity: 0;\n        transform: translateY(-3px);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    input {\n      display: flex;\n      flex: 1;\n      padding: 0;\n      border: none;\n      background: transparent;\n      color: var(--affine-text-primary-color);\n      ${FONT_XS};\n    }\n    input::placeholder {\n      color: var(--affine-placeholder-color);\n    }\n    input:focus {\n      outline: none;\n    }\n\n    editor-icon-button.save .label {\n      ${FONT_XS};\n      color: inherit;\n      text-transform: none;\n    }\n  `;\n\n  private _onSave = () => {\n    const title = this.title$.value.trim();\n    if (!title) {\n      this.remove();\n      return;\n    }\n\n    this._setTitle(title);\n\n    track(this.std, 'SavedAlias', { control: 'save' });\n\n    this.remove();\n  };\n\n  private _updateTitle = (e: InputEvent) => {\n    const target = e.target as HTMLInputElement;\n    const value = target.value;\n    this.title$.value = value;\n  };\n\n  private _onKeydown(e: KeyboardEvent) {\n    e.stopPropagation();\n    if (!e.isComposing) {\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        this.remove();\n        return;\n      }\n      if (e.key === 'Enter') {\n        e.preventDefault();\n        this._onSave();\n      }\n    }\n  }\n\n  private _onReset() {\n    this.title$.value = this.docTitle;\n\n    this._setTitle();\n\n    track(this.std, 'ResetedAlias', { control: 'reset' });\n\n    this.remove();\n  }\n\n  private _setTitle(title?: string) {\n    const reference: AffineTextAttributes['reference'] = {\n      type: 'LinkedPage',\n      ...this.referenceInfo,\n    };\n\n    if (title) {\n      reference.title = title;\n    } else {\n      delete reference.title;\n      delete reference.description;\n    }\n\n    this.inlineEditor.insertText(this.inlineRange, REFERENCE_NODE, {\n      reference,\n    });\n    this.inlineEditor.setInlineRange({\n      index: this.inlineRange.index + REFERENCE_NODE.length,\n      length: 0,\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.title$.value = this.referenceInfo.title ?? this.docTitle;\n  }\n\n  override firstUpdated() {\n    this.disposables.addFromEvent(this.overlayMask, 'click', e => {\n      e.stopPropagation();\n      this.remove();\n    });\n    this.disposables.addFromEvent(this, 'keydown', this._onKeydown);\n\n    this.inputElement.focus();\n    this.inputElement.select();\n  }\n\n  override render() {\n    return html`\n      <div class=\"overlay-root\">\n        <div class=\"overlay-mask\"></div>\n        <div class=\"alias-form-popup\">\n          <input\n            id=\"alias-title\"\n            type=\"text\"\n            placeholder=\"Add a custom title\"\n            .value=${live(this.title$.value)}\n            @input=${this._updateTitle}\n          />\n          <editor-icon-button\n            aria-label=\"Reset\"\n            class=\"reset\"\n            .iconContainerPadding=${4}\n            .tooltip=${'Reset'}\n            @click=${this._onReset}\n          >\n            ${ResetIcon({ width: '16px', height: '16px' })}\n          </editor-icon-button>\n          <editor-toolbar-separator></editor-toolbar-separator>\n          <editor-icon-button\n            aria-label=\"Save\"\n            class=\"save\"\n            .active=${true}\n            @click=${this._onSave}\n          >\n            ${DoneIcon({ width: '16px', height: '16px' })}\n            <span class=\"label\">Save</span>\n          </editor-icon-button>\n        </div>\n      </div>\n    `;\n  }\n\n  override updated() {\n    const range = this.inlineEditor.toDomRange(this.inlineRange);\n    assertExists(range);\n\n    const visualElement = {\n      getBoundingClientRect: () => range.getBoundingClientRect(),\n      getClientRects: () => range.getClientRects(),\n    };\n    computePosition(visualElement, this.popupContainer, {\n      middleware: [\n        offset(10),\n        inline(),\n        shift({\n          padding: 6,\n        }),\n      ],\n    })\n      .then(({ x, y }) => {\n        const popupContainer = this.popupContainer;\n        if (!popupContainer) return;\n        popupContainer.style.left = `${x}px`;\n        popupContainer.style.top = `${y}px`;\n      })\n      .catch(console.error);\n  }\n\n  @property({ type: Object })\n  accessor delta!: DeltaInsert<AffineTextAttributes>;\n\n  @property({ attribute: false })\n  accessor docTitle!: string;\n\n  @property({ attribute: false })\n  accessor inlineEditor!: AffineInlineEditor;\n\n  @property({ attribute: false })\n  accessor inlineRange!: InlineRange;\n\n  @query('input#alias-title')\n  accessor inputElement!: HTMLInputElement;\n\n  @query('.overlay-mask')\n  accessor overlayMask!: HTMLDivElement;\n\n  @query('.alias-form-popup')\n  accessor popupContainer!: HTMLDivElement;\n\n  @property({ type: Object })\n  accessor referenceInfo!: ReferenceInfo;\n\n  @query('editor-icon-button.save')\n  accessor saveButton!: EditorIconButton;\n\n  @property({ attribute: false })\n  accessor std!: BlockStdScope;\n\n  accessor title$ = signal<string>('');\n}\n\nfunction track(\n  std: BlockStdScope,\n  event: LinkEventType,\n  props: Partial<TelemetryEvent>\n) {\n  std.getOptional(TelemetryProvider)?.track(event, {\n    segment: 'toolbar',\n    page: 'doc editor',\n    module: 'reference edit popup',\n    type: 'inline view',\n    category: 'linked doc',\n    ...props,\n  });\n}\n"]}