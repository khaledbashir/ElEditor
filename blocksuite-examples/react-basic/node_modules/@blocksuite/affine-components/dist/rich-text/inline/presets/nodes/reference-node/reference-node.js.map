{"version":3,"file":"reference-node.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/reference-node/reference-node.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReferenceInfo } from '@blocksuite/affine-model';\nimport type { AffineTextAttributes } from '@blocksuite/affine-shared/types';\nimport type { Doc, DocMeta } from '@blocksuite/store';\n\nimport { DocDisplayMetaProvider } from '@blocksuite/affine-shared/services';\nimport {\n  cloneReferenceInfo,\n  referenceToNode,\n} from '@blocksuite/affine-shared/utils';\nimport {\n  BLOCK_ID_ATTR,\n  type BlockComponent,\n  ShadowlessElement,\n} from '@blocksuite/block-std';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { WithDisposable } from '@blocksuite/global/utils';\nimport { LinkedPageIcon } from '@blocksuite/icons/lit';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_NON_JOINER,\n  ZERO_WIDTH_SPACE,\n} from '@blocksuite/inline';\nimport { css, html, nothing } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { ifDefined } from 'lit/directives/if-defined.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { ReferenceNodeConfigProvider } from './reference-config.js';\n\nimport { HoverController } from '../../../../../hover/index.js';\nimport { Peekable } from '../../../../../peek/index.js';\nimport { RefNodeSlotsProvider } from '../../../../extension/index.js';\nimport { affineTextStyles } from '../affine-text.js';\nimport { DEFAULT_DOC_NAME, REFERENCE_NODE } from '../consts.js';\nimport { toggleReferencePopup } from './reference-popup.js';\n\n@Peekable({ action: false })\nexport class AffineReference extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .affine-reference {\n      white-space: normal;\n      word-break: break-word;\n      color: var(--affine-text-primary-color);\n      fill: var(--affine-icon-color);\n      border-radius: 4px;\n      text-decoration: none;\n      cursor: pointer;\n      user-select: none;\n      padding: 1px 2px 1px 0;\n    }\n    .affine-reference:hover {\n      background: var(--affine-hover-color);\n    }\n\n    .affine-reference[data-selected='true'] {\n      background: var(--affine-hover-color);\n    }\n\n    .affine-reference-title {\n      margin-left: 4px;\n      border-bottom: 0.5px solid var(--affine-divider-color);\n      transition: border 0.2s ease-out;\n    }\n    .affine-reference-title:hover {\n      border-bottom: 0.5px solid var(--affine-icon-color);\n    }\n  `;\n\n  private _updateRefMeta = (doc: Doc) => {\n    const refAttribute = this.delta.attributes?.reference;\n    if (!refAttribute) {\n      return;\n    }\n\n    const refMeta = doc.collection.meta.docMetas.find(\n      doc => doc.id === refAttribute.pageId\n    );\n    this.refMeta = refMeta\n      ? {\n          ...refMeta,\n        }\n      : undefined;\n  };\n\n  // Since the linked doc may be deleted, the `_refMeta` could be undefined.\n  @state()\n  accessor refMeta: DocMeta | undefined = undefined;\n\n  private _whenHover: HoverController = new HoverController(\n    this,\n    ({ abortController }) => {\n      if (\n        this.config.hidePopup ||\n        this.doc?.readonly ||\n        this.closest('.prevent-reference-popup') ||\n        !this.selfInlineRange ||\n        !this.inlineEditor\n      ) {\n        return null;\n      }\n\n      const selection = this.std?.selection;\n      if (!selection) {\n        return null;\n      }\n      const textSelection = selection.find('text');\n      if (!!textSelection && !textSelection.isCollapsed()) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (blockSelections.length) {\n        return null;\n      }\n\n      return {\n        template: toggleReferencePopup(\n          this,\n          this.referenceToNode(),\n          this.referenceInfo,\n          this.inlineEditor,\n          this.selfInlineRange,\n          this.refMeta?.title ?? DEFAULT_DOC_NAME,\n          abortController\n        ),\n      };\n    },\n    { enterDelay: 500 }\n  );\n\n  get _icon() {\n    const { pageId, params, title } = this.referenceInfo;\n    return this.block?.std\n      ?.get(DocDisplayMetaProvider)\n      .icon(pageId, { params, title, referenced: true }).value;\n  }\n\n  get _title() {\n    const { pageId, params, title } = this.referenceInfo;\n    return (\n      title ||\n      this.block?.std\n        ?.get(DocDisplayMetaProvider)\n        .title(pageId, { params, title, referenced: true }).value\n    );\n  }\n\n  get block() {\n    const block = this.inlineEditor?.rootElement.closest<BlockComponent>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    return block;\n  }\n\n  get customContent() {\n    return this.config.customContent;\n  }\n\n  get doc() {\n    const doc = this.config.doc;\n    return doc;\n  }\n\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    return inlineRoot?.inlineEditor;\n  }\n\n  get referenceInfo(): ReferenceInfo {\n    const reference = this.delta.attributes?.reference;\n    const id = this.doc?.id ?? '';\n    if (!reference) return { pageId: id };\n    return cloneReferenceInfo(reference);\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor?.getInlineRangeFromElement(this);\n    return selfInlineRange;\n  }\n\n  get std() {\n    const std = this.block?.std;\n    if (!std) {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        'std not found in reference node'\n      );\n    }\n    return std;\n  }\n\n  private _onClick() {\n    if (!this.config.interactable) return;\n    this.std\n      .getOptional(RefNodeSlotsProvider)\n      ?.docLinkClicked.emit(this.referenceInfo);\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.config) {\n      console.error('`reference-node` need `ReferenceNodeConfig`.');\n      return;\n    }\n\n    if (this.delta.insert !== REFERENCE_NODE) {\n      console.error(\n        `Reference node must be initialized with '${REFERENCE_NODE}', but got '${this.delta.insert}'`\n      );\n    }\n\n    const doc = this.doc;\n    if (doc) {\n      this._disposables.add(\n        doc.collection.slots.docUpdated.on(() => this._updateRefMeta(doc))\n      );\n    }\n\n    this.updateComplete\n      .then(() => {\n        if (!this.inlineEditor || !doc) return;\n\n        // observe yText update\n        this.disposables.add(\n          this.inlineEditor.slots.textChange.on(() => this._updateRefMeta(doc))\n        );\n      })\n      .catch(console.error);\n  }\n\n  // reference to block/element\n  referenceToNode() {\n    return referenceToNode(this.referenceInfo);\n  }\n\n  override render() {\n    const refMeta = this.refMeta;\n    const isDeleted = !refMeta;\n\n    const attributes = this.delta.attributes;\n    const reference = attributes?.reference;\n    const type = reference?.type;\n    if (!attributes || !type) {\n      return nothing;\n    }\n\n    const title = this._title;\n    const icon = choose(type, [\n      ['LinkedPage', () => this._icon],\n      [\n        'Subpage',\n        () =>\n          LinkedPageIcon({\n            width: '1.25em',\n            height: '1.25em',\n            style:\n              'user-select:none;flex-shrink:0;vertical-align:middle;font-size:inherit;margin-bottom:0.1em;',\n          }),\n      ],\n    ]);\n\n    const style = affineTextStyles(\n      attributes,\n      isDeleted\n        ? {\n            color: 'var(--affine-text-disable-color)',\n            textDecoration: 'line-through',\n            fill: 'var(--affine-text-disable-color)',\n          }\n        : {}\n    );\n\n    const content = this.customContent\n      ? this.customContent(this)\n      : html`${icon}<span\n            data-title=${ifDefined(title)}\n            class=\"affine-reference-title\"\n            >${title}</span\n          >`;\n\n    // we need to add `<v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text>` in an\n    // embed element to make sure inline range calculation is correct\n    return html`<span\n      ${this.config.interactable ? ref(this._whenHover.setReference) : ''}\n      data-selected=${this.selected}\n      class=\"affine-reference\"\n      style=${styleMap(style)}\n      @click=${this._onClick}\n      >${content}<v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text\n    ></span>`;\n  }\n\n  override willUpdate(_changedProperties: Map<PropertyKey, unknown>) {\n    super.willUpdate(_changedProperties);\n\n    const doc = this.doc;\n    if (doc) {\n      this._updateRefMeta(doc);\n    }\n  }\n\n  @property({ attribute: false })\n  accessor config!: ReferenceNodeConfigProvider;\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n    attributes: {},\n  };\n\n  @property({ type: Boolean })\n  accessor selected = false;\n}\n"]}