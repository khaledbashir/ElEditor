{"version":3,"file":"latex-editor-menu.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/latex-node/latex-editor-menu.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Y } from '@blocksuite/store';\n\nimport { ColorScheme } from '@blocksuite/affine-model';\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport { unsafeCSSVar } from '@blocksuite/affine-shared/theme';\nimport { type BlockStdScope, ShadowlessElement } from '@blocksuite/block-std';\nimport { noop, SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { DoneIcon } from '@blocksuite/icons/lit';\nimport { DocCollection } from '@blocksuite/store';\nimport { effect, type Signal, signal } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { codeToTokensBase, type ThemedToken } from 'shiki';\n\nimport { InlineManagerExtension } from '../../../../extension/index.js';\nimport { LatexEditorUnitSpecExtension } from '../../affine-inline-specs.js';\n\nexport const LatexEditorInlineManagerExtension = InlineManagerExtension({\n  id: 'latex-inline-editor',\n  enableMarkdown: false,\n  specs: [LatexEditorUnitSpecExtension.identifier],\n});\n\nexport class LatexEditorMenu extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    .latex-editor-container {\n      display: grid;\n      grid-template-columns: 1fr auto;\n      grid-template-rows: auto auto;\n      grid-template-areas:\n        'editor-box confirm-box'\n        'hint-box hint-box';\n\n      padding: 8px;\n      border-radius: 8px;\n      border: 0.5px solid ${unsafeCSSVar('borderColor')};\n      background: ${unsafeCSSVar('backgroundOverlayPanelColor')};\n\n      /* light/toolbarShadow */\n      box-shadow: 0px 6px 16px 0px rgba(0, 0, 0, 0.14);\n    }\n\n    .latex-editor {\n      grid-area: editor-box;\n      width: 280px;\n      padding: 4px 10px;\n\n      border-radius: 4px;\n      background: ${unsafeCSSVar('white10')};\n\n      /* light/activeShadow */\n      box-shadow: 0px 0px 0px 2px rgba(30, 150, 235, 0.3);\n\n      font-family: ${unsafeCSSVar('fontCodeFamily')};\n      border: 1px solid transparent;\n    }\n    .latex-editor:focus-within {\n      border: 1px solid ${unsafeCSSVar('blue700')};\n    }\n\n    .latex-editor-confirm {\n      grid-area: confirm-box;\n      display: flex;\n      align-items: flex-end;\n      padding-left: 10px;\n    }\n\n    .latex-editor-hint {\n      grid-area: hint-box;\n      padding-top: 6px;\n\n      color: ${unsafeCSSVar('placeholderColor')};\n\n      /* MobileTypeface/caption */\n      font-family: 'SF Pro Text';\n      font-size: 12px;\n      font-style: normal;\n      font-weight: 400;\n      line-height: 16px; /* 133.333% */\n      letter-spacing: -0.24px;\n    }\n  `;\n\n  highlightTokens$: Signal<ThemedToken[][]> = signal([]);\n\n  yText!: Y.Text;\n\n  get inlineManager() {\n    return this.std.get(LatexEditorInlineManagerExtension.identifier);\n  }\n\n  get richText() {\n    return this.querySelector('rich-text');\n  }\n\n  private _updateHighlightTokens(text: string) {\n    const editorTheme = this.std.get(ThemeProvider).theme;\n    const theme = editorTheme === ColorScheme.Dark ? 'dark-plus' : 'light-plus';\n\n    codeToTokensBase(text, {\n      lang: 'latex',\n      theme,\n    })\n      .then(token => {\n        this.highlightTokens$.value = token;\n      })\n      .catch(console.error);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const doc = new DocCollection.Y.Doc();\n    this.yText = doc.getText('latex');\n    this.yText.insert(0, this.latexSignal.value);\n\n    const yTextObserver = () => {\n      const text = this.yText.toString();\n      this.latexSignal.value = text;\n\n      this._updateHighlightTokens(text);\n    };\n    this.yText.observe(yTextObserver);\n    this.disposables.add(() => {\n      this.yText.unobserve(yTextObserver);\n    });\n\n    this.disposables.add(\n      effect(() => {\n        noop(this.highlightTokens$.value);\n        this.richText?.inlineEditor?.render();\n      })\n    );\n\n    this.disposables.add(\n      this.std.get(ThemeProvider).theme$.subscribe(() => {\n        this._updateHighlightTokens(this.yText.toString());\n      })\n    );\n\n    this.disposables.addFromEvent(this, 'keydown', e => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        e.stopPropagation();\n        this.abortController.abort();\n      }\n    });\n\n    this.disposables.addFromEvent(this, 'pointerdown', e => {\n      e.stopPropagation();\n    });\n    this.disposables.addFromEvent(this, 'pointerup', e => {\n      e.stopPropagation();\n    });\n\n    this.updateComplete\n      .then(async () => {\n        await this.richText?.updateComplete;\n\n        setTimeout(() => {\n          this.richText?.inlineEditor?.focusEnd();\n        });\n      })\n      .catch(console.error);\n  }\n\n  override render() {\n    return html`<div class=\"latex-editor-container\">\n      <div class=\"latex-editor\">\n        <rich-text\n          .yText=${this.yText}\n          .attributesSchema=${this.inlineManager.getSchema()}\n          .attributeRenderer=${this.inlineManager.getRenderer()}\n        ></rich-text>\n      </div>\n      <div class=\"latex-editor-confirm\">\n        <span @click=${() => this.abortController.abort()}\n          >${DoneIcon({\n            width: '24',\n            height: '24',\n          })}</span\n        >\n      </div>\n      <div class=\"latex-editor-hint\">Shift Enter to line break</div>\n    </div>`;\n  }\n\n  @property({ attribute: false })\n  accessor abortController!: AbortController;\n\n  @property({ attribute: false })\n  accessor latexSignal!: Signal<string>;\n\n  @property({ attribute: false })\n  accessor std!: BlockStdScope;\n}\n"]}