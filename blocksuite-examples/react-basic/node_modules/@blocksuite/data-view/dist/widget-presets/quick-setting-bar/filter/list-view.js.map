{"version":3,"file":"list-view.js","sourceRoot":"","sources":["../../../../src/widget-presets/quick-setting-bar/filter/list-view.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type PopupTarget,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher } from '@blocksuite/global/utils';\nimport {\n  ArrowDownSmallIcon,\n  FilterIcon,\n  PlusIcon,\n} from '@blocksuite/icons/lit';\nimport { computed, type ReadonlySignal } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nimport type { Variable } from '../../../core/expression/types.js';\nimport type { Filter, FilterGroup } from '../../../core/filter/types.js';\n\nimport { popCreateFilter } from '../../../core/index.js';\nimport { popFilterGroup } from './group-panel-view.js';\n\nexport class FilterBar extends SignalWatcher(ShadowlessElement) {\n  static override styles = css`\n    filter-bar {\n      display: flex;\n      gap: 8px;\n      overflow-x: scroll;\n      margin-bottom: -10px;\n      padding-bottom: 2px;\n      align-items: center;\n    }\n\n    .filter-group-tag {\n      font-size: 12px;\n      font-style: normal;\n      font-weight: 600;\n      line-height: 20px;\n      display: flex;\n      align-items: center;\n      padding: 4px;\n      background-color: var(--affine-white);\n    }\n\n    .filter-bar-add-filter {\n      white-space: nowrap;\n      color: var(--affine-text-secondary-color);\n      padding: 4px 8px;\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      font-size: 14px;\n      font-style: normal;\n      font-weight: 400;\n      line-height: 22px;\n    }\n\n    filter-bar::-webkit-scrollbar {\n      -webkit-appearance: none;\n      display: block;\n    }\n\n    filter-bar::-webkit-scrollbar-thumb {\n      border-radius: 2px;\n      background-color: transparent;\n    }\n\n    filter-bar::-webkit-scrollbar:horizontal {\n      height: 8px;\n    }\n\n    filter-bar:hover::-webkit-scrollbar-thumb {\n      border-radius: 16px;\n      background-color: var(--affine-black-30);\n    }\n\n    filter-bar:hover::-webkit-scrollbar-track {\n      //background-color: var(--affine-hover-color);\n    }\n  `;\n\n  private _setFilter = (index: number, filter: Filter) => {\n    this.onChange({\n      ...this.filterGroup.value,\n      conditions: this.filterGroup.value.conditions.map((v, i) =>\n        index === i ? filter : v\n      ),\n    });\n  };\n\n  private addFilter = (e: MouseEvent) => {\n    const element = popupTargetFromElement(e.target as HTMLElement);\n    popCreateFilter(element, {\n      vars: this.vars,\n      onSelect: filter => {\n        const index = this.filterGroup.value.conditions.length;\n        this.onChange({\n          ...this.filterGroup.value,\n          conditions: [...this.filterGroup.value.conditions, filter],\n        });\n        requestAnimationFrame(() => {\n          this.expandGroup(element, index);\n        });\n      },\n    });\n  };\n\n  private expandGroup = (position: PopupTarget, i: number) => {\n    if (this.filterGroup.value.conditions[i]?.type !== 'group') {\n      return;\n    }\n    popFilterGroup(position, {\n      vars: this.vars,\n      value$: computed(() => {\n        return this.filterGroup.value.conditions[i] as FilterGroup;\n      }),\n      onChange: filter => {\n        if (filter) {\n          this._setFilter(i, filter);\n        } else {\n          this.deleteFilter(i);\n        }\n      },\n    });\n  };\n\n  @property({ attribute: false })\n  accessor filterGroup!: ReadonlySignal<FilterGroup>;\n\n  conditions$ = computed(() => {\n    return this.filterGroup.value.conditions;\n  });\n\n  renderAddFilter = () => {\n    return html` <div\n      style=\"height: 100%;\"\n      class=\"filter-bar-add-filter dv-icon-16 dv-round-4 dv-hover\"\n      @click=\"${this.addFilter}\"\n    >\n      ${PlusIcon()} Add filter\n    </div>`;\n  };\n\n  setConditions = (conditions: Filter[]) => {\n    this.onChange({\n      ...this.filterGroup.value,\n      conditions: conditions,\n    });\n  };\n\n  updateMoreFilterPanel?: () => void;\n\n  private deleteFilter(i: number) {\n    this.onChange({\n      ...this.filterGroup.value,\n      conditions: this.filterGroup.value.conditions.filter(\n        (_, index) => index !== i\n      ),\n    });\n  }\n\n  override render() {\n    return html` ${this.renderFilters()} ${this.renderAddFilter()} `;\n  }\n\n  renderCondition(i: number) {\n    const condition = this.conditions$.value[i];\n    if (!condition) {\n      return;\n    }\n    if (condition.type === 'filter') {\n      return html` <filter-condition-view\n        .vars=\"${this.vars}\"\n        .index=\"${i}\"\n        .value=\"${this.conditions$}\"\n        .onChange=\"${this.setConditions}\"\n      ></filter-condition-view>`;\n    }\n    const expandGroup = (e: MouseEvent) => {\n      this.expandGroup(\n        popupTargetFromElement(e.currentTarget as HTMLElement),\n        i\n      );\n    };\n    const length = condition.conditions.length;\n    const text = length > 1 ? `${length} rules` : `${length} rule`;\n    return html` <data-view-component-button\n      hoverType=\"border\"\n      .icon=\"${FilterIcon()}\"\n      @click=\"${expandGroup}\"\n      .text=\"${html`${text}`}\"\n      .postfix=\"${ArrowDownSmallIcon()}\"\n    ></data-view-component-button>`;\n  }\n\n  renderFilters() {\n    return this.filterGroup.value.conditions.map((_, i) =>\n      this.renderCondition(i)\n    );\n  }\n\n  override updated() {\n    this.updateMoreFilterPanel?.();\n  }\n\n  @property({ attribute: false })\n  accessor onChange!: (filter: FilterGroup) => void;\n\n  @property({ attribute: false })\n  accessor vars!: ReadonlySignal<Variable[]>;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'filter-bar': FilterBar;\n  }\n}\n"]}