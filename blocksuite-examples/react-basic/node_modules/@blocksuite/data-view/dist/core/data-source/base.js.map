{"version":3,"file":"base.js","sourceRoot":"","sources":["../../../src/core/data-source/base.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,QAAQ,EAAuB,MAAM,sBAAsB,CAAC;AAkFrE,MAAM,OAAgB,cAAc;IAApC;QACE,YAAO,GAAG,IAAI,GAAG,EAAmB,CAAC;IA6IvC,CAAC;IA3GC,aAAa,CACX,KAAa,EACb,UAAkB;QAElB,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC,CAAC;IAC9D,CAAC;IAED,UAAU,CAAI,GAA0B;QACtC,OAAQ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,CAAO,IAAI,GAAG,CAAC,YAAY,CAAC;IAC9D,CAAC;IAED,UAAU,CAAI,GAA0B,EAAE,KAAQ;QAChD,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;IACnC,CAAC;IASD,gBAAgB,CACd,UAAkB;QAElB,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,CAAC,CAAC;IAC1D,CAAC;IASD,oBAAoB,CAClB,UAAkB;QAElB,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,mBAAmB,CAAC,UAAU,CAAC,CAAC,CAAC;IAC9D,CAAC;IAUD,gBAAgB,CAAC,UAAkB;QACjC,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,CAAC,CAAC;IAC1D,CAAC;IAID,mBAAmB,CAAC,WAAmB;QACrC,OAAO,KAAK,CAAC;IACf,CAAC;IAED,oBAAoB,CAAC,UAAkB;QACrC,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,mBAAmB,CAAC,UAAU,CAAC,CAAC,CAAC;IAC9D,CAAC;IAID,gBAAgB,CAAC,UAAkB;QACjC,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,CAAC,CAAC;IAC1D,CAAC;IAkBD,YAAY,CAAC,MAAc;QACzB,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;IAClD,CAAC;IAWD,YAAY,CAAC,IAAY;QACvB,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC;IAChD,CAAC;IAID,gBAAgB,CAAC,MAAc;QAC7B,OAAO,QAAQ,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC,CAAC;IACtD,CAAC;CACF","sourcesContent":["import type { InsertToPosition } from '@blocksuite/affine-shared/utils';\n\nimport { computed, type ReadonlySignal } from '@preact/signals-core';\n\nimport type { TypeInstance } from '../logical/type.js';\nimport type { PropertyMetaConfig } from '../property/property-config.js';\nimport type { DatabaseFlags } from '../types.js';\nimport type { ViewConvertConfig } from '../view/convert.js';\nimport type { DataViewDataType, ViewMeta } from '../view/data-view.js';\nimport type { ViewManager } from '../view-manager/view-manager.js';\nimport type { DataViewContextKey } from './context.js';\n\nexport interface DataSource {\n  readonly$: ReadonlySignal<boolean>;\n  properties$: ReadonlySignal<string[]>;\n  featureFlags$: ReadonlySignal<DatabaseFlags>;\n\n  cellValueGet(rowId: string, propertyId: string): unknown;\n  cellValueGet$(\n    rowId: string,\n    propertyId: string\n  ): ReadonlySignal<unknown | undefined>;\n  cellValueChange(rowId: string, propertyId: string, value: unknown): void;\n\n  rows$: ReadonlySignal<string[]>;\n  rowAdd(InsertToPosition: InsertToPosition | number): string;\n  rowDelete(ids: string[]): void;\n  rowMove(rowId: string, position: InsertToPosition): void;\n\n  propertyMetas: PropertyMetaConfig[];\n\n  propertyNameGet$(propertyId: string): ReadonlySignal<string | undefined>;\n  propertyNameGet(propertyId: string): string;\n  propertyNameSet(propertyId: string, name: string): void;\n\n  propertyTypeGet(propertyId: string): string | undefined;\n  propertyTypeGet$(propertyId: string): ReadonlySignal<string | undefined>;\n  propertyTypeSet(propertyId: string, type: string): void;\n\n  propertyDataGet(propertyId: string): Record<string, unknown>;\n  propertyDataGet$(\n    propertyId: string\n  ): ReadonlySignal<Record<string, unknown> | undefined>;\n  propertyDataSet(propertyId: string, data: Record<string, unknown>): void;\n\n  propertyDataTypeGet(propertyId: string): TypeInstance | undefined;\n  propertyDataTypeGet$(\n    propertyId: string\n  ): ReadonlySignal<TypeInstance | undefined>;\n\n  propertyReadonlyGet(propertyId: string): boolean;\n  propertyReadonlyGet$(propertyId: string): ReadonlySignal<boolean>;\n\n  propertyMetaGet(type: string): PropertyMetaConfig;\n  propertyAdd(insertToPosition: InsertToPosition, type?: string): string;\n  propertyDuplicate(propertyId: string): string;\n  propertyDelete(id: string): void;\n\n  contextGet<T>(key: DataViewContextKey<T>): T;\n\n  viewConverts: ViewConvertConfig[];\n  viewManager: ViewManager;\n  viewMetas: ViewMeta[];\n  viewDataList$: ReadonlySignal<DataViewDataType[]>;\n\n  viewDataGet(viewId: string): DataViewDataType | undefined;\n  viewDataGet$(viewId: string): ReadonlySignal<DataViewDataType | undefined>;\n\n  viewDataAdd(viewData: DataViewDataType): string;\n  viewDataDuplicate(id: string): string;\n  viewDataDelete(viewId: string): void;\n  viewDataMoveTo(id: string, position: InsertToPosition): void;\n  viewDataUpdate<ViewData extends DataViewDataType>(\n    id: string,\n    updater: (data: ViewData) => Partial<ViewData>\n  ): void;\n\n  viewMetaGet(type: string): ViewMeta;\n  viewMetaGet$(type: string): ReadonlySignal<ViewMeta | undefined>;\n\n  viewMetaGetById(viewId: string): ViewMeta;\n  viewMetaGetById$(viewId: string): ReadonlySignal<ViewMeta | undefined>;\n}\n\nexport abstract class DataSourceBase implements DataSource {\n  context = new Map<symbol, unknown>();\n\n  abstract featureFlags$: ReadonlySignal<DatabaseFlags>;\n\n  abstract properties$: ReadonlySignal<string[]>;\n\n  abstract propertyMetas: PropertyMetaConfig[];\n\n  abstract readonly$: ReadonlySignal<boolean>;\n\n  abstract rows$: ReadonlySignal<string[]>;\n\n  abstract viewConverts: ViewConvertConfig[];\n\n  abstract viewDataList$: ReadonlySignal<DataViewDataType[]>;\n\n  abstract viewManager: ViewManager;\n\n  abstract viewMetas: ViewMeta[];\n\n  abstract cellValueChange(\n    rowId: string,\n    propertyId: string,\n    value: unknown\n  ): void;\n\n  abstract cellValueChange(\n    rowId: string,\n    propertyId: string,\n    value: unknown\n  ): void;\n\n  abstract cellValueGet(rowId: string, propertyId: string): unknown;\n\n  cellValueGet$(\n    rowId: string,\n    propertyId: string\n  ): ReadonlySignal<unknown | undefined> {\n    return computed(() => this.cellValueGet(rowId, propertyId));\n  }\n\n  contextGet<T>(key: DataViewContextKey<T>): T {\n    return (this.context.get(key.key) as T) ?? key.defaultValue;\n  }\n\n  contextSet<T>(key: DataViewContextKey<T>, value: T): void {\n    this.context.set(key.key, value);\n  }\n\n  abstract propertyAdd(\n    insertToPosition: InsertToPosition,\n    type?: string\n  ): string;\n\n  abstract propertyDataGet(propertyId: string): Record<string, unknown>;\n\n  propertyDataGet$(\n    propertyId: string\n  ): ReadonlySignal<Record<string, unknown> | undefined> {\n    return computed(() => this.propertyDataGet(propertyId));\n  }\n\n  abstract propertyDataSet(\n    propertyId: string,\n    data: Record<string, unknown>\n  ): void;\n\n  abstract propertyDataTypeGet(propertyId: string): TypeInstance | undefined;\n\n  propertyDataTypeGet$(\n    propertyId: string\n  ): ReadonlySignal<TypeInstance | undefined> {\n    return computed(() => this.propertyDataTypeGet(propertyId));\n  }\n\n  abstract propertyDelete(id: string): void;\n\n  abstract propertyDuplicate(propertyId: string): string;\n\n  abstract propertyMetaGet(type: string): PropertyMetaConfig;\n\n  abstract propertyNameGet(propertyId: string): string;\n\n  propertyNameGet$(propertyId: string): ReadonlySignal<string | undefined> {\n    return computed(() => this.propertyNameGet(propertyId));\n  }\n\n  abstract propertyNameSet(propertyId: string, name: string): void;\n\n  propertyReadonlyGet(_propertyId: string): boolean {\n    return false;\n  }\n\n  propertyReadonlyGet$(propertyId: string): ReadonlySignal<boolean> {\n    return computed(() => this.propertyReadonlyGet(propertyId));\n  }\n\n  abstract propertyTypeGet(propertyId: string): string;\n\n  propertyTypeGet$(propertyId: string): ReadonlySignal<string | undefined> {\n    return computed(() => this.propertyTypeGet(propertyId));\n  }\n\n  abstract propertyTypeSet(propertyId: string, type: string): void;\n\n  abstract rowAdd(InsertToPosition: InsertToPosition | number): string;\n\n  abstract rowDelete(ids: string[]): void;\n\n  abstract rowMove(rowId: string, position: InsertToPosition): void;\n\n  abstract viewDataAdd(viewData: DataViewDataType): string;\n\n  abstract viewDataDelete(viewId: string): void;\n\n  abstract viewDataDuplicate(id: string): string;\n\n  abstract viewDataGet(viewId: string): DataViewDataType;\n\n  viewDataGet$(viewId: string): ReadonlySignal<DataViewDataType | undefined> {\n    return computed(() => this.viewDataGet(viewId));\n  }\n\n  abstract viewDataMoveTo(id: string, position: InsertToPosition): void;\n\n  abstract viewDataUpdate<ViewData extends DataViewDataType>(\n    id: string,\n    updater: (data: ViewData) => Partial<ViewData>\n  ): void;\n\n  abstract viewMetaGet(type: string): ViewMeta;\n\n  viewMetaGet$(type: string): ReadonlySignal<ViewMeta | undefined> {\n    return computed(() => this.viewMetaGet(type));\n  }\n\n  abstract viewMetaGetById(viewId: string): ViewMeta;\n\n  viewMetaGetById$(viewId: string): ReadonlySignal<ViewMeta | undefined> {\n    return computed(() => this.viewMetaGetById(viewId));\n  }\n}\n"]}