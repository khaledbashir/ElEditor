import { filterMatcher } from './filter-fn/matcher.js';
const evalRef = (ref, row) => {
    return row[ref.name];
};
const evalValue = (value) => {
    return value?.value;
};
export const evalFilter = (filterGroup, row) => {
    const evalF = (filter) => {
        if (filter.type === 'filter') {
            const value = evalRef(filter.left, row);
            const func = filterMatcher.getFilterByName(filter.function);
            if (!func) {
                return true;
            }
            const expectArgLen = func.args.length;
            const args = [];
            for (let i = 0; i < expectArgLen; i++) {
                const argValue = evalValue(filter.args[i]);
                const argType = func.args[i];
                if (argValue == null) {
                    return true;
                }
                if (!argType.valueValidate(argValue)) {
                    return true;
                }
                args.push(argValue);
            }
            const impl = func.impl;
            try {
                return impl(value ?? undefined, ...args);
            }
            catch (e) {
                console.error(e);
                return true;
            }
        }
        else if (filter.type === 'group') {
            if (filter.op === 'and') {
                return filter.conditions.every(f => evalF(f));
            }
            else if (filter.op === 'or') {
                return filter.conditions.some(f => evalF(f));
            }
        }
        return true;
    };
    return evalF(filterGroup);
};
//# sourceMappingURL=eval.js.map