{"version":3,"file":"single-view.js","sourceRoot":"","sources":["../../../src/core/view-manager/single-view.ts"],"names":[],"mappings":"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","sourcesContent":["import type { InsertToPosition } from '@blocksuite/affine-shared/utils';\n\nimport { computed, type ReadonlySignal, signal } from '@preact/signals-core';\n\nimport type { DataViewContextKey } from '../data-source/context.js';\nimport type { Variable } from '../expression/types.js';\nimport type { DVJSON } from '../index.js';\nimport type { TypeInstance } from '../logical/type.js';\nimport type { PropertyMetaConfig } from '../property/property-config.js';\nimport type { TraitKey } from '../traits/key.js';\nimport type { DatabaseFlags } from '../types.js';\nimport type { UniComponent } from '../utils/uni-component/index.js';\nimport type { DataViewDataType, ViewMeta } from '../view/data-view.js';\nimport type { Property } from './property.js';\nimport type { ViewManager } from './view-manager.js';\n\nimport { type Cell, CellBase } from './cell.js';\nimport { type Row, RowBase } from './row.js';\n\nexport type MainProperties = {\n  titleColumn?: string;\n  iconColumn?: string;\n  imageColumn?: string;\n};\n\nexport interface SingleView {\n  readonly id: string;\n  readonly type: string;\n  readonly manager: ViewManager;\n  readonly meta: ViewMeta;\n  readonly readonly$: ReadonlySignal<boolean>;\n\n  delete(): void;\n\n  duplicate(): void;\n\n  readonly name$: ReadonlySignal<string>;\n\n  nameSet(name: string): void;\n\n  readonly propertyIds$: ReadonlySignal<string[]>;\n  readonly propertiesWithoutFilter$: ReadonlySignal<string[]>;\n  readonly properties$: ReadonlySignal<Property[]>;\n  readonly detailProperties$: ReadonlySignal<string[]>;\n  readonly rows$: ReadonlySignal<string[]>;\n\n  readonly vars$: ReadonlySignal<Variable[]>;\n\n  readonly featureFlags$: ReadonlySignal<DatabaseFlags>;\n\n  cellValueGet(rowId: string, propertyId: string): unknown;\n\n  cellValueSet(rowId: string, propertyId: string, value: unknown): void;\n\n  cellJsonValueGet(rowId: string, propertyId: string): unknown;\n\n  cellJsonValueSet(rowId: string, propertyId: string, value: DVJSON): void;\n\n  cellStringValueGet(rowId: string, propertyId: string): string | undefined;\n\n  cellGet(rowId: string, propertyId: string): Cell;\n\n  propertyParseValueFromString(\n    propertyId: string,\n    value: string\n  ):\n    | {\n        value: unknown;\n        data?: Record<string, unknown>;\n      }\n    | undefined;\n\n  rowAdd(insertPosition: InsertToPosition): string;\n\n  rowDelete(ids: string[]): void;\n\n  rowMove(rowId: string, position: InsertToPosition): void;\n\n  rowGet(rowId: string): Row;\n\n  rowPrevGet(rowId: string): string;\n\n  rowNextGet(rowId: string): string;\n\n  readonly propertyMetas: PropertyMetaConfig[];\n\n  propertyAdd(toAfterOfProperty: InsertToPosition, type?: string): string;\n\n  propertyDelete(propertyId: string): void;\n\n  propertyDuplicate(propertyId: string): void;\n\n  propertyGet(propertyId: string): Property;\n\n  propertyMetaGet(type: string): PropertyMetaConfig | undefined;\n\n  propertyPreGet(propertyId: string): Property | undefined;\n\n  propertyNextGet(propertyId: string): Property | undefined;\n\n  propertyNameGet(propertyId: string): string;\n\n  propertyNameSet(propertyId: string, name: string): void;\n\n  propertyTypeGet(propertyId: string): string | undefined;\n\n  propertyTypeSet(propertyId: string, type: string): void;\n\n  propertyHideGet(propertyId: string): boolean;\n\n  propertyHideSet(propertyId: string, hide: boolean): void;\n\n  propertyDataGet(propertyId: string): Record<string, unknown>;\n\n  propertyDataSet(propertyId: string, data: Record<string, unknown>): void;\n\n  propertyDataTypeGet(propertyId: string): TypeInstance | undefined;\n\n  propertyIndexGet(propertyId: string): number;\n\n  propertyIdGetByIndex(index: number): string;\n\n  propertyReadonlyGet(propertyId: string): boolean;\n\n  propertyMove(propertyId: string, position: InsertToPosition): void;\n\n  propertyIconGet(type: string): UniComponent | undefined;\n\n  contextGet<T>(key: DataViewContextKey<T>): T;\n\n  traitGet<T>(key: TraitKey<T>): T | undefined;\n\n  mainProperties$: ReadonlySignal<MainProperties>;\n\n  lockRows(lock: boolean): void;\n\n  isLocked$: ReadonlySignal<boolean>;\n}\n\nexport abstract class SingleViewBase<\n  ViewData extends DataViewDataType = DataViewDataType,\n> implements SingleView\n{\n  private searchString = signal('');\n\n  private traitMap = new Map<symbol, unknown>();\n\n  data$ = computed(() => {\n    return this.dataSource.viewDataGet(this.id) as ViewData | undefined;\n  });\n\n  abstract detailProperties$: ReadonlySignal<string[]>;\n\n  protected lockRows$ = signal(false);\n\n  isLocked$ = computed(() => {\n    return this.lockRows$.value;\n  });\n\n  abstract mainProperties$: ReadonlySignal<MainProperties>;\n\n  name$: ReadonlySignal<string> = computed(() => {\n    return this.data$.value?.name ?? '';\n  });\n\n  preRows: string[] = [];\n\n  abstract propertyIds$: ReadonlySignal<string[]>;\n\n  properties$ = computed(() => {\n    return this.propertyIds$.value.map(\n      id => this.propertyGet(id) as ReturnType<this['propertyGet']>\n    );\n  });\n\n  abstract propertiesWithoutFilter$: ReadonlySignal<string[]>;\n\n  abstract readonly$: ReadonlySignal<boolean>;\n\n  rows$ = computed(() => {\n    if (this.lockRows$.value) {\n      return this.preRows;\n    }\n    return (this.preRows = this.rowsMapping(this.dataSource.rows$.value));\n  });\n\n  vars$ = computed(() => {\n    return this.propertiesWithoutFilter$.value.map(id => {\n      const v = this.propertyGet(id);\n      const propertyMeta = this.dataSource.propertyMetaGet(v.type$.value);\n      return {\n        id: v.id,\n        name: v.name$.value,\n        type: propertyMeta.config.type({\n          data: v.data$.value,\n          dataSource: this.dataSource,\n        }),\n        icon: v.icon,\n        propertyType: v.type$.value,\n      };\n    });\n  });\n\n  protected get dataSource() {\n    return this.manager.dataSource;\n  }\n\n  get featureFlags$() {\n    return this.dataSource.featureFlags$;\n  }\n\n  get isLocked() {\n    return this.lockRows$.value;\n  }\n\n  get meta() {\n    return this.dataSource.viewMetaGet(this.type);\n  }\n\n  get propertyMetas(): PropertyMetaConfig[] {\n    return this.dataSource.propertyMetas;\n  }\n\n  abstract get type(): string;\n\n  constructor(\n    public manager: ViewManager,\n    public id: string\n  ) {}\n\n  private searchRowsMapping(rows: string[], searchString: string): string[] {\n    return rows.filter(id => {\n      if (searchString) {\n        const containsSearchString = this.propertyIds$.value.some(\n          propertyId => {\n            return this.cellStringValueGet(id, propertyId)\n              ?.toLowerCase()\n              .includes(searchString?.toLowerCase());\n          }\n        );\n        if (!containsSearchString) {\n          return false;\n        }\n      }\n      return this.isShow(id);\n    });\n  }\n\n  cellGet(rowId: string, propertyId: string): Cell {\n    return new CellBase(this, propertyId, rowId);\n  }\n\n  cellJsonValueGet(rowId: string, propertyId: string): unknown {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    return this.dataSource.propertyMetaGet(type).config.cellToJson({\n      value: this.dataSource.cellValueGet(rowId, propertyId),\n      data: this.propertyDataGet(propertyId),\n      dataSource: this.dataSource,\n    });\n  }\n\n  cellJsonValueSet(rowId: string, propertyId: string, value: DVJSON): void {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    const fromJson = this.dataSource.propertyMetaGet(type).config.cellFromJson;\n    this.dataSource.cellValueChange(\n      rowId,\n      propertyId,\n      fromJson({\n        value,\n        data: this.propertyDataGet(propertyId),\n        dataSource: this.dataSource,\n      })\n    );\n  }\n\n  cellStringValueGet(rowId: string, propertyId: string): string | undefined {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    return (\n      this.dataSource.propertyMetaGet(type).config.cellToString({\n        value: this.dataSource.cellValueGet(rowId, propertyId),\n        data: this.propertyDataGet(propertyId),\n        dataSource: this.dataSource,\n      }) ?? ''\n    );\n  }\n\n  cellValueGet(rowId: string, propertyId: string): unknown {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    const cellValue = this.dataSource.cellValueGet(rowId, propertyId);\n    return (\n      this.dataSource.propertyMetaGet(type).config.formatValue?.({\n        value: cellValue,\n        data: this.propertyDataGet(propertyId),\n        dataSource: this.dataSource,\n      }) ?? cellValue\n    );\n  }\n\n  cellValueSet(rowId: string, propertyId: string, value: unknown): void {\n    this.dataSource.cellValueChange(rowId, propertyId, value);\n  }\n\n  contextGet<T>(key: DataViewContextKey<T>): T {\n    return this.dataSource.contextGet(key);\n  }\n\n  dataUpdate(updater: (viewData: ViewData) => Partial<ViewData>): void {\n    this.dataSource.viewDataUpdate(this.id, updater);\n  }\n\n  delete(): void {\n    this.manager.viewDelete(this.id);\n  }\n\n  duplicate(): void {\n    this.manager.viewDuplicate(this.id);\n  }\n\n  abstract isShow(rowId: string): boolean;\n\n  lockRows(lock: boolean) {\n    this.lockRows$.value = lock;\n  }\n\n  nameSet(name: string): void {\n    this.dataUpdate(() => {\n      return {\n        name,\n      } as ViewData;\n    });\n  }\n\n  propertyAdd(position: InsertToPosition, type?: string): string {\n    const id = this.dataSource.propertyAdd(position, type);\n    this.propertyMove(id, position);\n    return id;\n  }\n\n  propertyDataGet(propertyId: string): Record<string, unknown> {\n    return this.dataSource.propertyDataGet(propertyId);\n  }\n\n  propertyDataSet(propertyId: string, data: Record<string, unknown>): void {\n    this.dataSource.propertyDataSet(propertyId, data);\n  }\n\n  propertyDataTypeGet(propertyId: string): TypeInstance | undefined {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    return this.dataSource.propertyMetaGet(type).config.type({\n      data: this.propertyDataGet(propertyId),\n      dataSource: this.dataSource,\n    });\n  }\n\n  propertyDelete(propertyId: string): void {\n    this.dataSource.propertyDelete(propertyId);\n  }\n\n  propertyDuplicate(propertyId: string): void {\n    const id = this.dataSource.propertyDuplicate(propertyId);\n    this.propertyMove(id, {\n      before: false,\n      id: propertyId,\n    });\n  }\n\n  abstract propertyGet(propertyId: string): Property;\n\n  abstract propertyHideGet(propertyId: string): boolean;\n\n  abstract propertyHideSet(propertyId: string, hide: boolean): void;\n\n  propertyIconGet(type: string): UniComponent | undefined {\n    return this.dataSource.propertyMetaGet(type).renderer.icon;\n  }\n\n  propertyIdGetByIndex(index: number): string {\n    return this.propertyIds$.value[index];\n  }\n\n  propertyIndexGet(propertyId: string): number {\n    return this.propertyIds$.value.indexOf(propertyId);\n  }\n\n  propertyMetaGet(type: string): PropertyMetaConfig {\n    return this.dataSource.propertyMetaGet(type);\n  }\n\n  abstract propertyMove(propertyId: string, position: InsertToPosition): void;\n\n  propertyNameGet(propertyId: string): string {\n    return this.dataSource.propertyNameGet(propertyId);\n  }\n\n  propertyNameSet(propertyId: string, name: string): void {\n    this.dataSource.propertyNameSet(propertyId, name);\n  }\n\n  propertyNextGet(propertyId: string): Property | undefined {\n    return this.propertyGet(\n      this.propertyIdGetByIndex(this.propertyIndexGet(propertyId) + 1)\n    );\n  }\n\n  propertyParseValueFromString(propertyId: string, cellData: string) {\n    const type = this.propertyTypeGet(propertyId);\n    if (!type) {\n      return;\n    }\n    return (\n      this.dataSource.propertyMetaGet(type).config.cellFromString({\n        value: cellData,\n        data: this.propertyDataGet(propertyId),\n        dataSource: this.dataSource,\n      }) ?? ''\n    );\n  }\n\n  propertyPreGet(propertyId: string): Property | undefined {\n    return this.propertyGet(\n      this.propertyIdGetByIndex(this.propertyIndexGet(propertyId) - 1)\n    );\n  }\n\n  propertyReadonlyGet(propertyId: string): boolean {\n    return this.dataSource.propertyReadonlyGet(propertyId);\n  }\n\n  propertyTypeGet(propertyId: string): string | undefined {\n    return this.dataSource.propertyTypeGet(propertyId);\n  }\n\n  propertyTypeSet(propertyId: string, type: string): void {\n    this.dataSource.propertyTypeSet(propertyId, type);\n  }\n\n  rowAdd(insertPosition: InsertToPosition | number): string {\n    return this.dataSource.rowAdd(insertPosition);\n  }\n\n  rowDelete(ids: string[]): void {\n    this.dataSource.rowDelete(ids);\n  }\n\n  rowGet(rowId: string): Row {\n    return new RowBase(this, rowId);\n  }\n\n  rowMove(rowId: string, position: InsertToPosition): void {\n    this.dataSource.rowMove(rowId, position);\n  }\n\n  abstract rowNextGet(rowId: string): string;\n\n  abstract rowPrevGet(rowId: string): string;\n\n  protected rowsMapping(rows: string[]): string[] {\n    return this.searchRowsMapping(rows, this.searchString.value);\n  }\n\n  setSearch(str: string): void {\n    this.searchString.value = str;\n  }\n\n  traitGet<T>(key: TraitKey<T>): T | undefined {\n    return this.traitMap.get(key.key) as T | undefined;\n  }\n\n  protected traitSet<T>(key: TraitKey<T>, value: T): T {\n    this.traitMap.set(key.key, value);\n    return value;\n  }\n}\n"]}