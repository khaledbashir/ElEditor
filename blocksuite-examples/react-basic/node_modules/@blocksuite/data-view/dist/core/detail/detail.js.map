{"version":3,"file":"detail.js","sourceRoot":"","sources":["../../../src/core/detail/detail.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  menu,\n  popMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport {\n  ArrowDownBigIcon,\n  ArrowUpBigIcon,\n  PlusIcon,\n} from '@blocksuite/icons/lit';\nimport { computed } from '@preact/signals-core';\nimport { css, nothing, unsafeCSS } from 'lit';\nimport { property, query } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { keyed } from 'lit/directives/keyed.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { SingleView } from '../view-manager/single-view.js';\n\nimport { dataViewCommonStyle } from '../common/css-variable.js';\nimport {\n  renderUniLit,\n  type UniComponent,\n} from '../utils/uni-component/uni-component.js';\nimport { DetailSelection } from './selection.js';\n\nexport type DetailSlotProps = {\n  view: SingleView;\n  rowId: string;\n  openDoc: (docId: string) => void;\n};\n\nexport interface DetailSlots {\n  header?: UniComponent<DetailSlotProps>;\n  note?: UniComponent<DetailSlotProps>;\n}\n\nconst styles = css`\n  ${unsafeCSS(dataViewCommonStyle('affine-data-view-record-detail'))}\n  affine-data-view-record-detail {\n    position: relative;\n    display: flex;\n    flex: 1;\n    flex-direction: column;\n    padding: 20px;\n    gap: 12px;\n    background-color: var(--affine-background-primary-color);\n    border-radius: 8px;\n    height: 100%;\n    width: 100%;\n    box-sizing: border-box;\n  }\n\n  .add-property {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    font-size: var(--data-view-cell-text-size);\n    font-style: normal;\n    font-weight: 400;\n    line-height: var(--data-view-cell-text-line-height);\n    color: var(--affine-text-disable-color);\n    border-radius: 4px;\n    padding: 6px 8px 6px 4px;\n    cursor: pointer;\n    margin-top: 8px;\n    width: max-content;\n  }\n\n  .add-property:hover {\n    background-color: var(--affine-hover-color);\n  }\n\n  .add-property .icon {\n    display: flex;\n    align-items: center;\n  }\n\n  .add-property .icon svg {\n    fill: var(--affine-icon-color);\n    width: 20px;\n    height: 20px;\n  }\n\n  .switch-row {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 2px;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 22px;\n    color: var(--affine-icon-color);\n  }\n\n  .switch-row:hover {\n    background-color: var(--affine-hover-color);\n  }\n\n  .switch-row.disable {\n    cursor: default;\n    background: none;\n    opacity: 0.5;\n  }\n`;\n\nexport class RecordDetail extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = styles;\n\n  _clickAddProperty = () => {\n    popMenu(popupTargetFromElement(this.addPropertyButton), {\n      options: {\n        title: {\n          text: 'Add property',\n        },\n        items: [\n          menu.group({\n            items: this.view.propertyMetas.map(meta => {\n              return menu.action({\n                name: meta.config.name,\n                prefix: renderUniLit(this.view.propertyIconGet(meta.type)),\n                select: () => {\n                  this.view.propertyAdd('end', meta.type);\n                },\n              });\n            }),\n          }),\n        ],\n      },\n    });\n  };\n\n  @property({ attribute: false })\n  accessor view!: SingleView;\n\n  properties$ = computed(() => {\n    return this.view.detailProperties$.value.map(id =>\n      this.view.propertyGet(id)\n    );\n  });\n\n  selection = new DetailSelection(this);\n\n  private get readonly() {\n    return this.view.readonly$.value;\n  }\n\n  private renderHeader() {\n    const header = this.detailSlots?.header;\n    if (header) {\n      const props: DetailSlotProps = {\n        view: this.view,\n        rowId: this.rowId,\n        openDoc: this.openDoc,\n      };\n      return renderUniLit(header, props);\n    }\n    return undefined;\n  }\n\n  private renderNote() {\n    const note = this.detailSlots?.note;\n    if (note) {\n      const props: DetailSlotProps = {\n        view: this.view,\n        rowId: this.rowId,\n        openDoc: this.openDoc,\n      };\n      return renderUniLit(note, props);\n    }\n    return undefined;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.disposables.addFromEvent(this, 'click', e => {\n      e.stopPropagation();\n      this.selection.selection = undefined;\n    });\n    //FIXME: simulate as a widget\n    this.dataset.widgetId = 'affine-detail-widget';\n  }\n\n  hasNext() {\n    return this.view.rowNextGet(this.rowId) != null;\n  }\n\n  hasPrev() {\n    return this.view.rowPrevGet(this.rowId) != null;\n  }\n\n  nextRow() {\n    const rowId = this.view.rowNextGet(this.rowId);\n    if (rowId == null) {\n      return;\n    }\n    this.rowId = rowId;\n    this.requestUpdate();\n  }\n\n  prevRow() {\n    const rowId = this.view.rowPrevGet(this.rowId);\n    if (rowId == null) {\n      return;\n    }\n    this.rowId = rowId;\n    this.requestUpdate();\n  }\n\n  override render() {\n    const properties = this.properties$.value;\n    const upClass = classMap({\n      'switch-row': true,\n      disable: !this.hasPrev(),\n    });\n    const downClass = classMap({\n      'switch-row': true,\n      disable: !this.hasNext(),\n    });\n    return html`\n      <div\n        style=\"position: absolute;left: 20px;top:20px;display: flex;align-items:center;gap:4px;\"\n      >\n        <div @click=\"${this.prevRow}\" class=\"${upClass}\">\n          ${ArrowUpBigIcon()}\n        </div>\n        <div @click=\"${this.nextRow}\" class=\"${downClass}\">\n          ${ArrowDownBigIcon()}\n        </div>\n      </div>\n      <div\n        style=\"width: 100%;max-width: var(--affine-editor-width);display: flex;flex-direction: column;margin: 0 auto;box-sizing: border-box;\"\n      >\n        ${keyed(this.rowId, this.renderHeader())}\n        ${repeat(\n          properties,\n          v => v.id,\n          property => {\n            return keyed(\n              this.rowId,\n              html` <affine-data-view-record-field\n                .view=\"${this.view}\"\n                .column=\"${property}\"\n                .rowId=\"${this.rowId}\"\n                data-column-id=\"${property.id}\"\n              ></affine-data-view-record-field>`\n            );\n          }\n        )}\n        ${!this.readonly\n          ? html` <div class=\"add-property\" @click=\"${this._clickAddProperty}\">\n              <div class=\"icon\">${PlusIcon()}</div>\n              Add Property\n            </div>`\n          : nothing}\n      </div>\n      ${keyed(this.rowId, this.renderNote())}\n    `;\n  }\n\n  @query('.add-property')\n  accessor addPropertyButton!: HTMLElement;\n\n  @property({ attribute: false })\n  accessor detailSlots: DetailSlots | undefined;\n\n  @property({ attribute: false })\n  accessor openDoc!: (docId: string) => void;\n\n  @property({ attribute: false })\n  accessor rowId!: string;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-record-detail': RecordDetail;\n  }\n}\nexport const createRecordDetail = (ops: {\n  view: SingleView;\n  rowId: string;\n  detail: DetailSlots;\n  openDoc: (docId: string) => void;\n}) => {\n  return html` <affine-data-view-record-detail\n    .view=${ops.view}\n    .rowId=${ops.rowId}\n    .detailSlots=${ops.detail}\n    .openDoc=${ops.openDoc}\n    class=\"data-view-popup-container\"\n  ></affine-data-view-record-detail>`;\n};\n"]}