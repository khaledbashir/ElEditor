{"version":3,"file":"setting.js","sourceRoot":"","sources":["../../../src/core/group-by/setting.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  menu,\n  type MenuConfig,\n  type MenuOptions,\n  popMenu,\n  type PopupTarget,\n} from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { DeleteIcon } from '@blocksuite/icons/lit';\nimport { computed } from '@preact/signals-core';\nimport { css, html, unsafeCSS } from 'lit';\nimport { property, query } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { GroupTrait } from './trait.js';\nimport type { GroupRenderProps } from './types.js';\n\nimport { KanbanSingleView } from '../../view-presets/kanban/kanban-view-manager.js';\nimport { TableSingleView } from '../../view-presets/table/table-view-manager.js';\nimport { dataViewCssVariable } from '../common/css-variable.js';\nimport { renderUniLit } from '../utils/uni-component/uni-component.js';\nimport { dragHandler } from '../utils/wc-dnd/dnd-context.js';\nimport { defaultActivators } from '../utils/wc-dnd/sensors/index.js';\nimport {\n  createSortContext,\n  sortable,\n} from '../utils/wc-dnd/sort/sort-context.js';\nimport { verticalListSortingStrategy } from '../utils/wc-dnd/sort/strategies/index.js';\nimport { groupByMatcher } from './matcher.js';\n\nexport class GroupSetting extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    data-view-group-setting {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      ${unsafeCSS(dataViewCssVariable())};\n    }\n\n    .group-item {\n      display: flex;\n      padding: 4px 12px;\n      position: relative;\n      cursor: grab;\n    }\n\n    .group-item-drag-bar {\n      width: 4px;\n      height: 12px;\n      border-radius: 1px;\n      background-color: #efeff0;\n      position: absolute;\n      left: 4px;\n      top: 0;\n      bottom: 0;\n      margin: auto;\n    }\n\n    .group-item:hover .group-item-drag-bar {\n      background-color: #c0bfc1;\n    }\n  `;\n\n  @property({ attribute: false })\n  accessor groupTrait!: GroupTrait;\n\n  groups$ = computed(() => {\n    return this.groupTrait.groupsDataList$.value;\n  });\n\n  sortContext = createSortContext({\n    activators: defaultActivators,\n    container: this,\n    onDragEnd: evt => {\n      const over = evt.over;\n      const activeId = evt.active.id;\n      const groups = this.groups$.value;\n      if (over && over.id !== activeId && groups) {\n        const activeIndex = groups.findIndex(data => data.key === activeId);\n        const overIndex = groups.findIndex(data => data.key === over.id);\n\n        this.groupTrait.moveGroupTo(\n          activeId,\n          activeIndex > overIndex\n            ? {\n                before: true,\n                id: over.id,\n              }\n            : {\n                before: false,\n                id: over.id,\n              }\n        );\n      }\n    },\n    modifiers: [\n      ({ transform }) => {\n        return {\n          ...transform,\n          x: 0,\n        };\n      },\n    ],\n    items: computed(() => {\n      return this.groupTrait.groupsDataList$.value?.map(v => v.key) ?? [];\n    }),\n    strategy: verticalListSortingStrategy,\n  });\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._disposables.addFromEvent(this, 'pointerdown', e => {\n      e.stopPropagation();\n    });\n  }\n\n  protected override render(): unknown {\n    const groups = this.groupTrait.groupsDataList$.value;\n    if (!groups) {\n      return;\n    }\n    return html`\n      <div style=\"padding: 7px 0;\">\n        <div\n          style=\"padding: 0 4px; font-size: 12px;color: var(--affine-text-secondary-color);line-height: 20px;\"\n        >\n          Groups\n        </div>\n        <div></div>\n      </div>\n      <div\n        style=\"display:flex;flex-direction: column;gap: 4px;\"\n        class=\"group-sort-setting\"\n      >\n        ${repeat(\n          groups,\n          group => group.key,\n          group => {\n            const props: GroupRenderProps = {\n              value: group.value,\n              data: group.property.data$.value,\n              readonly: true,\n            };\n            const config = group.manager.config$.value;\n            return html` <div\n              ${sortable(group.key)}\n              ${dragHandler(group.key)}\n              class=\"dv-hover dv-round-4 group-item\"\n            >\n              <div class=\"group-item-drag-bar\"></div>\n              <div style=\"padding: 0 4px;position:relative;\">\n                ${renderUniLit(config?.view, props)}\n                <div\n                  style=\"position:absolute;left: 0;top: 0;right: 0;bottom: 0;\"\n                ></div>\n              </div>\n            </div>`;\n          }\n        )}\n      </div>\n    `;\n  }\n\n  @query('.group-sort-setting')\n  accessor groupContainer!: HTMLElement;\n}\n\nexport const selectGroupByProperty = (\n  group: GroupTrait,\n  ops?: {\n    onSelect?: (id?: string) => void;\n    onClose?: () => void;\n    onBack?: () => void;\n  }\n): MenuOptions => {\n  const view = group.view;\n  return {\n    onClose: ops?.onClose,\n    title: {\n      text: 'Group by',\n      onBack: ops?.onBack,\n    },\n    items: [\n      menu.group({\n        items: view.propertiesWithoutFilter$.value\n          .filter(id => {\n            if (view.propertyGet(id).type$.value === 'title') {\n              return false;\n            }\n            return !!groupByMatcher.match(view.propertyGet(id).dataType$.value);\n          })\n          .map<MenuConfig>(id => {\n            const property = view.propertyGet(id);\n            return menu.action({\n              name: property.name$.value,\n              isSelected: group.property$.value?.id === id,\n              prefix: html` <uni-lit .uni=\"${property.icon}\"></uni-lit>`,\n              select: () => {\n                group.changeGroup(id);\n                ops?.onSelect?.(id);\n              },\n            });\n          }),\n      }),\n      menu.group({\n        items: [\n          menu.action({\n            prefix: DeleteIcon(),\n            hide: () =>\n              view instanceof KanbanSingleView || group.property$.value == null,\n            class: { 'delete-item': true },\n            name: 'Remove Grouping',\n            select: () => {\n              group.changeGroup(undefined);\n              ops?.onSelect?.();\n            },\n          }),\n        ],\n      }),\n    ],\n  };\n};\nexport const popSelectGroupByProperty = (\n  target: PopupTarget,\n  group: GroupTrait,\n  ops?: {\n    onSelect?: () => void;\n    onClose?: () => void;\n    onBack?: () => void;\n  }\n) => {\n  popMenu(target, {\n    options: selectGroupByProperty(group, ops),\n  });\n};\nexport const popGroupSetting = (\n  target: PopupTarget,\n  group: GroupTrait,\n  onBack: () => void\n) => {\n  const view = group.view;\n  const groupProperty = group.property$.value;\n  if (groupProperty == null) {\n    return;\n  }\n  const type = groupProperty.type$.value;\n  if (!type) {\n    return;\n  }\n  const icon = view.propertyIconGet(type);\n  const menuHandler = popMenu(target, {\n    options: {\n      title: {\n        text: 'Group',\n        onBack: onBack,\n      },\n      items: [\n        menu.group({\n          items: [\n            menu.subMenu({\n              name: 'Group By',\n              postfix: html`\n                <div\n                  style=\"display:flex;align-items:center;gap: 4px;font-size: 12px;line-height: 20px;color: var(--affine-text-secondary-color);margin-right: 4px;margin-left: 8px;\"\n                  class=\"dv-icon-16\"\n                >\n                  ${renderUniLit(icon, {})} ${groupProperty.name$.value}\n                </div>\n              `,\n              label: () => html`\n                <div style=\"color: var(--affine-text-secondary-color);\">\n                  Group By\n                </div>\n              `,\n              options: selectGroupByProperty(group, {\n                onSelect: () => {\n                  menuHandler.close();\n                  popGroupSetting(target, group, onBack);\n                },\n              }),\n            }),\n          ],\n        }),\n        menu.group({\n          items: [\n            menu =>\n              html` <data-view-group-setting\n                @mouseenter=\"${() => menu.closeSubMenu()}\"\n                .groupTrait=\"${group}\"\n                .columnId=\"${groupProperty.id}\"\n              ></data-view-group-setting>`,\n          ],\n        }),\n        menu.group({\n          items: [\n            menu.action({\n              name: 'Remove grouping',\n              prefix: DeleteIcon(),\n              class: { 'delete-item': true },\n              hide: () => !(view instanceof TableSingleView),\n              select: () => {\n                group.changeGroup(undefined);\n              },\n            }),\n          ],\n        }),\n      ],\n    },\n  });\n};\n"]}