{"version":3,"file":"cell-renderer.js","sourceRoot":"","sources":["../../../src/property-presets/date/cell-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  popMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { DatePicker } from '@blocksuite/affine-components/date-picker';\nimport { createLitPortal } from '@blocksuite/affine-components/portal';\nimport { unsafeCSSVarV2 } from '@blocksuite/affine-shared/theme';\nimport { IS_MOBILE } from '@blocksuite/global/env';\nimport { flip, offset } from '@floating-ui/dom';\nimport { signal } from '@preact/signals-core';\nimport { baseTheme } from '@toeverything/theme';\nimport { format } from 'date-fns/format';\nimport { css, html, unsafeCSS } from 'lit';\n\nimport { BaseCellRenderer } from '../../core/property/index.js';\nimport { createFromBaseCellRenderer } from '../../core/property/renderer.js';\nimport { createIcon } from '../../core/utils/uni-icon.js';\nimport { datePropertyModelConfig } from './define.js';\n\nexport class DateCell extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell {\n      width: 100%;\n    }\n\n    .affine-database-date {\n      display: flex;\n      align-items: center;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      height: var(--data-view-cell-text-line-height);\n    }\n\n    input.affine-database-date[type='date']::-webkit-calendar-picker-indicator {\n      display: none;\n    }\n  `;\n\n  override render() {\n    const value = this.value ? format(this.value, 'yyyy/MM/dd') : '';\n    if (!value) {\n      return '';\n    }\n    return html` <div class=\"affine-database-date date\">${value}</div>`;\n  }\n}\n\nexport class DateCellEditing extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell-editing {\n      width: 100%;\n      cursor: text;\n    }\n\n    .affine-database-date:focus {\n      outline: none;\n    }\n  `;\n\n  private _prevPortalAbortController: AbortController | null = null;\n\n  private openDatePicker = () => {\n    if (\n      this._prevPortalAbortController &&\n      !this._prevPortalAbortController.signal.aborted\n    )\n      return;\n\n    this.tempValue$.value = this.value ? new Date(this.value) : undefined;\n\n    this._prevPortalAbortController?.abort();\n    const abortController = new AbortController();\n    abortController.signal.addEventListener(\n      'abort',\n      () => {\n        this.selectCurrentCell(false);\n      },\n      { once: true }\n    );\n    this._prevPortalAbortController = abortController;\n    if (IS_MOBILE) {\n      popMenu(popupTargetFromElement(this), {\n        options: {\n          title: {\n            text: this.property.name$.value,\n          },\n          onClose: () => {\n            abortController.abort();\n          },\n          items: [\n            () =>\n              html`<div\n                style=\"\npadding: 12px;\nbackground-color: ${unsafeCSSVarV2('layer/background/primary')};\nborder-radius: 12px;\ncolor: ${unsafeCSSVarV2('text/secondary')};\nfont-size: 17px;\nline-height: 22px;\nheight: 46px;\n\"\n              >\n                ${this.dateString}\n              </div>`,\n            () => {\n              const datePicker = new DatePicker();\n              datePicker.padding = 0;\n              datePicker.value = this.tempValue$.value?.getTime() ?? Date.now();\n              datePicker.onChange = (date: Date) => {\n                this.tempValue$.value = date;\n              };\n              datePicker.onClear = () => {\n                this.tempValue$.value = undefined;\n              };\n              datePicker.onEscape = () => {\n                abortController.abort();\n              };\n              requestAnimationFrame(() => datePicker.focusDateCell());\n              return html`<div\n                style=\"padding: 12px;background-color: ${unsafeCSSVarV2(\n                  'layer/background/primary'\n                )};border-radius: 12px\"\n              >\n                ${datePicker}\n              </div>`;\n            },\n          ],\n        },\n      });\n    } else {\n      const root = createLitPortal({\n        abortController,\n        closeOnClickAway: true,\n        computePosition: {\n          referenceElement: this,\n          placement: 'bottom',\n          middleware: [offset(10), flip()],\n        },\n        template: () => {\n          const datePicker = new DatePicker();\n          datePicker.value = this.tempValue$.value?.getTime() ?? Date.now();\n          datePicker.popup = true;\n          datePicker.onClear = () => {\n            this.tempValue$.value = undefined;\n          };\n          datePicker.onChange = (date: Date) => {\n            this.tempValue$.value = date;\n          };\n          datePicker.onEscape = () => {\n            abortController.abort();\n          };\n          requestAnimationFrame(() => datePicker.focusDateCell());\n          return datePicker;\n        },\n      });\n      // TODO: use z-index from variable,\n      //       for now the slide-layout-modal's z-index is `1001`\n      //       the z-index of popover should be higher than it\n      // root.style.zIndex = 'var(--affine-z-index-popover)';\n      root.style.zIndex = '1002';\n    }\n  };\n\n  private updateValue = () => {\n    const tempValue = this.tempValue$.value;\n    const currentValue = this.value;\n\n    if (\n      (!tempValue && !currentValue) ||\n      (tempValue && currentValue && tempValue.getTime() === currentValue)\n    ) {\n      return;\n    }\n\n    this.onChange(tempValue?.getTime());\n    this.tempValue$.value = undefined;\n  };\n\n  tempValue$ = signal<Date>();\n\n  get dateString() {\n    const value = this.tempValue;\n    return value ? format(value, 'yyyy/MM/dd') : '';\n  }\n\n  get tempValue() {\n    return this.tempValue$.value;\n  }\n\n  override firstUpdated() {\n    this.openDatePicker();\n  }\n\n  override onExitEditMode() {\n    this.updateValue();\n    this._prevPortalAbortController?.abort();\n  }\n\n  override render() {\n    return html` <div\n      class=\"affine-database-date date\"\n      @click=\"${this.openDatePicker}\"\n    >\n      ${this.dateString}\n    </div>`;\n  }\n}\n\nexport const datePropertyConfig = datePropertyModelConfig.createPropertyMeta({\n  icon: createIcon('DateTimeIcon'),\n  cellRenderer: {\n    view: createFromBaseCellRenderer(DateCell),\n    edit: createFromBaseCellRenderer(DateCellEditing),\n  },\n});\n"]}