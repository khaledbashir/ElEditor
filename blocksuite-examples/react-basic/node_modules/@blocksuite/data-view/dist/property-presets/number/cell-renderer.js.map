{"version":3,"file":"cell-renderer.js","sourceRoot":"","sources":["../../../src/property-presets/number/cell-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import { IS_MAC } from '@blocksuite/global/env';\nimport { baseTheme } from '@toeverything/theme';\nimport { css, html, unsafeCSS } from 'lit';\nimport { query } from 'lit/decorators.js';\n\nimport type { NumberPropertyDataType } from './types.js';\n\nimport { BaseCellRenderer } from '../../core/property/index.js';\nimport { createFromBaseCellRenderer } from '../../core/property/renderer.js';\nimport { stopPropagation } from '../../core/utils/event.js';\nimport { createIcon } from '../../core/utils/uni-icon.js';\nimport { numberPropertyModelConfig } from './define.js';\nimport {\n  formatNumber,\n  type NumberFormat,\n  parseNumber,\n} from './utils/formatter.js';\n\nexport class NumberCell extends BaseCellRenderer<\n  number,\n  NumberPropertyDataType\n> {\n  static override styles = css`\n    affine-database-number-cell {\n      display: block;\n      width: 100%;\n    }\n\n    .affine-database-number {\n      overflow: hidden;\n      display: flex;\n      align-items: center;\n      justify-content: flex-end;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      word-break: break-all;\n    }\n  `;\n\n  private _getFormattedString() {\n    const enableNewFormatting =\n      this.view.featureFlags$.value.enable_number_formatting;\n    const decimals = this.property.data$.value.decimal ?? 0;\n    const formatMode = (this.property.data$.value.format ??\n      'number') as NumberFormat;\n    return this.value != undefined\n      ? enableNewFormatting\n        ? formatNumber(this.value, formatMode, decimals)\n        : this.value.toString()\n      : '';\n  }\n\n  override render() {\n    return html` <div class=\"affine-database-number number\">\n      ${this._getFormattedString()}\n    </div>`;\n  }\n}\n\nexport class NumberCellEditing extends BaseCellRenderer<\n  number,\n  NumberPropertyDataType\n> {\n  static override styles = css`\n    affine-database-number-cell-editing {\n      display: block;\n      width: 100%;\n      cursor: text;\n    }\n\n    .affine-database-number {\n      display: flex;\n      align-items: center;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      text-align: right;\n    }\n\n    .affine-database-number:focus {\n      outline: none;\n    }\n  `;\n\n  private _getFormattedString = (value: number) => {\n    const enableNewFormatting =\n      this.view.featureFlags$.value.enable_number_formatting;\n    const decimals = this.property.data$.value.decimal ?? 0;\n    const formatMode = (this.property.data$.value.format ??\n      'number') as NumberFormat;\n    return enableNewFormatting\n      ? formatNumber(value, formatMode, decimals)\n      : value.toString();\n  };\n\n  private _keydown = (e: KeyboardEvent) => {\n    const ctrlKey = IS_MAC ? e.metaKey : e.ctrlKey;\n\n    if (e.key.toLowerCase() === 'z' && ctrlKey) {\n      e.stopPropagation();\n      return;\n    }\n\n    if (e.key === 'Enter' && !e.isComposing) {\n      requestAnimationFrame(() => {\n        this.selectCurrentCell(false);\n      });\n    }\n  };\n\n  private _setValue = (str: string = this._inputEle.value) => {\n    if (!str) {\n      this.onChange(undefined);\n      return;\n    }\n\n    const enableNewFormatting =\n      this.view.featureFlags$.value.enable_number_formatting;\n    const value = enableNewFormatting ? parseNumber(str) : parseFloat(str);\n    if (isNaN(value)) {\n      this._inputEle.value = this.value\n        ? this._getFormattedString(this.value)\n        : '';\n      return;\n    }\n\n    this._inputEle.value = this._getFormattedString(value);\n    this.onChange(value);\n  };\n\n  focusEnd = () => {\n    const end = this._inputEle.value.length;\n    this._inputEle.focus();\n    this._inputEle.setSelectionRange(end, end);\n  };\n\n  _blur() {\n    this.selectCurrentCell(false);\n  }\n\n  _focus() {\n    if (!this.isEditing) {\n      this.selectCurrentCell(true);\n    }\n  }\n\n  override firstUpdated() {\n    requestAnimationFrame(() => {\n      this.focusEnd();\n    });\n  }\n\n  override onExitEditMode() {\n    this._setValue();\n  }\n\n  override render() {\n    const formatted = this.value ? this._getFormattedString(this.value) : '';\n\n    return html`<input\n      type=\"text\"\n      autocomplete=\"off\"\n      .value=\"${formatted}\"\n      @keydown=\"${this._keydown}\"\n      @blur=\"${this._blur}\"\n      @focus=\"${this._focus}\"\n      class=\"affine-database-number number\"\n      @pointerdown=\"${stopPropagation}\"\n    />`;\n  }\n\n  @query('input')\n  private accessor _inputEle!: HTMLInputElement;\n}\n\nexport const numberPropertyConfig =\n  numberPropertyModelConfig.createPropertyMeta({\n    icon: createIcon('NumberIcon'),\n    cellRenderer: {\n      view: createFromBaseCellRenderer(NumberCell),\n      edit: createFromBaseCellRenderer(NumberCellEditing),\n    },\n  });\n"]}