{"version":3,"file":"group.js","sourceRoot":"","sources":["../../../../src/view-presets/table/mobile/group.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  menu,\n  popFilterableSimpleMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { PlusIcon } from '@blocksuite/icons/lit';\nimport { css, html } from 'lit';\nimport { property, query } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { DataViewRenderer } from '../../../core/data-view.js';\nimport type { GroupData } from '../../../core/group-by/trait.js';\nimport type { DataViewTable } from '../pc/table-view.js';\nimport type { TableSingleView } from '../table-view-manager.js';\n\nimport { GroupTitle } from '../../../core/group-by/group-title.js';\nimport { LEFT_TOOL_BAR_WIDTH } from '../consts.js';\nimport { TableAreaSelection } from '../types.js';\n\nconst styles = css`\n  .data-view-table-group-add-row {\n    display: flex;\n    width: 100%;\n    height: 28px;\n    position: relative;\n    z-index: 0;\n    cursor: pointer;\n    transition: opacity 0.2s ease-in-out;\n    padding: 4px 8px;\n    border-bottom: 1px solid var(--affine-border-color);\n  }\n\n  .data-view-table-group-add-row-button {\n    position: sticky;\n    left: ${8 + LEFT_TOOL_BAR_WIDTH}px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 10px;\n    user-select: none;\n    font-size: 12px;\n    line-height: 20px;\n    color: var(--affine-text-secondary-color);\n  }\n`;\n\nexport class MobileTableGroup extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = styles;\n\n  private clickAddRow = () => {\n    this.view.rowAdd('end', this.group?.key);\n    requestAnimationFrame(() => {\n      const selectionController = this.viewEle.selectionController;\n      const index = this.view.properties$.value.findIndex(\n        v => v.type$.value === 'title'\n      );\n      selectionController.selection = TableAreaSelection.create({\n        groupKey: this.group?.key,\n        focus: {\n          rowIndex: this.rows.length - 1,\n          columnIndex: index,\n        },\n        isEditing: true,\n      });\n    });\n  };\n\n  private clickAddRowInStart = () => {\n    this.view.rowAdd('start', this.group?.key);\n    requestAnimationFrame(() => {\n      const selectionController = this.viewEle.selectionController;\n      const index = this.view.properties$.value.findIndex(\n        v => v.type$.value === 'title'\n      );\n      selectionController.selection = TableAreaSelection.create({\n        groupKey: this.group?.key,\n        focus: {\n          rowIndex: 0,\n          columnIndex: index,\n        },\n        isEditing: true,\n      });\n    });\n  };\n\n  private clickGroupOptions = (e: MouseEvent) => {\n    const group = this.group;\n    if (!group) {\n      return;\n    }\n    const ele = e.currentTarget as HTMLElement;\n    popFilterableSimpleMenu(popupTargetFromElement(ele), [\n      menu.action({\n        name: 'Ungroup',\n        hide: () => group.value == null,\n        select: () => {\n          group.rows.forEach(id => {\n            group.manager.removeFromGroup(id, group.key);\n          });\n        },\n      }),\n      menu.action({\n        name: 'Delete Cards',\n        select: () => {\n          this.view.rowDelete(group.rows);\n        },\n      }),\n    ]);\n  };\n\n  private renderGroupHeader = () => {\n    if (!this.group) {\n      return null;\n    }\n    return html`\n      <div\n        style=\"position: sticky;left: 0;width: max-content;padding: 6px 0;margin-bottom: 4px;display:flex;align-items:center;gap: 12px;max-width: 400px\"\n      >\n        ${GroupTitle(this.group, {\n          readonly: this.view.readonly$.value,\n          clickAdd: this.clickAddRowInStart,\n          clickOps: this.clickGroupOptions,\n        })}\n      </div>\n    `;\n  };\n\n  get rows() {\n    return this.group?.rows ?? this.view.rows$.value;\n  }\n\n  private renderRows(ids: string[]) {\n    return html`\n      <mobile-table-header\n        .renderGroupHeader=\"${this.renderGroupHeader}\"\n        .tableViewManager=\"${this.view}\"\n      ></mobile-table-header>\n      <div class=\"mobile-affine-table-body\">\n        ${repeat(\n          ids,\n          id => id,\n          (id, idx) => {\n            return html` <mobile-table-row\n              data-row-index=\"${idx}\"\n              data-row-id=\"${id}\"\n              .dataViewEle=\"${this.dataViewEle}\"\n              .view=\"${this.view}\"\n              .rowId=\"${id}\"\n              .rowIndex=\"${idx}\"\n            ></mobile-table-row>`;\n          }\n        )}\n      </div>\n      ${this.view.readonly$.value\n        ? null\n        : html` <div\n            class=\"data-view-table-group-add-row dv-hover\"\n            @click=\"${this.clickAddRow}\"\n          >\n            <div\n              class=\"data-view-table-group-add-row-button dv-icon-16\"\n              data-test-id=\"affine-database-add-row-button\"\n              role=\"button\"\n            >\n              ${PlusIcon()}<span style=\"font-size: 12px\">New Record</span>\n            </div>\n          </div>`}\n      <affine-database-column-stats .view=\"${this.view}\" .group=\"${this.group}\">\n      </affine-database-column-stats>\n    `;\n  }\n\n  override render() {\n    return this.renderRows(this.rows);\n  }\n\n  @property({ attribute: false })\n  accessor dataViewEle!: DataViewRenderer;\n\n  @property({ attribute: false })\n  accessor group: GroupData | undefined = undefined;\n\n  @query('.affine-database-block-rows')\n  accessor rowsContainer: HTMLElement | null = null;\n\n  @property({ attribute: false })\n  accessor view!: TableSingleView;\n\n  @property({ attribute: false })\n  accessor viewEle!: DataViewTable;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'mobile-table-group': MobileTableGroup;\n  }\n}\n"]}