{"version":3,"file":"row.js","sourceRoot":"","sources":["../../../../../src/view-presets/table/pc/row/row.ts"],"names":[],"mappings":"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","sourcesContent":["import { popupTargetFromElement } from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { CenterPeekIcon, MoreHorizontalIcon } from '@blocksuite/icons/lit';\nimport { css, nothing } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { DataViewRenderer } from '../../../../core/data-view.js';\nimport type { TableSingleView } from '../../table-view-manager.js';\n\nimport { TableRowSelection, type TableViewSelection } from '../../types.js';\nimport { openDetail, popRowMenu } from '../menu.js';\n\nexport class TableRow extends SignalWatcher(WithDisposable(ShadowlessElement)) {\n  static override styles = css`\n    .affine-database-block-row:has(.row-select-checkbox.selected) {\n      background: var(--affine-primary-color-04);\n    }\n    .affine-database-block-row:has(.row-select-checkbox.selected)\n      .row-selected-bg {\n      position: relative;\n    }\n    .affine-database-block-row:has(.row-select-checkbox.selected)\n      .row-selected-bg:before {\n      content: '';\n      position: absolute;\n      left: 0;\n      right: 0;\n      top: 0;\n      bottom: 0;\n      background: var(--affine-primary-color-04);\n    }\n    .affine-database-block-row {\n      width: 100%;\n      display: flex;\n      flex-direction: row;\n      border-bottom: 1px solid var(--affine-border-color);\n      position: relative;\n    }\n\n    .affine-database-block-row.selected > .database-cell {\n      background: transparent;\n    }\n\n    .row-ops {\n      position: relative;\n      width: 0;\n      margin-top: 4px;\n      height: max-content;\n      visibility: hidden;\n      display: flex;\n      gap: 4px;\n      cursor: pointer;\n      justify-content: end;\n    }\n\n    .row-op:last-child {\n      margin-right: 8px;\n    }\n\n    .affine-database-block-row .show-on-hover-row {\n      visibility: hidden;\n      opacity: 0;\n    }\n    .affine-database-block-row:hover .show-on-hover-row {\n      visibility: visible;\n      opacity: 1;\n    }\n    .affine-database-block-row:has(.active) .show-on-hover-row {\n      visibility: visible;\n      opacity: 1;\n    }\n    .affine-database-block-row:has([data-editing='true']) .show-on-hover-row {\n      visibility: hidden;\n      opacity: 0;\n    }\n\n    .row-op {\n      display: flex;\n      padding: 4px;\n      border-radius: 4px;\n      box-shadow: 0px 0px 4px 0px rgba(66, 65, 73, 0.14);\n      background-color: var(--affine-background-primary-color);\n      position: relative;\n    }\n\n    .row-op:hover:before {\n      content: '';\n      border-radius: 4px;\n      position: absolute;\n      left: 0;\n      right: 0;\n      top: 0;\n      bottom: 0;\n      background-color: var(--affine-hover-color);\n    }\n\n    .row-op svg {\n      fill: var(--affine-icon-color);\n      color: var(--affine-icon-color);\n      width: 16px;\n      height: 16px;\n    }\n    .data-view-table-view-drag-handler {\n      width: 4px;\n      height: 34px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: grab;\n      background-color: var(--affine-background-primary-color);\n    }\n  `;\n\n  private _clickDragHandler = () => {\n    if (this.view.readonly$.value) {\n      return;\n    }\n    this.selectionController?.toggleRow(this.rowId, this.groupKey);\n  };\n\n  contextMenu = (e: MouseEvent) => {\n    if (this.view.readonly$.value) {\n      return;\n    }\n    const selection = this.selectionController;\n    if (!selection) {\n      return;\n    }\n    e.preventDefault();\n    const ele = e.target as HTMLElement;\n    const cell = ele.closest('affine-database-cell-container');\n    const row = { id: this.rowId, groupKey: this.groupKey };\n    if (!TableRowSelection.includes(selection.selection, row)) {\n      selection.selection = TableRowSelection.create({\n        rows: [row],\n      });\n    }\n    const target =\n      cell ??\n      (e.target as HTMLElement).closest('.database-cell') ?? // for last add btn cell\n      (e.target as HTMLElement);\n\n    popRowMenu(this.dataViewEle, popupTargetFromElement(target), selection);\n  };\n\n  setSelection = (selection?: TableViewSelection) => {\n    if (this.selectionController) {\n      this.selectionController.selection = selection;\n    }\n  };\n\n  get groupKey() {\n    return this.closest('affine-data-view-table-group')?.group?.key;\n  }\n\n  get selectionController() {\n    return this.closest('affine-database-table')?.selectionController;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.disposables.addFromEvent(this, 'contextmenu', this.contextMenu);\n\n    this.classList.add('affine-database-block-row', 'database-row');\n  }\n\n  protected override render(): unknown {\n    const view = this.view;\n    return html`\n      ${view.readonly$.value\n        ? nothing\n        : html`<div class=\"data-view-table-left-bar\" style=\"height: 34px\">\n            <div style=\"display: flex;\">\n              <div\n                class=\"data-view-table-view-drag-handler show-on-hover-row row-selected-bg\"\n                @click=${this._clickDragHandler}\n              >\n                <div\n                  style=\"width: 4px;\n                  border-radius: 2px;\n                  height: 12px;\n                  background-color: var(--affine-placeholder-color);\"\n                ></div>\n              </div>\n              <row-select-checkbox\n                .selection=\"${this.dataViewEle.config.selection$}\"\n                .rowId=\"${this.rowId}\"\n                .groupKey=\"${this.groupKey}\"\n              ></row-select-checkbox>\n            </div>\n          </div>`}\n      ${repeat(\n        view.properties$.value,\n        v => v.id,\n        (column, i) => {\n          const clickDetail = () => {\n            if (!this.selectionController) {\n              return;\n            }\n            this.setSelection(\n              TableRowSelection.create({\n                rows: [{ id: this.rowId, groupKey: this.groupKey }],\n              })\n            );\n            openDetail(this.dataViewEle, this.rowId, this.selectionController);\n          };\n          const openMenu = (e: MouseEvent) => {\n            if (!this.selectionController) {\n              return;\n            }\n            const ele = e.currentTarget as HTMLElement;\n            const selection = this.selectionController.selection;\n            if (\n              !TableRowSelection.is(selection) ||\n              !selection.rows.some(\n                row => row.id === this.rowId && row.groupKey === this.groupKey\n              )\n            ) {\n              const row = { id: this.rowId, groupKey: this.groupKey };\n              this.setSelection(\n                TableRowSelection.create({\n                  rows: [row],\n                })\n              );\n            }\n            popRowMenu(\n              this.dataViewEle,\n              popupTargetFromElement(ele),\n              this.selectionController\n            );\n          };\n          return html`\n            <div style=\"display: flex;\">\n              <affine-database-cell-container\n                class=\"database-cell\"\n                style=${styleMap({\n                  width: `${column.width$.value}px`,\n                  border: i === 0 ? 'none' : undefined,\n                })}\n                .view=\"${view}\"\n                .column=\"${column}\"\n                .rowId=\"${this.rowId}\"\n                data-row-id=\"${this.rowId}\"\n                .rowIndex=\"${this.rowIndex}\"\n                data-row-index=\"${this.rowIndex}\"\n                .columnId=\"${column.id}\"\n                data-column-id=\"${column.id}\"\n                .columnIndex=\"${i}\"\n                data-column-index=\"${i}\"\n              >\n              </affine-database-cell-container>\n              <div class=\"cell-divider\"></div>\n            </div>\n            ${!column.readonly$.value &&\n            column.view.mainProperties$.value.titleColumn === column.id\n              ? html`<div class=\"row-ops show-on-hover-row\">\n                  <div class=\"row-op\" @click=\"${clickDetail}\">\n                    ${CenterPeekIcon()}\n                  </div>\n                  ${!view.readonly$.value\n                    ? html`<div class=\"row-op\" @click=\"${openMenu}\">\n                        ${MoreHorizontalIcon()}\n                      </div>`\n                    : nothing}\n                </div>`\n              : nothing}\n          `;\n        }\n      )}\n      <div class=\"database-cell add-column-button\"></div>\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor dataViewEle!: DataViewRenderer;\n\n  @property({ attribute: false })\n  accessor rowId!: string;\n\n  @property({ attribute: false })\n  accessor rowIndex!: number;\n\n  @property({ attribute: false })\n  accessor view!: TableSingleView;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'data-view-table-row': TableRow;\n  }\n}\n"]}