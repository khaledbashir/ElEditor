{"version":3,"file":"table-view.js","sourceRoot":"","sources":["../../../../src/view-presets/table/mobile/table-view.ts"],"names":[],"mappings":"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","sourcesContent":["import type { InsertToPosition } from '@blocksuite/affine-shared/utils';\n\nimport {\n  menu,\n  popMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { AddCursorIcon } from '@blocksuite/icons/lit';\nimport { css } from 'lit';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { GroupTrait } from '../../../core/group-by/trait.js';\nimport type { DataViewInstance } from '../../../core/index.js';\nimport type { TableSingleView } from '../table-view-manager.js';\nimport type { TableViewSelectionWithType } from '../types.js';\n\nimport { renderUniLit } from '../../../core/utils/uni-component/uni-component.js';\nimport { DataViewBase } from '../../../core/view/data-view-base.js';\nimport { LEFT_TOOL_BAR_WIDTH } from '../consts.js';\n\nexport class MobileDataViewTable extends DataViewBase<\n  TableSingleView,\n  TableViewSelectionWithType\n> {\n  static override styles = css`\n    .mobile-affine-database-table-wrapper {\n      position: relative;\n      width: 100%;\n      padding-bottom: 4px;\n      overflow-x: scroll;\n      overflow-y: hidden;\n    }\n\n    .mobile-affine-database-table-container {\n      position: relative;\n      width: fit-content;\n      min-width: 100%;\n    }\n\n    .cell-divider {\n      width: 1px;\n      height: 100%;\n      background-color: var(--affine-border-color);\n    }\n  `;\n\n  private _addRow = (\n    tableViewManager: TableSingleView,\n    position: InsertToPosition | number\n  ) => {\n    if (this.readonly) return;\n    tableViewManager.rowAdd(position);\n  };\n\n  onWheel = (event: WheelEvent) => {\n    if (event.metaKey || event.ctrlKey) {\n      return;\n    }\n    const ele = event.currentTarget;\n    if (ele instanceof HTMLElement) {\n      if (ele.scrollWidth === ele.clientWidth) {\n        return;\n      }\n      event.stopPropagation();\n    }\n  };\n\n  renderAddGroup = (groupHelper: GroupTrait) => {\n    const addGroup = groupHelper.addGroup;\n    if (!addGroup) {\n      return;\n    }\n    const add = (e: MouseEvent) => {\n      const ele = e.currentTarget as HTMLElement;\n      popMenu(popupTargetFromElement(ele), {\n        options: {\n          items: [\n            menu.input({\n              onComplete: text => {\n                const column = groupHelper.property$.value;\n                if (column) {\n                  column.dataUpdate(\n                    () =>\n                      addGroup({\n                        text,\n                        oldData: column.data$.value,\n                        dataSource: this.props.view.manager.dataSource,\n                      }) as never\n                  );\n                }\n              },\n            }),\n          ],\n        },\n      });\n    };\n    return html` <div style=\"display:flex;\">\n      <div\n        class=\"dv-hover dv-round-8\"\n        style=\"display:flex;align-items:center;gap: 10px;padding: 6px 12px 6px 8px;color: var(--affine-text-secondary-color);font-size: 12px;line-height: 20px;position: sticky;left: ${LEFT_TOOL_BAR_WIDTH}px;\"\n        @click=\"${add}\"\n      >\n        <div class=\"dv-icon-16\" style=\"display:flex;\">${AddCursorIcon()}</div>\n        <div>New Group</div>\n      </div>\n    </div>`;\n  };\n\n  get expose(): DataViewInstance {\n    return {\n      clearSelection: () => {},\n      addRow: position => {\n        this._addRow(this.props.view, position);\n      },\n      focusFirstCell: () => {},\n      showIndicator: _evt => {\n        return false;\n      },\n      hideIndicator: () => {\n        // this.dragController.dropPreview.remove();\n      },\n      moveTo: (_id, _evt) => {\n        // const result = this.dragController.getInsertPosition(evt);\n        // if (result) {\n        //   this.props.view.rowMove(\n        //     id,\n        //     result.position,\n        //     undefined,\n        //     result.groupKey,\n        //   );\n        // }\n      },\n      getSelection: () => {\n        throw new BlockSuiteError(\n          ErrorCode.DatabaseBlockError,\n          'Not implemented'\n        );\n      },\n      view: this.props.view,\n      eventTrace: this.props.eventTrace,\n    };\n  }\n\n  private get readonly() {\n    return this.props.view.readonly$.value;\n  }\n\n  private renderTable() {\n    const groups = this.props.view.groupTrait.groupsDataList$.value;\n    if (groups) {\n      return html`\n        <div style=\"display:flex;flex-direction: column;gap: 16px;\">\n          ${repeat(\n            groups,\n            v => v.key,\n            group => {\n              return html` <mobile-table-group\n                data-group-key=\"${group.key}\"\n                .dataViewEle=\"${this.props.dataViewEle}\"\n                .view=\"${this.props.view}\"\n                .viewEle=\"${this}\"\n                .group=\"${group}\"\n              ></mobile-table-group>`;\n            }\n          )}\n          ${this.renderAddGroup(this.props.view.groupTrait)}\n        </div>\n      `;\n    }\n    return html` <mobile-table-group\n      .dataViewEle=\"${this.props.dataViewEle}\"\n      .view=\"${this.props.view}\"\n      .viewEle=\"${this}\"\n    ></mobile-table-group>`;\n  }\n\n  override render() {\n    const vPadding = this.props.virtualPadding$.value;\n    const wrapperStyle = styleMap({\n      marginLeft: `-${vPadding}px`,\n      marginRight: `-${vPadding}px`,\n    });\n    const containerStyle = styleMap({\n      paddingLeft: `${vPadding}px`,\n      paddingRight: `${vPadding}px`,\n    });\n    return html`\n      ${renderUniLit(this.props.headerWidget, {\n        dataViewInstance: this.expose,\n      })}\n      <div class=\"mobile-affine-database-table-wrapper\" style=\"${wrapperStyle}\">\n        <div\n          class=\"mobile-affine-database-table-container\"\n          style=\"${containerStyle}\"\n          @wheel=\"${this.onWheel}\"\n        >\n          ${this.renderTable()}\n        </div>\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'mobile-data-view-table': MobileDataViewTable;\n  }\n}\n"]}