{"version":3,"file":"column-stats-column.js","sourceRoot":"","sources":["../../../../src/view-presets/table/stats/column-stats-column.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  menu,\n  type MenuConfig,\n  popMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { ArrowDownSmallIcon } from '@blocksuite/icons/lit';\nimport { Text } from '@blocksuite/store';\nimport { autoPlacement, offset } from '@floating-ui/dom';\nimport { computed, signal } from '@preact/signals-core';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { GroupData } from '../../../core/group-by/trait.js';\nimport type { StatisticsConfig } from '../../../core/statistics/types.js';\nimport type { TableColumn } from '../table-view-manager.js';\n\nimport { typeSystem } from '../../../core/index.js';\nimport { statsFunctions } from '../../../core/statistics/index.js';\n\nconst styles = css`\n  .stats-cell {\n    cursor: pointer;\n    transition: opacity 230ms ease;\n    font-size: 12px;\n    color: var(--affine-text-secondary-color);\n    display: flex;\n    opacity: 0;\n    justify-content: flex-end;\n    height: 100%;\n    align-items: center;\n    user-select: none;\n  }\n\n  .affine-database-column-stats:hover .stats-cell {\n    opacity: 1;\n  }\n\n  .stats-cell:hover,\n  affine-database-column-stats-cell.active .stats-cell {\n    opacity: 1;\n    background-color: var(--affine-hover-color);\n    cursor: pointer;\n  }\n\n  .stats-cell[calculated='true'] {\n    opacity: 1;\n  }\n\n  .stats-cell .content {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.2rem;\n    margin-inline: 5px;\n  }\n\n  .label {\n    text-transform: uppercase;\n    color: var(--affine-text-secondary-color);\n  }\n\n  .value {\n    color: var(--affine-text-primary-color);\n  }\n`;\n\nexport class DatabaseColumnStatsCell extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = styles;\n\n  @property({ attribute: false })\n  accessor column!: TableColumn;\n\n  cellValues$ = computed(() => {\n    if (this.group) {\n      return this.group.rows.map(id => {\n        return this.column.valueGet(id);\n      });\n    }\n    return this.column.cells$.value.map(cell => cell.value$.value);\n  });\n\n  groups$ = computed(() => {\n    const groups: Record<string, Record<string, StatisticsConfig>> = {};\n\n    statsFunctions.forEach(func => {\n      if (!typeSystem.unify(this.column.dataType$.value, func.dataType)) {\n        return;\n      }\n      if (!groups[func.group]) {\n        groups[func.group] = {};\n      }\n      const oldFunc = groups[func.group][func.type];\n      if (!oldFunc || typeSystem.unify(func.dataType, oldFunc.dataType)) {\n        if (!func.impl) {\n          delete groups[func.group][func.type];\n        } else {\n          groups[func.group][func.type] = func;\n        }\n      }\n    });\n    return groups;\n  });\n\n  openMenu = (ev: MouseEvent) => {\n    const menus: MenuConfig[] = Object.entries(this.groups$.value).map(\n      ([group, funcs]) => {\n        return menu.subMenu({\n          name: group,\n          options: {\n            items: Object.values(funcs).map(func => {\n              return menu.action({\n                isSelected: func.type === this.column.statCalcOp$.value,\n                name: func.menuName ?? func.type,\n                select: () => {\n                  this.column.updateStatCalcOp(func.type);\n                },\n              });\n            }),\n          },\n        });\n      }\n    );\n    popMenu(popupTargetFromElement(ev.currentTarget as HTMLElement), {\n      options: {\n        items: [\n          menu.action({\n            isSelected: !this.column.statCalcOp$.value,\n            name: 'None',\n            select: () => {\n              this.column.updateStatCalcOp();\n            },\n          }),\n          ...menus,\n        ],\n      },\n      middleware: [\n        autoPlacement({ allowedPlacements: ['top', 'bottom'] }),\n        offset(10),\n      ],\n    });\n  };\n\n  statsFunc$ = computed(() => {\n    return Object.values(this.groups$.value)\n      .flatMap(group => Object.values(group))\n      .find(func => func.type === this.column.statCalcOp$.value);\n  });\n\n  values$ = signal<unknown[]>([]);\n\n  statsResult$ = computed(() => {\n    const meta = this.column.view.propertyMetaGet(this.column.type$.value);\n    if (!meta) {\n      return null;\n    }\n    const func = this.statsFunc$.value;\n    if (!func) {\n      return null;\n    }\n    return {\n      name: func.displayName,\n      value:\n        func.impl?.(this.values$.value, {\n          meta,\n          dataSource: this.column.view.manager.dataSource,\n        }) ?? '',\n    };\n  });\n\n  subscriptionMap = new Map<unknown, () => void>();\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this.disposables.addFromEvent(this, 'click', this.openMenu);\n    this.disposables.add(\n      this.cellValues$.subscribe(values => {\n        const map = new Map<unknown, () => void>();\n        values.forEach(value => {\n          if (value instanceof Text) {\n            const unsub = this.subscriptionMap.get(value);\n            if (unsub) {\n              map.set(value, unsub);\n              this.subscriptionMap.delete(value);\n            } else {\n              const f = () => {\n                this.values$.value = [...this.cellValues$.value];\n              };\n              value.yText.observe(f);\n              map.set(value, () => {\n                value.yText.unobserve(f);\n              });\n            }\n          }\n        });\n        this.subscriptionMap.forEach(unsub => {\n          unsub();\n        });\n        this.subscriptionMap = map;\n        this.values$.value = this.cellValues$.value;\n      })\n    );\n    this.disposables.add(() => {\n      this.subscriptionMap.forEach(unsub => {\n        unsub();\n      });\n    });\n  }\n\n  protected override render() {\n    const style = {\n      width: `${this.column.width$.value}px`,\n    };\n    return html` <div\n      calculated=\"${!!this.column.statCalcOp$.value}\"\n      style=\"${styleMap(style)}\"\n      class=\"stats-cell\"\n    >\n      <div class=\"content\">\n        ${!this.statsResult$.value\n          ? html`Calculate ${ArrowDownSmallIcon()}`\n          : html`\n              <span class=\"label\">${this.statsResult$.value.name}</span>\n              <span class=\"value\">${this.statsResult$.value.value} </span>\n            `}\n      </div>\n    </div>`;\n  }\n\n  @property({ attribute: false })\n  accessor group: GroupData | undefined = undefined;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database-column-stats-cell': DatabaseColumnStatsCell;\n  }\n}\n"]}