{"version":3,"file":"cell.js","sourceRoot":"","sources":["../../../../src/view-presets/table/mobile/cell.ts"],"names":[],"mappings":"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","sourcesContent":["import { ShadowlessElement } from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { computed, effect } from '@preact/signals-core';\nimport { css } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { createRef } from 'lit/directives/ref.js';\n\nimport type { TableColumn } from '../table-view-manager.js';\n\nimport {\n  type CellRenderProps,\n  type DataViewCellLifeCycle,\n  renderUniLit,\n  type SingleView,\n} from '../../../core/index.js';\nimport { TableAreaSelection } from '../types.js';\n\nexport class MobileTableCell extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    mobile-table-cell {\n      display: flex;\n      align-items: start;\n      width: 100%;\n      height: 100%;\n      border: none;\n      outline: none;\n    }\n\n    mobile-table-cell * {\n      box-sizing: border-box;\n    }\n\n    mobile-table-cell uni-lit > *:first-child {\n      padding: 6px;\n    }\n  `;\n\n  private _cell = createRef<DataViewCellLifeCycle>();\n\n  @property({ attribute: false })\n  accessor column!: TableColumn;\n\n  @property({ attribute: false })\n  accessor rowId!: string;\n\n  cell$ = computed(() => {\n    return this.column.cellGet(this.rowId);\n  });\n\n  isEditing$ = computed(() => {\n    const selection = this.table?.props.selection$.value;\n    if (selection?.selectionType !== 'area') {\n      return false;\n    }\n    if (selection.groupKey !== this.groupKey) {\n      return false;\n    }\n    if (selection.focus.columnIndex !== this.columnIndex) {\n      return false;\n    }\n    if (selection.focus.rowIndex !== this.rowIndex) {\n      return false;\n    }\n    return selection.isEditing;\n  });\n\n  selectCurrentCell = (editing: boolean) => {\n    if (this.view.readonly$.value) {\n      return;\n    }\n    const setSelection = this.table?.props.setSelection;\n    const viewId = this.table?.props.view.id;\n    if (setSelection && viewId) {\n      if (editing && this.cell?.beforeEnterEditMode() === false) {\n        return;\n      }\n      setSelection({\n        viewId,\n        type: 'table',\n        ...TableAreaSelection.create({\n          groupKey: this.groupKey,\n          focus: {\n            rowIndex: this.rowIndex,\n            columnIndex: this.columnIndex,\n          },\n          isEditing: editing,\n        }),\n      });\n    }\n  };\n\n  get cell(): DataViewCellLifeCycle | undefined {\n    return this._cell.value;\n  }\n\n  private get groupKey() {\n    return this.closest('mobile-table-group')?.group?.key;\n  }\n\n  private get readonly() {\n    return this.column.readonly$.value;\n  }\n\n  private get table() {\n    return this.closest('mobile-data-view-table');\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (this.column.readonly$.value) return;\n    this.disposables.add(\n      effect(() => {\n        const isEditing = this.isEditing$.value;\n        if (isEditing) {\n          this.isEditing = true;\n          this._cell.value?.onEnterEditMode();\n        } else {\n          this._cell.value?.onExitEditMode();\n          this.isEditing = false;\n        }\n      })\n    );\n    this.disposables.addFromEvent(this, 'click', () => {\n      if (!this.isEditing) {\n        this.selectCurrentCell(!this.column.readonly$.value);\n      }\n    });\n  }\n\n  override render() {\n    const renderer = this.column.renderer$.value;\n    if (!renderer) {\n      return;\n    }\n    const { edit, view } = renderer;\n    const uni = !this.readonly && this.isEditing && edit != null ? edit : view;\n    this.view.lockRows(this.isEditing);\n    this.dataset['editing'] = `${this.isEditing}`;\n    const props: CellRenderProps = {\n      cell: this.cell$.value,\n      isEditing: this.isEditing,\n      selectCurrentCell: this.selectCurrentCell,\n    };\n\n    return renderUniLit(uni, props, {\n      ref: this._cell,\n      style: {\n        display: 'contents',\n      },\n    });\n  }\n\n  @property({ attribute: false })\n  accessor columnId!: string;\n\n  @property({ attribute: false })\n  accessor columnIndex!: number;\n\n  @state()\n  accessor isEditing = false;\n\n  @property({ attribute: false })\n  accessor rowIndex!: number;\n\n  @property({ attribute: false })\n  accessor view!: SingleView;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'mobile-table-cell': MobileTableCell;\n  }\n}\n"]}