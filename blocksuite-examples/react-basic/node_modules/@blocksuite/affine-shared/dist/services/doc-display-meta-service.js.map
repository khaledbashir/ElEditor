{"version":3,"file":"doc-display-meta-service.js","sourceRoot":"","sources":["../../src/services/doc-display-meta-service.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AliasInfo, ReferenceParams } from '@blocksuite/affine-model';\nimport type { Disposable } from '@blocksuite/global/utils';\nimport type { Doc } from '@blocksuite/store';\nimport type { TemplateResult } from 'lit';\n\nimport { LifeCycleWatcher, StdIdentifier } from '@blocksuite/block-std';\nimport { type Container, createIdentifier } from '@blocksuite/global/di';\nimport {\n  AliasIcon,\n  BlockLinkIcon,\n  DeleteIcon,\n  EdgelessIcon,\n  LinkedEdgelessIcon,\n  LinkedPageIcon,\n  PageIcon,\n} from '@blocksuite/icons/lit';\nimport { computed, signal, type Signal } from '@preact/signals-core';\n\nimport { referenceToNode } from '../utils/reference.js';\nimport { DocModeProvider } from './doc-mode-service.js';\n\nexport type DocDisplayMetaParams = {\n  referenced?: boolean;\n  params?: ReferenceParams;\n} & AliasInfo;\n\n/**\n * Customize document display title and icon.\n *\n * Supports the following blocks:\n *\n * * Inline View:\n *      `AffineReference`\n * * Card View:\n *      `EmbedLinkedDocBlockComponent`\n *      `EmbedEdgelessLinkedDocBlockComponent`\n * * Embed View:\n *      `EmbedSyncedDocBlockComponent`\n *      `EmbedEdgelessSyncedDocBlockComponent`\n */\nexport interface DocDisplayMetaExtension {\n  icon: (\n    docId: string,\n    referenceInfo?: DocDisplayMetaParams\n  ) => Signal<TemplateResult>;\n  title: (\n    docId: string,\n    referenceInfo?: DocDisplayMetaParams\n  ) => Signal<string>;\n}\n\nexport const DocDisplayMetaProvider = createIdentifier<DocDisplayMetaExtension>(\n  'DocDisplayMetaService'\n);\n\nexport class DocDisplayMetaService\n  extends LifeCycleWatcher\n  implements DocDisplayMetaExtension\n{\n  static icons = {\n    deleted: iconBuilder(DeleteIcon),\n    aliased: iconBuilder(AliasIcon),\n    page: iconBuilder(PageIcon),\n    edgeless: iconBuilder(EdgelessIcon),\n    linkedBlock: iconBuilder(BlockLinkIcon),\n    linkedPage: iconBuilder(LinkedPageIcon),\n    linkedEdgeless: iconBuilder(LinkedEdgelessIcon),\n  } as const;\n\n  static override key = 'doc-display-meta';\n\n  readonly disposables: Disposable[] = [];\n\n  readonly iconMap = new WeakMap<Doc, Signal<TemplateResult>>();\n\n  readonly titleMap = new WeakMap<Doc, Signal<string>>();\n\n  static override setup(di: Container) {\n    di.addImpl(DocDisplayMetaProvider, this, [StdIdentifier]);\n  }\n\n  dispose() {\n    while (this.disposables.length > 0) {\n      this.disposables.pop()?.dispose();\n    }\n  }\n\n  icon(\n    pageId: string,\n    { params, title, referenced }: DocDisplayMetaParams = {}\n  ): Signal<TemplateResult> {\n    const doc = this.std.collection.getDoc(pageId);\n\n    if (!doc) {\n      return signal(DocDisplayMetaService.icons.deleted);\n    }\n\n    let icon$ = this.iconMap.get(doc);\n\n    if (!icon$) {\n      icon$ = signal(\n        this.std.get(DocModeProvider).getPrimaryMode(pageId) === 'edgeless'\n          ? DocDisplayMetaService.icons.edgeless\n          : DocDisplayMetaService.icons.page\n      );\n\n      const disposable = this.std\n        .get(DocModeProvider)\n        .onPrimaryModeChange(mode => {\n          icon$!.value =\n            mode === 'edgeless'\n              ? DocDisplayMetaService.icons.edgeless\n              : DocDisplayMetaService.icons.page;\n        }, pageId);\n\n      this.disposables.push(disposable);\n      this.disposables.push(\n        this.std.collection.slots.docRemoved\n          .filter(docId => docId === doc.id)\n          .once(() => {\n            const index = this.disposables.findIndex(d => d === disposable);\n            if (index !== -1) {\n              this.disposables.splice(index, 1);\n              disposable.dispose();\n            }\n            this.iconMap.delete(doc);\n          })\n      );\n      this.iconMap.set(doc, icon$);\n    }\n\n    return computed(() => {\n      if (title) {\n        return DocDisplayMetaService.icons.aliased;\n      }\n\n      if (referenceToNode({ pageId, params })) {\n        return DocDisplayMetaService.icons.linkedBlock;\n      }\n\n      if (referenced) {\n        const mode =\n          params?.mode ??\n          this.std.get(DocModeProvider).getPrimaryMode(pageId) ??\n          'page';\n        return mode === 'edgeless'\n          ? DocDisplayMetaService.icons.linkedEdgeless\n          : DocDisplayMetaService.icons.linkedPage;\n      }\n\n      return icon$.value;\n    });\n  }\n\n  title(pageId: string, { title }: DocDisplayMetaParams = {}): Signal<string> {\n    const doc = this.std.collection.getDoc(pageId);\n\n    if (!doc) {\n      return signal(title || 'Deleted doc');\n    }\n\n    let title$ = this.titleMap.get(doc);\n    if (!title$) {\n      title$ = signal(doc.meta?.title || 'Untitled');\n\n      const disposable = this.std.collection.meta.docMetaUpdated.on(() => {\n        title$!.value = doc.meta?.title || 'Untitled';\n      });\n\n      this.disposables.push(disposable);\n      this.disposables.push(\n        this.std.collection.slots.docRemoved\n          .filter(docId => docId === doc.id)\n          .once(() => {\n            const index = this.disposables.findIndex(d => d === disposable);\n            if (index !== -1) {\n              this.disposables.splice(index, 1);\n              disposable.dispose();\n            }\n            this.titleMap.delete(doc);\n          })\n      );\n      this.titleMap.set(doc, title$);\n    }\n\n    return computed(() => {\n      return title || title$.value;\n    });\n  }\n\n  override unmounted() {\n    this.dispose();\n  }\n}\n\nfunction iconBuilder(\n  icon: typeof PageIcon,\n  size = '1.25em',\n  style = 'user-select:none;flex-shrink:0;vertical-align:middle;font-size:inherit;margin-bottom:0.1em;'\n) {\n  return icon({ width: size, height: size, style });\n}\n"]}