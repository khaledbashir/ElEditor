{"version":3,"file":"theme-service.js","sourceRoot":"","sources":["../../src/services/theme-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Color, ColorScheme } from '@blocksuite/affine-model';\nimport {\n  type BlockStdScope,\n  Extension,\n  type ExtensionType,\n  StdIdentifier,\n} from '@blocksuite/block-std';\nimport { type Container, createIdentifier } from '@blocksuite/global/di';\nimport { signal, type Signal } from '@preact/signals-core';\nimport {\n  type AffineCssVariables,\n  combinedDarkCssVariables,\n  combinedLightCssVariables,\n} from '@toeverything/theme';\n\nimport { isInsideEdgelessEditor } from '../utils/index.js';\n\nconst TRANSPARENT = 'transparent';\n\nexport const ThemeExtensionIdentifier = createIdentifier<ThemeExtension>(\n  'AffineThemeExtension'\n);\n\nexport interface ThemeExtension {\n  getAppTheme?: () => Signal<ColorScheme>;\n  getEdgelessTheme?: (docId?: string) => Signal<ColorScheme>;\n}\n\nexport function OverrideThemeExtension(service: ThemeExtension): ExtensionType {\n  return {\n    setup: di => {\n      di.override(ThemeExtensionIdentifier, () => service);\n    },\n  };\n}\n\nexport const ThemeProvider = createIdentifier<ThemeService>(\n  'AffineThemeProvider'\n);\n\nexport class ThemeService extends Extension {\n  app$: Signal<ColorScheme>;\n\n  edgeless$: Signal<ColorScheme>;\n\n  get appTheme() {\n    return this.app$.peek();\n  }\n\n  get edgelessTheme() {\n    return this.edgeless$.peek();\n  }\n\n  get theme() {\n    return isInsideEdgelessEditor(this.std.host)\n      ? this.edgelessTheme\n      : this.appTheme;\n  }\n\n  get theme$() {\n    return isInsideEdgelessEditor(this.std.host) ? this.edgeless$ : this.app$;\n  }\n\n  constructor(private std: BlockStdScope) {\n    super();\n    const extension = this.std.getOptional(ThemeExtensionIdentifier);\n    this.app$ = extension?.getAppTheme?.() || getThemeObserver().theme$;\n    this.edgeless$ =\n      extension?.getEdgelessTheme?.(this.std.doc.id) ||\n      getThemeObserver().theme$;\n  }\n\n  static override setup(di: Container) {\n    di.addImpl(ThemeProvider, ThemeService, [StdIdentifier]);\n  }\n\n  /**\n   * Generates a CSS's color property with `var` or `light-dark` functions.\n   *\n   * Sometimes used to set the frame/note background.\n   *\n   * @param color - A color value.\n   * @param fallback  - If color value processing fails, it will be used as a fallback.\n   * @returns - A color property string.\n   *\n   * @example\n   *\n   * ```\n   * `rgba(255,0,0)`\n   * `#fff`\n   * `light-dark(#fff, #000)`\n   * `var(--affine-palette-shape-blue)`\n   * ```\n   */\n  generateColorProperty(\n    color: Color,\n    fallback = 'transparent',\n    theme = this.theme\n  ) {\n    let result: string | undefined = undefined;\n\n    if (typeof color === 'object') {\n      result = color[theme] ?? color.normal;\n    } else {\n      result = color;\n    }\n    if (!result) {\n      result = fallback;\n    }\n    if (result.startsWith('--')) {\n      return result.endsWith(TRANSPARENT) ? TRANSPARENT : `var(${result})`;\n    }\n\n    return result ?? TRANSPARENT;\n  }\n\n  /**\n   * Gets a color with the current theme.\n   *\n   * @param color - A color value.\n   * @param fallback - If color value processing fails, it will be used as a fallback.\n   * @param real - If true, it returns the computed style.\n   * @returns - A color property string.\n   *\n   * @example\n   *\n   * ```\n   * `rgba(255,0,0)`\n   * `#fff`\n   * `--affine-palette-shape-blue`\n   * ```\n   */\n  getColorValue(\n    color: Color,\n    fallback = TRANSPARENT,\n    real = false,\n    theme = this.theme\n  ) {\n    let result: string | undefined = undefined;\n\n    if (typeof color === 'object') {\n      result = color[theme] ?? color.normal;\n    } else {\n      result = color;\n    }\n    if (!result) {\n      result = fallback;\n    }\n    if (real && result.startsWith('--')) {\n      result = result.endsWith(TRANSPARENT)\n        ? TRANSPARENT\n        : this.getCssVariableColor(result, theme);\n    }\n\n    return result ?? TRANSPARENT;\n  }\n\n  getCssVariableColor(property: string, theme = this.theme) {\n    if (property.startsWith('--')) {\n      if (property.endsWith(TRANSPARENT)) {\n        return TRANSPARENT;\n      }\n      const key = property as keyof AffineCssVariables;\n      const color =\n        theme === ColorScheme.Dark\n          ? combinedDarkCssVariables[key]\n          : combinedLightCssVariables[key];\n      return color;\n    }\n    return property;\n  }\n}\n\nexport class ThemeObserver {\n  private observer: MutationObserver;\n\n  theme$ = signal(ColorScheme.Light);\n\n  constructor() {\n    const COLOR_SCHEMES: string[] = Object.values(ColorScheme);\n    this.observer = new MutationObserver(() => {\n      const mode = document.documentElement.dataset.theme;\n      if (!mode) return;\n      if (!COLOR_SCHEMES.includes(mode)) return;\n      if (mode === this.theme$.value) return;\n\n      this.theme$.value = mode as ColorScheme;\n    });\n    this.observer.observe(document.documentElement, {\n      attributes: true,\n      attributeFilter: ['data-theme'],\n    });\n  }\n\n  destroy() {\n    this.observer.disconnect();\n  }\n}\n\nexport const getThemeObserver = (function () {\n  let observer: ThemeObserver;\n  return function () {\n    if (observer) return observer;\n    observer = new ThemeObserver();\n    return observer;\n  };\n})();\n"]}