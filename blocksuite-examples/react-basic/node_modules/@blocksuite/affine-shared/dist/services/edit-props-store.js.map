{"version":3,"file":"edit-props-store.js","sourceRoot":"","sources":["../../src/services/edit-props-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { type BlockStdScope, LifeCycleWatcher } from '@blocksuite/block-std';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport {\n  type DeepPartial,\n  DisposableGroup,\n  Slot,\n} from '@blocksuite/global/utils';\nimport { DocCollection } from '@blocksuite/store';\nimport { computed, type Signal, signal } from '@preact/signals-core';\nimport clonedeep from 'lodash.clonedeep';\nimport mergeWith from 'lodash.mergewith';\nimport { z } from 'zod';\n\nimport {\n  ColorSchema,\n  makeDeepOptional,\n  NodePropsSchema,\n} from '../utils/index.js';\nimport { EditorSettingProvider } from './editor-setting-service.js';\n\nconst LastPropsSchema = NodePropsSchema;\nconst OptionalPropsSchema = makeDeepOptional(NodePropsSchema);\nexport type LastProps = z.infer<typeof NodePropsSchema>;\nexport type LastPropsKey = keyof LastProps;\n\nconst SessionPropsSchema = z.object({\n  viewport: z.union([\n    z.object({\n      centerX: z.number(),\n      centerY: z.number(),\n      zoom: z.number(),\n    }),\n    z.object({\n      xywh: z.string(),\n      padding: z\n        .tuple([z.number(), z.number(), z.number(), z.number()])\n        .optional(),\n    }),\n  ]),\n  templateCache: z.string(),\n  remoteColor: z.string(),\n  showBidirectional: z.boolean(),\n});\n\nconst LocalPropsSchema = z.object({\n  presentBlackBackground: z.boolean(),\n  presentFillScreen: z.boolean(),\n  presentHideToolbar: z.boolean(),\n\n  autoHideEmbedHTMLFullScreenToolbar: z.boolean(),\n});\n\ntype SessionProps = z.infer<typeof SessionPropsSchema>;\ntype LocalProps = z.infer<typeof LocalPropsSchema>;\ntype StorageProps = SessionProps & LocalProps;\ntype StoragePropsKey = keyof StorageProps;\n\nfunction isLocalProp(key: string): key is keyof LocalProps {\n  return key in LocalPropsSchema.shape;\n}\n\nfunction isSessionProp(key: string): key is keyof SessionProps {\n  return key in SessionPropsSchema.shape;\n}\n\nfunction customizer(_target: unknown, source: unknown) {\n  if (\n    ColorSchema.safeParse(source).success ||\n    source instanceof DocCollection.Y.Text ||\n    source instanceof DocCollection.Y.Array ||\n    source instanceof DocCollection.Y.Map\n  ) {\n    return source;\n  }\n  return;\n}\n\nexport class EditPropsStore extends LifeCycleWatcher {\n  static override key = 'EditPropsStore';\n\n  private _disposables = new DisposableGroup();\n\n  private innerProps$: Signal<DeepPartial<LastProps>> = signal({});\n\n  lastProps$: Signal<LastProps>;\n\n  slots = {\n    storageUpdated: new Slot<{\n      key: StoragePropsKey;\n      value: StorageProps[StoragePropsKey];\n    }>(),\n  };\n\n  constructor(std: BlockStdScope) {\n    super(std);\n    const initProps: LastProps = LastPropsSchema.parse(\n      Object.entries(LastPropsSchema.shape).reduce((value, [key, schema]) => {\n        return {\n          ...value,\n          [key]: schema.parse(undefined),\n        };\n      }, {})\n    );\n\n    this.lastProps$ = computed(() => {\n      const editorSetting$ = this.std.getOptional(EditorSettingProvider);\n      const nextProps = mergeWith(\n        clonedeep(initProps),\n        editorSetting$?.value,\n        this.innerProps$.value,\n        customizer\n      );\n      return LastPropsSchema.parse(nextProps);\n    });\n  }\n\n  private _getStorage<T extends StoragePropsKey>(key: T) {\n    return isSessionProp(key) ? sessionStorage : localStorage;\n  }\n\n  private _getStorageKey<T extends StoragePropsKey>(key: T) {\n    const id = this.std.doc.id;\n    switch (key) {\n      case 'viewport':\n        return 'blocksuite:' + id + ':edgelessViewport';\n      case 'presentBlackBackground':\n        return 'blocksuite:presentation:blackBackground';\n      case 'presentFillScreen':\n        return 'blocksuite:presentation:fillScreen';\n      case 'presentHideToolbar':\n        return 'blocksuite:presentation:hideToolbar';\n      case 'templateCache':\n        return 'blocksuite:' + id + ':templateTool';\n      case 'remoteColor':\n        return 'blocksuite:remote-color';\n      case 'showBidirectional':\n        return 'blocksuite:' + id + ':showBidirectional';\n      case 'autoHideEmbedHTMLFullScreenToolbar':\n        return 'blocksuite:embedHTML:autoHideFullScreenToolbar';\n      default:\n        return key;\n    }\n  }\n\n  applyLastProps(key: LastPropsKey, props: Record<string, unknown>) {\n    if (['__proto__', 'constructor', 'prototype'].includes(key)) {\n      throw new BlockSuiteError(\n        ErrorCode.DefaultRuntimeError,\n        `Invalid key: ${key}`\n      );\n    }\n    const lastProps = this.lastProps$.value[key];\n    return mergeWith(clonedeep(lastProps), props, customizer);\n  }\n\n  dispose() {\n    this._disposables.dispose();\n  }\n\n  getStorage<T extends StoragePropsKey>(key: T) {\n    try {\n      const storage = this._getStorage(key);\n      const value = storage.getItem(this._getStorageKey(key));\n      if (!value) return null;\n      if (isLocalProp(key)) {\n        return LocalPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else if (isSessionProp(key)) {\n        return SessionPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else {\n        return null;\n      }\n    } catch {\n      return null;\n    }\n  }\n\n  recordLastProps(key: LastPropsKey, props: Partial<LastProps[LastPropsKey]>) {\n    const schema = OptionalPropsSchema._def.innerType.shape[key];\n    if (!schema) return;\n\n    const overrideProps = schema.parse(props);\n    if (Object.keys(overrideProps).length === 0) return;\n\n    const innerProps = this.innerProps$.value;\n    const nextProps = mergeWith(\n      clonedeep(innerProps),\n      { [key]: overrideProps },\n      customizer\n    );\n    this.innerProps$.value = OptionalPropsSchema.parse(nextProps);\n  }\n\n  setStorage<T extends StoragePropsKey>(key: T, value: StorageProps[T]) {\n    const oldValue = this.getStorage(key);\n    this._getStorage(key).setItem(\n      this._getStorageKey(key),\n      JSON.stringify(value)\n    );\n    if (oldValue === value) return;\n    this.slots.storageUpdated.emit({ key, value });\n  }\n\n  override unmounted() {\n    super.unmounted();\n    this.dispose();\n  }\n}\n"]}