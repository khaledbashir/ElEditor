{"version":3,"file":"drag-handle-config.js","sourceRoot":"","sources":["../../src/services/drag-handle-config.ts"],"names":[],"mappings":"AAEA,OAAO,EAKL,SAAS,EAET,aAAa,GACd,MAAM,uBAAuB,CAAC;AAC/B,OAAO,EAAkB,gBAAgB,EAAE,MAAM,uBAAuB,CAAC;AACzE,OAAO,EAAE,GAAG,EAAE,KAAK,EAAsB,MAAM,mBAAmB,CAAC;AAsCnE,MAAM,CAAC,MAAM,0BAA0B,GAAG,gBAAgB,CACxD,4BAA4B,CAC7B,CAAC;AAEF,MAAM,UAAU,yBAAyB,CACvC,MAAwB;IAExB,OAAO;QACL,KAAK,EAAE,EAAE,CAAC,EAAE;YACV,MAAM,GAAG,GACP,OAAO,MAAM,CAAC,OAAO,KAAK,QAAQ;gBAChC,CAAC,CAAC,MAAM,CAAC,OAAO;gBAChB,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC;YAC5B,EAAE,CAAC,OAAO,CAAC,0BAA0B,CAAC,GAAG,CAAC,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,CAAC;QAC5D,CAAC;KACF,CAAC;AACJ,CAAC;AAED,MAAM,CAAC,MAAM,yBAAyB,GAAG,gBAAgB,CACvD,wBAAwB,CACzB,CAAC;AAEF,MAAM,OAAO,eAAgB,SAAQ,SAAS;IAG5C,YAAqB,GAAkB;QACrC,KAAK,EAAE,CAAC;QADW,QAAG,GAAH,GAAG,CAAe;QAFvC,aAAQ,GAAG,8BAA8B,CAAC;IAI1C,CAAC;IAED,MAAM,CAAU,KAAK,CAAC,EAAa;QACjC,EAAE,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,aAAa,CAAC,CAAC,CAAC;QAE9B,EAAE,CAAC,OAAO,CAAC,yBAAyB,EAAE,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC;IACxE,CAAC;IAED,cAAc,CAAC,IAAY;QACzB,OAAO,IAAI,CAAC,KAAK,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC,CAAC;IAC9C,CAAC;IAED,cAAc,CAAC,IAAmB;QAChC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACtC,OAAO,kBAAkB,CAAC,QAAQ,CAAC,CAAC;IACtC,CAAC;IAED,UAAU,CAAC,OAIV;QACC,MAAM,EAAE,KAAK,EAAE,OAAO,GAAG,yBAAyB,EAAE,OAAO,EAAE,GAAG,OAAO,CAAC;QAExE,MAAM,KAAK,GAAG,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;QACjD,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,EAAE,UAAU,EAAE,IAAI,CAAC,GAAG,CAAC,UAAU,EAAE,CAAC,CAAC;QACzD,MAAM,QAAQ,GAAG,GAAG,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;QAC5C,IAAI,CAAC,QAAQ,EAAE,CAAC;YACd,OAAO,CAAC,KAAK,CAAC,qCAAqC,CAAC,CAAC;YACrD,OAAO,IAAI,CAAC;QACd,CAAC;QACD,MAAM,KAAK,GAAG;YACZ,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;YAC/B,MAAM,EAAE,KAAK;SACd,CAAC;QACF,OAAO;YACL,GAAG,QAAQ;YACX,OAAO,EAAE;gBACP;oBACE,EAAE,EAAE,IAAI,CAAC,GAAG,CAAC,UAAU,CAAC,WAAW,EAAE;oBACrC,IAAI,EAAE,OAAO;oBACb,OAAO;oBACP,KAAK;oBACL,QAAQ,EAAE,EAAE;iBACb;aACF;SACF,CAAC;IACJ,CAAC;CACF","sourcesContent":["import type { Point } from '@blocksuite/global/utils';\n\nimport {\n  type BlockComponent,\n  type BlockStdScope,\n  type DndEventState,\n  type EditorHost,\n  Extension,\n  type ExtensionType,\n  StdIdentifier,\n} from '@blocksuite/block-std';\nimport { type Container, createIdentifier } from '@blocksuite/global/di';\nimport { Job, Slice, type SliceSnapshot } from '@blocksuite/store';\n\nexport type DropType = 'before' | 'after' | 'in';\nexport type OnDragStartProps = {\n  state: DndEventState;\n  startDragging: (\n    blocks: BlockComponent[],\n    state: DndEventState,\n    dragPreview?: HTMLElement,\n    dragPreviewOffset?: Point\n  ) => void;\n  anchorBlockId: string | null;\n  editorHost: EditorHost;\n};\n\nexport type OnDragEndProps = {\n  state: DndEventState;\n  draggingElements: BlockComponent[];\n  dropBlockId: string;\n  dropType: DropType | null;\n  dragPreview: HTMLElement;\n  noteScale: number;\n  editorHost: EditorHost;\n};\n\nexport type OnDragMoveProps = {\n  state: DndEventState;\n  draggingElements?: BlockComponent[];\n};\n\nexport type DragHandleOption = {\n  flavour: string | RegExp;\n  edgeless?: boolean;\n  onDragStart?: (props: OnDragStartProps) => boolean;\n  onDragMove?: (props: OnDragMoveProps) => boolean;\n  onDragEnd?: (props: OnDragEndProps) => boolean;\n};\n\nexport const DragHandleConfigIdentifier = createIdentifier<DragHandleOption>(\n  'AffineDragHandleIdentifier'\n);\n\nexport function DragHandleConfigExtension(\n  option: DragHandleOption\n): ExtensionType {\n  return {\n    setup: di => {\n      const key =\n        typeof option.flavour === 'string'\n          ? option.flavour\n          : option.flavour.source;\n      di.addImpl(DragHandleConfigIdentifier(key), () => option);\n    },\n  };\n}\n\nexport const DndApiExtensionIdentifier = createIdentifier<DNDAPIExtension>(\n  'AffineDndApiIdentifier'\n);\n\nexport class DNDAPIExtension extends Extension {\n  mimeType = 'application/x-blocksuite-dnd';\n\n  constructor(readonly std: BlockStdScope) {\n    super();\n  }\n\n  static override setup(di: Container) {\n    di.add(this, [StdIdentifier]);\n\n    di.addImpl(DndApiExtensionIdentifier, provider => provider.get(this));\n  }\n\n  decodeSnapshot(data: string): SliceSnapshot {\n    return JSON.parse(decodeURIComponent(data));\n  }\n\n  encodeSnapshot(json: SliceSnapshot) {\n    const snapshot = JSON.stringify(json);\n    return encodeURIComponent(snapshot);\n  }\n\n  fromEntity(options: {\n    docId: string;\n    flavour?: string;\n    blockId?: string;\n  }): SliceSnapshot | null {\n    const { docId, flavour = 'affine:embed-linked-doc', blockId } = options;\n\n    const slice = Slice.fromModels(this.std.doc, []);\n    const job = new Job({ collection: this.std.collection });\n    const snapshot = job.sliceToSnapshot(slice);\n    if (!snapshot) {\n      console.error('Failed to convert slice to snapshot');\n      return null;\n    }\n    const props = {\n      ...(blockId ? { blockId } : {}),\n      pageId: docId,\n    };\n    return {\n      ...snapshot,\n      content: [\n        {\n          id: this.std.collection.idGenerator(),\n          type: 'block',\n          flavour,\n          props,\n          children: [],\n        },\n      ],\n    };\n  }\n}\n"]}