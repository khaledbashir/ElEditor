{"version":3,"file":"delta-converter.js","sourceRoot":"","sources":["../../../src/adapters/html-adapter/delta-converter.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ExtensionType } from '@blocksuite/block-std';\nimport type { DeltaInsert } from '@blocksuite/inline';\n\nimport {\n  createIdentifier,\n  type ServiceIdentifier,\n} from '@blocksuite/global/di';\n\nimport type { AffineTextAttributes } from '../../types/index.js';\nimport type { HtmlAST, InlineHtmlAST } from '../types/hast.js';\n\nimport {\n  type ASTToDeltaMatcher,\n  DeltaASTConverter,\n  type DeltaASTConverterOptions,\n  type InlineDeltaMatcher,\n} from '../types/adapter.js';\nimport { TextUtils } from '../utils/text.js';\n\nexport type InlineDeltaToHtmlAdapterMatcher = InlineDeltaMatcher<InlineHtmlAST>;\n\nexport const InlineDeltaToHtmlAdapterMatcherIdentifier =\n  createIdentifier<InlineDeltaToHtmlAdapterMatcher>(\n    'InlineDeltaToHtmlAdapterMatcher'\n  );\n\nexport function InlineDeltaToHtmlAdapterExtension(\n  matcher: InlineDeltaToHtmlAdapterMatcher\n): ExtensionType & {\n  identifier: ServiceIdentifier<InlineDeltaToHtmlAdapterMatcher>;\n} {\n  const identifier = InlineDeltaToHtmlAdapterMatcherIdentifier(matcher.name);\n  return {\n    setup: di => {\n      di.addImpl(identifier, () => matcher);\n    },\n    identifier,\n  };\n}\n\nexport type HtmlASTToDeltaMatcher = ASTToDeltaMatcher<HtmlAST>;\n\nexport const HtmlASTToDeltaMatcherIdentifier =\n  createIdentifier<HtmlASTToDeltaMatcher>('HtmlASTToDeltaMatcher');\n\nexport function HtmlASTToDeltaExtension(\n  matcher: HtmlASTToDeltaMatcher\n): ExtensionType & {\n  identifier: ServiceIdentifier<HtmlASTToDeltaMatcher>;\n} {\n  const identifier = HtmlASTToDeltaMatcherIdentifier(matcher.name);\n  return {\n    setup: di => {\n      di.addImpl(identifier, () => matcher);\n    },\n    identifier,\n  };\n}\n\nexport class HtmlDeltaConverter extends DeltaASTConverter<\n  AffineTextAttributes,\n  HtmlAST\n> {\n  constructor(\n    readonly configs: Map<string, string>,\n    readonly inlineDeltaMatchers: InlineDeltaToHtmlAdapterMatcher[],\n    readonly htmlASTToDeltaMatchers: HtmlASTToDeltaMatcher[]\n  ) {\n    super();\n  }\n\n  private _applyTextFormatting(\n    delta: DeltaInsert<AffineTextAttributes>\n  ): InlineHtmlAST {\n    let hast: InlineHtmlAST = {\n      type: 'text',\n      value: delta.insert,\n    };\n\n    const context: {\n      configs: Map<string, string>;\n      current: InlineHtmlAST;\n    } = {\n      configs: this.configs,\n      current: hast,\n    };\n    for (const matcher of this.inlineDeltaMatchers) {\n      if (matcher.match(delta)) {\n        hast = matcher.toAST(delta, context);\n        context.current = hast;\n      }\n    }\n\n    return hast;\n  }\n\n  private _spreadAstToDelta(\n    ast: HtmlAST,\n    options: DeltaASTConverterOptions = Object.create(null)\n  ): DeltaInsert<AffineTextAttributes>[] {\n    const context = {\n      configs: this.configs,\n      options,\n      toDelta: (ast: HtmlAST, options?: DeltaASTConverterOptions) =>\n        this._spreadAstToDelta(ast, options),\n    };\n    for (const matcher of this.htmlASTToDeltaMatchers) {\n      if (matcher.match(ast)) {\n        return matcher.toDelta(ast, context);\n      }\n    }\n    return 'children' in ast\n      ? ast.children.flatMap(child => this._spreadAstToDelta(child, options))\n      : [];\n  }\n\n  astToDelta(\n    ast: HtmlAST,\n    options: DeltaASTConverterOptions = Object.create(null)\n  ): DeltaInsert<AffineTextAttributes>[] {\n    return this._spreadAstToDelta(ast, options).reduce((acc, cur) => {\n      return TextUtils.mergeDeltas(acc, cur);\n    }, [] as DeltaInsert<AffineTextAttributes>[]);\n  }\n\n  deltaToAST(\n    deltas: DeltaInsert<AffineTextAttributes>[],\n    depth = 0\n  ): InlineHtmlAST[] {\n    if (depth > 0) {\n      deltas.unshift({ insert: ' '.repeat(4).repeat(depth) });\n    }\n\n    return deltas.map(delta => this._applyTextFormatting(delta));\n  }\n}\n"]}