{"version":3,"file":"adapter.js","sourceRoot":"","sources":["../../../src/adapters/types/adapter.ts"],"names":[],"mappings":"AAEA,OAAO,EAKL,mBAAmB,GAGpB,MAAM,mBAAmB,CAAC;AAI3B,MAAM,CAAC,MAAM,mBAAmB,GAAG,CAAC,IAAa,EAAyB,EAAE,CAC1E,mBAAmB,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC;AA4G9C,MAAM,OAAgB,iBAAiB;CAmBtC","sourcesContent":["import type { BaseTextAttributes, DeltaInsert } from '@blocksuite/inline';\n\nimport {\n  type AssetsManager,\n  type ASTWalker,\n  type ASTWalkerContext,\n  type BlockSnapshot,\n  BlockSnapshotSchema,\n  type Job,\n  type NodeProps,\n} from '@blocksuite/store';\n\nimport type { AffineTextAttributes } from '../../types/index.js';\n\nexport const isBlockSnapshotNode = (node: unknown): node is BlockSnapshot =>\n  BlockSnapshotSchema.safeParse(node).success;\n\nexport type TextBuffer = {\n  content: string;\n};\n\nexport type DeltaASTConverterOptions = {\n  trim?: boolean;\n  pre?: boolean;\n  pageMap?: Map<string, string>;\n  removeLastBr?: boolean;\n};\n\nexport type AdapterContext<\n  ONode extends object,\n  TNode extends object = never,\n  TConverter extends DeltaASTConverter = DeltaASTConverter,\n> = {\n  walker: ASTWalker<ONode, TNode>;\n  walkerContext: ASTWalkerContext<TNode>;\n  configs: Map<string, string>;\n  job: Job;\n  deltaConverter: TConverter;\n  textBuffer: TextBuffer;\n  assets?: AssetsManager;\n  pageMap?: Map<string, string>;\n  updateAssetIds?: (assetsId: string) => void;\n};\n\n/**\n * Defines the interface for adapting between different blocks and target formats.\n * Used to convert blocks between a source format (TNode) and BlockSnapshot format.\n *\n * @template TNode - The source/target node type to convert from/to\n * @template TConverter - The converter used for handling delta format conversions\n */\nexport type BlockAdapterMatcher<\n  TNode extends object = never,\n  TConverter extends DeltaASTConverter = DeltaASTConverter,\n> = {\n  /** The block flavour identifier */\n  flavour: string;\n\n  /**\n   * Function to check if a target node matches this adapter\n   * @param o - The target node properties to check\n   * @returns true if this adapter can handle the node\n   */\n  toMatch: (o: NodeProps<TNode>) => boolean;\n\n  /**\n   * Function to check if a BlockSnapshot matches this adapter\n   * @param o - The BlockSnapshot properties to check\n   * @returns true if this adapter can handle the snapshot\n   */\n  fromMatch: (o: NodeProps<BlockSnapshot>) => boolean;\n\n  /**\n   * Handlers for converting from target format to BlockSnapshot\n   */\n  toBlockSnapshot: {\n    /**\n     * Called when entering a target walker node during traversal\n     * @param o - The target node properties\n     * @param context - The adapter context\n     */\n    enter?: (\n      o: NodeProps<TNode>,\n      context: AdapterContext<TNode, BlockSnapshot, TConverter>\n    ) => void | Promise<void>;\n\n    /**\n     * Called when leaving a target walker node during traversal\n     * @param o - The target node properties\n     * @param context - The adapter context\n     */\n    leave?: (\n      o: NodeProps<TNode>,\n      context: AdapterContext<TNode, BlockSnapshot, TConverter>\n    ) => void | Promise<void>;\n  };\n\n  /**\n   * Handlers for converting from BlockSnapshot to target format\n   */\n  fromBlockSnapshot: {\n    /**\n     * Called when entering a BlockSnapshot walker node during traversal\n     * @param o - The BlockSnapshot properties\n     * @param context - The adapter context\n     */\n    enter?: (\n      o: NodeProps<BlockSnapshot>,\n      context: AdapterContext<BlockSnapshot, TNode, TConverter>\n    ) => void | Promise<void>;\n\n    /**\n     * Called when leaving a BlockSnapshot walker node during traversal\n     * @param o - The BlockSnapshot properties\n     * @param context - The adapter context\n     */\n    leave?: (\n      o: NodeProps<BlockSnapshot>,\n      context: AdapterContext<BlockSnapshot, TNode, TConverter>\n    ) => void | Promise<void>;\n  };\n};\n\nexport abstract class DeltaASTConverter<\n  TextAttributes extends BaseTextAttributes = BaseTextAttributes,\n  AST = unknown,\n> {\n  /**\n   * Convert AST format to delta format\n   */\n  abstract astToDelta(\n    ast: AST,\n    options?: unknown\n  ): DeltaInsert<TextAttributes>[];\n\n  /**\n   * Convert delta format to AST format\n   */\n  abstract deltaToAST(\n    deltas: DeltaInsert<TextAttributes>[],\n    options?: unknown\n  ): AST[];\n}\n\nexport type InlineDeltaMatcher<TNode extends object = never> = {\n  name: keyof AffineTextAttributes | string;\n  match: (delta: DeltaInsert<AffineTextAttributes>) => boolean;\n  toAST: (\n    delta: DeltaInsert<AffineTextAttributes>,\n    context: {\n      configs: Map<string, string>;\n      current: TNode;\n    }\n  ) => TNode;\n};\n\nexport type ASTToDeltaMatcher<AST> = {\n  name: string;\n  match: (ast: AST) => boolean;\n  toDelta: (\n    ast: AST,\n    context: {\n      configs: Map<string, string>;\n      options: DeltaASTConverterOptions;\n      toDelta: (\n        ast: AST,\n        options?: DeltaASTConverterOptions\n      ) => DeltaInsert<AffineTextAttributes>[];\n    }\n  ) => DeltaInsert<AffineTextAttributes>[];\n};\n"]}