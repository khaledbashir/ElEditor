{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../src/adapters/notion-html.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DeltaInsert } from '@blocksuite/inline';\n\nimport { ListBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockNotionHtmlAdapterExtension,\n  type BlockNotionHtmlAdapterMatcher,\n  HastUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\n\nconst listBlockMatchTags = ['ul', 'ol', 'li'];\n\nexport const listBlockNotionHtmlAdapterMatcher: BlockNotionHtmlAdapterMatcher =\n  {\n    flavour: ListBlockSchema.model.flavour,\n    toMatch: o =>\n      HastUtils.isElement(o.node) &&\n      listBlockMatchTags.includes(o.node.tagName),\n    fromMatch: () => false,\n    toBlockSnapshot: {\n      enter: (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n\n        const { walkerContext, pageMap, deltaConverter } = context;\n        switch (o.node.tagName) {\n          case 'ul':\n          case 'ol': {\n            walkerContext.setNodeContext('hast:list:type', 'bulleted');\n            if (o.node.tagName === 'ol') {\n              walkerContext.setNodeContext('hast:list:type', 'numbered');\n            } else if (Array.isArray(o.node.properties?.className)) {\n              if (o.node.properties.className.includes('to-do-list')) {\n                walkerContext.setNodeContext('hast:list:type', 'todo');\n              } else if (o.node.properties.className.includes('toggle')) {\n                walkerContext.setNodeContext('hast:list:type', 'toggle');\n              } else if (\n                o.node.properties.className.includes('bulleted-list')\n              ) {\n                walkerContext.setNodeContext('hast:list:type', 'bulleted');\n              }\n            }\n            break;\n          }\n          case 'li': {\n            const firstElementChild = HastUtils.getElementChildren(o.node)[0];\n            const notionListType =\n              walkerContext.getNodeContext('hast:list:type');\n            const listType =\n              notionListType === 'toggle' ? 'bulleted' : notionListType;\n            let delta: DeltaInsert[] = [];\n            if (notionListType === 'toggle') {\n              delta = deltaConverter.astToDelta(\n                HastUtils.querySelector(o.node, 'summary') ?? o.node,\n                { pageMap }\n              );\n            } else if (notionListType === 'todo') {\n              delta = deltaConverter.astToDelta(o.node, { pageMap });\n            } else {\n              delta = deltaConverter.astToDelta(\n                HastUtils.getInlineOnlyElementAST(o.node),\n                {\n                  pageMap,\n                }\n              );\n            }\n            walkerContext.openNode(\n              {\n                type: 'block',\n                id: nanoid(),\n                flavour: 'affine:list',\n                props: {\n                  type: listType,\n                  text: {\n                    '$blocksuite:internal:text$': true,\n                    delta,\n                  },\n                  checked:\n                    notionListType === 'todo'\n                      ? firstElementChild &&\n                        Array.isArray(\n                          firstElementChild.properties?.className\n                        ) &&\n                        firstElementChild.properties.className.includes(\n                          'checkbox-on'\n                        )\n                      : false,\n                  collapsed:\n                    notionListType === 'toggle'\n                      ? firstElementChild &&\n                        firstElementChild.tagName === 'details' &&\n                        firstElementChild.properties.open === undefined\n                      : false,\n                },\n                children: [],\n              },\n              'children'\n            );\n            break;\n          }\n        }\n      },\n      leave: (o, context) => {\n        const { walkerContext } = context;\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        if (o.node.tagName === 'li') {\n          walkerContext.closeNode();\n        }\n      },\n    },\n    fromBlockSnapshot: {},\n  };\n\nexport const ListBlockNotionHtmlAdapterExtension =\n  BlockNotionHtmlAdapterExtension(listBlockNotionHtmlAdapterMatcher);\n"]}