{"version":3,"file":"html.js","sourceRoot":"","sources":["../../src/adapters/html.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,eAAe,EAAE,MAAM,0BAA0B,CAAC;AAC3D,OAAO,EACL,yBAAyB,EAEzB,SAAS,EACT,SAAS,GACV,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EAAE,MAAM,EAAE,MAAM,mBAAmB,CAAC;AAE3C,MAAM,CAAC,MAAM,2BAA2B,GAA4B;IAClE,OAAO,EAAE,eAAe,CAAC,KAAK,CAAC,OAAO;IACtC,OAAO,EAAE,CAAC,CAAC,EAAE,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,OAAO,KAAK,IAAI;IACpE,SAAS,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,KAAK,eAAe,CAAC,KAAK,CAAC,OAAO;IAChE,eAAe,EAAE;QACf,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;gBACjC,OAAO;YACT,CAAC;YAED,MAAM,UAAU,GAAG,CAAC,CAAC,MAAM,EAAE,IAAe,CAAC;YAC7C,IAAI,QAAQ,GAAG,UAAU,CAAC;YAC1B,IAAI,UAAU,CAAC,OAAO,KAAK,IAAI,EAAE,CAAC;gBAChC,QAAQ,GAAG,UAAU,CAAC;YACxB,CAAC;iBAAM,IAAI,KAAK,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,EAAE,SAAS,CAAC,EAAE,CAAC;gBAC3D,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,YAAY,CAAC,EAAE,CAAC;oBAC3D,QAAQ,GAAG,MAAM,CAAC;gBACpB,CAAC;qBAAM,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC;oBAC9D,QAAQ,GAAG,QAAQ,CAAC;gBACtB,CAAC;qBAAM,IAAI,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC;oBACrE,QAAQ,GAAG,UAAU,CAAC;gBACxB,CAAC;YACH,CAAC;YAED,MAAM,UAAU,GACd,OAAO,UAAU,CAAC,UAAU,CAAC,KAAK,KAAK,QAAQ;gBAC7C,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC,KAAK,GAAG,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC;gBACnE,CAAC,CAAC,IAAI,CAAC;YACX,MAAM,iBAAiB,GAAG,SAAS,CAAC,kBAAkB,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;YAClE,CAAC,CAAC,IAAI,GAAG,SAAS,CAAC,SAAS,CAC1B,CAAC,CAAC,IAAI,EACN,OAAO,CAAC,EAAE,CAAC,OAAO,KAAK,KAAK,IAAI,OAAO,KAAK,GAAG,CACrC,CAAC;YAEb,MAAM,EAAE,aAAa,EAAE,cAAc,EAAE,GAAG,OAAO,CAAC;YAClD,aAAa,CAAC,QAAQ,CACpB;gBACE,IAAI,EAAE,OAAO;gBACb,EAAE,EAAE,MAAM,EAAE;gBACZ,OAAO,EAAE,aAAa;gBACtB,KAAK,EAAE;oBACL,IAAI,EAAE,QAAQ;oBACd,IAAI,EAAE;wBACJ,4BAA4B,EAAE,IAAI;wBAClC,KAAK,EACH,QAAQ,KAAK,QAAQ;4BACnB,CAAC,CAAC,cAAc,CAAC,UAAU,CACvB,SAAS,CAAC,uBAAuB,CAAC,CAAC,CAAC,IAAI,CAAC,CAC1C;4BACH,CAAC,CAAC,cAAc,CAAC,UAAU,CACvB,SAAS,CAAC,aAAa,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,IAAI,CAAC,CAAC,IAAI,CACrD;qBACR;oBACD,OAAO,EACL,QAAQ,KAAK,MAAM;wBACjB,CAAC,CAAC,iBAAiB;4BACjB,KAAK,CAAC,OAAO,CAAC,iBAAiB,CAAC,UAAU,EAAE,SAAS,CAAC;4BACtD,iBAAiB,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,aAAa,CAAC;wBAChE,CAAC,CAAC,KAAK;oBACX,SAAS,EACP,QAAQ,KAAK,QAAQ;wBACnB,CAAC,CAAC,iBAAiB;4BACjB,iBAAiB,CAAC,OAAO,KAAK,SAAS;4BACvC,iBAAiB,CAAC,UAAU,CAAC,IAAI,KAAK,SAAS;wBACjD,CAAC,CAAC,KAAK;oBACX,KAAK,EAAE,UAAU;iBAClB;gBACD,QAAQ,EAAE,EAAE;aACb,EACD,UAAU,CACX,CAAC;QACJ,CAAC;QACD,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,aAAa,CAAC,SAAS,EAAE,CAAC;QAC5B,CAAC;KACF;IACD,iBAAiB,EAAE;QACjB,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,IAAI,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,IAAI,EAAE,KAAK,EAAE,EAAE,EAAE,CAE/C,CAAC;YACF,MAAM,EAAE,cAAc,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClD,MAAM,YAAY,GAAG,aAAa,CAAC,WAAW,EAAE,CAAC;YACjD,MAAM,UAAU,GAAG,cAAc,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACzD,IAAI,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;gBACjC,UAAU,CAAC,OAAO,CAAC;oBACjB,IAAI,EAAE,SAAS;oBACf,OAAO,EAAE,OAAO;oBAChB,UAAU,EAAE;wBACV,IAAI,EAAE,UAAU;wBAChB,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,OAAkB;qBACzC;oBACD,QAAQ,EAAE;wBACR;4BACE,IAAI,EAAE,SAAS;4BACf,OAAO,EAAE,OAAO;4BAChB,UAAU,EAAE;gCACV,KAAK,EAAE,oBAAoB;6BAC5B;4BACD,QAAQ,EAAE,EAAE;yBACb;qBACF;iBACF,CAAC,CAAC;YACL,CAAC;YACD,wCAAwC;YACxC,IACE,aAAa,CAAC,cAAc,CAAC,oBAAoB,CAAC,KAAK,CAAC,CAAC,MAAM;gBAC/D,YAAY,CAAC,IAAI,KAAK,SAAS;gBAC/B,YAAY,CAAC,OAAO;oBAClB,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC;gBAClD,CAAC,CACC,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC,UAAU,CAAC,SAAS,CAAC;oBAChD,YAAY,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,CAAC,CACxD;oBACC,SAAS,CAAC,SAAS,CACjB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM;wBAC1B,CAAC,CAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,OAAmB;wBACnC,CAAC,CAAC,SAAS,CACd,EACH,CAAC;gBACD,yCAAyC;YAC3C,CAAC;iBAAM,CAAC;gBACN,8BAA8B;gBAC9B,aAAa,CAAC,QAAQ,CACpB;oBACE,IAAI,EAAE,SAAS;oBACf,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI;oBACvD,UAAU,EAAE;wBACV,KAAK,EACH,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM;4BAC1B,CAAC,CAAC,oDAAoD;4BACtD,CAAC,CAAC,IAAI;wBACV,SAAS,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,GAAG,OAAO,CAAC;qBACzC;oBACD,QAAQ,EAAE,EAAE;iBACb,EACD,UAAU,CACX,CAAC;gBACF,aAAa,CAAC,cAAc,CAAC,oBAAoB,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC;YAC/D,CAAC;YAED,aAAa,CAAC,QAAQ,CACpB;gBACE,IAAI,EAAE,SAAS;gBACf,OAAO,EAAE,IAAI;gBACb,UAAU,EAAE;oBACV,SAAS,EAAE,CAAC,6BAA6B,CAAC;iBAC3C;gBACD,QAAQ,EAAE,UAAU;aACrB,EACD,UAAU,CACX,CAAC;QACJ,CAAC;QACD,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,MAAM,YAAY,GAAG,aAAa,CAAC,WAAW,EAAa,CAAC;YAC5D,MAAM,aAAa,GAAG,aAAa,CAAC,YAAY,EAAa,CAAC;YAC9D,IACE,aAAa,CAAC,sBAAsB,CAAC,oBAAoB,CAAC;gBACxD,CAAC,CAAC,MAAM;gBACV,YAAY,CAAC,OAAO,KAAK,IAAI;gBAC7B,aAAa,CAAC,OAAO;oBACnB,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC;gBAClD,CAAC,CACC,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,UAAU,CAAC,SAAS,CAAC;oBACjD,aAAa,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,CAAC,CACzD;oBACC,SAAS,CAAC,SAAS,CACjB,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,MAAM;wBAC1B,CAAC,CAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,OAAmB;wBACnC,CAAC,CAAC,SAAS,CACd,EACH,CAAC;gBACD,aAAa,CAAC,SAAS,EAAE,CAAC;gBAC1B,IACE,CAAC,CAAC,IAAI,EAAE,OAAO,KAAK,aAAa;oBACjC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EACvC,CAAC;oBACD,2EAA2E;oBAC3E,aAAa,CAAC,SAAS,EAAE,CAAC;gBAC5B,CAAC;YACH,CAAC;iBAAM,CAAC;gBACN,aAAa,CAAC,SAAS,EAAE,CAAC,SAAS,EAAE,CAAC;YACxC,CAAC;QACH,CAAC;KACF;CACF,CAAC;AAEF,MAAM,CAAC,MAAM,6BAA6B,GAAG,yBAAyB,CACpE,2BAA2B,CAC5B,CAAC","sourcesContent":["import type { DeltaInsert } from '@blocksuite/inline';\nimport type { Element } from 'hast';\n\nimport { ListBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockHtmlAdapterExtension,\n  type BlockHtmlAdapterMatcher,\n  HastUtils,\n  TextUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\n\nexport const listBlockHtmlAdapterMatcher: BlockHtmlAdapterMatcher = {\n  flavour: ListBlockSchema.model.flavour,\n  toMatch: o => HastUtils.isElement(o.node) && o.node.tagName === 'li',\n  fromMatch: o => o.node.flavour === ListBlockSchema.model.flavour,\n  toBlockSnapshot: {\n    enter: (o, context) => {\n      if (!HastUtils.isElement(o.node)) {\n        return;\n      }\n\n      const parentList = o.parent?.node as Element;\n      let listType = 'bulleted';\n      if (parentList.tagName === 'ol') {\n        listType = 'numbered';\n      } else if (Array.isArray(parentList.properties?.className)) {\n        if (parentList.properties.className.includes('to-do-list')) {\n          listType = 'todo';\n        } else if (parentList.properties.className.includes('toggle')) {\n          listType = 'toggle';\n        } else if (parentList.properties.className.includes('bulleted-list')) {\n          listType = 'bulleted';\n        }\n      }\n\n      const listNumber =\n        typeof parentList.properties.start === 'number'\n          ? parentList.properties.start + parentList.children.indexOf(o.node)\n          : null;\n      const firstElementChild = HastUtils.getElementChildren(o.node)[0];\n      o.node = HastUtils.flatNodes(\n        o.node,\n        tagName => tagName === 'div' || tagName === 'p'\n      ) as Element;\n\n      const { walkerContext, deltaConverter } = context;\n      walkerContext.openNode(\n        {\n          type: 'block',\n          id: nanoid(),\n          flavour: 'affine:list',\n          props: {\n            type: listType,\n            text: {\n              '$blocksuite:internal:text$': true,\n              delta:\n                listType !== 'toggle'\n                  ? deltaConverter.astToDelta(\n                      HastUtils.getInlineOnlyElementAST(o.node)\n                    )\n                  : deltaConverter.astToDelta(\n                      HastUtils.querySelector(o.node, 'summary') ?? o.node\n                    ),\n            },\n            checked:\n              listType === 'todo'\n                ? firstElementChild &&\n                  Array.isArray(firstElementChild.properties?.className) &&\n                  firstElementChild.properties.className.includes('checkbox-on')\n                : false,\n            collapsed:\n              listType === 'toggle'\n                ? firstElementChild &&\n                  firstElementChild.tagName === 'details' &&\n                  firstElementChild.properties.open === undefined\n                : false,\n            order: listNumber,\n          },\n          children: [],\n        },\n        'children'\n      );\n    },\n    leave: (_, context) => {\n      const { walkerContext } = context;\n      walkerContext.closeNode();\n    },\n  },\n  fromBlockSnapshot: {\n    enter: (o, context) => {\n      const text = (o.node.props.text ?? { delta: [] }) as {\n        delta: DeltaInsert[];\n      };\n      const { deltaConverter, walkerContext } = context;\n      const currentTNode = walkerContext.currentNode();\n      const liChildren = deltaConverter.deltaToAST(text.delta);\n      if (o.node.props.type === 'todo') {\n        liChildren.unshift({\n          type: 'element',\n          tagName: 'input',\n          properties: {\n            type: 'checkbox',\n            checked: o.node.props.checked as boolean,\n          },\n          children: [\n            {\n              type: 'element',\n              tagName: 'label',\n              properties: {\n                style: 'margin-right: 3px;',\n              },\n              children: [],\n            },\n          ],\n        });\n      }\n      // check if the list is of the same type\n      if (\n        walkerContext.getNodeContext('affine:list:parent') === o.parent &&\n        currentTNode.type === 'element' &&\n        currentTNode.tagName ===\n          (o.node.props.type === 'numbered' ? 'ol' : 'ul') &&\n        !(\n          Array.isArray(currentTNode.properties.className) &&\n          currentTNode.properties.className.includes('todo-list')\n        ) ===\n          TextUtils.isNullish(\n            o.node.props.type === 'todo'\n              ? (o.node.props.checked as boolean)\n              : undefined\n          )\n      ) {\n        // if true, add the list item to the list\n      } else {\n        // if false, create a new list\n        walkerContext.openNode(\n          {\n            type: 'element',\n            tagName: o.node.props.type === 'numbered' ? 'ol' : 'ul',\n            properties: {\n              style:\n                o.node.props.type === 'todo'\n                  ? 'list-style-type: none; padding-inline-start: 18px;'\n                  : null,\n              className: [o.node.props.type + '-list'],\n            },\n            children: [],\n          },\n          'children'\n        );\n        walkerContext.setNodeContext('affine:list:parent', o.parent);\n      }\n\n      walkerContext.openNode(\n        {\n          type: 'element',\n          tagName: 'li',\n          properties: {\n            className: ['affine-list-block-container'],\n          },\n          children: liChildren,\n        },\n        'children'\n      );\n    },\n    leave: (o, context) => {\n      const { walkerContext } = context;\n      const currentTNode = walkerContext.currentNode() as Element;\n      const previousTNode = walkerContext.previousNode() as Element;\n      if (\n        walkerContext.getPreviousNodeContext('affine:list:parent') ===\n          o.parent &&\n        currentTNode.tagName === 'li' &&\n        previousTNode.tagName ===\n          (o.node.props.type === 'numbered' ? 'ol' : 'ul') &&\n        !(\n          Array.isArray(previousTNode.properties.className) &&\n          previousTNode.properties.className.includes('todo-list')\n        ) ===\n          TextUtils.isNullish(\n            o.node.props.type === 'todo'\n              ? (o.node.props.checked as boolean)\n              : undefined\n          )\n      ) {\n        walkerContext.closeNode();\n        if (\n          o.next?.flavour !== 'affine:list' ||\n          o.next.props.type !== o.node.props.type\n        ) {\n          // If the next node is not a list or different type of list, close the list\n          walkerContext.closeNode();\n        }\n      } else {\n        walkerContext.closeNode().closeNode();\n      }\n    },\n  },\n};\n\nexport const ListBlockHtmlAdapterExtension = BlockHtmlAdapterExtension(\n  listBlockHtmlAdapterMatcher\n);\n"]}