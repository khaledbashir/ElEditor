{"version":3,"file":"list-block.js","sourceRoot":"","sources":["../src/list-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ListBlockModel } from '@blocksuite/affine-model';\nimport type { BaseSelection, BlockComponent } from '@blocksuite/block-std';\nimport type { InlineRangeProvider } from '@blocksuite/inline';\n\nimport { CaptionedBlockComponent } from '@blocksuite/affine-components/caption';\nimport { playCheckAnimation } from '@blocksuite/affine-components/icons';\nimport {\n  DefaultInlineManagerExtension,\n  type RichText,\n} from '@blocksuite/affine-components/rich-text';\nimport '@blocksuite/affine-shared/commands';\nimport { TOGGLE_BUTTON_PARENT_CLASS } from '@blocksuite/affine-components/toggle-button';\nimport {\n  BLOCK_CHILDREN_CONTAINER_PADDING_LEFT,\n  NOTE_SELECTOR,\n} from '@blocksuite/affine-shared/consts';\nimport { DocModeProvider } from '@blocksuite/affine-shared/services';\nimport { getViewportElement } from '@blocksuite/affine-shared/utils';\nimport { getInlineRangeProvider } from '@blocksuite/block-std';\nimport { effect } from '@preact/signals-core';\nimport { html, nothing, type TemplateResult } from 'lit';\nimport { query, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { ListBlockService } from './list-service.js';\n\nimport { correctNumberedListsOrderToPrev } from './commands/utils.js';\nimport { listBlockStyles } from './styles.js';\nimport { getListIcon } from './utils/get-list-icon.js';\n\nexport class ListBlockComponent extends CaptionedBlockComponent<\n  ListBlockModel,\n  ListBlockService\n> {\n  static override styles = listBlockStyles;\n\n  private _inlineRangeProvider: InlineRangeProvider | null = null;\n\n  private _onClickIcon = (e: MouseEvent) => {\n    e.stopPropagation();\n\n    if (this.model.type === 'toggle') {\n      if (this.doc.readonly) {\n        this._readonlyCollapsed = !this._readonlyCollapsed;\n      } else {\n        this.doc.captureSync();\n        this.doc.updateBlock(this.model, {\n          collapsed: !this.model.collapsed,\n        });\n      }\n\n      return;\n    } else if (this.model.type === 'todo') {\n      if (this.doc.readonly) return;\n\n      this.doc.captureSync();\n      const checkedPropObj = { checked: !this.model.checked };\n      this.doc.updateBlock(this.model, checkedPropObj);\n      if (this.model.checked) {\n        const checkEl = this.querySelector('.affine-list-block__todo-prefix');\n        if (checkEl) {\n          playCheckAnimation(checkEl).catch(console.error);\n        }\n      }\n      return;\n    }\n    this._select();\n  };\n\n  get attributeRenderer() {\n    return this.inlineManager.getRenderer();\n  }\n\n  get attributesSchema() {\n    return this.inlineManager.getSchema();\n  }\n\n  get embedChecker() {\n    return this.inlineManager.embedChecker;\n  }\n\n  get inlineManager() {\n    return this.std.get(DefaultInlineManagerExtension.identifier);\n  }\n\n  get markdownShortcutHandler() {\n    return this.inlineManager.markdownShortcutHandler;\n  }\n\n  override get topContenteditableElement() {\n    if (this.std.get(DocModeProvider).getEditorMode() === 'edgeless') {\n      return this.closest<BlockComponent>(NOTE_SELECTOR);\n    }\n    return this.rootComponent;\n  }\n\n  private _select() {\n    const selection = this.host.selection;\n    selection.update(selList => {\n      return selList\n        .filter<BaseSelection>(sel => !sel.is('text') && !sel.is('block'))\n        .concat(selection.create('block', { blockId: this.blockId }));\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._inlineRangeProvider = getInlineRangeProvider(this);\n\n    this.disposables.add(\n      effect(() => {\n        const collapsed = this.model.collapsed$.value;\n        this._readonlyCollapsed = collapsed;\n      })\n    );\n\n    this.disposables.add(\n      effect(() => {\n        const type = this.model.type$.value;\n        const order = this.model.order$.value;\n        // old numbered list has no order\n        if (type === 'numbered' && !Number.isInteger(order)) {\n          correctNumberedListsOrderToPrev(this.doc, this.model, false);\n        }\n        // if list is not numbered, order should be null\n        if (type !== 'numbered' && order !== null) {\n          this.model.order = null;\n        }\n      })\n    );\n  }\n\n  override async getUpdateComplete() {\n    const result = await super.getUpdateComplete();\n    await this._richTextElement?.updateComplete;\n    return result;\n  }\n\n  override renderBlock(): TemplateResult<1> {\n    const { model, _onClickIcon } = this;\n    const collapsed = this.doc.readonly\n      ? this._readonlyCollapsed\n      : model.collapsed;\n\n    const listIcon = getListIcon(model, !collapsed, _onClickIcon);\n\n    const children = html`<div\n      class=\"affine-block-children-container\"\n      style=${styleMap({\n        paddingLeft: `${BLOCK_CHILDREN_CONTAINER_PADDING_LEFT}px`,\n        display: collapsed ? 'none' : undefined,\n      })}\n    >\n      ${this.renderChildren(this.model)}\n    </div>`;\n\n    return html`\n      <div class=${'affine-list-block-container'}>\n        <div\n          class=${classMap({\n            'affine-list-rich-text-wrapper': true,\n            'affine-list--checked':\n              this.model.type === 'todo' && this.model.checked,\n            [TOGGLE_BUTTON_PARENT_CLASS]: true,\n          })}\n        >\n          ${this.model.children.length > 0\n            ? html`\n                <blocksuite-toggle-button\n                  .collapsed=${collapsed}\n                  .updateCollapsed=${(value: boolean) => {\n                    if (this.doc.readonly) {\n                      this._readonlyCollapsed = value;\n                    } else {\n                      this.doc.captureSync();\n                      this.doc.updateBlock(this.model, {\n                        collapsed: value,\n                      });\n                    }\n                  }}\n                ></blocksuite-toggle-button>\n              `\n            : nothing}\n          ${listIcon}\n          <rich-text\n            .yText=${this.model.text.yText}\n            .inlineEventSource=${this.topContenteditableElement ?? nothing}\n            .undoManager=${this.doc.history}\n            .attributeRenderer=${this.attributeRenderer}\n            .attributesSchema=${this.attributesSchema}\n            .markdownShortcutHandler=${this.markdownShortcutHandler}\n            .embedChecker=${this.embedChecker}\n            .readonly=${this.doc.readonly}\n            .inlineRangeProvider=${this._inlineRangeProvider}\n            .enableClipboard=${false}\n            .enableUndoRedo=${false}\n            .verticalScrollContainerGetter=${() =>\n              getViewportElement(this.host)}\n          ></rich-text>\n        </div>\n\n        ${children}\n      </div>\n    `;\n  }\n\n  @state()\n  private accessor _readonlyCollapsed = false;\n\n  @query('rich-text')\n  private accessor _richTextElement: RichText | null = null;\n\n  override accessor blockContainerStyles = {\n    margin: 'var(--affine-list-margin, 10px 0)',\n  };\n}\n"]}