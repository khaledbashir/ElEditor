{"version":3,"file":"delta.js","sourceRoot":"","sources":["../../src/services/delta.ts"],"names":[],"mappings":"AAIA,OAAO,EAAE,4BAA4B,EAAE,MAAM,mBAAmB,CAAC;AAEjE,MAAM,OAAO,YAAY;IA4IvB,IAAI,WAAW;QACb,OAAO,4BAA4B,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;IAC5E,CAAC;IAED,YAAqB,MAAoC;QAApC,WAAM,GAAN,MAAM,CAA8B;QA/IzD;;;;;;;;;;;;;;;;;;;;;;;;WAwBG;QACH,yBAAoB,GAAG,CAAC,UAAkB,EAAE,EAAE;YAC5C,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YAEvC,IAAI,KAAK,GAAG,CAAC,CAAC;YACd,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;gBAC3B,IAAI,KAAK,GAAG,KAAK,CAAC,MAAM,CAAC,MAAM,IAAI,UAAU,EAAE,CAAC;oBAC9C,OAAO,KAAK,CAAC;gBACf,CAAC;gBACD,KAAK,IAAI,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC;YAC/B,CAAC;YAED,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;QAEF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;WAuDG;QACH,2BAAsB,GAAG,CACvB,WAAwB,EACM,EAAE;YAChC,OAAO,IAAI,CAAC,sBAAsB,CAChC,WAAW,EACX,CAAC,KAAK,EAAE,KAAK,EAA8B,EAAE,CAAC;gBAC5C,KAAK;gBACL,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE;aACvC,CACF,CAAC;QACJ,CAAC,CAAC;QAEF,2BAAsB,GAAG,CACvB,WAAwB,EACxB,QAIW,EACX,EAAE;YACF,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YACvC,MAAM,MAAM,GAAa,EAAE,CAAC;YAE5B,MAAM,CAAC,MAAM,CAAC,CAAC,UAAU,EAAE,KAAK,EAAE,UAAU,EAAE,EAAE;gBAC9C,MAAM,MAAM,GAAG,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC;gBACnC,MAAM,IAAI,GAAG,WAAW,CAAC,KAAK,GAAG,MAAM,CAAC;gBACxC,MAAM,EAAE,GAAG,WAAW,CAAC,KAAK,GAAG,WAAW,CAAC,MAAM,CAAC;gBAElD,MAAM,YAAY,GAChB,UAAU,IAAI,IAAI;oBAClB,CAAC,UAAU,GAAG,EAAE;wBACd,CAAC,WAAW,CAAC,MAAM,KAAK,CAAC,IAAI,UAAU,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC;gBAEpE,IAAI,YAAY,EAAE,CAAC;oBACjB,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,EAAE,UAAU,EAAE,UAAU,CAAC,CAAC;oBACtD,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;gBACrB,CAAC;gBAED,OAAO,UAAU,GAAG,MAAM,CAAC;YAC7B,CAAC,EAAE,CAAC,CAAC,CAAC;YAEN,OAAO,MAAM,CAAC;QAChB,CAAC,CAAC;IAM0D,CAAC;CAC9D","sourcesContent":["import type { InlineEditor } from '../inline-editor.js';\nimport type { DeltaEntry, DeltaInsert, InlineRange } from '../types.js';\nimport type { BaseTextAttributes } from '../utils/index.js';\n\nimport { transformDeltasToEmbedDeltas } from '../utils/index.js';\n\nexport class DeltaService<TextAttributes extends BaseTextAttributes> {\n  /**\n   * Here are examples of how this function computes and gets the delta.\n   *\n   * We have such a text:\n   * ```\n   * [\n   *   {\n   *      insert: 'aaa',\n   *      attributes: { bold: true },\n   *   },\n   *   {\n   *      insert: 'bbb',\n   *      attributes: { italic: true },\n   *   },\n   * ]\n   * ```\n   *\n   * `getDeltaByRangeIndex(0)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(1)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(3)` returns `{ insert: 'aaa', attributes: { bold: true } }`.\n   *\n   * `getDeltaByRangeIndex(4)` returns `{ insert: 'bbb', attributes: { italic: true } }`.\n   */\n  getDeltaByRangeIndex = (rangeIndex: number) => {\n    const deltas = this.editor.embedDeltas;\n\n    let index = 0;\n    for (const delta of deltas) {\n      if (index + delta.insert.length >= rangeIndex) {\n        return delta;\n      }\n      index += delta.insert.length;\n    }\n\n    return null;\n  };\n\n  /**\n   * Here are examples of how this function computes and gets the deltas.\n   *\n   * We have such a text:\n   * ```\n   * [\n   *   {\n   *      insert: 'aaa',\n   *      attributes: { bold: true },\n   *   },\n   *   {\n   *      insert: 'bbb',\n   *      attributes: { italic: true },\n   *   },\n   *   {\n   *      insert: 'ccc',\n   *      attributes: { underline: true },\n   *   },\n   * ]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 0 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 1 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 0, length: 4 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 3, length: 1 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   * `getDeltasByInlineRange({ index: 3, length: 3 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }]]\n   * ```\n   *\n   *  `getDeltasByInlineRange({ index: 3, length: 4 })` returns\n   * ```\n   * [{ insert: 'aaa', attributes: { bold: true }, }, { index: 0, length: 3, }],\n   *  [{ insert: 'bbb', attributes: { italic: true }, }, { index: 3, length: 3, }],\n   *  [{ insert: 'ccc', attributes: { underline: true }, }, { index: 6, length: 3, }]]\n   * ```\n   */\n  getDeltasByInlineRange = (\n    inlineRange: InlineRange\n  ): DeltaEntry<TextAttributes>[] => {\n    return this.mapDeltasInInlineRange(\n      inlineRange,\n      (delta, index): DeltaEntry<TextAttributes> => [\n        delta,\n        { index, length: delta.insert.length },\n      ]\n    );\n  };\n\n  mapDeltasInInlineRange = <Result>(\n    inlineRange: InlineRange,\n    callback: (\n      delta: DeltaInsert<TextAttributes>,\n      rangeIndex: number,\n      deltaIndex: number\n    ) => Result\n  ) => {\n    const deltas = this.editor.embedDeltas;\n    const result: Result[] = [];\n\n    deltas.reduce((rangeIndex, delta, deltaIndex) => {\n      const length = delta.insert.length;\n      const from = inlineRange.index - length;\n      const to = inlineRange.index + inlineRange.length;\n\n      const deltaInRange =\n        rangeIndex >= from &&\n        (rangeIndex < to ||\n          (inlineRange.length === 0 && rangeIndex === inlineRange.index));\n\n      if (deltaInRange) {\n        const value = callback(delta, rangeIndex, deltaIndex);\n        result.push(value);\n      }\n\n      return rangeIndex + length;\n    }, 0);\n\n    return result;\n  };\n\n  get embedDeltas() {\n    return transformDeltasToEmbedDeltas(this.editor, this.editor.yTextDeltas);\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n"]}