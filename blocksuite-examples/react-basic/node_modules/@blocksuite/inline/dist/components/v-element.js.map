{"version":3,"file":"v-element.js","sourceRoot":"","sources":["../../src/components/v-element.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { DisposableGroup, SignalWatcher } from '@blocksuite/global/utils';\nimport { effect, signal } from '@preact/signals-core';\nimport { html, LitElement } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { InlineEditor } from '../inline-editor.js';\nimport type { DeltaInsert } from '../types.js';\nimport type { BaseTextAttributes } from '../utils/base-attributes.js';\n\nimport { ZERO_WIDTH_SPACE } from '../consts.js';\nimport { isInlineRangeIntersect } from '../utils/inline-range.js';\n\nexport class VElement<\n  T extends BaseTextAttributes = BaseTextAttributes,\n> extends SignalWatcher(LitElement) {\n  readonly disposables = new DisposableGroup();\n\n  readonly selected = signal(false);\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    this.disposables.add(\n      effect(() => {\n        const inlineRange = this.inlineEditor.inlineRange$.value;\n        this.selected.value =\n          !!inlineRange &&\n          isInlineRangeIntersect(inlineRange, {\n            index: this.startOffset,\n            length: this.endOffset - this.startOffset,\n          });\n      })\n    );\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    const span = this.querySelector('[data-v-element=\"true\"]') as HTMLElement;\n    const el = span.firstElementChild as LitElement;\n    await el.updateComplete;\n    const vTexts = Array.from(this.querySelectorAll('v-text'));\n    await Promise.all(vTexts.map(vText => vText.updateComplete));\n    return result;\n  }\n\n  override render() {\n    const inlineEditor = this.inlineEditor;\n    const attributeRenderer = inlineEditor.attributeService.attributeRenderer;\n    const renderProps: Parameters<typeof attributeRenderer>[0] = {\n      delta: this.delta,\n      selected: this.selected.value,\n      startOffset: this.startOffset,\n      endOffset: this.endOffset,\n      lineIndex: this.lineIndex,\n      editor: inlineEditor,\n    };\n\n    const isEmbed = inlineEditor.isEmbed(this.delta);\n    if (isEmbed) {\n      if (this.delta.insert.length !== 1) {\n        throw new BlockSuiteError(\n          ErrorCode.InlineEditorError,\n          `The length of embed node should only be 1.\n          This seems to be an internal issue with inline editor.\n          Please go to https://github.com/toeverything/blocksuite/issues\n          to report it.`\n        );\n      }\n\n      return html`<span\n        data-v-embed=\"true\"\n        data-v-element=\"true\"\n        contenteditable=\"false\"\n        style=${styleMap({ userSelect: 'none' })}\n        >${attributeRenderer(renderProps)}</span\n      >`;\n    }\n\n    // we need to avoid \\n appearing before and after the span element, which will\n    // cause the unexpected space\n    return html`<span data-v-element=\"true\"\n      >${attributeRenderer(renderProps)}</span\n    >`;\n  }\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<T> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n\n  @property({ attribute: false })\n  accessor endOffset!: number;\n\n  @property({ attribute: false })\n  accessor inlineEditor!: InlineEditor;\n\n  @property({ attribute: false })\n  accessor lineIndex!: number;\n\n  @property({ attribute: false })\n  accessor startOffset!: number;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'v-element': VElement;\n  }\n}\n"]}