{"version":3,"file":"job.js","sourceRoot":"","sources":["../../src/transformer/job.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { nextTick, Slot } from '@blocksuite/global/utils';\n\nimport type { BlockModel, BlockSchemaType } from '../schema/index.js';\nimport type { Doc, DocCollection, DocMeta } from '../store/index.js';\nimport type { DraftModel } from './draft.js';\nimport type {\n  BeforeExportPayload,\n  BeforeImportPayload,\n  FinalPayload,\n  JobMiddleware,\n  JobSlots,\n} from './middleware.js';\nimport type {\n  BlockSnapshot,\n  CollectionInfoSnapshot,\n  DocSnapshot,\n  SliceSnapshot,\n} from './type.js';\n\nimport { AssetsManager } from './assets.js';\nimport { BaseBlockTransformer } from './base.js';\nimport { Slice } from './slice.js';\nimport {\n  BlockSnapshotSchema,\n  CollectionInfoSnapshotSchema,\n  DocSnapshotSchema,\n  SliceSnapshotSchema,\n} from './type.js';\n\nexport type JobConfig = {\n  collection: DocCollection;\n  middlewares?: JobMiddleware[];\n};\n\ninterface FlatSnapshot {\n  snapshot: BlockSnapshot;\n  parentId?: string;\n  index?: number;\n}\n\ninterface DraftBlockTreeNode {\n  draft: DraftModel;\n  snapshot: BlockSnapshot;\n  children: Array<DraftBlockTreeNode>;\n}\n\n// The number of blocks to insert in one batch\nconst BATCH_SIZE = 100;\n\nexport class Job {\n  private readonly _adapterConfigs = new Map<string, string>();\n\n  private readonly _assetsManager: AssetsManager;\n\n  private readonly _collection: DocCollection;\n\n  private readonly _slots: JobSlots = {\n    beforeImport: new Slot<BeforeImportPayload>(),\n    afterImport: new Slot<FinalPayload>(),\n    beforeExport: new Slot<BeforeExportPayload>(),\n    afterExport: new Slot<FinalPayload>(),\n  };\n\n  blockToSnapshot = (model: DraftModel): BlockSnapshot | undefined => {\n    try {\n      const snapshot = this._blockToSnapshot(model);\n      BlockSnapshotSchema.parse(snapshot);\n\n      return snapshot;\n    } catch (error) {\n      console.error(`Error when transforming block to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  collectionInfoToSnapshot = (): CollectionInfoSnapshot | undefined => {\n    try {\n      this._slots.beforeExport.emit({\n        type: 'info',\n      });\n      const collectionMeta = this._getCollectionMeta();\n      const snapshot: CollectionInfoSnapshot = {\n        type: 'info',\n        id: this._collection.id,\n        ...collectionMeta,\n      };\n      this._slots.afterExport.emit({\n        type: 'info',\n        snapshot,\n      });\n      CollectionInfoSnapshotSchema.parse(snapshot);\n\n      return snapshot;\n    } catch (error) {\n      console.error(`Error when transforming collection info to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  docToSnapshot = (doc: Doc): DocSnapshot | undefined => {\n    try {\n      this._slots.beforeExport.emit({\n        type: 'page',\n        page: doc,\n      });\n      const rootModel = doc.root;\n      const meta = this._exportDocMeta(doc);\n      if (!rootModel) {\n        throw new BlockSuiteError(\n          ErrorCode.TransformerError,\n          'Root block not found in doc'\n        );\n      }\n      const blocks = this.blockToSnapshot(rootModel);\n      if (!blocks) {\n        return;\n      }\n      const docSnapshot: DocSnapshot = {\n        type: 'page',\n        meta,\n        blocks,\n      };\n      this._slots.afterExport.emit({\n        type: 'page',\n        page: doc,\n        snapshot: docSnapshot,\n      });\n      DocSnapshotSchema.parse(docSnapshot);\n\n      return docSnapshot;\n    } catch (error) {\n      console.error(`Error when transforming doc to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  sliceToSnapshot = (slice: Slice): SliceSnapshot | undefined => {\n    try {\n      this._slots.beforeExport.emit({\n        type: 'slice',\n        slice,\n      });\n      const { content, pageId, workspaceId } = slice.data;\n      const contentSnapshot = [];\n      for (const block of content) {\n        const blockSnapshot = this.blockToSnapshot(block);\n        if (!blockSnapshot) {\n          return;\n        }\n        contentSnapshot.push(blockSnapshot);\n      }\n      const snapshot: SliceSnapshot = {\n        type: 'slice',\n        workspaceId,\n        pageId,\n        content: contentSnapshot,\n      };\n      this._slots.afterExport.emit({\n        type: 'slice',\n        slice,\n        snapshot,\n      });\n      SliceSnapshotSchema.parse(snapshot);\n\n      return snapshot;\n    } catch (error) {\n      console.error(`Error when transforming slice to snapshot:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToBlock = async (\n    snapshot: BlockSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ): Promise<BlockModel | undefined> => {\n    try {\n      BlockSnapshotSchema.parse(snapshot);\n      const model = await this._snapshotToBlock(snapshot, doc, parent, index);\n      if (!model) return;\n      return model;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to block:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToDoc = async (snapshot: DocSnapshot): Promise<Doc | undefined> => {\n    try {\n      this._slots.beforeImport.emit({\n        type: 'page',\n        snapshot,\n      });\n      DocSnapshotSchema.parse(snapshot);\n      const { meta, blocks } = snapshot;\n      const doc = this._collection.createDoc({ id: meta.id });\n      doc.load();\n      await this.snapshotToBlock(blocks, doc);\n      this._slots.afterImport.emit({\n        type: 'page',\n        snapshot,\n        page: doc,\n      });\n\n      return doc;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to doc:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToModelData = async (snapshot: BlockSnapshot) => {\n    try {\n      const { children, flavour, props, id } = snapshot;\n\n      const schema = this._getSchema(flavour);\n      const snapshotLeaf = {\n        id,\n        flavour,\n        props,\n      };\n      const transformer = this._getTransformer(schema);\n      const modelData = await transformer.fromSnapshot({\n        json: snapshotLeaf,\n        assets: this._assetsManager,\n        children,\n      });\n\n      return modelData;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to model data:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  snapshotToSlice = async (\n    snapshot: SliceSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ): Promise<Slice | undefined> => {\n    SliceSnapshotSchema.parse(snapshot);\n    try {\n      this._slots.beforeImport.emit({\n        type: 'slice',\n        snapshot,\n      });\n\n      const { content, workspaceId, pageId } = snapshot;\n\n      // Create a temporary root snapshot to encompass all content blocks\n      const tmpRootSnapshot: BlockSnapshot = {\n        id: 'temporary-root',\n        flavour: 'affine:page',\n        props: {},\n        type: 'block',\n        children: content,\n      };\n\n      for (const block of content) {\n        this._triggerBeforeImportEvent(block, parent, index);\n      }\n      const flatSnapshots: FlatSnapshot[] = [];\n      this._flattenSnapshot(tmpRootSnapshot, flatSnapshots, parent, index);\n\n      const blockTree = await this._convertFlatSnapshots(flatSnapshots);\n\n      await this._insertBlockTree(blockTree.children, doc, parent, index);\n\n      const contentBlocks = blockTree.children\n        .map(tree => doc.getBlockById(tree.draft.id))\n        .filter(Boolean) as DraftModel[];\n\n      const slice = new Slice({\n        content: contentBlocks,\n        workspaceId,\n        pageId,\n      });\n\n      this._slots.afterImport.emit({\n        type: 'slice',\n        snapshot,\n        slice,\n      });\n\n      return slice;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to slice:`);\n      console.error(error);\n      return;\n    }\n  };\n\n  walk = (snapshot: DocSnapshot, callback: (block: BlockSnapshot) => void) => {\n    const walk = (block: BlockSnapshot) => {\n      try {\n        callback(block);\n      } catch (error) {\n        console.error(`Error when walking snapshot:`);\n        console.error(error);\n      }\n\n      if (block.children) {\n        block.children.forEach(walk);\n      }\n    };\n\n    walk(snapshot.blocks);\n  };\n\n  get adapterConfigs() {\n    return this._adapterConfigs;\n  }\n\n  get assets() {\n    return this._assetsManager.getAssets();\n  }\n\n  get assetsManager() {\n    return this._assetsManager;\n  }\n\n  get collection() {\n    return this._collection;\n  }\n\n  constructor({ collection, middlewares = [] }: JobConfig) {\n    this._collection = collection;\n    this._assetsManager = new AssetsManager({ blob: collection.blobSync });\n\n    middlewares.forEach(middleware => {\n      middleware({\n        slots: this._slots,\n        assetsManager: this._assetsManager,\n        collection: this._collection,\n        adapterConfigs: this._adapterConfigs,\n      });\n    });\n  }\n\n  private _blockToSnapshot(model: DraftModel): BlockSnapshot {\n    this._slots.beforeExport.emit({\n      type: 'block',\n      model,\n    });\n    const schema = this._getSchema(model.flavour);\n    const transformer = this._getTransformer(schema);\n    const snapshotLeaf = transformer.toSnapshot({\n      model,\n      assets: this._assetsManager,\n    });\n    const children = model.children.map(child => {\n      return this._blockToSnapshot(child);\n    });\n    const snapshot: BlockSnapshot = {\n      type: 'block',\n      ...snapshotLeaf,\n      children,\n    };\n    this._slots.afterExport.emit({\n      type: 'block',\n      model,\n      snapshot,\n    });\n\n    return snapshot;\n  }\n\n  private async _convertFlatSnapshots(flatSnapshots: FlatSnapshot[]) {\n    // Phase 1: Convert snapshots to draft models in series\n    // This is not time-consuming, this is faster than Promise.all\n    const draftModels = [];\n    for (const flat of flatSnapshots) {\n      const draft = await this._convertSnapshotToDraftModel(flat);\n      if (draft) {\n        draft.id = flat.snapshot.id;\n      }\n      draftModels.push({\n        draft,\n        snapshot: flat.snapshot,\n        parentId: flat.parentId,\n        index: flat.index,\n      });\n    }\n\n    // Phase 2: Filter out the models that failed to convert\n    const validDraftModels = draftModels.filter(item => !!item.draft) as {\n      draft: DraftModel;\n      snapshot: BlockSnapshot;\n      parentId?: string;\n      index?: number;\n    }[];\n\n    // Phase 3: Rebuild the block trees\n    const blockTree = this._rebuildBlockTree(validDraftModels);\n    return blockTree;\n  }\n\n  private async _convertSnapshotToDraftModel(\n    flat: FlatSnapshot\n  ): Promise<DraftModel | undefined> {\n    try {\n      const { children, flavour } = flat.snapshot;\n      const schema = this._getSchema(flavour);\n      const transformer = this._getTransformer(schema);\n      const { props } = await transformer.fromSnapshot({\n        json: {\n          id: flat.snapshot.id,\n          flavour: flat.snapshot.flavour,\n          props: flat.snapshot.props,\n        },\n        assets: this._assetsManager,\n        children,\n      });\n\n      return {\n        id: flat.snapshot.id,\n        flavour: flat.snapshot.flavour,\n        children: [],\n        ...props,\n      } as DraftModel;\n    } catch (error) {\n      console.error(`Error when transforming snapshot to model data:`);\n      console.error(error);\n      return;\n    }\n  }\n\n  private _exportDocMeta(doc: Doc): DocSnapshot['meta'] {\n    const docMeta = doc.meta;\n\n    if (!docMeta) {\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        'Doc meta not found'\n      );\n    }\n    return {\n      id: docMeta.id,\n      title: docMeta.title,\n      createDate: docMeta.createDate,\n      tags: [], // for backward compatibility\n    };\n  }\n\n  private _flattenSnapshot(\n    snapshot: BlockSnapshot,\n    flatSnapshots: FlatSnapshot[],\n    parentId?: string,\n    index?: number\n  ) {\n    flatSnapshots.push({ snapshot, parentId, index });\n    if (snapshot.children) {\n      snapshot.children.forEach((child, idx) => {\n        this._flattenSnapshot(child, flatSnapshots, snapshot.id, idx);\n      });\n    }\n  }\n\n  private _getCollectionMeta() {\n    const { meta } = this._collection;\n    const { docs } = meta;\n    if (!docs) {\n      throw new BlockSuiteError(ErrorCode.TransformerError, 'Docs not found');\n    }\n    return {\n      properties: {}, // for backward compatibility\n      pages: JSON.parse(JSON.stringify(docs)) as DocMeta[],\n    };\n  }\n\n  private _getSchema(flavour: string) {\n    const schema = this._collection.schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        `Flavour schema not found for ${flavour}`\n      );\n    }\n    return schema;\n  }\n\n  private _getTransformer(schema: BlockSchemaType) {\n    return schema.transformer?.() ?? new BaseBlockTransformer();\n  }\n\n  private async _insertBlockTree(\n    nodes: DraftBlockTreeNode[],\n    doc: Doc,\n    parentId?: string,\n    startIndex?: number,\n    counter: number = 0\n  ) {\n    for (let index = 0; index < nodes.length; index++) {\n      const node = nodes[index];\n      const { draft } = node;\n      const { id, flavour } = draft;\n\n      const actualIndex =\n        startIndex !== undefined ? startIndex + index : undefined;\n      doc.addBlock(flavour as BlockSuite.Flavour, draft, parentId, actualIndex);\n\n      const model = doc.getBlock(id)?.model;\n      if (!model) {\n        throw new BlockSuiteError(\n          ErrorCode.TransformerError,\n          `Block not found by id ${id}`\n        );\n      }\n\n      this._slots.afterImport.emit({\n        type: 'block',\n        model,\n        snapshot: node.snapshot,\n      });\n\n      counter++;\n      if (counter % BATCH_SIZE === 0) {\n        await nextTick();\n      }\n\n      if (node.children.length > 0) {\n        counter = await this._insertBlockTree(\n          node.children,\n          doc,\n          id,\n          undefined,\n          counter\n        );\n      }\n    }\n\n    return counter;\n  }\n\n  private _rebuildBlockTree(\n    draftModels: {\n      draft: DraftModel;\n      snapshot: BlockSnapshot;\n      parentId?: string;\n      index?: number;\n    }[]\n  ): DraftBlockTreeNode {\n    const nodeMap = new Map<string, DraftBlockTreeNode>();\n    // First pass: create nodes and add them to the map\n    draftModels.forEach(({ draft, snapshot }) => {\n      nodeMap.set(draft.id, { draft, snapshot, children: [] });\n    });\n    const root = nodeMap.get(draftModels[0].draft.id) as DraftBlockTreeNode;\n\n    // Second pass: build the tree structure\n    draftModels.forEach(({ draft, parentId, index }) => {\n      const node = nodeMap.get(draft.id);\n      if (!node) return;\n\n      if (parentId) {\n        const parentNode = nodeMap.get(parentId);\n        if (parentNode && index !== undefined) {\n          parentNode.children[index] = node;\n        }\n      }\n    });\n\n    if (!root) {\n      throw new Error('No root node found in the tree');\n    }\n\n    return root;\n  }\n\n  private async _snapshotToBlock(\n    snapshot: BlockSnapshot,\n    doc: Doc,\n    parent?: string,\n    index?: number\n  ): Promise<BlockModel | null> {\n    this._triggerBeforeImportEvent(snapshot, parent, index);\n\n    const flatSnapshots: FlatSnapshot[] = [];\n    this._flattenSnapshot(snapshot, flatSnapshots, parent, index);\n\n    const blockTree = await this._convertFlatSnapshots(flatSnapshots);\n\n    await this._insertBlockTree([blockTree], doc, parent, index);\n\n    return doc.getBlock(snapshot.id)?.model ?? null;\n  }\n\n  private _triggerBeforeImportEvent(\n    snapshot: BlockSnapshot,\n    parent?: string,\n    index?: number\n  ) {\n    const traverseAndTrigger = (\n      node: BlockSnapshot,\n      parent?: string,\n      index?: number\n    ) => {\n      this._slots.beforeImport.emit({\n        type: 'block',\n        snapshot: node,\n        parent: parent,\n        index: index,\n      });\n      if (node.children) {\n        node.children.forEach((child, idx) => {\n          traverseAndTrigger(child, node.id, idx);\n        });\n      }\n    };\n    traverseAndTrigger(snapshot, parent, index);\n  }\n\n  reset() {\n    this._assetsManager.cleanup();\n  }\n}\n"]}