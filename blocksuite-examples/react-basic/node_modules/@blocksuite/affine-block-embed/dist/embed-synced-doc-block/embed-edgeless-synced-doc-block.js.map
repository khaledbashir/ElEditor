{"version":3,"file":"embed-edgeless-synced-doc-block.js","sourceRoot":"","sources":["../../src/embed-synced-doc-block/embed-edgeless-synced-doc-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AliasInfo } from '@blocksuite/affine-model';\n\nimport {\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '@blocksuite/affine-shared/consts';\nimport {\n  ThemeExtensionIdentifier,\n  ThemeProvider,\n} from '@blocksuite/affine-shared/services';\nimport { BlockStdScope } from '@blocksuite/block-std';\nimport { assertExists, Bound } from '@blocksuite/global/utils';\nimport { html } from 'lit';\nimport { choose } from 'lit/directives/choose.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { guard } from 'lit/directives/guard.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport { toEdgelessEmbedBlock } from '../common/to-edgeless-embed-block.js';\nimport { EmbedSyncedDocBlockComponent } from './embed-synced-doc-block.js';\n\nexport class EmbedEdgelessSyncedDocBlockComponent extends toEdgelessEmbedBlock(\n  EmbedSyncedDocBlockComponent\n) {\n  protected override _renderSyncedView = () => {\n    const { syncedDoc, editorMode } = this;\n\n    assertExists(syncedDoc, 'Doc should exist');\n\n    let containerStyleMap = styleMap({\n      position: 'relative',\n      width: '100%',\n    });\n    const modelScale = this.model.scale ?? 1;\n    const bound = Bound.deserialize(this.model.xywh);\n    const width = bound.w / modelScale;\n    const height = bound.h / modelScale;\n    containerStyleMap = styleMap({\n      width: `${width}px`,\n      height: `${height}px`,\n      minHeight: `${height}px`,\n      transform: `scale(${modelScale})`,\n      transformOrigin: '0 0',\n    });\n\n    const themeService = this.std.get(ThemeProvider);\n    const themeExtension = this.std.getOptional(ThemeExtensionIdentifier);\n    const appTheme = themeService.app$.value;\n    let edgelessTheme = themeService.edgeless$.value;\n    if (themeExtension?.getEdgelessTheme && this.syncedDoc?.id) {\n      edgelessTheme = themeExtension.getEdgelessTheme(this.syncedDoc.id).value;\n    }\n    const theme = this.isPageMode ? appTheme : edgelessTheme;\n\n    const isSelected = !!this.selected?.is('block');\n    const scale = this.model.scale ?? 1;\n\n    this.dataset.nestedEditor = '';\n\n    const renderEditor = () => {\n      return choose(editorMode, [\n        [\n          'page',\n          () => html`\n            <div class=\"affine-page-viewport\" data-theme=${appTheme}>\n              ${new BlockStdScope({\n                doc: syncedDoc,\n                extensions: this._buildPreviewSpec('page:preview'),\n              }).render()}\n            </div>\n          `,\n        ],\n        [\n          'edgeless',\n          () => html`\n            <div class=\"affine-edgeless-viewport\" data-theme=${edgelessTheme}>\n              ${new BlockStdScope({\n                doc: syncedDoc,\n                extensions: this._buildPreviewSpec('edgeless:preview'),\n              }).render()}\n            </div>\n          `,\n        ],\n      ]);\n    };\n\n    return this.renderEmbed(\n      () => html`\n        <div\n          class=${classMap({\n            'affine-embed-synced-doc-container': true,\n            [editorMode]: true,\n            [theme]: true,\n            selected: isSelected,\n            surface: true,\n          })}\n          @click=${this._handleClick}\n          style=${containerStyleMap}\n          ?data-scale=${scale}\n        >\n          <div class=\"affine-embed-synced-doc-editor\">\n            ${this.isPageMode && this._isEmptySyncedDoc\n              ? html`\n                  <div class=\"affine-embed-synced-doc-editor-empty\">\n                    <span>\n                      This is a linked doc, you can add content here.\n                    </span>\n                  </div>\n                `\n              : guard([editorMode, syncedDoc], renderEditor)}\n          </div>\n          <div class=\"affine-embed-synced-doc-editor-overlay\"></div>\n        </div>\n      `\n    );\n  };\n\n  override convertToCard = (aliasInfo?: AliasInfo) => {\n    const { id, doc, caption, xywh } = this.model;\n\n    const edgelessService = this.rootService;\n    const style = 'vertical';\n    const bound = Bound.deserialize(xywh);\n    bound.w = EMBED_CARD_WIDTH[style];\n    bound.h = EMBED_CARD_HEIGHT[style];\n\n    if (!edgelessService) {\n      return;\n    }\n\n    // @ts-expect-error TODO: fix after edgeless refactor\n    const newId = edgelessService.addBlock(\n      'affine:embed-linked-doc',\n      {\n        xywh: bound.serialize(),\n        style,\n        caption,\n        ...this.referenceInfo,\n        ...aliasInfo,\n      },\n      // @ts-expect-error TODO: fix after edgeless refactor\n      edgelessService.surface\n    );\n\n    this.std.command.exec('reassociateConnectors', {\n      oldId: id,\n      newId,\n    });\n\n    // @ts-expect-error TODO: fix after edgeless refactor\n    edgelessService.selection.set({\n      editing: false,\n      elements: [newId],\n    });\n    doc.deleteBlock(this.model);\n  };\n\n  get rootService() {\n    return this.std.getService('affine:page');\n  }\n\n  override renderGfxBlock() {\n    const { style, xywh } = this.model;\n    const bound = Bound.deserialize(xywh);\n\n    this.embedContainerStyle.width = `${bound.w}px`;\n    this.embedContainerStyle.height = `${bound.h}px`;\n\n    this.cardStyleMap = {\n      display: 'block',\n      width: `${EMBED_CARD_WIDTH[style]}px`,\n      height: `${EMBED_CARD_WIDTH[style]}px`,\n      transform: `scale(${bound.w / EMBED_CARD_WIDTH[style]}, ${bound.h / EMBED_CARD_HEIGHT[style]})`,\n      transformOrigin: '0 0',\n    };\n\n    return this.renderPageContent();\n  }\n\n  override accessor useCaptionEditor = true;\n}\n"]}