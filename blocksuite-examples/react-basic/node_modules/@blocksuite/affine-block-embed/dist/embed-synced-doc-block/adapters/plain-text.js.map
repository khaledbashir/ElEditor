{"version":3,"file":"plain-text.js","sourceRoot":"","sources":["../../../src/embed-synced-doc-block/adapters/plain-text.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,yBAAyB,EAAE,MAAM,0BAA0B,CAAC;AACrE,OAAO,EACL,8BAA8B,GAE/B,MAAM,oCAAoC,CAAC;AAE5C,MAAM,CAAC,MAAM,0CAA0C,GACrD;IACE,OAAO,EAAE,yBAAyB,CAAC,KAAK,CAAC,OAAO;IAChD,OAAO,EAAE,GAAG,EAAE,CAAC,KAAK;IACpB,SAAS,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,KAAK,yBAAyB,CAAC,KAAK,CAAC,OAAO;IAC1E,eAAe,EAAE,EAAE;IACnB,iBAAiB,EAAE;QACjB,KAAK,EAAE,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,EAAE;YAC1B,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG,EAAE,UAAU,EAAE,GAAG,OAAO,CAAC;YACpE,MAAM,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,0BAA0B,CAAC,CAAC;YAErD,6CAA6C;YAC7C,IACE,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,CAAC;gBAC1D,SAAS,EACT,CAAC;gBACD,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,CAAC,CAAC,CAAC;YAChE,CAAC;YACD,IAAI,OAAO,GAAG,aAAa,CAAC,gBAAgB,CAC1C,0BAA0B,CACjB,CAAC;YACZ,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,EAAE,OAAO,CAAC,CAAC;YAEtE,IAAI,MAAM,GAAG,EAAE,CAAC;YAEhB,IAAI,IAAI,KAAK,SAAS,EAAE,CAAC;gBACvB,MAAM,WAAW,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAgB,CAAC;gBAClD,MAAM,SAAS,GAAG,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;gBACrD,IAAI,CAAC,SAAS;oBAAE,OAAO;gBAEvB,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;oBAClB,MAAM,cAAc,GAAG,GAAG,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC;oBACpD,IAAI,cAAc,EAAE,CAAC;wBACnB,MAAM,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;oBAChD,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,MAAM,GAAG,SAAS,CAAC,IAAI,EAAE,KAAK,IAAI,EAAE,CAAC;oBACrC,IAAI,MAAM,EAAE,CAAC;wBACX,MAAM,IAAI,IAAI,CAAC;oBACjB,CAAC;gBACH,CAAC;YACH,CAAC;YACD,UAAU,CAAC,OAAO,IAAI,MAAM,CAAC;QAC/B,CAAC;QACD,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,MAAM,OAAO,GAAG,aAAa,CAAC,gBAAgB,CAC5C,0BAA0B,CACjB,CAAC;YACZ,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,OAAO,GAAG,CAAC,CAAC,CAAC;QAC1E,CAAC;KACF;CACF,CAAC;AAEJ,MAAM,CAAC,MAAM,4CAA4C,GACvD,8BAA8B,CAAC,0CAA0C,CAAC,CAAC","sourcesContent":["import { EmbedSyncedDocBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockPlainTextAdapterExtension,\n  type BlockPlainTextAdapterMatcher,\n} from '@blocksuite/affine-shared/adapters';\n\nexport const embedSyncedDocBlockPlainTextAdapterMatcher: BlockPlainTextAdapterMatcher =\n  {\n    flavour: EmbedSyncedDocBlockSchema.model.flavour,\n    toMatch: () => false,\n    fromMatch: o => o.node.flavour === EmbedSyncedDocBlockSchema.model.flavour,\n    toBlockSnapshot: {},\n    fromBlockSnapshot: {\n      enter: async (o, context) => {\n        const { configs, walker, walkerContext, job, textBuffer } = context;\n        const type = configs.get('embedSyncedDocExportType');\n\n        // this context is used for nested sync block\n        if (\n          walkerContext.getGlobalContext('embed-synced-doc-counter') ===\n          undefined\n        ) {\n          walkerContext.setGlobalContext('embed-synced-doc-counter', 0);\n        }\n        let counter = walkerContext.getGlobalContext(\n          'embed-synced-doc-counter'\n        ) as number;\n        walkerContext.setGlobalContext('embed-synced-doc-counter', ++counter);\n\n        let buffer = '';\n\n        if (type === 'content') {\n          const syncedDocId = o.node.props.pageId as string;\n          const syncedDoc = job.collection.getDoc(syncedDocId);\n          if (!syncedDoc) return;\n\n          if (counter === 1) {\n            const syncedSnapshot = job.docToSnapshot(syncedDoc);\n            if (syncedSnapshot) {\n              await walker.walkONode(syncedSnapshot.blocks);\n            }\n          } else {\n            buffer = syncedDoc.meta?.title ?? '';\n            if (buffer) {\n              buffer += '\\n';\n            }\n          }\n        }\n        textBuffer.content += buffer;\n      },\n      leave: (_, context) => {\n        const { walkerContext } = context;\n        const counter = walkerContext.getGlobalContext(\n          'embed-synced-doc-counter'\n        ) as number;\n        walkerContext.setGlobalContext('embed-synced-doc-counter', counter - 1);\n      },\n    },\n  };\n\nexport const EmbedSyncedDocBlockPlainTextAdapterExtension =\n  BlockPlainTextAdapterExtension(embedSyncedDocBlockPlainTextAdapterMatcher);\n"]}