{"version":3,"file":"html.js","sourceRoot":"","sources":["../../../src/embed-synced-doc-block/adapters/html.ts"],"names":[],"mappings":"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","sourcesContent":["import { EmbedSyncedDocBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockHtmlAdapterExtension,\n  type BlockHtmlAdapterMatcher,\n} from '@blocksuite/affine-shared/adapters';\n\nexport const embedSyncedDocBlockHtmlAdapterMatcher: BlockHtmlAdapterMatcher = {\n  flavour: EmbedSyncedDocBlockSchema.model.flavour,\n  toMatch: () => false,\n  fromMatch: o => o.node.flavour === EmbedSyncedDocBlockSchema.model.flavour,\n  toBlockSnapshot: {},\n  fromBlockSnapshot: {\n    enter: async (o, context) => {\n      const { configs, walker, walkerContext, job } = context;\n      const type = configs.get('embedSyncedDocExportType');\n\n      // this context is used for nested sync block\n      if (\n        walkerContext.getGlobalContext('embed-synced-doc-counter') === undefined\n      ) {\n        walkerContext.setGlobalContext('embed-synced-doc-counter', 0);\n      }\n      let counter = walkerContext.getGlobalContext(\n        'embed-synced-doc-counter'\n      ) as number;\n      walkerContext.setGlobalContext('embed-synced-doc-counter', ++counter);\n\n      if (type === 'content') {\n        const syncedDocId = o.node.props.pageId as string;\n        const syncedDoc = job.collection.getDoc(syncedDocId);\n        walkerContext.setGlobalContext('hast:html-root-doc', false);\n        if (!syncedDoc) return;\n\n        if (counter === 1) {\n          const syncedSnapshot = job.docToSnapshot(syncedDoc);\n          if (syncedSnapshot) {\n            await walker.walkONode(syncedSnapshot.blocks);\n          }\n        } else {\n          walkerContext\n            .openNode(\n              {\n                type: 'element',\n                tagName: 'div',\n                properties: {\n                  className: ['affine-paragraph-block-container'],\n                },\n                children: [],\n              },\n              'children'\n            )\n            .openNode(\n              {\n                type: 'element',\n                tagName: 'p',\n                properties: {},\n                children: [\n                  { type: 'text', value: syncedDoc.meta?.title ?? '' },\n                ],\n              },\n              'children'\n            )\n            .closeNode()\n            .closeNode();\n        }\n      }\n    },\n    leave: (_, context) => {\n      const { walkerContext } = context;\n      const counter = walkerContext.getGlobalContext(\n        'embed-synced-doc-counter'\n      ) as number;\n      const currentCounter = counter - 1;\n      walkerContext.setGlobalContext(\n        'embed-synced-doc-counter',\n        currentCounter\n      );\n      // When leave the last embed synced doc block, we need to set the html root doc context to true\n      walkerContext.setGlobalContext(\n        'hast:html-root-doc',\n        currentCounter === 0\n      );\n    },\n  },\n};\n\nexport const EmbedSyncedDocBlockHtmlAdapterExtension =\n  BlockHtmlAdapterExtension(embedSyncedDocBlockHtmlAdapterMatcher);\n"]}