{"version":3,"file":"markdown.js","sourceRoot":"","sources":["../../../src/embed-synced-doc-block/adapters/markdown.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,yBAAyB,EAAE,MAAM,0BAA0B,CAAC;AACrE,OAAO,EACL,6BAA6B,GAE9B,MAAM,oCAAoC,CAAC;AAE5C,MAAM,CAAC,MAAM,yCAAyC,GACpD;IACE,OAAO,EAAE,yBAAyB,CAAC,KAAK,CAAC,OAAO;IAChD,OAAO,EAAE,GAAG,EAAE,CAAC,KAAK;IACpB,SAAS,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,KAAK,yBAAyB,CAAC,KAAK,CAAC,OAAO;IAC1E,eAAe,EAAE,EAAE;IACnB,iBAAiB,EAAE;QACjB,KAAK,EAAE,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,EAAE;YAC1B,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG,EAAE,GAAG,OAAO,CAAC;YACxD,MAAM,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,0BAA0B,CAAC,CAAC;YAErD,6CAA6C;YAC7C,IACE,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,CAAC;gBAC1D,SAAS,EACT,CAAC;gBACD,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,CAAC,CAAC,CAAC;YAChE,CAAC;YACD,IAAI,OAAO,GAAG,aAAa,CAAC,gBAAgB,CAC1C,0BAA0B,CACjB,CAAC;YACZ,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,EAAE,OAAO,CAAC,CAAC;YAEtE,IAAI,IAAI,KAAK,SAAS,EAAE,CAAC;gBACvB,MAAM,WAAW,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAgB,CAAC;gBAClD,MAAM,SAAS,GAAG,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;gBACrD,IAAI,CAAC,SAAS;oBAAE,OAAO;gBAEvB,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;oBAClB,MAAM,cAAc,GAAG,GAAG,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC;oBACpD,IAAI,cAAc,EAAE,CAAC;wBACnB,MAAM,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC;oBAChD,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,6CAA6C;oBAC7C,aAAa;yBACV,QAAQ,CAAC;wBACR,IAAI,EAAE,WAAW;wBACjB,QAAQ,EAAE;4BACR,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,CAAC,IAAI,EAAE,KAAK,IAAI,EAAE,EAAE;yBACrD;qBACF,CAAC;yBACD,SAAS,EAAE,CAAC;gBACjB,CAAC;YACH,CAAC;QACH,CAAC;QACD,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,MAAM,OAAO,GAAG,aAAa,CAAC,gBAAgB,CAC5C,0BAA0B,CACjB,CAAC;YACZ,aAAa,CAAC,gBAAgB,CAAC,0BAA0B,EAAE,OAAO,GAAG,CAAC,CAAC,CAAC;QAC1E,CAAC;KACF;CACF,CAAC;AAEJ,MAAM,CAAC,MAAM,2CAA2C,GACtD,6BAA6B,CAAC,yCAAyC,CAAC,CAAC","sourcesContent":["import { EmbedSyncedDocBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockMarkdownAdapterExtension,\n  type BlockMarkdownAdapterMatcher,\n} from '@blocksuite/affine-shared/adapters';\n\nexport const embedSyncedDocBlockMarkdownAdapterMatcher: BlockMarkdownAdapterMatcher =\n  {\n    flavour: EmbedSyncedDocBlockSchema.model.flavour,\n    toMatch: () => false,\n    fromMatch: o => o.node.flavour === EmbedSyncedDocBlockSchema.model.flavour,\n    toBlockSnapshot: {},\n    fromBlockSnapshot: {\n      enter: async (o, context) => {\n        const { configs, walker, walkerContext, job } = context;\n        const type = configs.get('embedSyncedDocExportType');\n\n        // this context is used for nested sync block\n        if (\n          walkerContext.getGlobalContext('embed-synced-doc-counter') ===\n          undefined\n        ) {\n          walkerContext.setGlobalContext('embed-synced-doc-counter', 0);\n        }\n        let counter = walkerContext.getGlobalContext(\n          'embed-synced-doc-counter'\n        ) as number;\n        walkerContext.setGlobalContext('embed-synced-doc-counter', ++counter);\n\n        if (type === 'content') {\n          const syncedDocId = o.node.props.pageId as string;\n          const syncedDoc = job.collection.getDoc(syncedDocId);\n          if (!syncedDoc) return;\n\n          if (counter === 1) {\n            const syncedSnapshot = job.docToSnapshot(syncedDoc);\n            if (syncedSnapshot) {\n              await walker.walkONode(syncedSnapshot.blocks);\n            }\n          } else {\n            // TODO(@L-Sun) may be use the nested content\n            walkerContext\n              .openNode({\n                type: 'paragraph',\n                children: [\n                  { type: 'text', value: syncedDoc.meta?.title ?? '' },\n                ],\n              })\n              .closeNode();\n          }\n        }\n      },\n      leave: (_, context) => {\n        const { walkerContext } = context;\n        const counter = walkerContext.getGlobalContext(\n          'embed-synced-doc-counter'\n        ) as number;\n        walkerContext.setGlobalContext('embed-synced-doc-counter', counter - 1);\n      },\n    },\n  };\n\nexport const EmbedSyncedDocBlockMarkdownAdapterExtension =\n  BlockMarkdownAdapterExtension(embedSyncedDocBlockMarkdownAdapterMatcher);\n"]}