{"version":3,"file":"render-linked-doc.js","sourceRoot":"","sources":["../../src/common/render-linked-doc.ts"],"names":[],"mappings":"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","sourcesContent":["import type { SurfaceBlockModel } from '@blocksuite/affine-block-surface';\n\nimport {\n  type DocMode,\n  type ImageBlockModel,\n  NoteDisplayMode,\n} from '@blocksuite/affine-model';\nimport { EMBED_CARD_HEIGHT } from '@blocksuite/affine-shared/consts';\nimport { matchFlavours, SpecProvider } from '@blocksuite/affine-shared/utils';\nimport { BlockStdScope } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type BlockModel,\n  BlockViewType,\n  type Doc,\n  type Query,\n} from '@blocksuite/store';\nimport { render, type TemplateResult } from 'lit';\n\nimport type { EmbedLinkedDocBlockComponent } from '../embed-linked-doc-block/index.js';\nimport type { EmbedSyncedDocCard } from '../embed-synced-doc-block/components/embed-synced-doc-card.js';\n\nexport function renderLinkedDocInCard(\n  card: EmbedLinkedDocBlockComponent | EmbedSyncedDocCard\n) {\n  const linkedDoc = card.linkedDoc;\n  assertExists(\n    linkedDoc,\n    `Trying to load page ${card.model.pageId} in linked page block, but the page is not found.`\n  );\n\n  if ('bannerContainer' in card) {\n    if (card.editorMode === 'page') {\n      renderPageAsBanner(card).catch(e => {\n        console.error(e);\n        card.isError = true;\n      });\n    }\n  }\n\n  renderNoteContent(card).catch(e => {\n    console.error(e);\n    card.isError = true;\n  });\n}\n\nasync function renderPageAsBanner(card: EmbedSyncedDocCard) {\n  const linkedDoc = card.linkedDoc;\n  assertExists(\n    linkedDoc,\n    `Trying to load page ${card.model.pageId} in linked page block, but the page is not found.`\n  );\n\n  const notes = getNotesFromDoc(linkedDoc);\n  if (!notes) {\n    card.isBannerEmpty = true;\n    return;\n  }\n\n  const target = notes.flatMap(note =>\n    note.children.filter(child => matchFlavours(child, ['affine:image']))\n  )[0];\n\n  if (target) {\n    await renderImageAsBanner(card, target);\n    return;\n  }\n\n  card.isBannerEmpty = true;\n}\n\nasync function renderImageAsBanner(\n  card: EmbedSyncedDocCard,\n  image: BlockModel\n) {\n  const sourceId = (image as ImageBlockModel).sourceId;\n  if (!sourceId) return;\n\n  const storage = card.linkedDoc?.blobSync;\n  if (!storage) return;\n\n  const blob = await storage.get(sourceId);\n  if (!blob) return;\n\n  const url = URL.createObjectURL(blob);\n  const $img = document.createElement('img');\n  $img.src = url;\n  await addCover(card, $img);\n\n  card.isBannerEmpty = false;\n}\n\nasync function addCover(\n  card: EmbedSyncedDocCard,\n  cover: HTMLElement | TemplateResult<1>\n) {\n  const coverContainer = await card.bannerContainer;\n  if (!coverContainer) return;\n  while (coverContainer.firstChild) {\n    coverContainer.firstChild.remove();\n  }\n\n  if (cover instanceof HTMLElement) {\n    coverContainer.append(cover);\n  } else {\n    render(cover, coverContainer);\n  }\n}\n\nasync function renderNoteContent(\n  card: EmbedLinkedDocBlockComponent | EmbedSyncedDocCard\n) {\n  card.isNoteContentEmpty = true;\n\n  const doc = card.linkedDoc;\n  assertExists(\n    doc,\n    `Trying to load page ${card.model.pageId} in linked page block, but the page is not found.`\n  );\n\n  const notes = getNotesFromDoc(doc);\n  if (!notes) {\n    return;\n  }\n\n  const cardStyle = card.model.style;\n  const isHorizontal = cardStyle === 'horizontal';\n  const allowFlavours: (keyof BlockSuite.BlockModels)[] = isHorizontal\n    ? []\n    : ['affine:image'];\n\n  const noteChildren = notes.flatMap(note =>\n    note.children.filter(model => {\n      if (matchFlavours(model, allowFlavours)) {\n        return true;\n      }\n      return filterTextModel(model);\n    })\n  );\n\n  if (!noteChildren.length) {\n    return;\n  }\n\n  card.isNoteContentEmpty = false;\n\n  const noteContainer = await card.noteContainer;\n\n  if (!noteContainer) {\n    return;\n  }\n\n  while (noteContainer.firstChild) {\n    noteContainer.firstChild.remove();\n  }\n\n  const noteBlocksContainer = document.createElement('div');\n  noteBlocksContainer.classList.add('affine-embed-doc-content-note-blocks');\n  noteBlocksContainer.contentEditable = 'false';\n  noteContainer.append(noteBlocksContainer);\n\n  if (isHorizontal) {\n    // When the card is horizontal, we only render the first block\n    noteChildren.splice(1);\n  } else {\n    // Before rendering, we can not know the height of each block\n    // But we can limit the number of blocks to render simply by the height of the card\n    const cardHeight = EMBED_CARD_HEIGHT[cardStyle];\n    const minSingleBlockHeight = 20;\n    const maxBlockCount = Math.floor(cardHeight / minSingleBlockHeight);\n    if (noteChildren.length > maxBlockCount) {\n      noteChildren.splice(maxBlockCount);\n    }\n  }\n  const childIds = noteChildren.map(child => child.id);\n  const ids: string[] = [];\n  childIds.map(block => {\n    let parent: string | null = block;\n    while (parent && !ids.includes(parent)) {\n      ids.push(parent);\n      parent = doc.blockCollection.crud.getParent(parent);\n    }\n  });\n  const query: Query = {\n    mode: 'strict',\n    match: ids.map(id => ({ id, viewType: BlockViewType.Display })),\n  };\n  const previewDoc = doc.blockCollection.getDoc({ query });\n  const previewSpec = SpecProvider.getInstance().getSpec('page:preview');\n  const previewStd = new BlockStdScope({\n    doc: previewDoc,\n    extensions: previewSpec.value,\n  });\n  const previewTemplate = previewStd.render();\n  const fragment = document.createDocumentFragment();\n  render(previewTemplate, fragment);\n  noteBlocksContainer.append(fragment);\n  const contentEditableElements = noteBlocksContainer.querySelectorAll(\n    '[contenteditable=\"true\"]'\n  );\n  contentEditableElements.forEach(element => {\n    (element as HTMLElement).contentEditable = 'false';\n  });\n}\n\nfunction filterTextModel(model: BlockModel) {\n  if (matchFlavours(model, ['affine:paragraph', 'affine:list'])) {\n    return !!model.text?.toString().length;\n  }\n  return false;\n}\n\nexport function getNotesFromDoc(doc: Doc) {\n  const notes = doc.root?.children.filter(\n    child =>\n      matchFlavours(child, ['affine:note']) &&\n      child.displayMode !== NoteDisplayMode.EdgelessOnly\n  );\n\n  if (!notes || !notes.length) {\n    return null;\n  }\n\n  return notes;\n}\n\nexport function isEmptyDoc(doc: Doc | null, mode: DocMode) {\n  if (!doc) {\n    return true;\n  }\n\n  if (mode === 'page') {\n    const notes = getNotesFromDoc(doc);\n    if (!notes || !notes.length) {\n      return true;\n    }\n    return notes.every(note => isEmptyNote(note));\n  } else {\n    const surface = getSurfaceBlock(doc);\n    if (surface?.elementModels.length || doc.blockSize > 2) {\n      return false;\n    }\n    return true;\n  }\n}\n\nexport function isEmptyNote(note: BlockModel) {\n  return note.children.every(block => {\n    return (\n      block.flavour === 'affine:paragraph' &&\n      (!block.text || block.text.length === 0)\n    );\n  });\n}\n\nfunction getSurfaceBlock(doc: Doc) {\n  const blocks = doc.getBlocksByFlavour('affine:surface');\n  return blocks.length !== 0 ? (blocks[0].model as SurfaceBlockModel) : null;\n}\n\n/**\n * Gets the document content with a max length.\n */\nexport function getDocContentWithMaxLength(doc: Doc, maxlength = 500) {\n  const notes = getNotesFromDoc(doc);\n  if (!notes) return;\n\n  const noteChildren = notes.flatMap(note =>\n    note.children.filter(model => filterTextModel(model))\n  );\n  if (!noteChildren.length) return;\n\n  let count = 0;\n  let reached = false;\n  const texts = [];\n\n  for (const model of noteChildren) {\n    let t = model.text?.toString();\n    if (t?.length) {\n      const c: number = count + Math.max(0, texts.length - 1);\n\n      if (t.length + c > maxlength) {\n        t = t.substring(0, maxlength - c);\n        reached = true;\n      }\n\n      texts.push(t);\n      count += t.length;\n\n      if (reached) {\n        break;\n      }\n    }\n  }\n\n  return texts.join('\\n');\n}\n"]}