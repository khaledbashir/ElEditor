{"version":3,"file":"embed-block-element.js","sourceRoot":"","sources":["../../src/common/embed-block-element.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKA,OAAO,EACL,uBAAuB,EACvB,aAAa,GACd,MAAM,uCAAuC,CAAC;AAC/C,OAAO,EACL,iBAAiB,EACjB,oBAAoB,EACpB,gBAAgB,GACjB,MAAM,kCAAkC,CAAC;AAC1C,OAAO,EACL,eAAe,EACf,yBAAyB,GAC1B,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EACL,kBAAkB,EAClB,+BAA+B,EAC/B,+BAA+B,GAChC,MAAM,iCAAiC,CAAC;AACzC,OAAO,EAAqB,mBAAmB,EAAE,MAAM,uBAAuB,CAAC;AAC/E,OAAO,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAC3B,OAAO,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAC1C,OAAO,EAAE,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AACvD,OAAO,EAAkB,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AAEvE,MAAM,CAAC,MAAM,qBAAqB,GAAG,yBAAyB,CAAC;IAC7D,OAAO,EAAE,gBAAgB;IACzB,QAAQ,EAAE,IAAI;IACd,SAAS,EAAE,KAAK,CAAC,EAAE;QACjB,MAAM,EAAE,KAAK,EAAE,gBAAgB,EAAE,GAAG,KAAK,CAAC;QAC1C,IACE,gBAAgB,CAAC,MAAM,KAAK,CAAC;YAC7B,gBAAgB,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,gBAAgB,CAAC,KAAK,IAAI;YAElE,OAAO,KAAK,CAAC;QAEf,MAAM,cAAc,GAAG,gBAAgB,CAAC,CAAC,CAAwB,CAAC;QAClE,MAAM,WAAW,GAAG,mBAAmB,CAAC,cAAc,CAAC,CAAC;QACxD,MAAM,MAAM,GAAG,kBAAkB,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACpD,MAAM,yBAAyB,GAC7B,MAAM,EAAE,SAAS,CAAC,QAAQ,CAAC,oBAAoB,CAAC,CAAC;QAEnD,IAAI,WAAW,EAAE,CAAC;YAChB,MAAM,KAAK,GAAG,cAAc,CAAC,UAAU,CAAC;YACxC,MAAM,WAAW,GACf,KAAK,KAAK,UAAU,IAAI,KAAK,KAAK,MAAM,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,KAAK,CAAC;YAClE,OAAO,+BAA+B,CAAC;gBACrC,cAAc;gBACd,KAAK,EAAE,WAAW;gBAClB,GAAG,KAAK;aACT,CAAC,CAAC;QACL,CAAC;aAAM,IAAI,yBAAyB,EAAE,CAAC;YACrC,MAAM,KAAK,GAAG,cAAc,CAAC,UAAU,CAAC;YAExC,OAAO,+BAA+B,CAAC;gBACrC,cAAc;gBACd,WAAW,EAAE,wBAAwB;gBACrC,KAAK,EAAE,gBAAgB,CAAC,KAAK,CAAC;gBAC9B,MAAM,EAAE,iBAAiB,CAAC,KAAK,CAAC;gBAChC,GAAG,KAAK;aACT,CAAC,CAAC;QACL,CAAC;QAED,OAAO,KAAK,CAAC;IACf,CAAC;CACF,CAAC,CAAC;IAEU,mBAAmB;sBAItB,uBAAuB;;;;iBAJpB,mBAIX,SAAQ,WAAmD;;;YACnD,0BAAqB,GAAG,IAAI,eAAe,EAAE,CAAC;YAEtD,eAAU,GAAmB,YAAY,CAAC;YAE1C;;;eAGG;YACO,WAAM,GAAG,CAAC,CAAC;YAErB,mBAAc,GAAG,IAAI,CAAC;YAEtB;;;;eAIG;YACO,wBAAmB,GAAc,EAAE,CAAC;YAE9C,gBAAW,GAAG,CAAC,OAA6B,EAAE,EAAE;gBAC9C,IACE,IAAI,CAAC,UAAU,KAAK,YAAY;oBAChC,IAAI,CAAC,UAAU,KAAK,gBAAgB;oBACpC,IAAI,CAAC,UAAU,KAAK,MAAM,EAC1B,CAAC;oBACD,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,OAAO,CAAC;oBAE7B,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,aAAa,EAAE,CAAC;oBAC3D,IAAI,IAAI,KAAK,UAAU,EAAE,CAAC;wBACxB,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG,GAAG,oBAAoB,IAAI,CAAC;oBACpD,CAAC;gBACH,CAAC;gBAED,MAAM,QAAQ,GAAG,CAAC,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,CAAC,OAAO,CAAC,CAAC;gBAC9C,OAAO,IAAI,CAAA;;qBAEM,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO;gBAC3C,QAAQ,CAAC;oBACf,uBAAuB,EAAE,IAAI;oBAC7B,gBAAgB,EAAE,QAAQ;iBAC3B,CAAC;gBACM,QAAQ,CAAC;oBACf,MAAM,EAAE,GAAG,IAAI,CAAC,WAAW,IAAI;oBAC/B,KAAK,EAAE,MAAM;oBACb,GAAG,IAAI,CAAC,mBAAmB;iBAC5B,CAAC;;UAEA,OAAO,EAAE;;KAEd,CAAC;YACJ,CAAC,CAAC;YAkC0B,8CAA8C;gBACxE,MAAM,EAAE,QAAQ;aACjB,CAAC;YAGiB,8FAA4B;YAE7B,gGAAgB,aAAa,CAAC,MAAM,EAAC;YAErC,0CAAmB,IAAI,CAAC;YAExB,sCAAe,IAAI,CAAC;QACxC,CAAC;;;sCARE,KAAK,CAAC,wBAAwB,CAAC;YAChC,mLAAmB,UAAU,6BAAV,UAAU,+FAAkB;;;QArC/C;;WAEG;QACH,IAAI,WAAW;YACb,OAAO,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAC5C,CAAC;QAED;;WAEG;QACH,IAAI,UAAU;YACZ,OAAO,gBAAgB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAC3C,CAAC;QAED,IAAI,oBAAoB;YACtB,OAAO,IAAI,CAAC,qBAAqB,CAAC;QACpC,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAE1B,IAAI,IAAI,CAAC,qBAAqB,CAAC,MAAM,CAAC,OAAO;gBAC3C,IAAI,CAAC,qBAAqB,GAAG,IAAI,eAAe,EAAE,CAAC;YAErD,IAAI,CAAC,eAAe,GAAG,OAAO,CAAC;QACjC,CAAC;QAEQ,oBAAoB;YAC3B,KAAK,CAAC,oBAAoB,EAAE,CAAC;YAC7B,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAAE,CAAC;QACrC,CAAC;QAED,uCAEE;QAFF,IAA4B,oBAAoB,0DAE9C;QAFF,IAA4B,oBAAoB,gEAE9C;QAGF,6BAA+C;QAA/C,IAAmB,UAAU,gDAAkB;QAA/C,IAAmB,UAAU,sDAAkB;QAE/C,gCAAuD;QAAvD,IAAkB,aAAa,mDAAwB;QAAvD,IAAkB,aAAa,yDAAwB;QAEvD,mCAA0C;QAA1C,IAAkB,gBAAgB,sDAAQ;QAA1C,IAAkB,gBAAgB,4DAAQ;QAE1C,+BAAsC;QAAtC,IAAkB,YAAY,kDAAQ;QAAtC,IAAkB,YAAY,wDAAQ;;;SApG3B,mBAAmB","sourcesContent":["import type { EmbedCardStyle } from '@blocksuite/affine-model';\nimport type { GfxCompatibleProps } from '@blocksuite/block-std/gfx';\nimport type { BlockModel } from '@blocksuite/store';\nimport type { TemplateResult } from 'lit';\n\nimport {\n  CaptionedBlockComponent,\n  SelectedStyle,\n} from '@blocksuite/affine-components/caption';\nimport {\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_MIN_WIDTH,\n  EMBED_CARD_WIDTH,\n} from '@blocksuite/affine-shared/consts';\nimport {\n  DocModeProvider,\n  DragHandleConfigExtension,\n} from '@blocksuite/affine-shared/services';\nimport {\n  captureEventTarget,\n  convertDragPreviewDocToEdgeless,\n  convertDragPreviewEdgelessToDoc,\n} from '@blocksuite/affine-shared/utils';\nimport { type BlockService, isGfxBlockComponent } from '@blocksuite/block-std';\nimport { html } from 'lit';\nimport { query } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { type StyleInfo, styleMap } from 'lit/directives/style-map.js';\n\nexport const EmbedDragHandleOption = DragHandleConfigExtension({\n  flavour: /affine:embed-*/,\n  edgeless: true,\n  onDragEnd: props => {\n    const { state, draggingElements } = props;\n    if (\n      draggingElements.length !== 1 ||\n      draggingElements[0].model.flavour.match(/affine:embed-*/) === null\n    )\n      return false;\n\n    const blockComponent = draggingElements[0] as EmbedBlockComponent;\n    const isInSurface = isGfxBlockComponent(blockComponent);\n    const target = captureEventTarget(state.raw.target);\n    const isTargetEdgelessContainer =\n      target?.classList.contains('edgeless-container');\n\n    if (isInSurface) {\n      const style = blockComponent._cardStyle;\n      const targetStyle =\n        style === 'vertical' || style === 'cube' ? 'horizontal' : style;\n      return convertDragPreviewEdgelessToDoc({\n        blockComponent,\n        style: targetStyle,\n        ...props,\n      });\n    } else if (isTargetEdgelessContainer) {\n      const style = blockComponent._cardStyle;\n\n      return convertDragPreviewDocToEdgeless({\n        blockComponent,\n        cssSelector: '.embed-block-container',\n        width: EMBED_CARD_WIDTH[style],\n        height: EMBED_CARD_HEIGHT[style],\n        ...props,\n      });\n    }\n\n    return false;\n  },\n});\n\nexport class EmbedBlockComponent<\n  Model extends BlockModel<GfxCompatibleProps> = BlockModel<GfxCompatibleProps>,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends CaptionedBlockComponent<Model, Service, WidgetName> {\n  private _fetchAbortController = new AbortController();\n\n  _cardStyle: EmbedCardStyle = 'horizontal';\n\n  /**\n   * The actual rendered scale of the embed card.\n   * By default, it is set to 1.\n   */\n  protected _scale = 1;\n\n  blockDraggable = true;\n\n  /**\n   * The style of the embed card.\n   * You can use this to change the height and width of the card.\n   * By default, the height and width are set to `_cardHeight` and `_cardWidth` respectively.\n   */\n  protected embedContainerStyle: StyleInfo = {};\n\n  renderEmbed = (content: () => TemplateResult) => {\n    if (\n      this._cardStyle === 'horizontal' ||\n      this._cardStyle === 'horizontalThin' ||\n      this._cardStyle === 'list'\n    ) {\n      this.style.display = 'block';\n\n      const mode = this.std.get(DocModeProvider).getEditorMode();\n      if (mode === 'edgeless') {\n        this.style.minWidth = `${EMBED_CARD_MIN_WIDTH}px`;\n      }\n    }\n\n    const selected = !!this.selected?.is('block');\n    return html`\n      <div\n        draggable=\"${this.blockDraggable ? 'true' : 'false'}\"\n        class=${classMap({\n          'embed-block-container': true,\n          'selected-style': selected,\n        })}\n        style=${styleMap({\n          height: `${this._cardHeight}px`,\n          width: '100%',\n          ...this.embedContainerStyle,\n        })}\n      >\n        ${content()}\n      </div>\n    `;\n  };\n\n  /**\n   * The height of the current embed card. Changes based on the card style.\n   */\n  get _cardHeight() {\n    return EMBED_CARD_HEIGHT[this._cardStyle];\n  }\n\n  /**\n   * The width of the current embed card. Changes based on the card style.\n   */\n  get _cardWidth() {\n    return EMBED_CARD_WIDTH[this._cardStyle];\n  }\n\n  get fetchAbortController() {\n    return this._fetchAbortController;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this._fetchAbortController.signal.aborted)\n      this._fetchAbortController = new AbortController();\n\n    this.contentEditable = 'false';\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    this._fetchAbortController.abort();\n  }\n\n  protected override accessor blockContainerStyles: StyleInfo | undefined = {\n    margin: '18px 0',\n  };\n\n  @query('.embed-block-container')\n  protected accessor embedBlock!: HTMLDivElement;\n\n  override accessor selectedStyle = SelectedStyle.Border;\n\n  override accessor useCaptionEditor = true;\n\n  override accessor useZeroWidth = true;\n}\n"]}