{"version":3,"file":"surface-block.js","sourceRoot":"","sources":["../src/surface-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Color } from '@blocksuite/affine-model';\nimport type { EditorHost, SurfaceSelection } from '@blocksuite/block-std';\nimport type { Slot } from '@blocksuite/global/utils';\n\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport { BlockComponent, RANGE_SYNC_EXCLUDE_ATTR } from '@blocksuite/block-std';\nimport {\n  GfxControllerIdentifier,\n  type Viewport,\n} from '@blocksuite/block-std/gfx';\nimport { Bound } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { query } from 'lit/decorators.js';\n\nimport type { ElementRenderer } from './renderer/elements/index.js';\nimport type { SurfaceBlockModel } from './surface-model.js';\nimport type { SurfaceBlockService } from './surface-service.js';\n\nimport { ConnectorElementModel } from './element-model/index.js';\nimport { CanvasRenderer } from './renderer/canvas-renderer.js';\nimport { OverlayIdentifier } from './renderer/overlay.js';\n\nexport interface SurfaceContext {\n  viewport: Viewport;\n  host: EditorHost;\n  elementRenderers: Record<string, ElementRenderer>;\n  selection: {\n    selectedIds: string[];\n    slots: {\n      updated: Slot<SurfaceSelection[]>;\n    };\n  };\n}\n\nexport class SurfaceBlockComponent extends BlockComponent<\n  SurfaceBlockModel,\n  SurfaceBlockService\n> {\n  static isConnector = (element: unknown): element is ConnectorElementModel => {\n    return element instanceof ConnectorElementModel;\n  };\n\n  static override styles = css`\n    .affine-edgeless-surface-block-container {\n      width: 100%;\n      height: 100%;\n    }\n\n    .affine-edgeless-surface-block-container canvas {\n      left: 0;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      z-index: 1;\n      pointer-events: none;\n    }\n\n    edgeless-block-portal-container {\n      position: relative;\n      box-sizing: border-box;\n      overflow: hidden;\n      display: block;\n      height: 100%;\n      font-family: var(--affine-font-family);\n      font-size: var(--affine-font-base);\n      line-height: var(--affine-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n    }\n\n    .affine-block-children-container.edgeless {\n      padding-left: 0;\n      position: relative;\n      overflow: hidden;\n      height: 100%;\n      /**\n       * Fix: pointerEvent stops firing after a short time.\n       * When a gesture is started, the browser intersects the touch-action values of the touched element and its ancestors,\n       * up to the one that implements the gesture (in other words, the first containing scrolling element)\n       * https://developer.mozilla.org/en-US/docs/Web/CSS/touch-action\n       */\n      touch-action: none;\n      background-color: var(--affine-background-primary-color);\n      background-image: radial-gradient(\n        var(--affine-edgeless-grid-color) 1px,\n        var(--affine-background-primary-color) 1px\n      );\n      z-index: 0;\n    }\n\n    .affine-edgeless-block-child {\n      position: absolute;\n      transform-origin: center;\n      box-sizing: border-box;\n      border: 2px solid var(--affine-white-10);\n      border-radius: 8px;\n      box-shadow: var(--affine-shadow-3);\n      pointer-events: all;\n    }\n  `;\n\n  private _cachedViewport = new Bound();\n\n  private _initThemeObserver = () => {\n    const theme = this.std.get(ThemeProvider);\n    this.disposables.add(theme.theme$.subscribe(() => this.requestUpdate()));\n  };\n\n  private _lastTime = 0;\n\n  private _renderer!: CanvasRenderer;\n\n  fitToViewport = (bound: Bound) => {\n    const { viewport } = this._gfx;\n    bound = bound.expand(30);\n    if (Date.now() - this._lastTime > 200)\n      this._cachedViewport = viewport.viewportBounds;\n    this._lastTime = Date.now();\n\n    if (this._cachedViewport.contains(bound)) return;\n\n    this._cachedViewport = this._cachedViewport.unite(bound);\n    viewport.setViewportByBound(this._cachedViewport, [0, 0, 0, 0], true);\n  };\n\n  refresh = () => {\n    this._renderer?.refresh();\n  };\n\n  private get _edgelessService() {\n    return this.std.getService('affine:page') as unknown as SurfaceContext;\n  }\n\n  private get _gfx() {\n    return this.std.get(GfxControllerIdentifier);\n  }\n\n  get renderer() {\n    return this._renderer;\n  }\n\n  private _initOverlays() {\n    this.std.provider.getAll(OverlayIdentifier).forEach(overlay => {\n      this._renderer.addOverlay(overlay);\n    });\n\n    this._disposables.add(() => {\n      this.std.provider.getAll(OverlayIdentifier).forEach(overlay => {\n        this._renderer.removeOverlay(overlay);\n      });\n    });\n  }\n\n  private _initRenderer() {\n    const gfx = this._gfx;\n    const themeService = this.std.get(ThemeProvider);\n\n    this._renderer = new CanvasRenderer({\n      viewport: gfx.viewport,\n      layerManager: gfx.layer,\n      gridManager: gfx.grid,\n      enableStackingCanvas: true,\n      provider: {\n        generateColorProperty: (color: Color, fallback: string) =>\n          themeService.generateColorProperty(\n            color,\n            fallback,\n            themeService.edgelessTheme\n          ),\n        getColorValue: (color: Color, fallback?: string, real?: boolean) =>\n          themeService.getColorValue(\n            color,\n            fallback,\n            real,\n            themeService.edgelessTheme\n          ),\n        getColorScheme: () => themeService.edgelessTheme,\n        getPropertyValue: (property: string) =>\n          themeService.getCssVariableColor(\n            property,\n            themeService.edgelessTheme\n          ),\n        selectedElements: () => this._edgelessService.selection.selectedIds,\n      },\n      onStackingCanvasCreated(canvas) {\n        canvas.className = 'indexable-canvas';\n      },\n      elementRenderers: this._edgelessService.elementRenderers,\n      surfaceModel: this.model,\n    });\n\n    this._disposables.add(() => {\n      this._renderer.dispose();\n    });\n    this._disposables.add(\n      this._renderer.stackingCanvasUpdated.on(payload => {\n        if (payload.added.length) {\n          this._surfaceContainer.append(...payload.added);\n        }\n\n        if (payload.removed.length) {\n          payload.removed.forEach(canvas => {\n            canvas.remove();\n          });\n        }\n      })\n    );\n    this._disposables.add(\n      this._edgelessService.selection.slots.updated.on(() => {\n        this._renderer.refresh();\n      })\n    );\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n\n    this._initThemeObserver();\n    this._initRenderer();\n    this._initOverlays();\n  }\n\n  override firstUpdated() {\n    this._renderer.attach(this._surfaceContainer);\n    this._surfaceContainer.append(...this._renderer.stackingCanvas);\n  }\n\n  override render() {\n    return html`\n      <div class=\"affine-edgeless-surface-block-container\">\n        <!-- attach canvas later in renderer -->\n      </div>\n    `;\n  }\n\n  @query('.affine-edgeless-surface-block-container')\n  private accessor _surfaceContainer!: HTMLElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-surface': SurfaceBlockComponent;\n  }\n}\n"]}