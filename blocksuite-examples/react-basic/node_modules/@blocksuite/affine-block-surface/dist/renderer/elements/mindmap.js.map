{"version":3,"file":"mindmap.js","sourceRoot":"","sources":["../../../src/renderer/elements/mindmap.ts"],"names":[],"mappings":"AAUA,OAAO,EAAE,sBAAsB,EAAE,MAAM,qCAAqC,CAAC;AAC7E,OAAO,EAAE,SAAS,IAAI,eAAe,EAAE,MAAM,sBAAsB,CAAC;AAEpE,MAAM,UAAU,OAAO,CACrB,KAA0B,EAC1B,GAA6B,EAC7B,MAAiB,EACjB,QAAwB,EACxB,EAAe,EACf,KAAa;IAEb,MAAM,EAAE,GAAG,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC;IAC7B,MAAM,EAAE,GAAG,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC;IAE7B,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC;IAEpC,MAAM,cAAc,GAAG,KAAK,CAAC,OAAO,CAAC;IAErC,MAAM,QAAQ,GAAG,CAAC,IAAiB,EAAE,EAAE;QACrC,MAAM,UAAU,GAAG,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QAC7C,IAAI,CAAC,UAAU;YAAE,OAAO;QACxB,UAAU,CAAC,OAAO,EAAE,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YACpC,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,GAAG,MAAM,CAAC;YACvC,MAAM,aAAa,GAAG,CAAC,EAAU,EAAE,EAAE,CACnC,KAAK,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE,CAAC;gBAC/B,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,CAAc,CAAC;YAEnD,IAAI,QAAQ,EAAE,CAAC;gBACb,sBAAsB,CAAC,UAAU,CAAC,SAAS,EAAE,IAAI,EAAE,aAAa,CAAC,CAAC;YACpE,CAAC;YAED,MAAM,EAAE,GAAG,SAAS,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC;YACjC,MAAM,EAAE,GAAG,SAAS,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC;YACjC,MAAM,MAAM,GAAG,GAAG,CAAC,WAAW,CAAC;YAC/B,MAAM,oBAAoB,GACxB,MAAM,KAAK,SAAS,CAAC,OAAO,GAAG,cAAc,CAAC;YAEhD,IAAI,oBAAoB,EAAE,CAAC;gBACzB,GAAG,CAAC,WAAW,GAAG,SAAS,CAAC,OAAO,GAAG,cAAc,CAAC;YACvD,CAAC;YAED,eAAe,CAAC,SAAS,EAAE,GAAG,EAAE,MAAM,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,QAAQ,EAAE,EAAE,CAAC,CAAC;YAExE,IAAI,oBAAoB,EAAE,CAAC;gBACzB,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;YAC3B,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC;YAC1B,OAAO;QACT,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QAClC,CAAC;IACH,CAAC,CAAC;IAEF,KAAK,CAAC,IAAI,IAAI,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;AACrC,CAAC","sourcesContent":["import type {\n  MindmapElementModel,\n  MindmapNode,\n} from '@blocksuite/affine-model';\nimport type { GfxModel } from '@blocksuite/block-std/gfx';\nimport type { IBound } from '@blocksuite/global/utils';\n\nimport type { RoughCanvas } from '../../utils/rough/canvas.js';\nimport type { CanvasRenderer } from '../canvas-renderer.js';\n\nimport { ConnectorPathGenerator } from '../../managers/connector-manager.js';\nimport { connector as renderConnector } from './connector/index.js';\n\nexport function mindmap(\n  model: MindmapElementModel,\n  ctx: CanvasRenderingContext2D,\n  matrix: DOMMatrix,\n  renderer: CanvasRenderer,\n  rc: RoughCanvas,\n  bound: IBound\n) {\n  const dx = model.x - bound.x;\n  const dy = model.y - bound.y;\n\n  matrix = matrix.translate(-dx, -dy);\n\n  const mindmapOpacity = model.opacity;\n\n  const traverse = (node: MindmapNode) => {\n    const connectors = model.getConnectors(node);\n    if (!connectors) return;\n    connectors.reverse().forEach(result => {\n      const { connector, outdated } = result;\n      const elementGetter = (id: string) =>\n        model.surface.getElementById(id) ??\n        (model.surface.doc.getBlockById(id) as GfxModel);\n\n      if (outdated) {\n        ConnectorPathGenerator.updatePath(connector, null, elementGetter);\n      }\n\n      const dx = connector.x - bound.x;\n      const dy = connector.y - bound.y;\n      const origin = ctx.globalAlpha;\n      const shouldSetGlobalAlpha =\n        origin !== connector.opacity * mindmapOpacity;\n\n      if (shouldSetGlobalAlpha) {\n        ctx.globalAlpha = connector.opacity * mindmapOpacity;\n      }\n\n      renderConnector(connector, ctx, matrix.translate(dx, dy), renderer, rc);\n\n      if (shouldSetGlobalAlpha) {\n        ctx.globalAlpha = origin;\n      }\n    });\n\n    if (node.detail.collapsed) {\n      return;\n    } else {\n      node.children.forEach(traverse);\n    }\n  };\n\n  model.tree && traverse(model.tree);\n}\n"]}