{"version":3,"file":"mindmap.js","sourceRoot":"","sources":["../../src/view/mindmap.ts"],"names":[],"mappings":"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","sourcesContent":["import type { PointerEventState } from '@blocksuite/block-std';\n\nimport {\n  LayoutType,\n  LocalShapeElementModel,\n  type MindmapElementModel,\n  type MindmapNode,\n  type MindmapRoot,\n} from '@blocksuite/affine-model';\nimport { TelemetryProvider } from '@blocksuite/affine-shared/services';\nimport { requestThrottledConnectedFrame } from '@blocksuite/affine-shared/utils';\nimport { GfxElementModelView } from '@blocksuite/block-std/gfx';\n\nimport { handleLayout } from '../utils/mindmap/utils.js';\n\nexport class MindMapView extends GfxElementModelView<MindmapElementModel> {\n  static override type = 'mindmap';\n\n  private _collapseButtons = new Map<string, LocalShapeElementModel>();\n\n  private _hoveredState = new Map<\n    string,\n    {\n      button: boolean;\n      node: boolean;\n    }\n  >();\n\n  private _getCollapseButton(node: MindmapNode | string) {\n    const id = typeof node === 'string' ? node : node.id;\n    return this._collapseButtons.get(`collapse-btn-${id}`);\n  }\n\n  private _initCollapseButtons() {\n    const updateButtons = requestThrottledConnectedFrame(() => {\n      if (!this.isConnected) {\n        return;\n      }\n\n      const visited = new Set<LocalShapeElementModel>();\n\n      this.model.traverse(node => {\n        const btn = this._updateCollapseButton(node);\n\n        btn && visited.add(btn);\n      });\n\n      this._collapseButtons.forEach(btn => {\n        if (!visited.has(btn)) {\n          this.surface.deleteLocalElement(btn);\n          this._collapseButtons.delete(btn.id);\n          const hoveredId = btn.id.replace('collapse-btn-', '');\n\n          this._hoveredState.delete(hoveredId);\n        }\n      });\n    });\n\n    this.disposable.add(\n      this.model.propsUpdated.on(({ key }) => {\n        if (key === 'layoutType' || key === 'style') {\n          updateButtons();\n        }\n      })\n    );\n\n    this.disposable.add(\n      this.surface.elementUpdated.on(payload => {\n        if (this.model.children.has(payload.id)) {\n          if (payload.props['xywh']) {\n            updateButtons();\n          }\n          if (payload.props['hidden'] !== undefined) {\n            this._updateButtonVisibility(payload.id);\n          }\n        }\n      })\n    );\n\n    this.model.children.observe(updateButtons);\n\n    this.disposable.add(() => {\n      this.model.children.unobserve(updateButtons);\n    });\n\n    updateButtons();\n  }\n\n  private _needToUpdateButtonStyle(options: {\n    button: LocalShapeElementModel;\n    node: MindmapNode;\n    updateKey?: boolean;\n  }) {\n    const { button, node } = options;\n    const layout = this.model.getLayoutDir(node);\n    const cacheKey = `${node.detail.collapsed ?? false}-${layout}-${node.element.xywh}-${this.model.style}`;\n\n    if (button.cache.get('MINDMAP_COLLAPSE_BUTTON') === cacheKey) {\n      return false;\n    } else if (options.updateKey) {\n      button.cache.set('MINDMAP_COLLAPSE_BUTTON', cacheKey);\n    }\n\n    return true;\n  }\n\n  private _setLayoutMethod() {\n    this.model.setLayoutMethod(function (\n      this: MindmapElementModel,\n      tree: MindmapNode | MindmapRoot = this.tree,\n      options: {\n        applyStyle?: boolean;\n        layoutType?: LayoutType;\n        stashed?: boolean;\n      } = {\n        applyStyle: true,\n        stashed: true,\n      }\n    ) {\n      const { stashed, applyStyle, layoutType } = Object.assign(\n        {\n          applyStyle: true,\n          calculateTreeBound: true,\n          stashed: true,\n        },\n        options\n      );\n\n      const pop = stashed ? this.stashTree(tree) : null;\n      handleLayout(this, tree, applyStyle, layoutType);\n      pop?.();\n    });\n  }\n\n  private _setVisibleOnSelection() {\n    let lastNode: null | string = null;\n    this.disposable.add(\n      this.gfx.selection.slots.updated.on(() => {\n        const elm = this.gfx.selection.firstElement;\n\n        if (lastNode) {\n          this._updateButtonVisibility(lastNode);\n        }\n\n        if (\n          this.gfx.selection.selectedElements.length === 1 &&\n          elm?.id &&\n          this.model.children.has(elm.id)\n        ) {\n          const button = this._getCollapseButton(elm.id);\n\n          if (!button) {\n            return;\n          }\n\n          this._updateButtonVisibility(elm.id);\n          lastNode = elm.id;\n        }\n      })\n    );\n  }\n\n  private _updateButtonVisibility(node: string) {\n    const latestNode = this.model.getNode(node);\n    const buttonModel = this._getCollapseButton(node);\n\n    if (!buttonModel) {\n      return;\n    }\n\n    if (!latestNode) {\n      buttonModel.opacity = 0;\n      return;\n    }\n\n    const hoveredState = this._hoveredState.get(node) ?? {\n      button: false,\n      node: false,\n    };\n\n    const hovered = hoveredState.button || hoveredState.node;\n    const hasChildren = (latestNode.children.length ?? 0) > 0;\n    const notHidden = !latestNode.element.hidden;\n    const isNodeSelected =\n      this.gfx.selection.firstElement === latestNode.element;\n    const collapsed = latestNode.detail.collapsed ?? false;\n\n    buttonModel.hidden = latestNode.element.hidden;\n    buttonModel.opacity =\n      hasChildren && notHidden && (collapsed || isNodeSelected || hovered)\n        ? 1\n        : 0;\n  }\n\n  private _updateCollapseButton(node: MindmapNode) {\n    if (!node?.element || node.children.length === 0) return null;\n\n    const id = `collapse-btn-${node.id}`;\n    const alreadyCreated = this._collapseButtons.has(id);\n    const collapseButton =\n      this._collapseButtons.get(id) ||\n      new LocalShapeElementModel(this.model.surface);\n    const collapsed = node.detail.collapsed ?? false;\n\n    if (\n      this._needToUpdateButtonStyle({\n        button: collapseButton,\n        node,\n        updateKey: true,\n      })\n    ) {\n      const style = this.model.styleGetter.getNodeStyle(\n        node,\n        this.model.getPath(node)\n      );\n      const layout = this.model.getLayoutDir(node);\n      const buttonStyle = collapsed ? style.expandButton : style.collapseButton;\n\n      Object.entries(buttonStyle).forEach(([key, value]) => {\n        // @ts-ignore\n        collapseButton[key as unknown] = value;\n      });\n\n      const nodeElementBound = node.element.elementBound;\n      const buttonBound = nodeElementBound.moveDelta(\n        layout === LayoutType.LEFT\n          ? -6 - buttonStyle.width\n          : 6 + nodeElementBound.w,\n        (nodeElementBound.h - buttonStyle.height) / 2\n      );\n\n      buttonBound.w = buttonStyle.width;\n      buttonBound.h = buttonStyle.height;\n\n      collapseButton.responseExtension = [16, 16];\n      collapseButton.xywh = buttonBound.serialize();\n      collapseButton.groupId = this.model.id;\n      collapseButton.text = collapsed ? node.children.length.toString() : '';\n    }\n\n    if (!alreadyCreated) {\n      collapseButton.id = id;\n      collapseButton.opacity = !node.element.hidden && collapsed ? 1 : 0;\n\n      this._collapseButtons.set(id, collapseButton);\n      this.surface.addLocalElement(collapseButton);\n\n      const hoveredState = {\n        button: false,\n        node: false,\n      };\n      const buttonView = this.gfx.view.get(id) as GfxElementModelView;\n      const isOnElementBound = (evt: PointerEventState) => {\n        const [x, y] = this.gfx.viewport.toModelCoord(evt.x, evt.y);\n\n        return buttonView.model.includesPoint(\n          x,\n          y,\n          { useElementBound: true },\n          this.gfx.std.host\n        );\n      };\n\n      this._hoveredState = this._hoveredState.set(node.id, hoveredState);\n\n      buttonView.on('pointerenter', () => {\n        hoveredState.button = true;\n        this._updateButtonVisibility(node.id);\n      });\n      buttonView.on('pointermove', evt => {\n        const latestNode = this.model.getNode(node.id);\n        if (\n          latestNode &&\n          !latestNode.element.hidden &&\n          latestNode.children.length > 0\n        ) {\n          if (isOnElementBound(evt)) {\n            this.gfx.cursor$.value = 'pointer';\n          } else {\n            this.gfx.cursor$.value = 'default';\n          }\n        }\n      });\n      buttonView.on('pointerleave', () => {\n        this.gfx.cursor$.value = 'default';\n\n        hoveredState.button = false;\n        this._updateButtonVisibility(node.id);\n      });\n      buttonView.on('click', evt => {\n        const latestNode = this.model.getNode(node.id);\n        const telemetry = this.gfx.std.getOptional(TelemetryProvider);\n\n        if (latestNode && isOnElementBound(evt)) {\n          if (telemetry) {\n            telemetry.track('ExpandedAndCollapsed', {\n              page: 'whiteboard editor',\n              segment: 'mind map',\n              type: latestNode.detail.collapsed ? 'expand' : 'collapse',\n            });\n          }\n\n          this.model.toggleCollapse(latestNode!, { layout: true });\n        }\n      });\n\n      const nodeView = this.gfx.view.get(node.id) as GfxElementModelView;\n\n      nodeView.on('pointerenter', () => {\n        hoveredState.node = true;\n        this._updateButtonVisibility(node.id);\n      });\n      nodeView.on('pointerleave', () => {\n        hoveredState.node = false;\n        this._updateButtonVisibility(node.id);\n      });\n    } else {\n      this._updateButtonVisibility(node.id);\n    }\n\n    return collapseButton;\n  }\n\n  override onCreated(): void {\n    this._setLayoutMethod();\n    this._initCollapseButtons();\n    this._setVisibleOnSelection();\n  }\n\n  override onDestroyed() {\n    super.onDestroyed();\n    this._collapseButtons.forEach(btn => {\n      this.surface.deleteLocalElement(btn);\n    });\n  }\n}\n"]}