{"version":3,"file":"dedent-blocks.js","sourceRoot":"","sources":["../../../src/note-block/commands/dedent-blocks.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Command } from '@blocksuite/block-std';\n\nimport {\n  calculateCollapsedSiblings,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\n\nexport const dedentBlocks: Command<\n  never,\n  never,\n  {\n    blockIds?: string[];\n    stopCapture?: boolean;\n  }\n> = (ctx, next) => {\n  let { blockIds } = ctx;\n  const { std, stopCapture = true } = ctx;\n  const { doc, selection, range, host } = std;\n  const { schema } = doc;\n\n  if (!blockIds || !blockIds.length) {\n    const nativeRange = range.value;\n    if (nativeRange) {\n      const topBlocks = range.getSelectedBlockComponentsByRange(nativeRange, {\n        match: el => el.model.role === 'content',\n        mode: 'highest',\n      });\n      if (topBlocks.length > 0) {\n        blockIds = topBlocks.map(block => block.blockId);\n      }\n    } else {\n      blockIds = std.selection.getGroup('note').map(sel => sel.blockId);\n    }\n  }\n\n  if (!blockIds || !blockIds.length || doc.readonly) return;\n\n  // Find the first model that can be unindented\n  let firstDedentIndex = -1;\n  for (let i = 0; i < blockIds.length; i++) {\n    const model = doc.getBlock(blockIds[i])?.model;\n    if (!model) continue;\n    const parent = doc.getParent(blockIds[i]);\n    if (!parent) continue;\n    const grandParent = doc.getParent(parent);\n    if (!grandParent) continue;\n\n    if (schema.isValid(model.flavour, grandParent.flavour)) {\n      firstDedentIndex = i;\n      break;\n    }\n  }\n\n  if (firstDedentIndex === -1) return;\n\n  if (stopCapture) doc.captureSync();\n\n  const collapsedIds: string[] = [];\n  blockIds.slice(firstDedentIndex).forEach(id => {\n    const model = doc.getBlock(id)?.model;\n    if (!model) return;\n    if (\n      matchFlavours(model, ['affine:paragraph']) &&\n      model.type.startsWith('h') &&\n      model.collapsed\n    ) {\n      const collapsedSiblings = calculateCollapsedSiblings(model);\n      collapsedIds.push(...collapsedSiblings.map(sibling => sibling.id));\n    }\n  });\n  // Models waiting to be dedented\n  const dedentIds = blockIds\n    .slice(firstDedentIndex)\n    .filter(id => !collapsedIds.includes(id));\n  dedentIds.reverse().forEach(id => {\n    std.command.exec('dedentBlock', { blockId: id, stopCapture: false });\n  });\n\n  const textSelection = selection.find('text');\n  if (textSelection) {\n    host.updateComplete\n      .then(() => {\n        range.syncTextSelectionToRange(textSelection);\n      })\n      .catch(console.error);\n  }\n\n  return next();\n};\n"]}