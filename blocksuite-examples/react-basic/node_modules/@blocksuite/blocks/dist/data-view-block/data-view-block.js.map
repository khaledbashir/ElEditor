{"version":3,"file":"data-view-block.js","sourceRoot":"","sources":["../../src/data-view-block/data-view-block.ts"],"names":[],"mappings":"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","sourcesContent":["import { CaptionedBlockComponent } from '@blocksuite/affine-components/caption';\nimport {\n  menu,\n  popMenu,\n  popupTargetFromElement,\n} from '@blocksuite/affine-components/context-menu';\nimport {\n  CopyIcon,\n  DeleteIcon,\n  MoreHorizontalIcon,\n} from '@blocksuite/affine-components/icons';\nimport { PeekViewProvider } from '@blocksuite/affine-components/peek';\nimport { toast } from '@blocksuite/affine-components/toast';\nimport {\n  NotificationProvider,\n  type TelemetryEventMap,\n  TelemetryProvider,\n} from '@blocksuite/affine-shared/services';\nimport { RANGE_SYNC_EXCLUDE_ATTR } from '@blocksuite/block-std';\nimport {\n  createRecordDetail,\n  createUniComponentFromWebComponent,\n  DatabaseSelection,\n  type DataSource,\n  DataView,\n  dataViewCommonStyle,\n  type DataViewProps,\n  type DataViewSelection,\n  type DataViewWidget,\n  type DataViewWidgetProps,\n  defineUniComponent,\n  renderUniLit,\n  uniMap,\n} from '@blocksuite/data-view';\nimport { widgetPresets } from '@blocksuite/data-view/widget-presets';\nimport { Slice } from '@blocksuite/store';\nimport { computed, signal } from '@preact/signals-core';\nimport { css, nothing, unsafeCSS } from 'lit';\nimport { html } from 'lit/static-html.js';\n\nimport type { NoteBlockComponent } from '../note-block/index.js';\nimport type { DataViewBlockModel } from './data-view-model.js';\n\nimport { BlockRenderer } from '../database-block/detail-panel/block-renderer.js';\nimport { NoteRenderer } from '../database-block/detail-panel/note-renderer.js';\nimport {\n  EdgelessRootBlockComponent,\n  type RootService,\n} from '../root-block/index.js';\nimport { BlockQueryDataSource } from './data-source.js';\n\nexport class DataViewBlockComponent extends CaptionedBlockComponent<DataViewBlockModel> {\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-database'))}\n    affine-database {\n      display: block;\n      border-radius: 8px;\n      background-color: var(--affine-background-primary-color);\n      padding: 8px;\n      margin: 8px -8px -8px;\n    }\n\n    .database-block-selected {\n      background-color: var(--affine-hover-color);\n      border-radius: 4px;\n    }\n\n    .database-ops {\n      padding: 2px;\n      border-radius: 4px;\n      display: flex;\n      cursor: pointer;\n    }\n\n    .database-ops svg {\n      width: 16px;\n      height: 16px;\n      color: var(--affine-icon-color);\n    }\n\n    .database-ops:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    @media print {\n      .database-ops {\n        display: none;\n      }\n\n      .database-header-bar {\n        display: none !important;\n      }\n    }\n  `;\n\n  private _clickDatabaseOps = (e: MouseEvent) => {\n    popMenu(popupTargetFromElement(e.currentTarget as HTMLElement), {\n      options: {\n        items: [\n          menu.input({\n            initialValue: this.model.title,\n            placeholder: 'Untitled',\n            onChange: text => {\n              this.model.title = text;\n            },\n          }),\n          menu.action({\n            prefix: CopyIcon,\n            name: 'Copy',\n            select: () => {\n              const slice = Slice.fromModels(this.doc, [this.model]);\n              this.std.clipboard.copySlice(slice).catch(console.error);\n            },\n          }),\n          menu.group({\n            name: '',\n            items: [\n              menu.action({\n                prefix: DeleteIcon,\n                class: {\n                  'delete-item': true,\n                },\n                name: 'Delete Database',\n                select: () => {\n                  this.model.children.slice().forEach(block => {\n                    this.doc.deleteBlock(block);\n                  });\n                  this.doc.deleteBlock(this.model);\n                },\n              }),\n            ],\n          }),\n        ],\n      },\n    });\n  };\n\n  private _dataSource?: DataSource;\n\n  private dataView = new DataView();\n\n  _bindHotkey: DataViewProps['bindHotkey'] = hotkeys => {\n    return {\n      dispose: this.host.event.bindHotkey(hotkeys, {\n        blockId: this.topContenteditableElement?.blockId ?? this.blockId,\n      }),\n    };\n  };\n\n  _handleEvent: DataViewProps['handleEvent'] = (name, handler) => {\n    return {\n      dispose: this.host.event.add(name, handler, {\n        blockId: this.blockId,\n      }),\n    };\n  };\n\n  getRootService = () => {\n    return this.std.getService<RootService>('affine:page');\n  };\n\n  headerWidget: DataViewWidget = defineUniComponent(\n    (props: DataViewWidgetProps) => {\n      return html`\n        <div style=\"margin-bottom: 16px;display:flex;flex-direction: column\">\n          <div style=\"display:flex;gap:8px;padding: 0 6px;margin-bottom: 8px;\">\n            <div>${this.model.title}</div>\n            ${this.renderDatabaseOps()}\n          </div>\n          <div\n            style=\"display:flex;align-items:center;justify-content: space-between;gap: 12px\"\n            class=\"database-header-bar\"\n          >\n            <div style=\"flex:1\">\n              ${renderUniLit(widgetPresets.viewBar, props)}\n            </div>\n            ${renderUniLit(this.toolsWidget, props)}\n          </div>\n          ${renderUniLit(widgetPresets.quickSettingBar, props)}\n        </div>\n      `;\n    }\n  );\n\n  selection$ = computed(() => {\n    const databaseSelection = this.selection.value.find(\n      (selection): selection is DatabaseSelection => {\n        if (selection.blockId !== this.blockId) {\n          return false;\n        }\n        return selection instanceof DatabaseSelection;\n      }\n    );\n    return databaseSelection?.viewSelection;\n  });\n\n  setSelection = (selection: DataViewSelection | undefined) => {\n    this.selection.setGroup(\n      'note',\n      selection\n        ? [\n            new DatabaseSelection({\n              blockId: this.blockId,\n              viewSelection: selection,\n            }),\n          ]\n        : []\n    );\n  };\n\n  toolsWidget: DataViewWidget = widgetPresets.createTools({\n    table: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n      widgetPresets.tools.tableAddRow,\n    ],\n    kanban: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n    ],\n  });\n\n  get dataSource(): DataSource {\n    if (!this._dataSource) {\n      this._dataSource = new BlockQueryDataSource(this.host, this.model, {\n        type: 'todo',\n      });\n    }\n    return this._dataSource;\n  }\n\n  override get topContenteditableElement() {\n    if (this.rootComponent instanceof EdgelessRootBlockComponent) {\n      const note = this.closest<NoteBlockComponent>('affine-note');\n      return note;\n    }\n    return this.rootComponent;\n  }\n\n  get view() {\n    return this.dataView.expose;\n  }\n\n  private renderDatabaseOps() {\n    if (this.doc.readonly) {\n      return nothing;\n    }\n    return html` <div class=\"database-ops\" @click=\"${this._clickDatabaseOps}\">\n      ${MoreHorizontalIcon}\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override renderBlock() {\n    const peekViewService = this.std.getOptional(PeekViewProvider);\n    const telemetryService = this.std.getOptional(TelemetryProvider);\n    return html`\n      <div contenteditable=\"false\" style=\"position: relative\">\n        ${this.dataView.render({\n          virtualPadding$: signal(0),\n          bindHotkey: this._bindHotkey,\n          handleEvent: this._handleEvent,\n          selection$: this.selection$,\n          setSelection: this.setSelection,\n          dataSource: this.dataSource,\n          headerWidget: this.headerWidget,\n          clipboard: this.std.clipboard,\n          notification: {\n            toast: message => {\n              const notification = this.std.getOptional(NotificationProvider);\n              if (notification) {\n                notification.toast(message);\n              } else {\n                toast(this.host, message);\n              }\n            },\n          },\n          eventTrace: (key, params) => {\n            telemetryService?.track(key, {\n              ...(params as TelemetryEventMap[typeof key]),\n              blockId: this.blockId,\n            });\n          },\n          detailPanelConfig: {\n            openDetailPanel: (target, data) => {\n              if (peekViewService) {\n                const template = createRecordDetail({\n                  ...data,\n                  openDoc: () => {},\n                  detail: {\n                    header: uniMap(\n                      createUniComponentFromWebComponent(BlockRenderer),\n                      props => ({\n                        ...props,\n                        host: this.host,\n                      })\n                    ),\n                    note: uniMap(\n                      createUniComponentFromWebComponent(NoteRenderer),\n                      props => ({\n                        ...props,\n                        model: this.model,\n                        host: this.host,\n                      })\n                    ),\n                  },\n                });\n                return peekViewService.peek({ target, template });\n              } else {\n                return Promise.resolve();\n              }\n            },\n          },\n        })}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view': DataViewBlockComponent;\n  }\n}\n"]}