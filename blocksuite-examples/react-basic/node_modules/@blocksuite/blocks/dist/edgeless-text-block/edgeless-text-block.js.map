{"version":3,"file":"edgeless-text-block.js","sourceRoot":"","sources":["../../src/edgeless-text-block/edgeless-text-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EdgelessTextBlockModel } from '@blocksuite/affine-model';\nimport type { BlockComponent } from '@blocksuite/block-std';\n\nimport { TextUtils } from '@blocksuite/affine-block-surface';\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport { matchFlavours } from '@blocksuite/affine-shared/utils';\nimport { GfxBlockComponent } from '@blocksuite/block-std';\nimport { Bound } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { query, state } from 'lit/decorators.js';\nimport { type StyleInfo, styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootService } from '../root-block/index.js';\n\nexport const EDGELESS_TEXT_BLOCK_MIN_WIDTH = 50;\nexport const EDGELESS_TEXT_BLOCK_MIN_HEIGHT = 50;\n\nexport class EdgelessTextBlockComponent extends GfxBlockComponent<EdgelessTextBlockModel> {\n  static override styles = css`\n    .edgeless-text-block-container[data-max-width='false'] .inline-editor span {\n      word-break: keep-all !important;\n      text-wrap: nowrap !important;\n    }\n\n    .edgeless-text-block-container affine-paragraph,\n    affine-list {\n      color: var(--edgeless-text-color);\n      font-family: var(--edgeless-text-font-family);\n      font-style: var(--edgeless-text-font-style);\n      font-weight: var(--edgeless-text-font-weight);\n      text-align: var(--edgeless-text-text-align);\n    }\n  `;\n\n  private _resizeObserver = new ResizeObserver(() => {\n    if (this.doc.readonly) {\n      return;\n    }\n\n    if (!this.model.hasMaxWidth) {\n      this._updateW();\n    }\n\n    this._updateH();\n  });\n\n  get rootService() {\n    return this.std.getService('affine:page') as EdgelessRootService;\n  }\n\n  private _updateH() {\n    const bound = Bound.deserialize(this.model.xywh);\n    const rect = this._textContainer.getBoundingClientRect();\n    bound.h = rect.height / this.gfx.viewport.zoom;\n\n    this.doc.updateBlock(this.model, {\n      xywh: bound.serialize(),\n    });\n  }\n\n  private _updateW() {\n    const bound = Bound.deserialize(this.model.xywh);\n    const rect = this._textContainer.getBoundingClientRect();\n    bound.w = Math.max(\n      rect.width / this.gfx.viewport.zoom,\n      EDGELESS_TEXT_BLOCK_MIN_WIDTH * this.gfx.viewport.zoom\n    );\n\n    this.doc.updateBlock(this.model, {\n      xywh: bound.serialize(),\n    });\n  }\n\n  checkWidthOverflow(width: number) {\n    let wValid = true;\n\n    const oldWidthStr = this._textContainer.style.width;\n    this._textContainer.style.width = `${width}px`;\n    if (\n      this.childrenContainer.scrollWidth > this.childrenContainer.offsetWidth\n    ) {\n      wValid = false;\n    }\n    this._textContainer.style.width = oldWidthStr;\n\n    return wValid;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.disposables.add(\n      this.model.propsUpdated.on(({ key }) => {\n        this.updateComplete\n          .then(() => {\n            if (!this.host) return;\n\n            const command = this.host.command;\n            const blockSelections = this.model.children.map(child =>\n              this.host.selection.create('block', {\n                blockId: child.id,\n              })\n            );\n\n            if (key === 'fontStyle') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  italic: null,\n                },\n              });\n            } else if (key === 'color') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  color: null,\n                },\n              });\n            } else if (key === 'fontWeight') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  bold: null,\n                },\n              });\n            }\n          })\n          .catch(console.error);\n      })\n    );\n  }\n\n  override firstUpdated(props: Map<string, unknown>) {\n    super.firstUpdated(props);\n\n    const { disposables, rootService } = this;\n    const edgelessSelection = rootService.selection;\n\n    disposables.add(\n      edgelessSelection.slots.updated.on(() => {\n        if (edgelessSelection.has(this.model.id) && edgelessSelection.editing) {\n          this._editing = true;\n        } else {\n          this._editing = false;\n        }\n      })\n    );\n\n    this._resizeObserver.observe(this._textContainer);\n    disposables.add(() => {\n      this._resizeObserver.disconnect();\n    });\n\n    disposables.addFromEvent(this._textContainer, 'click', e => {\n      if (!this._editing) return;\n\n      const containerRect = this._textContainer.getBoundingClientRect();\n      const isTop = e.clientY < containerRect.top + containerRect.height / 2;\n\n      let newParagraphId: string | null = null;\n      if (isTop) {\n        const firstChild = this.model.firstChild();\n        if (\n          !firstChild ||\n          !matchFlavours(firstChild, ['affine:list', 'affine:paragraph'])\n        ) {\n          newParagraphId = this.doc.addBlock(\n            'affine:paragraph',\n            {},\n            this.model.id,\n            0\n          );\n        }\n      } else {\n        const lastChild = this.model.lastChild();\n        if (\n          !lastChild ||\n          !matchFlavours(lastChild, ['affine:list', 'affine:paragraph'])\n        ) {\n          newParagraphId = this.doc.addBlock(\n            'affine:paragraph',\n            {},\n            this.model.id\n          );\n        }\n      }\n\n      if (newParagraphId) {\n        this.rootService.selectionManager.setGroup('note', [\n          this.rootService.selectionManager.create('text', {\n            from: {\n              blockId: newParagraphId,\n              index: 0,\n              length: 0,\n            },\n            to: null,\n          }),\n        ]);\n      }\n    });\n\n    disposables.addFromEvent(this._textContainer, 'focusout', () => {\n      if (!this._editing) return;\n\n      this.rootService.selectionManager.clear();\n    });\n\n    let composingWidth = EDGELESS_TEXT_BLOCK_MIN_WIDTH;\n    disposables.addFromEvent(this, 'compositionupdate', () => {\n      composingWidth = Math.max(\n        this._textContainer.offsetWidth,\n        EDGELESS_TEXT_BLOCK_MIN_HEIGHT\n      );\n    });\n    disposables.addFromEvent(this, 'compositionend', () => {\n      if (this.model.hasMaxWidth) {\n        composingWidth = EDGELESS_TEXT_BLOCK_MIN_WIDTH;\n        return;\n      }\n      // when IME finish container will crash to a small width, so\n      // we set a max width to prevent this\n      this._textContainer.style.width = `${composingWidth}px`;\n      this.model.hasMaxWidth = true;\n      requestAnimationFrame(() => {\n        this._textContainer.style.width = '';\n      });\n    });\n  }\n\n  override getCSSTransform(): string {\n    const viewport = this.gfx.viewport;\n    const { translateX, translateY, zoom } = viewport;\n    const bound = Bound.deserialize(this.model.xywh);\n\n    const scaledX = bound.x * zoom;\n    const scaledY = bound.y * zoom;\n    const deltaX = scaledX - bound.x;\n    const deltaY = scaledY - bound.y;\n\n    return `translate(${translateX + deltaX}px, ${translateY + deltaY}px) scale(${zoom * this.model.scale})`;\n  }\n\n  override getRenderingRect() {\n    const { xywh, scale, rotate, hasMaxWidth } = this.model;\n    const bound = Bound.deserialize(xywh);\n    const w = hasMaxWidth ? bound.w / scale : undefined;\n\n    return {\n      x: bound.x,\n      y: bound.y,\n      w,\n      h: bound.h / scale,\n      rotate,\n      zIndex: this.toZIndex(),\n    };\n  }\n\n  override renderGfxBlock() {\n    const { model } = this;\n    const { rotate, hasMaxWidth } = model;\n    const editing = this._editing;\n    const containerStyle: StyleInfo = {\n      transform: `rotate(${rotate}deg)`,\n      transformOrigin: 'center',\n      border: `1px solid ${editing ? 'var(--affine—primary—color, #1e96eb)' : 'transparent'}`,\n      borderRadius: '4px',\n      boxSizing: 'border-box',\n      boxShadow: editing ? '0px 0px 0px 2px rgba(30, 150, 235, 0.3)' : 'none',\n      fontWeight: '400',\n      lineHeight: 'var(--affine-line-height)',\n    };\n\n    return html`\n      <div\n        class=\"edgeless-text-block-container\"\n        data-max-width=\"${hasMaxWidth}\"\n        style=${styleMap(containerStyle)}\n      >\n        <div\n          style=${styleMap({\n            pointerEvents: editing ? 'auto' : 'none',\n            userSelect: editing ? 'auto' : 'none',\n          })}\n          contenteditable=${editing}\n        >\n          ${this.renderPageContent()}\n        </div>\n      </div>\n    `;\n  }\n\n  override renderPageContent() {\n    const { fontFamily, fontStyle, fontWeight, textAlign } = this.model;\n    const color = this.std\n      .get(ThemeProvider)\n      .generateColorProperty(this.model.color, '#000000');\n\n    const style = styleMap({\n      '--edgeless-text-color': color,\n      '--edgeless-text-font-family': TextUtils.wrapFontFamily(fontFamily),\n      '--edgeless-text-font-style': fontStyle,\n      '--edgeless-text-font-weight': fontWeight,\n      '--edgeless-text-text-align': textAlign,\n      '--affine-list-margin': '0',\n      '--affine-paragraph-margin': '0',\n    });\n\n    return html`\n      <div style=${style} class=\"affine-block-children-container\">\n        ${this.renderChildren(this.model)}\n      </div>\n    `;\n  }\n\n  tryFocusEnd() {\n    const paragraphOrLists = Array.from(\n      this.querySelectorAll<BlockComponent>('affine-paragraph, affine-list')\n    );\n    const last = paragraphOrLists.at(-1);\n    if (last) {\n      this.host.selection.setGroup('note', [\n        this.host.selection.create('text', {\n          from: {\n            blockId: last.blockId,\n            index: last.model.text?.length ?? 0,\n            length: 0,\n          },\n          to: null,\n        }),\n      ]);\n    }\n  }\n\n  @state()\n  private accessor _editing = false;\n\n  @query('.edgeless-text-block-container')\n  private accessor _textContainer!: HTMLDivElement;\n\n  @query('.affine-block-children-container')\n  accessor childrenContainer!: HTMLDivElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-edgeless-text': EdgelessTextBlockComponent;\n  }\n}\n"]}