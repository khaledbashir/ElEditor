{"version":3,"file":"render-linked-doc.js","sourceRoot":"","sources":["../../../src/_common/utils/render-linked-doc.ts"],"names":[],"mappings":"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","sourcesContent":["import type { FrameBlockModel, NoteBlockModel } from '@blocksuite/affine-model';\nimport type { EditorHost } from '@blocksuite/block-std';\n\nimport { NoteDisplayMode } from '@blocksuite/affine-model';\nimport {\n  DocModeProvider,\n  NotificationProvider,\n} from '@blocksuite/affine-shared/services';\nimport { getBlockProps, matchFlavours } from '@blocksuite/affine-shared/utils';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type BlockModel,\n  type BlockSnapshot,\n  type Doc,\n  type DraftModel,\n  Slice,\n} from '@blocksuite/store';\n\nimport { GfxBlockModel } from '../../root-block/edgeless/block-model.js';\nimport {\n  getElementProps,\n  mapFrameIds,\n  sortEdgelessElements,\n} from '../../root-block/edgeless/utils/clone-utils.js';\nimport {\n  isFrameBlock,\n  isNoteBlock,\n} from '../../root-block/edgeless/utils/query.js';\nimport { getSurfaceBlock } from '../../surface-ref-block/utils.js';\n\nexport function promptDocTitle(host: EditorHost, autofill?: string) {\n  const notification = host.std.getOptional(NotificationProvider);\n  if (!notification) return Promise.resolve(undefined);\n\n  return notification.prompt({\n    title: 'Create linked doc',\n    message: 'Enter a title for the new doc.',\n    placeholder: 'Untitled',\n    autofill,\n    confirmText: 'Confirm',\n    cancelText: 'Cancel',\n  });\n}\n\nexport function getTitleFromSelectedModels(selectedModels: DraftModel[]) {\n  const firstBlock = selectedModels[0];\n  if (\n    matchFlavours(firstBlock, ['affine:paragraph']) &&\n    firstBlock.type.startsWith('h')\n  ) {\n    return firstBlock.text.toString();\n  }\n  return undefined;\n}\n\nexport function notifyDocCreated(host: EditorHost, doc: Doc) {\n  const notification = host.std.getOptional(NotificationProvider);\n  if (!notification) return;\n\n  const abortController = new AbortController();\n  const clear = () => {\n    doc.history.off('stack-item-added', addHandler);\n    doc.history.off('stack-item-popped', popHandler);\n    disposable.dispose();\n  };\n  const closeNotify = () => {\n    abortController.abort();\n    clear();\n  };\n\n  // edit or undo or switch doc, close notify toast\n  const addHandler = doc.history.on('stack-item-added', closeNotify);\n  const popHandler = doc.history.on('stack-item-popped', closeNotify);\n  const disposable = host.slots.unmounted.on(closeNotify);\n\n  notification.notify({\n    title: 'Linked doc created',\n    message: 'You can click undo to recovery block content',\n    accent: 'info',\n    duration: 10 * 1000,\n    action: {\n      label: 'Undo',\n      onClick: () => {\n        doc.undo();\n        clear();\n      },\n    },\n    abort: abortController.signal,\n    onClose: clear,\n  });\n}\n\nexport function addBlocksToDoc(\n  targetDoc: Doc,\n  model: BlockModel,\n  parentId: string\n) {\n  // Add current block to linked doc\n  const blockProps = getBlockProps(model);\n  const newModelId = targetDoc.addBlock(\n    model.flavour as BlockSuite.Flavour,\n    blockProps,\n    parentId\n  );\n  // Add children to linked doc, parent is the new model\n  const children = model.children;\n  if (children.length > 0) {\n    children.forEach(child => {\n      addBlocksToDoc(targetDoc, child, newModelId);\n    });\n  }\n}\n\nexport async function convertSelectedBlocksToLinkedDoc(\n  std: BlockSuite.Std,\n  doc: Doc,\n  selectedModels: DraftModel[] | Promise<DraftModel[]>,\n  docTitle?: string\n) {\n  const models = await selectedModels;\n  const slice = std.clipboard.sliceToSnapshot(Slice.fromModels(doc, models));\n  if (!slice) {\n    return;\n  }\n  const firstBlock = models[0];\n  assertExists(firstBlock);\n  // if title undefined, use the first heading block content as doc title\n  const title = docTitle || getTitleFromSelectedModels(models);\n  const linkedDoc = createLinkedDocFromSlice(std, doc, slice.content, title);\n  // insert linked doc card\n  doc.addSiblingBlocks(\n    doc.getBlock(firstBlock.id)!.model,\n    [\n      {\n        flavour: 'affine:embed-linked-doc',\n        pageId: linkedDoc.id,\n      },\n    ],\n    'before'\n  );\n  // delete selected elements\n  models.forEach(model => doc.deleteBlock(model));\n  return linkedDoc;\n}\n\nexport function createLinkedDocFromSlice(\n  std: BlockSuite.Std,\n  doc: Doc,\n  snapshots: BlockSnapshot[],\n  docTitle?: string\n) {\n  // const modelsWithChildren = (list:BlockModel[]):BlockModel[]=>list.flatMap(model=>[model,...modelsWithChildren(model.children)])\n  const linkedDoc = doc.collection.createDoc({});\n  linkedDoc.load(() => {\n    const rootId = linkedDoc.addBlock('affine:page', {\n      title: new doc.Text(docTitle),\n    });\n    linkedDoc.addBlock('affine:surface', {}, rootId);\n    const noteId = linkedDoc.addBlock('affine:note', {}, rootId);\n    snapshots.forEach(snapshot => {\n      std.clipboard\n        .pasteBlockSnapshot(snapshot, linkedDoc, noteId)\n        .catch(console.error);\n    });\n  });\n  return linkedDoc;\n}\n\nexport function createLinkedDocFromNote(\n  doc: Doc,\n  note: NoteBlockModel,\n  docTitle?: string\n) {\n  const linkedDoc = doc.collection.createDoc({});\n  linkedDoc.load(() => {\n    const rootId = linkedDoc.addBlock('affine:page', {\n      title: new doc.Text(docTitle),\n    });\n    linkedDoc.addBlock('affine:surface', {}, rootId);\n    const blockProps = getBlockProps(note);\n    // keep note props & show in both mode\n    const noteId = linkedDoc.addBlock(\n      'affine:note',\n      {\n        ...blockProps,\n        hidden: false,\n        displayMode: NoteDisplayMode.DocAndEdgeless,\n      },\n      rootId\n    );\n    // Add note to linked doc recursively\n    note.children.forEach(model => {\n      addBlocksToDoc(linkedDoc, model, noteId);\n    });\n  });\n\n  return linkedDoc;\n}\n\nexport function createLinkedDocFromEdgelessElements(\n  host: EditorHost,\n  elements: BlockSuite.EdgelessModel[],\n  docTitle?: string\n) {\n  const linkedDoc = host.doc.collection.createDoc({});\n  linkedDoc.load(() => {\n    const rootId = linkedDoc.addBlock('affine:page', {\n      title: new host.doc.Text(docTitle),\n    });\n    const surfaceId = linkedDoc.addBlock('affine:surface', {}, rootId);\n    const surface = getSurfaceBlock(linkedDoc);\n    if (!surface) return;\n\n    const sortedElements = sortEdgelessElements(elements);\n    const ids = new Map<string, string>();\n    sortedElements.forEach(model => {\n      let newId = model.id;\n      if (model instanceof GfxBlockModel) {\n        const blockProps = getBlockProps(model);\n        if (isNoteBlock(model)) {\n          newId = linkedDoc.addBlock('affine:note', blockProps, rootId);\n          // Add note children to linked doc recursively\n          model.children.forEach(model => {\n            addBlocksToDoc(linkedDoc, model, newId);\n          });\n        } else {\n          if (isFrameBlock(model)) {\n            mapFrameIds(blockProps as unknown as FrameBlockModel, ids);\n          }\n\n          newId = linkedDoc.addBlock(\n            model.flavour as BlockSuite.Flavour,\n            blockProps,\n            surfaceId\n          );\n        }\n      } else {\n        const props = getElementProps(model, ids);\n        newId = surface.addElement(props);\n      }\n      ids.set(model.id, newId);\n    });\n  });\n\n  host.std.get(DocModeProvider).setPrimaryMode('edgeless', linkedDoc.id);\n  return linkedDoc;\n}\n"]}