{"version":3,"file":"html.js","sourceRoot":"","sources":["../../../src/_common/transformers/html.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Doc, DocCollection } from '@blocksuite/store';\n\nimport { sha } from '@blocksuite/global/utils';\nimport { extMimeMap, Job } from '@blocksuite/store';\n\nimport { HtmlAdapter } from '../adapters/html-adapter/html.js';\nimport {\n  defaultImageProxyMiddleware,\n  docLinkBaseURLMiddleware,\n  fileNameMiddleware,\n  titleMiddleware,\n} from './middlewares.js';\nimport { createAssetsArchive, download, Unzip } from './utils.js';\n\ntype ImportHTMLToDocOptions = {\n  collection: DocCollection;\n  html: string;\n  fileName?: string;\n};\n\ntype ImportHTMLZipOptions = {\n  collection: DocCollection;\n  imported: Blob;\n};\n\n/**\n * Exports a doc to HTML format.\n *\n * @param doc - The doc to be exported.\n * @returns A Promise that resolves when the export is complete.\n */\nasync function exportDoc(doc: Doc) {\n  const job = new Job({\n    collection: doc.collection,\n    middlewares: [docLinkBaseURLMiddleware, titleMiddleware],\n  });\n  const snapshot = job.docToSnapshot(doc);\n  const adapter = new HtmlAdapter(job);\n  if (!snapshot) {\n    return;\n  }\n  const htmlResult = await adapter.fromDocSnapshot({\n    snapshot,\n    assets: job.assetsManager,\n  });\n\n  let downloadBlob: Blob;\n  const docTitle = doc.meta?.title || 'Untitled';\n  let name: string;\n  const contentBlob = new Blob([htmlResult.file], { type: 'plain/text' });\n  if (htmlResult.assetsIds.length > 0) {\n    const zip = await createAssetsArchive(job.assets, htmlResult.assetsIds);\n\n    await zip.file('index.html', contentBlob);\n\n    downloadBlob = await zip.generate();\n    name = `${docTitle}.zip`;\n  } else {\n    downloadBlob = contentBlob;\n    name = `${docTitle}.html`;\n  }\n  download(downloadBlob, name);\n}\n\n/**\n * Imports HTML content into a new doc within a collection.\n *\n * @param options - The import options.\n * @param options.collection - The target doc collection.\n * @param options.html - The HTML content to import.\n * @param options.fileName - Optional filename for the imported doc.\n * @returns A Promise that resolves to the ID of the newly created doc, or undefined if import fails.\n */\nasync function importHTMLToDoc({\n  collection,\n  html,\n  fileName,\n}: ImportHTMLToDocOptions) {\n  const job = new Job({\n    collection,\n    middlewares: [\n      defaultImageProxyMiddleware,\n      fileNameMiddleware(fileName),\n      docLinkBaseURLMiddleware,\n    ],\n  });\n  const htmlAdapter = new HtmlAdapter(job);\n  const page = await htmlAdapter.toDoc({\n    file: html,\n    assets: job.assetsManager,\n  });\n  if (!page) {\n    return;\n  }\n  return page.id;\n}\n\n/**\n * Imports a zip file containing HTML files and assets into a collection.\n *\n * @param options - The import options.\n * @param options.collection - The target doc collection.\n * @param options.imported - The zip file as a Blob.\n * @returns A Promise that resolves to an array of IDs of the newly created docs.\n */\nasync function importHTMLZip({ collection, imported }: ImportHTMLZipOptions) {\n  const unzip = new Unzip();\n  await unzip.load(imported);\n\n  const docIds: string[] = [];\n  const pendingAssets = new Map<string, File>();\n  const pendingPathBlobIdMap = new Map<string, string>();\n  const htmlBlobs: [string, Blob][] = [];\n\n  for (const { path, content: blob } of unzip) {\n    if (path.includes('__MACOSX') || path.includes('.DS_Store')) {\n      continue;\n    }\n\n    const fileName = path.split('/').pop() ?? '';\n    if (fileName.endsWith('.html')) {\n      htmlBlobs.push([fileName, blob]);\n    } else {\n      const ext = path.split('.').at(-1) ?? '';\n      const mime = extMimeMap.get(ext) ?? '';\n      const key = await sha(await blob.arrayBuffer());\n      pendingPathBlobIdMap.set(path, key);\n      pendingAssets.set(key, new File([blob], fileName, { type: mime }));\n    }\n  }\n\n  await Promise.all(\n    htmlBlobs.map(async ([fileName, blob]) => {\n      const fileNameWithoutExt = fileName.replace(/\\.[^/.]+$/, '');\n      const job = new Job({\n        collection,\n        middlewares: [\n          defaultImageProxyMiddleware,\n          fileNameMiddleware(fileNameWithoutExt),\n          docLinkBaseURLMiddleware,\n        ],\n      });\n      const assets = job.assets;\n      const pathBlobIdMap = job.assetsManager.getPathBlobIdMap();\n      for (const [key, value] of pendingAssets.entries()) {\n        assets.set(key, value);\n      }\n      for (const [key, value] of pendingPathBlobIdMap.entries()) {\n        pathBlobIdMap.set(key, value);\n      }\n      const htmlAdapter = new HtmlAdapter(job);\n      const html = await blob.text();\n      const doc = await htmlAdapter.toDoc({\n        file: html,\n        assets: job.assetsManager,\n      });\n      if (doc) {\n        docIds.push(doc.id);\n      }\n    })\n  );\n  return docIds;\n}\n\nexport const HtmlTransformer = {\n  exportDoc,\n  importHTMLToDoc,\n  importHTMLZip,\n};\n"]}