{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../../src/_common/transformers/notion-html.ts"],"names":[],"mappings":"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","sourcesContent":["import { sha } from '@blocksuite/global/utils';\nimport { type DocCollection, extMimeMap, Job } from '@blocksuite/store';\n\nimport { NotionHtmlAdapter } from '../adapters/notion-html/notion-html.js';\nimport { defaultImageProxyMiddleware } from './middlewares.js';\nimport { Unzip } from './utils.js';\n\ntype ImportNotionZipOptions = {\n  collection: DocCollection;\n  imported: Blob;\n};\n\n/**\n * Imports a Notion zip file into the BlockSuite collection.\n *\n * @param {ImportNotionZipOptions} options - The options for importing.\n * @param {DocCollection} options.collection - The BlockSuite document collection.\n * @param {Blob} options.imported - The imported zip file as a Blob.\n *\n * @returns {Promise<{entryId: string | undefined, pageIds: string[], isWorkspaceFile: boolean, hasMarkdown: boolean}>}\n *          A promise that resolves to an object containing:\n *          - entryId: The ID of the entry page (if any).\n *          - pageIds: An array of imported page IDs.\n *          - isWorkspaceFile: Whether the imported file is a workspace file.\n *          - hasMarkdown: Whether the zip contains markdown files.\n */\nasync function importNotionZip({\n  collection,\n  imported,\n}: ImportNotionZipOptions) {\n  const pageIds: string[] = [];\n  let isWorkspaceFile = false;\n  let hasMarkdown = false;\n  let entryId: string | undefined;\n  const parseZipFile = async (path: File | Blob) => {\n    const unzip = new Unzip();\n    await unzip.load(path);\n    const zipFile = new Map<string, Blob>();\n    const pageMap = new Map<string, string>();\n    const pagePaths: string[] = [];\n    const promises: Promise<void>[] = [];\n    const pendingAssets = new Map<string, Blob>();\n    const pendingPathBlobIdMap = new Map<string, string>();\n    for (const { path, content, index } of unzip) {\n      if (path.startsWith('__MACOSX/')) continue;\n\n      zipFile.set(path, content);\n\n      const lastSplitIndex = path.lastIndexOf('/');\n\n      const fileName = path.substring(lastSplitIndex + 1);\n      if (fileName.endsWith('.md')) {\n        hasMarkdown = true;\n        continue;\n      }\n      if (fileName.endsWith('.html')) {\n        if (path.endsWith('/index.html')) {\n          isWorkspaceFile = true;\n          continue;\n        }\n        if (lastSplitIndex !== -1) {\n          const text = await content.text();\n          const doc = new DOMParser().parseFromString(text, 'text/html');\n          const pageBody = doc.querySelector('.page-body');\n          if (pageBody && pageBody.children.length == 0) {\n            // Skip empty pages\n            continue;\n          }\n        }\n        const id = collection.idGenerator();\n        const splitPath = path.split('/');\n        while (splitPath.length > 0) {\n          pageMap.set(splitPath.join('/'), id);\n          splitPath.shift();\n        }\n        pagePaths.push(path);\n        if (entryId === undefined && lastSplitIndex === -1) {\n          entryId = id;\n        }\n        continue;\n      }\n      if (index === 0 && fileName.endsWith('.csv')) {\n        window.open(\n          'https://affine.pro/blog/import-your-data-from-notion-into-affine',\n          '_blank'\n        );\n        continue;\n      }\n      if (fileName.endsWith('.zip')) {\n        const innerZipFile = content;\n        if (innerZipFile) {\n          promises.push(...(await parseZipFile(innerZipFile)));\n        }\n        continue;\n      }\n      const blob = content;\n      const ext = path.split('.').at(-1) ?? '';\n      const mime = extMimeMap.get(ext) ?? '';\n      const key = await sha(await blob.arrayBuffer());\n      const filePathSplit = path.split('/');\n      while (filePathSplit.length > 1) {\n        pendingPathBlobIdMap.set(filePathSplit.join('/'), key);\n        filePathSplit.shift();\n      }\n      pendingAssets.set(key, new File([blob], fileName, { type: mime }));\n    }\n    const pagePromises = Array.from(pagePaths).map(async path => {\n      const job = new Job({\n        collection: collection,\n        middlewares: [defaultImageProxyMiddleware],\n      });\n      const htmlAdapter = new NotionHtmlAdapter(job);\n      const assets = job.assetsManager.getAssets();\n      const pathBlobIdMap = job.assetsManager.getPathBlobIdMap();\n      for (const [key, value] of pendingAssets.entries()) {\n        if (!assets.has(key)) {\n          assets.set(key, value);\n        }\n      }\n      for (const [key, value] of pendingPathBlobIdMap.entries()) {\n        if (!pathBlobIdMap.has(key)) {\n          pathBlobIdMap.set(key, value);\n        }\n      }\n      const page = await htmlAdapter.toDoc({\n        file: await zipFile.get(path)!.text(),\n        pageId: pageMap.get(path),\n        pageMap,\n        assets: job.assetsManager,\n      });\n      if (page) {\n        pageIds.push(page.id);\n      }\n    });\n    promises.push(...pagePromises);\n    return promises;\n  };\n  const allPromises = await parseZipFile(imported);\n  await Promise.all(allPromises.flat());\n  entryId = entryId ?? pageIds[0];\n  return { entryId, pageIds, isWorkspaceFile, hasMarkdown };\n}\n\nexport const NotionHtmlTransformer = {\n  importNotionZip,\n};\n"]}