{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../../../src/_common/adapters/notion-html/notion-html.ts"],"names":[],"mappings":"AAEA,OAAO,EACL,6BAA6B,EAC7B,eAAe,GAChB,MAAM,0BAA0B,CAAC;AAClC,OAAO,EAGL,uCAAuC,EACvC,SAAS,EAGT,wBAAwB,GACzB,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EAAE,eAAe,EAAE,SAAS,EAAE,MAAM,+BAA+B,CAAC;AAC3E,OAAO,EAEL,SAAS,EACT,WAAW,EAUX,MAAM,GAEP,MAAM,mBAAmB,CAAC;AAC3B,OAAO,WAAW,MAAM,cAAc,CAAC;AACvC,OAAO,EAAE,OAAO,EAAE,MAAM,SAAS,CAAC;AAElC,OAAO,EAAE,wBAAwB,EAAE,MAAM,YAAY,CAAC;AACtD,OAAO,EAAE,qCAAqC,EAAE,MAAM,oBAAoB,CAAC;AAC3E,OAAO,EAAE,+BAA+B,EAAE,MAAM,kCAAkC,CAAC;AAmBnF,MAAM,OAAO,iBAAkB,SAAQ,WAAuB;IA2D5D,YACE,GAAQ,EACC,gBAAiD,qCAAqC;QAE/F,KAAK,CAAC,GAAG,CAAC,CAAC;QAFF,kBAAa,GAAb,aAAa,CAAyE;QA5DzF,wBAAmB,GAAG,KAAK,EACjC,IAAa,EACb,QAAuB,EACvB,MAAsB,EACtB,OAA6B,EAC7B,EAAE;YACF,MAAM,MAAM,GAAG,IAAI,SAAS,EAA0B,CAAC;YACvD,MAAM,CAAC,iBAAiB,CACtB,CAAC,IAAI,EAAmB,EAAE,CACxB,MAAM,IAAK,IAAe,IAAK,IAAgB,CAAC,IAAI,KAAK,SAAS,CACrE,CAAC;YACF,MAAM,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,EAAE;gBACnC,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;oBACzC,IAAI,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;wBACvB,MAAM,cAAc,GAIhB;4BACF,MAAM;4BACN,aAAa,EAAE,OAAO;4BACtB,OAAO,EAAE,IAAI,CAAC,OAAO;4BACrB,GAAG,EAAE,IAAI,CAAC,GAAG;4BACb,cAAc,EAAE,IAAI,CAAC,cAAc;4BACnC,UAAU,EAAE,EAAE,OAAO,EAAE,EAAE,EAAE;4BAC3B,MAAM;4BACN,OAAO;yBACR,CAAC;wBACF,MAAM,OAAO,CAAC,eAAe,CAAC,KAAK,EAAE,CAAC,CAAC,EAAE,cAAc,CAAC,CAAC;oBAC3D,CAAC;gBACH,CAAC;YACH,CAAC,CAAC,CAAC;YACH,MAAM,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,EAAE;gBACnC,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;oBACzC,IAAI,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;wBACvB,MAAM,cAAc,GAIhB;4BACF,MAAM;4BACN,aAAa,EAAE,OAAO;4BACtB,OAAO,EAAE,IAAI,CAAC,OAAO;4BACrB,GAAG,EAAE,IAAI,CAAC,GAAG;4BACb,cAAc,EAAE,IAAI,CAAC,cAAc;4BACnC,UAAU,EAAE,EAAE,OAAO,EAAE,EAAE,EAAE;4BAC3B,MAAM;4BACN,OAAO;yBACR,CAAC;wBACF,MAAM,OAAO,CAAC,eAAe,CAAC,KAAK,EAAE,CAAC,CAAC,EAAE,cAAc,CAAC,CAAC;oBAC3D,CAAC;gBACH,CAAC;YACH,CAAC,CAAC,CAAC;YACH,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;QACrC,CAAC,CAAC;QASA,IAAI,CAAC,cAAc,GAAG,IAAI,wBAAwB,CAChD,GAAG,CAAC,cAAc,EAClB,EAAE,EACF,+BAA+B,CAChC,CAAC;IACJ,CAAC;IAEO,UAAU,CAAC,UAAsB;QACvC,OAAO,OAAO,EAAE,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;IACtD,CAAC;IAEQ,iBAAiB,CACxB,QAAkC;QAElC,MAAM,IAAI,eAAe,CACvB,SAAS,CAAC,8BAA8B,EACxC,wDAAwD,CACzD,CAAC;IACJ,CAAC;IAEQ,eAAe,CACtB,QAAgC;QAEhC,MAAM,IAAI,eAAe,CACvB,SAAS,CAAC,8BAA8B,EACxC,sDAAsD,CACvD,CAAC;IACJ,CAAC;IAEQ,iBAAiB,CACxB,QAAkC;QAElC,MAAM,IAAI,eAAe,CACvB,SAAS,CAAC,8BAA8B,EACxC,wDAAwD,CACzD,CAAC;IACJ,CAAC;IAEQ,eAAe,CACtB,OAAyC;QAEzC,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACpD,MAAM,iBAAiB,GAAG;YACxB,IAAI,EAAE,OAAO;YACb,EAAE,EAAE,MAAM,EAAE;YACZ,OAAO,EAAE,aAAa;YACtB,KAAK,EAAE;gBACL,IAAI,EAAE,cAAc;gBACpB,UAAU,EAAE,6BAA6B;gBACzC,KAAK,EAAE,IAAI;gBACX,MAAM,EAAE,KAAK;gBACb,WAAW,EAAE,eAAe,CAAC,cAAc;aAC5C;YACD,QAAQ,EAAE,EAAE;SACb,CAAC;QACF,OAAO,IAAI,CAAC,mBAAmB,CAC7B,aAAa,EACb,iBAAkC,EAClC,OAAO,CAAC,MAAM,EACd,OAAO,CAAC,OAAO,CAChB,CAAC;IACJ,CAAC;IAEQ,KAAK,CAAC,KAAK,CAAC,OAAuC;QAC1D,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;QACnD,OAAO,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;IAC1C,CAAC;IAEQ,KAAK,CAAC,aAAa,CAC1B,OAAuC;QAEvC,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACpD,MAAM,QAAQ,GAAG,SAAS,CAAC,aAAa,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;QACjE,MAAM,iBAAiB,GAAG;YACxB,IAAI,EAAE,OAAO;YACb,EAAE,EAAE,MAAM,EAAE;YACZ,OAAO,EAAE,aAAa;YACtB,KAAK,EAAE;gBACL,IAAI,EAAE,cAAc;gBACpB,UAAU,EAAE,6BAA6B;gBACzC,KAAK,EAAE,IAAI;gBACX,MAAM,EAAE,KAAK;gBACb,WAAW,EAAE,eAAe,CAAC,cAAc;aAC5C;YACD,QAAQ,EAAE,EAAE;SACb,CAAC;QACF,OAAO;YACL,IAAI,EAAE,MAAM;YACZ,IAAI,EAAE;gBACJ,EAAE,EAAE,OAAO,CAAC,MAAM,IAAI,MAAM,EAAE;gBAC9B,KAAK,EAAE,SAAS,CAAC,cAAc,CAAC,QAAQ,EAAE,EAAE,CAAC;gBAC7C,UAAU,EAAE,IAAI,CAAC,GAAG,EAAE;gBACtB,IAAI,EAAE,EAAE;aACT;YACD,MAAM,EAAE;gBACN,IAAI,EAAE,OAAO;gBACb,EAAE,EAAE,MAAM,EAAE;gBACZ,OAAO,EAAE,aAAa;gBACtB,KAAK,EAAE;oBACL,KAAK,EAAE;wBACL,4BAA4B,EAAE,IAAI;wBAClC,KAAK,EAAE,IAAI,CAAC,cAAc,CAAC,UAAU,CACnC,QAAQ,IAAI;4BACV,IAAI,EAAE,MAAM;4BACZ,KAAK,EAAE,EAAE;yBACV,CACF;qBACF;iBACF;gBACD,QAAQ,EAAE;oBACR;wBACE,IAAI,EAAE,OAAO;wBACb,EAAE,EAAE,MAAM,EAAE;wBACZ,OAAO,EAAE,gBAAgB;wBACzB,KAAK,EAAE;4BACL,QAAQ,EAAE,EAAE;yBACb;wBACD,QAAQ,EAAE,EAAE;qBACb;oBACD,MAAM,IAAI,CAAC,mBAAmB,CAC5B,aAAa,EACb,iBAAkC,EAClC,OAAO,CAAC,MAAM,EACd,OAAO,CAAC,OAAO,CAChB;iBACF;aACF;SACF,CAAC;IACJ,CAAC;IAEQ,KAAK,CAAC,eAAe,CAC5B,OAAyC;QAEzC,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACpD,MAAM,iBAAiB,GAAG;YACxB,IAAI,EAAE,OAAO;YACb,EAAE,EAAE,MAAM,EAAE;YACZ,OAAO,EAAE,aAAa;YACtB,KAAK,EAAE;gBACL,IAAI,EAAE,cAAc;gBACpB,UAAU,EAAE,6BAA6B;gBACzC,KAAK,EAAE,IAAI;gBACX,MAAM,EAAE,KAAK;gBACb,WAAW,EAAE,eAAe,CAAC,cAAc;aAC5C;YACD,QAAQ,EAAE,EAAE;SACb,CAAC;QACF,MAAM,YAAY,GAAG,CAAC,MAAM,IAAI,CAAC,mBAAmB,CAClD,aAAa,EACb,iBAAkC,EAClC,OAAO,CAAC,MAAM,CACf,CAAkB,CAAC;QACpB,IAAI,YAAY,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvC,OAAO,IAAI,CAAC;QACd,CAAC;QACD,OAAO;YACL,IAAI,EAAE,OAAO;YACb,OAAO,EAAE,CAAC,YAAY,CAAC;YACvB,WAAW,EAAE,OAAO,CAAC,WAAW;YAChC,MAAM,EAAE,OAAO,CAAC,MAAM;SACvB,CAAC;IACJ,CAAC;CACF;AAED,MAAM,CAAC,MAAM,kCAAkC,GAC7C,wBAAwB,CAAC,YAAY,CAAC,CAAC;AAEzC,MAAM,CAAC,MAAM,iCAAiC,GAAkB;IAC9D,KAAK,EAAE,EAAE,CAAC,EAAE;QACV,EAAE,CAAC,OAAO,CAAC,kCAAkC,EAAE,QAAQ,CAAC,EAAE,CAAC,CAAC;YAC1D,GAAG,EAAE,CAAC,GAAQ,EAAE,EAAE,CAChB,IAAI,iBAAiB,CACnB,GAAG,EACH,KAAK,CAAC,IAAI,CACR,QAAQ,CAAC,MAAM,CAAC,uCAAuC,CAAC,CAAC,MAAM,EAAE,CAClE,CACF;SACJ,CAAC,CAAC,CAAC;IACN,CAAC;CACF,CAAC","sourcesContent":["import type { ExtensionType } from '@blocksuite/block-std';\n\nimport {\n  DEFAULT_NOTE_BACKGROUND_COLOR,\n  NoteDisplayMode,\n} from '@blocksuite/affine-model';\nimport {\n  type AdapterContext,\n  type BlockNotionHtmlAdapterMatcher,\n  BlockNotionHtmlAdapterMatcherIdentifier,\n  HastUtils,\n  type HtmlAST,\n  type NotionHtml,\n  NotionHtmlDeltaConverter,\n} from '@blocksuite/affine-shared/adapters';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport {\n  type AssetsManager,\n  ASTWalker,\n  BaseAdapter,\n  type BlockSnapshot,\n  type DocSnapshot,\n  type FromBlockSnapshotPayload,\n  type FromBlockSnapshotResult,\n  type FromDocSnapshotPayload,\n  type FromDocSnapshotResult,\n  type FromSliceSnapshotPayload,\n  type FromSliceSnapshotResult,\n  type Job,\n  nanoid,\n  type SliceSnapshot,\n} from '@blocksuite/store';\nimport rehypeParse from 'rehype-parse';\nimport { unified } from 'unified';\n\nimport { AdapterFactoryIdentifier } from '../type.js';\nimport { defaultBlockNotionHtmlAdapterMatchers } from './block-matcher.js';\nimport { notionHtmlInlineToDeltaMatchers } from './delta-converter/html-inline.js';\n\ntype NotionHtmlToSliceSnapshotPayload = {\n  file: NotionHtml;\n  assets?: AssetsManager;\n  blockVersions: Record<string, number>;\n  workspaceId: string;\n  pageId: string;\n};\n\ntype NotionHtmlToDocSnapshotPayload = {\n  file: NotionHtml;\n  assets?: AssetsManager;\n  pageId?: string;\n  pageMap?: Map<string, string>;\n};\n\ntype NotionHtmlToBlockSnapshotPayload = NotionHtmlToDocSnapshotPayload;\n\nexport class NotionHtmlAdapter extends BaseAdapter<NotionHtml> {\n  private _traverseNotionHtml = async (\n    html: HtmlAST,\n    snapshot: BlockSnapshot,\n    assets?: AssetsManager,\n    pageMap?: Map<string, string>\n  ) => {\n    const walker = new ASTWalker<HtmlAST, BlockSnapshot>();\n    walker.setONodeTypeGuard(\n      (node): node is HtmlAST =>\n        'type' in (node as object) && (node as HtmlAST).type !== undefined\n    );\n    walker.setEnter(async (o, context) => {\n      for (const matcher of this.blockMatchers) {\n        if (matcher.toMatch(o)) {\n          const adapterContext: AdapterContext<\n            HtmlAST,\n            BlockSnapshot,\n            NotionHtmlDeltaConverter\n          > = {\n            walker,\n            walkerContext: context,\n            configs: this.configs,\n            job: this.job,\n            deltaConverter: this.deltaConverter,\n            textBuffer: { content: '' },\n            assets,\n            pageMap,\n          };\n          await matcher.toBlockSnapshot.enter?.(o, adapterContext);\n        }\n      }\n    });\n    walker.setLeave(async (o, context) => {\n      for (const matcher of this.blockMatchers) {\n        if (matcher.toMatch(o)) {\n          const adapterContext: AdapterContext<\n            HtmlAST,\n            BlockSnapshot,\n            NotionHtmlDeltaConverter\n          > = {\n            walker,\n            walkerContext: context,\n            configs: this.configs,\n            job: this.job,\n            deltaConverter: this.deltaConverter,\n            textBuffer: { content: '' },\n            assets,\n            pageMap,\n          };\n          await matcher.toBlockSnapshot.leave?.(o, adapterContext);\n        }\n      }\n    });\n    return walker.walk(html, snapshot);\n  };\n\n  deltaConverter: NotionHtmlDeltaConverter;\n\n  constructor(\n    job: Job,\n    readonly blockMatchers: BlockNotionHtmlAdapterMatcher[] = defaultBlockNotionHtmlAdapterMatchers\n  ) {\n    super(job);\n    this.deltaConverter = new NotionHtmlDeltaConverter(\n      job.adapterConfigs,\n      [],\n      notionHtmlInlineToDeltaMatchers\n    );\n  }\n\n  private _htmlToAst(notionHtml: NotionHtml) {\n    return unified().use(rehypeParse).parse(notionHtml);\n  }\n\n  override fromBlockSnapshot(\n    _payload: FromBlockSnapshotPayload\n  ): Promise<FromBlockSnapshotResult<NotionHtml>> {\n    throw new BlockSuiteError(\n      ErrorCode.TransformerNotImplementedError,\n      'NotionHtmlAdapter.fromBlockSnapshot is not implemented'\n    );\n  }\n\n  override fromDocSnapshot(\n    _payload: FromDocSnapshotPayload\n  ): Promise<FromDocSnapshotResult<NotionHtml>> {\n    throw new BlockSuiteError(\n      ErrorCode.TransformerNotImplementedError,\n      'NotionHtmlAdapter.fromDocSnapshot is not implemented'\n    );\n  }\n\n  override fromSliceSnapshot(\n    _payload: FromSliceSnapshotPayload\n  ): Promise<FromSliceSnapshotResult<NotionHtml>> {\n    throw new BlockSuiteError(\n      ErrorCode.TransformerNotImplementedError,\n      'NotionHtmlAdapter.fromSliceSnapshot is not implemented'\n    );\n  }\n\n  override toBlockSnapshot(\n    payload: NotionHtmlToBlockSnapshotPayload\n  ): Promise<BlockSnapshot> {\n    const notionHtmlAst = this._htmlToAst(payload.file);\n    const blockSnapshotRoot = {\n      type: 'block',\n      id: nanoid(),\n      flavour: 'affine:note',\n      props: {\n        xywh: '[0,0,800,95]',\n        background: DEFAULT_NOTE_BACKGROUND_COLOR,\n        index: 'a0',\n        hidden: false,\n        displayMode: NoteDisplayMode.DocAndEdgeless,\n      },\n      children: [],\n    };\n    return this._traverseNotionHtml(\n      notionHtmlAst,\n      blockSnapshotRoot as BlockSnapshot,\n      payload.assets,\n      payload.pageMap\n    );\n  }\n\n  override async toDoc(payload: NotionHtmlToDocSnapshotPayload) {\n    const snapshot = await this.toDocSnapshot(payload);\n    return this.job.snapshotToDoc(snapshot);\n  }\n\n  override async toDocSnapshot(\n    payload: NotionHtmlToDocSnapshotPayload\n  ): Promise<DocSnapshot> {\n    const notionHtmlAst = this._htmlToAst(payload.file);\n    const titleAst = HastUtils.querySelector(notionHtmlAst, 'title');\n    const blockSnapshotRoot = {\n      type: 'block',\n      id: nanoid(),\n      flavour: 'affine:note',\n      props: {\n        xywh: '[0,0,800,95]',\n        background: DEFAULT_NOTE_BACKGROUND_COLOR,\n        index: 'a0',\n        hidden: false,\n        displayMode: NoteDisplayMode.DocAndEdgeless,\n      },\n      children: [],\n    };\n    return {\n      type: 'page',\n      meta: {\n        id: payload.pageId ?? nanoid(),\n        title: HastUtils.getTextContent(titleAst, ''),\n        createDate: Date.now(),\n        tags: [],\n      },\n      blocks: {\n        type: 'block',\n        id: nanoid(),\n        flavour: 'affine:page',\n        props: {\n          title: {\n            '$blocksuite:internal:text$': true,\n            delta: this.deltaConverter.astToDelta(\n              titleAst ?? {\n                type: 'text',\n                value: '',\n              }\n            ),\n          },\n        },\n        children: [\n          {\n            type: 'block',\n            id: nanoid(),\n            flavour: 'affine:surface',\n            props: {\n              elements: {},\n            },\n            children: [],\n          },\n          await this._traverseNotionHtml(\n            notionHtmlAst,\n            blockSnapshotRoot as BlockSnapshot,\n            payload.assets,\n            payload.pageMap\n          ),\n        ],\n      },\n    };\n  }\n\n  override async toSliceSnapshot(\n    payload: NotionHtmlToSliceSnapshotPayload\n  ): Promise<SliceSnapshot | null> {\n    const notionHtmlAst = this._htmlToAst(payload.file);\n    const blockSnapshotRoot = {\n      type: 'block',\n      id: nanoid(),\n      flavour: 'affine:note',\n      props: {\n        xywh: '[0,0,800,95]',\n        background: DEFAULT_NOTE_BACKGROUND_COLOR,\n        index: 'a0',\n        hidden: false,\n        displayMode: NoteDisplayMode.DocAndEdgeless,\n      },\n      children: [],\n    };\n    const contentSlice = (await this._traverseNotionHtml(\n      notionHtmlAst,\n      blockSnapshotRoot as BlockSnapshot,\n      payload.assets\n    )) as BlockSnapshot;\n    if (contentSlice.children.length === 0) {\n      return null;\n    }\n    return {\n      type: 'slice',\n      content: [contentSlice],\n      workspaceId: payload.workspaceId,\n      pageId: payload.pageId,\n    };\n  }\n}\n\nexport const NotionHtmlAdapterFactoryIdentifier =\n  AdapterFactoryIdentifier('NotionHtml');\n\nexport const NotionHtmlAdapterFactoryExtension: ExtensionType = {\n  setup: di => {\n    di.addImpl(NotionHtmlAdapterFactoryIdentifier, provider => ({\n      get: (job: Job) =>\n        new NotionHtmlAdapter(\n          job,\n          Array.from(\n            provider.getAll(BlockNotionHtmlAdapterMatcherIdentifier).values()\n          )\n        ),\n    }));\n  },\n};\n"]}