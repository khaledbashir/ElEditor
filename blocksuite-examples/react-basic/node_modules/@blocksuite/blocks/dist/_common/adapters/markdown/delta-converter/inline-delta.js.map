{"version":3,"file":"inline-delta.js","sourceRoot":"","sources":["../../../../../src/_common/adapters/markdown/delta-converter/inline-delta.ts"],"names":[],"mappings":"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","sourcesContent":["import type { InlineDeltaToMarkdownAdapterMatcher } from '@blocksuite/affine-shared/adapters';\nimport type { PhrasingContent } from 'mdast';\n\nimport { generateDocUrl } from '@blocksuite/affine-block-embed';\n\nexport const boldDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'bold',\n    match: delta => !!delta.attributes?.bold,\n    toAST: (_, context) => {\n      const { current: currentMdast } = context;\n      return {\n        type: 'strong',\n        children: [currentMdast],\n      };\n    },\n  };\n\nexport const italicDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'italic',\n    match: delta => !!delta.attributes?.italic,\n    toAST: (_, context) => {\n      const { current: currentMdast } = context;\n      return {\n        type: 'emphasis',\n        children: [currentMdast],\n      };\n    },\n  };\n\nexport const strikeDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'strike',\n    match: delta => !!delta.attributes?.strike,\n    toAST: (_, context) => {\n      const { current: currentMdast } = context;\n      return {\n        type: 'delete',\n        children: [currentMdast],\n      };\n    },\n  };\n\nexport const inlineCodeDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'inlineCode',\n    match: delta => !!delta.attributes?.code,\n    toAST: delta => ({\n      type: 'inlineCode',\n      value: delta.insert,\n    }),\n  };\n\nexport const referenceDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'reference',\n    match: delta => !!delta.attributes?.reference,\n    toAST: (delta, context) => {\n      let mdast: PhrasingContent = {\n        type: 'text',\n        value: delta.insert,\n      };\n      const reference = delta.attributes?.reference;\n      if (!reference) {\n        return mdast;\n      }\n\n      const { configs } = context;\n      const title = configs.get(`title:${reference.pageId}`);\n      const params = reference.params ?? {};\n      const url = generateDocUrl(\n        configs.get('docLinkBaseUrl') ?? '',\n        String(reference.pageId),\n        params\n      );\n      mdast = {\n        type: 'link',\n        url,\n        children: [\n          {\n            type: 'text',\n            value: title ?? '',\n          },\n        ],\n      };\n\n      return mdast;\n    },\n  };\n\nexport const linkDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'link',\n    match: delta => !!delta.attributes?.link,\n    toAST: (delta, context) => {\n      const mdast: PhrasingContent = {\n        type: 'text',\n        value: delta.insert,\n      };\n      const link = delta.attributes?.link;\n      if (!link) {\n        return mdast;\n      }\n\n      const { current: currentMdast } = context;\n      if ('value' in currentMdast) {\n        if (currentMdast.value === '') {\n          return {\n            type: 'text',\n            value: link,\n          };\n        }\n        if (mdast.value !== link) {\n          return {\n            type: 'link',\n            url: link,\n            children: [currentMdast],\n          };\n        }\n      }\n      return mdast;\n    },\n  };\n\nexport const latexDeltaToMarkdownAdapterMatcher: InlineDeltaToMarkdownAdapterMatcher =\n  {\n    name: 'inlineLatex',\n    match: delta => !!delta.attributes?.latex,\n    toAST: delta => {\n      const mdast: PhrasingContent = {\n        type: 'text',\n        value: delta.insert,\n      };\n      if (delta.attributes?.latex) {\n        return {\n          type: 'inlineMath',\n          value: delta.attributes.latex,\n        };\n      }\n      return mdast;\n    },\n  };\n\nexport const inlineDeltaToMarkdownAdapterMatchers: InlineDeltaToMarkdownAdapterMatcher[] =\n  [\n    referenceDeltaToMarkdownAdapterMatcher,\n    linkDeltaToMarkdownAdapterMatcher,\n    inlineCodeDeltaToMarkdownAdapterMatcher,\n    boldDeltaToMarkdownAdapterMatcher,\n    italicDeltaToMarkdownAdapterMatcher,\n    strikeDeltaToMarkdownAdapterMatcher,\n    latexDeltaToMarkdownAdapterMatcher,\n  ];\n"]}