{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../../src/image-block/adapters/notion-html.ts"],"names":[],"mappings":"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","sourcesContent":["import { ImageBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockNotionHtmlAdapterExtension,\n  type BlockNotionHtmlAdapterMatcher,\n  FetchUtils,\n  HastUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { getFilenameFromContentDisposition } from '@blocksuite/affine-shared/utils';\nimport { sha } from '@blocksuite/global/utils';\nimport {\n  type AssetsManager,\n  type ASTWalkerContext,\n  type BlockSnapshot,\n  nanoid,\n} from '@blocksuite/store';\n\nasync function processImageNode(\n  imageURL: string,\n  walkerContext: ASTWalkerContext<BlockSnapshot>,\n  assets: AssetsManager,\n  configs: Map<string, string>\n) {\n  let blobId = '';\n  if (!FetchUtils.fetchable(imageURL)) {\n    const imageURLSplit = imageURL.split('/');\n    while (imageURLSplit.length > 0) {\n      const key = assets\n        .getPathBlobIdMap()\n        .get(decodeURIComponent(imageURLSplit.join('/')));\n      if (key) {\n        blobId = key;\n        break;\n      }\n      imageURLSplit.shift();\n    }\n  } else {\n    const res = await FetchUtils.fetchImage(\n      imageURL,\n      undefined,\n      configs.get('imageProxy') as string\n    );\n    if (!res) {\n      return;\n    }\n    const clonedRes = res.clone();\n    const name =\n      getFilenameFromContentDisposition(\n        res.headers.get('Content-Disposition') ?? ''\n      ) ??\n      (imageURL.split('/').at(-1) ?? 'image') +\n        '.' +\n        (res.headers.get('Content-Type')?.split('/').at(-1) ?? 'png');\n    const file = new File([await res.blob()], name, {\n      type: res.headers.get('Content-Type') ?? '',\n    });\n    blobId = await sha(await clonedRes.arrayBuffer());\n    assets?.getAssets().set(blobId, file);\n    await assets?.writeToBlob(blobId);\n  }\n  walkerContext\n    .openNode(\n      {\n        type: 'block',\n        id: nanoid(),\n        flavour: ImageBlockSchema.model.flavour,\n        props: {\n          sourceId: blobId,\n        },\n        children: [],\n      },\n      'children'\n    )\n    .closeNode();\n  walkerContext.skipAllChildren();\n}\n\nexport const imageBlockNotionHtmlAdapterMatcher: BlockNotionHtmlAdapterMatcher =\n  {\n    flavour: ImageBlockSchema.model.flavour,\n    toMatch: o => {\n      return (\n        HastUtils.isElement(o.node) &&\n        (o.node.tagName === 'img' ||\n          (o.node.tagName === 'figure' &&\n            !!HastUtils.querySelector(o.node, '.image')))\n      );\n    },\n    fromMatch: () => false,\n    toBlockSnapshot: {\n      enter: async (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        const { assets, walkerContext, configs } = context;\n        if (!assets) {\n          return;\n        }\n        if (walkerContext.getGlobalContext('hast:disableimg')) {\n          return;\n        }\n\n        switch (o.node.tagName) {\n          case 'img': {\n            const image = o.node;\n            const imageURL =\n              typeof image?.properties.src === 'string'\n                ? image.properties.src\n                : '';\n            if (imageURL) {\n              await processImageNode(imageURL, walkerContext, assets, configs);\n            }\n            break;\n          }\n          case 'figure': {\n            const imageFigureWrapper = HastUtils.querySelector(\n              o.node,\n              '.image'\n            );\n            let imageURL = '';\n            if (imageFigureWrapper) {\n              const image = HastUtils.querySelector(imageFigureWrapper, 'img');\n              imageURL =\n                typeof image?.properties.src === 'string'\n                  ? image.properties.src\n                  : '';\n            }\n            if (imageURL) {\n              await processImageNode(imageURL, walkerContext, assets, configs);\n            }\n            break;\n          }\n        }\n      },\n    },\n    fromBlockSnapshot: {},\n  };\n\nexport const ImageBlockNotionHtmlAdapterExtension =\n  BlockNotionHtmlAdapterExtension(imageBlockNotionHtmlAdapterMatcher);\n"]}