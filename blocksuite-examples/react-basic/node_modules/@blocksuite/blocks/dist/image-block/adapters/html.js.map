{"version":3,"file":"html.js","sourceRoot":"","sources":["../../../src/image-block/adapters/html.ts"],"names":[],"mappings":"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","sourcesContent":["import { ImageBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockHtmlAdapterExtension,\n  type BlockHtmlAdapterMatcher,\n  FetchUtils,\n  HastUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { getFilenameFromContentDisposition } from '@blocksuite/affine-shared/utils';\nimport { sha } from '@blocksuite/global/utils';\nimport { getAssetName, nanoid } from '@blocksuite/store';\n\nexport const imageBlockHtmlAdapterMatcher: BlockHtmlAdapterMatcher = {\n  flavour: ImageBlockSchema.model.flavour,\n  toMatch: o => HastUtils.isElement(o.node) && o.node.tagName === 'img',\n  fromMatch: o => o.node.flavour === ImageBlockSchema.model.flavour,\n  toBlockSnapshot: {\n    enter: async (o, context) => {\n      if (!HastUtils.isElement(o.node)) {\n        return;\n      }\n      const { assets, walkerContext, configs } = context;\n      if (!assets) {\n        return;\n      }\n      const image = o.node;\n      const imageURL =\n        typeof image?.properties.src === 'string' ? image.properties.src : '';\n      if (imageURL) {\n        let blobId = '';\n        if (!FetchUtils.fetchable(imageURL)) {\n          const imageURLSplit = imageURL.split('/');\n          while (imageURLSplit.length > 0) {\n            const key = assets\n              .getPathBlobIdMap()\n              .get(decodeURIComponent(imageURLSplit.join('/')));\n            if (key) {\n              blobId = key;\n              break;\n            }\n            imageURLSplit.shift();\n          }\n        } else {\n          try {\n            const res = await FetchUtils.fetchImage(\n              imageURL,\n              undefined,\n              configs.get('imageProxy') as string\n            );\n            if (!res) {\n              return;\n            }\n            const clonedRes = res.clone();\n            const name =\n              getFilenameFromContentDisposition(\n                res.headers.get('Content-Disposition') ?? ''\n              ) ??\n              (imageURL.split('/').at(-1) ?? 'image') +\n                '.' +\n                (res.headers.get('Content-Type')?.split('/').at(-1) ?? 'png');\n            const file = new File([await res.blob()], name, {\n              type: res.headers.get('Content-Type') ?? '',\n            });\n            blobId = await sha(await clonedRes.arrayBuffer());\n            assets?.getAssets().set(blobId, file);\n            await assets?.writeToBlob(blobId);\n          } catch (_) {\n            return;\n          }\n        }\n        walkerContext\n          .openNode(\n            {\n              type: 'block',\n              id: nanoid(),\n              flavour: 'affine:image',\n              props: {\n                sourceId: blobId,\n              },\n              children: [],\n            },\n            'children'\n          )\n          .closeNode();\n        walkerContext.skipAllChildren();\n      }\n    },\n  },\n  fromBlockSnapshot: {\n    enter: async (o, context) => {\n      const blobId = (o.node.props.sourceId ?? '') as string;\n      const { assets, walkerContext, updateAssetIds } = context;\n      if (!assets) {\n        return;\n      }\n\n      await assets.readFromBlob(blobId);\n      const blob = assets.getAssets().get(blobId);\n      updateAssetIds?.(blobId);\n      if (!blob) {\n        return;\n      }\n      const blobName = getAssetName(assets.getAssets(), blobId);\n      const isScaledImage = o.node.props.width && o.node.props.height;\n      const widthStyle = isScaledImage\n        ? {\n            width: `${o.node.props.width}px`,\n            height: `${o.node.props.height}px`,\n          }\n        : {};\n\n      walkerContext\n        .openNode(\n          {\n            type: 'element',\n            tagName: 'figure',\n            properties: {\n              className: ['affine-image-block-container'],\n            },\n            children: [],\n          },\n          'children'\n        )\n        .openNode(\n          {\n            type: 'element',\n            tagName: 'img',\n            properties: {\n              src: `assets/${blobName}`,\n              alt: blobName,\n              title: (o.node.props.caption as string | undefined) ?? null,\n              ...widthStyle,\n            },\n            children: [],\n          },\n          'children'\n        )\n        .closeNode()\n        .closeNode();\n    },\n  },\n};\n\nexport const ImageBlockHtmlAdapterExtension = BlockHtmlAdapterExtension(\n  imageBlockHtmlAdapterMatcher\n);\n"]}