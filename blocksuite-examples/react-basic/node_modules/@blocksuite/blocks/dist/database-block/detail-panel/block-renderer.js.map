{"version":3,"file":"block-renderer.js","sourceRoot":"","sources":["../../../src/database-block/detail-panel/block-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport type { DetailSlotProps } from '@blocksuite/data-view';\nimport type {\n  KanbanSingleView,\n  TableSingleView,\n} from '@blocksuite/data-view/view-presets';\n\nimport { DefaultInlineManagerExtension } from '@blocksuite/affine-components/rich-text';\nimport { ShadowlessElement } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nexport class BlockRenderer\n  extends WithDisposable(ShadowlessElement)\n  implements DetailSlotProps\n{\n  static override styles = css`\n    database-datasource-block-renderer {\n      padding-top: 36px;\n      padding-bottom: 16px;\n      display: flex;\n      flex-direction: column;\n      gap: 16px;\n      margin-bottom: 12px;\n      border-bottom: 1px solid var(--affine-border-color);\n      font-size: var(--affine-font-base);\n      line-height: var(--affine-line-height);\n    }\n\n    database-datasource-block-renderer .tips-placeholder {\n      display: none;\n    }\n\n    database-datasource-block-renderer rich-text {\n      font-size: 15px;\n      line-height: 24px;\n    }\n\n    database-datasource-block-renderer.empty rich-text::before {\n      content: 'Untitled';\n      position: absolute;\n      color: var(--affine-text-disable-color);\n      font-size: 15px;\n      line-height: 24px;\n      user-select: none;\n      pointer-events: none;\n    }\n\n    .database-block-detail-header-icon {\n      width: 20px;\n      height: 20px;\n      padding: 2px;\n      border-radius: 4px;\n      background-color: var(--affine-background-secondary-color);\n    }\n\n    .database-block-detail-header-icon svg {\n      width: 16px;\n      height: 16px;\n    }\n  `;\n\n  get attributeRenderer() {\n    return this.inlineManager.getRenderer();\n  }\n\n  get attributesSchema() {\n    return this.inlineManager.getSchema();\n  }\n\n  get inlineManager() {\n    return this.host.std.get(DefaultInlineManagerExtension.identifier);\n  }\n\n  get model() {\n    return this.host?.doc.getBlock(this.rowId)?.model;\n  }\n\n  get service() {\n    return this.host.std.getService('affine:database');\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (this.model && this.model.text) {\n      const cb = () => {\n        if (this.model?.text?.length == 0) {\n          this.classList.add('empty');\n        } else {\n          this.classList.remove('empty');\n        }\n      };\n      this.model.text.yText.observe(cb);\n      this.disposables.add(() => {\n        this.model?.text?.yText.unobserve(cb);\n      });\n    }\n    this._disposables.addFromEvent(\n      this,\n      'keydown',\n      e => {\n        if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {\n          e.stopPropagation();\n          e.preventDefault();\n          return;\n        }\n        if (\n          e.key === 'Backspace' &&\n          !e.shiftKey &&\n          !e.metaKey &&\n          this.model?.text?.length === 0\n        ) {\n          e.stopPropagation();\n          e.preventDefault();\n          return;\n        }\n      },\n      true\n    );\n  }\n\n  protected override render(): unknown {\n    const model = this.model;\n    if (!model) {\n      return;\n    }\n    return html`\n      ${this.renderIcon()}\n      <rich-text\n        .yText=${model.text}\n        .attributesSchema=${this.attributesSchema}\n        .attributeRenderer=${this.attributeRenderer}\n        .embedChecker=${this.inlineManager.embedChecker}\n        .markdownShortcutHandler=${this.inlineManager.markdownShortcutHandler}\n        class=\"inline-editor\"\n      ></rich-text>\n    `;\n  }\n\n  renderIcon() {\n    const iconColumn = this.view.mainProperties$.value.iconColumn;\n    if (!iconColumn) {\n      return;\n    }\n    return html` <div class=\"database-block-detail-header-icon\">\n      ${this.view.cellValueGet(this.rowId, iconColumn)}\n    </div>`;\n  }\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor openDoc!: (docId: string) => void;\n\n  @property({ attribute: false })\n  accessor rowId!: string;\n\n  @property({ attribute: false })\n  accessor view!: TableSingleView | KanbanSingleView;\n}\n"]}