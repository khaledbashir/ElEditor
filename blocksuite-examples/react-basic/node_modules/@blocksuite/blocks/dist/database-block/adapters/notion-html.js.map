{"version":3,"file":"notion-html.js","sourceRoot":"","sources":["../../../src/database-block/adapters/notion-html.ts"],"names":[],"mappings":"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","sourcesContent":["import { DatabaseBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockNotionHtmlAdapterExtension,\n  type BlockNotionHtmlAdapterMatcher,\n  HastUtils,\n  TextUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { getTagColor } from '@blocksuite/data-view';\nimport { type BlockSnapshot, nanoid } from '@blocksuite/store';\n\nconst ColumnClassMap: Record<string, string> = {\n  typesSelect: 'select',\n  typesMultipleSelect: 'multi-select',\n  typesNumber: 'number',\n  typesCheckbox: 'checkbox',\n  typesText: 'rich-text',\n  typesTitle: 'title',\n};\n\nconst NotionDatabaseToken = '.collection-content';\nconst NotionDatabaseTitleToken = '.collection-title';\n\ntype BlocksuiteTableColumn = {\n  type: string;\n  name: string;\n  data: {\n    options?: {\n      id: string;\n      value: string;\n      color: string;\n    }[];\n  };\n  id: string;\n};\n\ntype BlocksuiteTableRow = Record<\n  string,\n  {\n    columnId: string;\n    value: unknown;\n  }\n>;\n\nconst DATABASE_NODE_TYPES = ['table', 'th', 'tr'];\n\nexport const databaseBlockNotionHtmlAdapterMatcher: BlockNotionHtmlAdapterMatcher =\n  {\n    flavour: DatabaseBlockSchema.model.flavour,\n    toMatch: o =>\n      HastUtils.isElement(o.node) &&\n      DATABASE_NODE_TYPES.includes(o.node.tagName),\n    fromMatch: () => false,\n    toBlockSnapshot: {\n      enter: (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        const { walkerContext, deltaConverter, pageMap } = context;\n        switch (o.node.tagName) {\n          case 'th': {\n            const columnId = nanoid();\n            const columnTypeClass = HastUtils.querySelector(o.node, 'svg')\n              ?.properties?.className;\n            const columnType = Array.isArray(columnTypeClass)\n              ? (ColumnClassMap[columnTypeClass[0]] ?? 'rich-text')\n              : 'rich-text';\n            walkerContext.pushGlobalContextStack<BlocksuiteTableColumn>(\n              'hast:table:column',\n              {\n                type: columnType,\n                name: HastUtils.getTextContent(\n                  HastUtils.getTextChildrenOnlyAst(o.node)\n                ),\n                data: Object.create(null),\n                id: columnId,\n              }\n            );\n            // disable icon img in th\n            walkerContext.setGlobalContext('hast:disableimg', true);\n            break;\n          }\n          case 'tr': {\n            if (\n              o.parent?.node.type === 'element' &&\n              o.parent.node.tagName === 'tbody'\n            ) {\n              const columns =\n                walkerContext.getGlobalContextStack<BlocksuiteTableColumn>(\n                  'hast:table:column'\n                );\n              const row = Object.create(null);\n              let plainTable = false;\n              HastUtils.getElementChildren(o.node).forEach((child, index) => {\n                if (plainTable || columns[index] === undefined) {\n                  plainTable = true;\n                  if (columns[index] === undefined) {\n                    columns.push({\n                      type: 'rich-text',\n                      name: '',\n                      data: Object.create(null),\n                      id: nanoid(),\n                    });\n                    walkerContext.pushGlobalContextStack<BlockSnapshot>(\n                      'hast:table:children',\n                      {\n                        type: 'block',\n                        id: nanoid(),\n                        flavour: 'affine:paragraph',\n                        props: {\n                          text: {\n                            '$blocksuite:internal:text$': true,\n                            delta: deltaConverter.astToDelta(child),\n                          },\n                          type: 'text',\n                        },\n                        children: [],\n                      }\n                    );\n                  }\n                  walkerContext.pushGlobalContextStack<BlockSnapshot>(\n                    'hast:table:children',\n                    {\n                      type: 'block',\n                      id: nanoid(),\n                      flavour: 'affine:paragraph',\n                      props: {\n                        text: {\n                          '$blocksuite:internal:text$': true,\n                          delta: deltaConverter.astToDelta(child),\n                        },\n                        type: 'text',\n                      },\n                      children: [],\n                    }\n                  );\n                  row[columns[index].id] = {\n                    columnId: columns[index].id,\n                    value: HastUtils.getTextContent(child),\n                  };\n                } else if (HastUtils.querySelector(child, '.cell-title')) {\n                  walkerContext.pushGlobalContextStack<BlockSnapshot>(\n                    'hast:table:children',\n                    {\n                      type: 'block',\n                      id: nanoid(),\n                      flavour: 'affine:paragraph',\n                      props: {\n                        text: {\n                          '$blocksuite:internal:text$': true,\n                          delta: deltaConverter.astToDelta(child, { pageMap }),\n                        },\n                        type: 'text',\n                      },\n                      children: [],\n                    }\n                  );\n                  columns[index].type = 'title';\n                  return;\n                }\n                const optionIds: string[] = [];\n                if (HastUtils.querySelector(child, '.selected-value')) {\n                  if (!('options' in columns[index].data)) {\n                    columns[index].data.options = [];\n                  }\n                  if (\n                    !['multi-select', 'select'].includes(columns[index].type)\n                  ) {\n                    columns[index].type = 'select';\n                  }\n                  if (\n                    columns[index].type === 'select' &&\n                    child.type === 'element' &&\n                    child.children.length > 1\n                  ) {\n                    columns[index].type = 'multi-select';\n                  }\n                  child.type === 'element' &&\n                    child.children.forEach(span => {\n                      const filteredArray = columns[index].data.options?.filter(\n                        option =>\n                          option.value === HastUtils.getTextContent(span)\n                      );\n                      const id = filteredArray?.length\n                        ? filteredArray[0].id\n                        : nanoid();\n                      if (!filteredArray?.length) {\n                        columns[index].data.options?.push({\n                          id,\n                          value: HastUtils.getTextContent(span),\n                          color: getTagColor(),\n                        });\n                      }\n                      optionIds.push(id);\n                    });\n                  // Expand will be done when leaving the table\n                  row[columns[index].id] = {\n                    columnId: columns[index].id,\n                    value: optionIds,\n                  };\n                } else if (HastUtils.querySelector(child, '.checkbox')) {\n                  if (columns[index].type !== 'checkbox') {\n                    columns[index].type = 'checkbox';\n                  }\n                  row[columns[index].id] = {\n                    columnId: columns[index].id,\n                    value: HastUtils.querySelector(child, '.checkbox-on')\n                      ? true\n                      : false,\n                  };\n                } else if (columns[index].type === 'number') {\n                  const text = HastUtils.getTextContent(child);\n                  const number = Number(text);\n                  if (Number.isNaN(number)) {\n                    columns[index].type = 'rich-text';\n                    row[columns[index].id] = {\n                      columnId: columns[index].id,\n                      value: TextUtils.createText(text),\n                    };\n                  } else {\n                    row[columns[index].id] = {\n                      columnId: columns[index].id,\n                      value: number,\n                    };\n                  }\n                } else {\n                  row[columns[index].id] = {\n                    columnId: columns[index].id,\n                    value: HastUtils.getTextContent(child),\n                  };\n                }\n                if (\n                  columns[index].type === 'rich-text' &&\n                  !TextUtils.isText(row[columns[index].id].value)\n                ) {\n                  row[columns[index].id] = {\n                    columnId: columns[index].id,\n                    value: TextUtils.createText(row[columns[index].id].value),\n                  };\n                }\n              });\n              walkerContext.setGlobalContextStack('hast:table:column', columns);\n              walkerContext.pushGlobalContextStack('hast:table:rows', row);\n            }\n          }\n        }\n      },\n      leave: (o, context) => {\n        if (!HastUtils.isElement(o.node)) {\n          return;\n        }\n        const { walkerContext } = context;\n        switch (o.node.tagName) {\n          case 'table': {\n            const columns =\n              walkerContext.getGlobalContextStack<BlocksuiteTableColumn>(\n                'hast:table:column'\n              );\n            walkerContext.setGlobalContextStack('hast:table:column', []);\n            const children = walkerContext.getGlobalContextStack<BlockSnapshot>(\n              'hast:table:children'\n            );\n            walkerContext.setGlobalContextStack('hast:table:children', []);\n            const cells = Object.create(null);\n            walkerContext\n              .getGlobalContextStack<BlocksuiteTableRow>('hast:table:rows')\n              .map((row, i) => {\n                Object.keys(row).forEach(columnId => {\n                  if (\n                    columns.find(column => column.id === columnId)?.type ===\n                    'select'\n                  ) {\n                    row[columnId].value = (row[columnId].value as string[])[0];\n                  }\n                });\n                cells[children.at(i)?.id ?? nanoid()] = row;\n              });\n            walkerContext.setGlobalContextStack('hast:table:cells', []);\n            let databaseTitle = '';\n            if (\n              o.parent?.node.type === 'element' &&\n              HastUtils.querySelector(o.parent.node, NotionDatabaseToken)\n            ) {\n              databaseTitle = HastUtils.getTextContent(\n                HastUtils.querySelector(o.parent.node, NotionDatabaseTitleToken)\n              );\n            }\n            walkerContext.openNode(\n              {\n                type: 'block',\n                id: nanoid(),\n                flavour: DatabaseBlockSchema.model.flavour,\n                props: {\n                  views: [\n                    {\n                      id: nanoid(),\n                      name: 'Table View',\n                      mode: 'table',\n                      columns: [],\n                      filter: {\n                        type: 'group',\n                        op: 'and',\n                        conditions: [],\n                      },\n                      header: {\n                        titleColumn:\n                          columns.find(column => column.type === 'title')?.id ??\n                          '',\n                        iconColumn: 'type',\n                      },\n                    },\n                  ],\n                  title: {\n                    '$blocksuite:internal:text$': true,\n                    delta: databaseTitle\n                      ? [\n                          {\n                            insert: databaseTitle,\n                          },\n                        ]\n                      : [],\n                  },\n                  columns,\n                  cells,\n                },\n                children: [],\n              },\n              'children'\n            );\n            children.forEach(child => {\n              walkerContext.openNode(child, 'children').closeNode();\n            });\n            walkerContext.closeNode();\n            walkerContext.cleanGlobalContextStack('hast:table:column');\n            walkerContext.cleanGlobalContextStack('hast:table:rows');\n            walkerContext.cleanGlobalContextStack('hast:table:children');\n            break;\n          }\n          case 'th': {\n            walkerContext.setGlobalContext('hast:disableimg', false);\n            break;\n          }\n        }\n      },\n    },\n    fromBlockSnapshot: {},\n  };\n\nexport const DatabaseBlockNotionHtmlAdapterExtension =\n  BlockNotionHtmlAdapterExtension(databaseBlockNotionHtmlAdapterMatcher);\n"]}