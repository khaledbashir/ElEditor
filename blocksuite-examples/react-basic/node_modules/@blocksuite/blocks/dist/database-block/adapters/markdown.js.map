{"version":3,"file":"markdown.js","sourceRoot":"","sources":["../../../src/database-block/adapters/markdown.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DeltaInsert } from '@blocksuite/inline';\nimport type { TableRow } from 'mdast';\n\nimport {\n  type Column,\n  DatabaseBlockSchema,\n  type SerializedCells,\n} from '@blocksuite/affine-model';\nimport {\n  BlockMarkdownAdapterExtension,\n  type BlockMarkdownAdapterMatcher,\n  type MarkdownAST,\n  TextUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { type BlockSnapshot, nanoid } from '@blocksuite/store';\nimport { format } from 'date-fns/format';\n\nconst DATABASE_NODE_TYPES = ['table', 'tableRow'];\n\nconst isDatabaseNode = (node: MarkdownAST) =>\n  DATABASE_NODE_TYPES.includes(node.type);\n\nexport const databaseBlockMarkdownAdapterMatcher: BlockMarkdownAdapterMatcher =\n  {\n    flavour: DatabaseBlockSchema.model.flavour,\n    toMatch: o => isDatabaseNode(o.node),\n    fromMatch: o => o.node.flavour === DatabaseBlockSchema.model.flavour,\n    toBlockSnapshot: {\n      enter: (o, context) => {\n        const { walkerContext } = context;\n        if (o.node.type === 'table') {\n          const viewsColumns = o.node.children[0].children.map(() => {\n            return {\n              id: nanoid(),\n              hide: false,\n              width: 180,\n            };\n          });\n          const cells = Object.create(null);\n          o.node.children.slice(1).forEach(row => {\n            const rowId = nanoid();\n            cells[rowId] = Object.create(null);\n            row.children.slice(1).forEach((cell, index) => {\n              cells[rowId][viewsColumns[index + 1].id] = {\n                columnId: viewsColumns[index + 1].id,\n                value: TextUtils.createText(\n                  cell.children\n                    .map(child => ('value' in child ? child.value : ''))\n                    .join('')\n                ),\n              };\n            });\n          });\n          const columns = o.node.children[0].children.map((_child, index) => {\n            return {\n              type: index === 0 ? 'title' : 'rich-text',\n              name: _child.children\n                .map(child => ('value' in child ? child.value : ''))\n                .join(''),\n              data: {},\n              id: viewsColumns[index].id,\n            };\n          });\n          walkerContext.openNode(\n            {\n              type: 'block',\n              id: nanoid(),\n              flavour: 'affine:database',\n              props: {\n                views: [\n                  {\n                    id: nanoid(),\n                    name: 'Table View',\n                    mode: 'table',\n                    columns: [],\n                    filter: {\n                      type: 'group',\n                      op: 'and',\n                      conditions: [],\n                    },\n                    header: {\n                      titleColumn: viewsColumns[0]?.id,\n                      iconColumn: 'type',\n                    },\n                  },\n                ],\n                title: {\n                  '$blocksuite:internal:text$': true,\n                  delta: [],\n                },\n                cells,\n                columns,\n              },\n              children: [],\n            },\n            'children'\n          );\n          walkerContext.setNodeContext(\n            'affine:table:rowid',\n            Object.keys(cells)\n          );\n          walkerContext.skipChildren(1);\n        }\n\n        if (o.node.type === 'tableRow') {\n          const { deltaConverter } = context;\n          walkerContext\n            .openNode({\n              type: 'block',\n              id:\n                (\n                  walkerContext.getNodeContext(\n                    'affine:table:rowid'\n                  ) as Array<string>\n                ).shift() ?? nanoid(),\n              flavour: 'affine:paragraph',\n              props: {\n                text: {\n                  '$blocksuite:internal:text$': true,\n                  delta: deltaConverter.astToDelta(o.node.children[0]),\n                },\n                type: 'text',\n              },\n              children: [],\n            })\n            .closeNode();\n          walkerContext.skipAllChildren();\n        }\n      },\n      leave: (o, context) => {\n        const { walkerContext } = context;\n        if (o.node.type === 'table') {\n          walkerContext.closeNode();\n        }\n      },\n    },\n    fromBlockSnapshot: {\n      enter: (o, context) => {\n        const { walkerContext, deltaConverter } = context;\n        const rows: TableRow[] = [];\n        const columns = o.node.props.columns as Array<Column>;\n        const children = o.node.children;\n        const cells = o.node.props.cells as SerializedCells;\n        const createAstCell = (children: MarkdownAST[]) => ({\n          type: 'tableCell',\n          children,\n        });\n        const mdAstCells = Array.prototype.map.call(\n          children,\n          (v: BlockSnapshot) =>\n            Array.prototype.map.call(columns, col => {\n              const cell = cells[v.id]?.[col.id];\n              if (!cell && col.type !== 'title') {\n                return createAstCell([{ type: 'text', value: '' }]);\n              }\n              switch (col.type) {\n                case 'link':\n                case 'progress':\n                case 'number':\n                  return createAstCell([\n                    {\n                      type: 'text',\n                      value: cell.value as string,\n                    },\n                  ]);\n                case 'rich-text':\n                  return createAstCell(\n                    deltaConverter.deltaToAST(\n                      (cell.value as { delta: DeltaInsert[] }).delta\n                    )\n                  );\n                case 'title':\n                  return createAstCell(\n                    deltaConverter.deltaToAST(\n                      (v.props.text as { delta: DeltaInsert[] }).delta\n                    )\n                  );\n                case 'date':\n                  return createAstCell([\n                    {\n                      type: 'text',\n                      value: format(\n                        new Date(cell.value as number),\n                        'yyyy-MM-dd'\n                      ),\n                    },\n                  ]);\n                case 'select': {\n                  const value = col.data.options.find(\n                    (opt: Record<string, string>) => opt.id === cell.value\n                  )?.value;\n                  return createAstCell([{ type: 'text', value }]);\n                }\n                case 'multi-select': {\n                  const value = Array.prototype.map\n                    .call(\n                      cell.value,\n                      val =>\n                        col.data.options.find(\n                          (opt: Record<string, string>) => val === opt.id\n                        ).value\n                    )\n                    .filter(Boolean)\n                    .join(',');\n                  return createAstCell([{ type: 'text', value }]);\n                }\n                case 'checkbox': {\n                  return createAstCell([\n                    { type: 'text', value: cell.value as string },\n                  ]);\n                }\n                default:\n                  return createAstCell([\n                    { type: 'text', value: cell.value as string },\n                  ]);\n              }\n            })\n        );\n\n        // Handle first row.\n        if (Array.isArray(columns)) {\n          rows.push({\n            type: 'tableRow',\n            children: Array.prototype.map.call(columns, v =>\n              createAstCell([\n                {\n                  type: 'text',\n                  value: v.name,\n                },\n              ])\n            ) as [],\n          });\n        }\n\n        // Handle 2-... rows\n        Array.prototype.forEach.call(mdAstCells, children => {\n          rows.push({ type: 'tableRow', children });\n        });\n\n        walkerContext\n          .openNode({\n            type: 'table',\n            children: rows,\n          })\n          .closeNode();\n\n        walkerContext.skipAllChildren();\n      },\n    },\n  };\n\nexport const DatabaseBlockMarkdownAdapterExtension =\n  BlockMarkdownAdapterExtension(databaseBlockMarkdownAdapterMatcher);\n"]}