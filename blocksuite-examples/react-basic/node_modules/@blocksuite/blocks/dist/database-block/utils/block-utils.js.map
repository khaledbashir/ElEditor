{"version":3,"file":"block-utils.js","sourceRoot":"","sources":["../../../src/database-block/utils/block-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  Cell,\n  Column,\n  ColumnUpdater,\n  DatabaseBlockModel,\n  ViewBasicDataType,\n} from '@blocksuite/affine-model';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport {\n  arrayMove,\n  insertPositionToIndex,\n  type InsertToPosition,\n} from '@blocksuite/affine-shared/utils';\n\nexport function addProperty(\n  model: DatabaseBlockModel,\n  position: InsertToPosition,\n  column: Omit<Column, 'id'> & {\n    id?: string;\n  }\n): string {\n  const id = column.id ?? model.doc.generateBlockId();\n  if (model.columns.some(v => v.id === id)) {\n    return id;\n  }\n  model.doc.transact(() => {\n    const col: Column = {\n      ...column,\n      id,\n    };\n    model.columns.splice(\n      insertPositionToIndex(position, model.columns),\n      0,\n      col\n    );\n  });\n  return id;\n}\n\nexport function applyCellsUpdate(model: DatabaseBlockModel) {\n  model.doc.updateBlock(model, {\n    cells: model.cells,\n  });\n}\n\nexport function applyPropertyUpdate(model: DatabaseBlockModel) {\n  model.doc.updateBlock(model, {\n    columns: model.columns,\n  });\n}\n\nexport function applyViewsUpdate(model: DatabaseBlockModel) {\n  model.doc.updateBlock(model, {\n    views: model.views,\n  });\n}\n\nexport function copyCellsByProperty(\n  model: DatabaseBlockModel,\n  fromId: Column['id'],\n  toId: Column['id']\n) {\n  model.doc.transact(() => {\n    Object.keys(model.cells).forEach(rowId => {\n      const cell = model.cells[rowId][fromId];\n      if (cell) {\n        model.cells[rowId][toId] = {\n          ...cell,\n          columnId: toId,\n        };\n      }\n    });\n  });\n}\n\nexport function deleteColumn(\n  model: DatabaseBlockModel,\n  columnId: Column['id']\n) {\n  const index = findPropertyIndex(model, columnId);\n  if (index < 0) return;\n\n  model.doc.transact(() => {\n    model.columns.splice(index, 1);\n  });\n}\n\nexport function deleteRows(model: DatabaseBlockModel, rowIds: string[]) {\n  model.doc.transact(() => {\n    for (const rowId of rowIds) {\n      delete model.cells[rowId];\n    }\n  });\n}\n\nexport function deleteView(model: DatabaseBlockModel, id: string) {\n  model.doc.captureSync();\n  model.doc.transact(() => {\n    model.views = model.views.filter(v => v.id !== id);\n  });\n}\n\nexport function duplicateView(model: DatabaseBlockModel, id: string): string {\n  const newId = model.doc.generateBlockId();\n  model.doc.transact(() => {\n    const index = model.views.findIndex(v => v.id === id);\n    const view = model.views[index];\n    if (view) {\n      model.views.splice(\n        index + 1,\n        0,\n        JSON.parse(JSON.stringify({ ...view, id: newId }))\n      );\n    }\n  });\n  return newId;\n}\n\nexport function findPropertyIndex(model: DatabaseBlockModel, id: Column['id']) {\n  return model.columns.findIndex(v => v.id === id);\n}\n\nexport function getCell(\n  model: DatabaseBlockModel,\n  rowId: BlockModel['id'],\n  columnId: Column['id']\n): Cell | null {\n  if (columnId === 'title') {\n    return {\n      columnId: 'title',\n      value: rowId,\n    };\n  }\n  const yRow = model.cells$.value[rowId];\n  const yCell = yRow?.[columnId] ?? null;\n  if (!yCell) return null;\n\n  return {\n    columnId: yCell.columnId,\n    value: yCell.value,\n  };\n}\n\nexport function getProperty(\n  model: DatabaseBlockModel,\n  id: Column['id']\n): Column | undefined {\n  return model.columns.find(v => v.id === id);\n}\n\nexport function moveViewTo(\n  model: DatabaseBlockModel,\n  id: string,\n  position: InsertToPosition\n) {\n  model.doc.transact(() => {\n    model.views = arrayMove(\n      model.views,\n      v => v.id === id,\n      arr => insertPositionToIndex(position, arr)\n    );\n  });\n  applyViewsUpdate(model);\n}\n\nexport function updateCell(\n  model: DatabaseBlockModel,\n  rowId: string,\n  cell: Cell\n) {\n  const hasRow = rowId in model.cells;\n  if (!hasRow) {\n    model.cells[rowId] = Object.create(null);\n  }\n  model.doc.transact(() => {\n    model.cells[rowId][cell.columnId] = {\n      columnId: cell.columnId,\n      value: cell.value,\n    };\n  });\n}\n\nexport function updateCells(\n  model: DatabaseBlockModel,\n  columnId: string,\n  cells: Record<string, unknown>\n) {\n  model.doc.transact(() => {\n    Object.entries(cells).forEach(([rowId, value]) => {\n      if (!model.cells[rowId]) {\n        model.cells[rowId] = Object.create(null);\n      }\n      model.cells[rowId][columnId] = {\n        columnId,\n        value,\n      };\n    });\n  });\n}\n\nexport function updateProperty(\n  model: DatabaseBlockModel,\n  id: string,\n  updater: ColumnUpdater\n) {\n  const index = model.columns.findIndex(v => v.id === id);\n  if (index == null) {\n    return;\n  }\n  model.doc.transact(() => {\n    const column = model.columns[index];\n    const result = updater(column);\n    model.columns[index] = { ...column, ...result };\n  });\n  return id;\n}\n\nexport const updateView = <ViewData extends ViewBasicDataType>(\n  model: DatabaseBlockModel,\n  id: string,\n  update: (data: ViewData) => Partial<ViewData>\n) => {\n  model.doc.transact(() => {\n    model.views = model.views.map(v => {\n      if (v.id !== id) {\n        return v;\n      }\n      return { ...v, ...update(v as ViewData) };\n    });\n  });\n  applyViewsUpdate(model);\n};\nexport const DATABASE_CONVERT_WHITE_LIST = ['affine:list', 'affine:paragraph'];\n"]}