{"version":3,"file":"cell-renderer.js","sourceRoot":"","sources":["../../../../src/database-block/properties/link/cell-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import { RefNodeSlotsProvider } from '@blocksuite/affine-components/rich-text';\nimport { ParseDocUrlProvider } from '@blocksuite/affine-shared/services';\nimport { unsafeCSSVarV2 } from '@blocksuite/affine-shared/theme';\nimport {\n  isValidUrl,\n  normalizeUrl,\n  stopPropagation,\n} from '@blocksuite/affine-shared/utils';\nimport {\n  BaseCellRenderer,\n  createFromBaseCellRenderer,\n  createIcon,\n} from '@blocksuite/data-view';\nimport { EditIcon } from '@blocksuite/icons/lit';\nimport { baseTheme } from '@toeverything/theme';\nimport { css, nothing, unsafeCSS } from 'lit';\nimport { query, state } from 'lit/decorators.js';\nimport { html } from 'lit/static-html.js';\n\nimport { HostContextKey } from '../../context/host-context.js';\nimport { linkColumnModelConfig } from './define.js';\n\nexport class LinkCell extends BaseCellRenderer<string> {\n  static override styles = css`\n    affine-database-link-cell {\n      width: 100%;\n      user-select: none;\n      position: relative;\n    }\n\n    affine-database-link-cell:hover .affine-database-link-icon {\n      visibility: visible;\n    }\n\n    .affine-database-link {\n      display: flex;\n      position: relative;\n      align-items: center;\n      width: 100%;\n      height: 100%;\n      outline: none;\n      overflow: hidden;\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      word-break: break-all;\n    }\n\n    affine-database-link-node {\n      flex: 1;\n      word-break: break-all;\n    }\n\n    .affine-database-link-icon {\n      position: absolute;\n      right: 8px;\n      top: 8px;\n      display: flex;\n      align-items: center;\n      visibility: hidden;\n      cursor: pointer;\n      background: ${unsafeCSSVarV2('button/iconButtonSolid')};\n      color: ${unsafeCSSVarV2('icon/primary')};\n      box-shadow: var(--affine-button-shadow);\n      border-radius: 4px;\n      font-size: 14px;\n      padding: 2px;\n    }\n\n    .affine-database-link-icon:hover {\n      background: var(--affine-hover-color);\n    }\n\n    .data-view-link-column-linked-doc {\n      text-decoration: underline;\n      text-decoration-color: var(--affine-divider-color);\n      transition: text-decoration-color 0.2s ease-out;\n      cursor: pointer;\n    }\n\n    .data-view-link-column-linked-doc:hover {\n      text-decoration-color: var(--affine-icon-color);\n    }\n  `;\n\n  private _onClick = (event: Event) => {\n    event.stopPropagation();\n    const value = this.value ?? '';\n\n    if (!value || !isValidUrl(value)) {\n      this.selectCurrentCell(true);\n      return;\n    }\n\n    if (isValidUrl(value)) {\n      const target = event.target as HTMLElement;\n      const link = target.querySelector<HTMLAnchorElement>('.link-node');\n      if (link) {\n        event.preventDefault();\n        link.click();\n      }\n      return;\n    }\n  };\n\n  private _onEdit = (e: Event) => {\n    e.stopPropagation();\n    this.selectCurrentCell(true);\n  };\n\n  private preValue?: string;\n\n  openDoc = (e: MouseEvent) => {\n    e.stopPropagation();\n    if (!this.docId) {\n      return;\n    }\n    const std = this.std;\n    if (!std) {\n      return;\n    }\n\n    std\n      .getOptional(RefNodeSlotsProvider)\n      ?.docLinkClicked.emit({ pageId: this.docId });\n  };\n\n  get std() {\n    const host = this.view.contextGet(HostContextKey);\n    return host?.std;\n  }\n\n  override render() {\n    const linkText = this.value ?? '';\n    const docName =\n      this.docId && this.std?.collection.getDoc(this.docId)?.meta?.title;\n    return html`\n      <div class=\"affine-database-link\" @click=\"${this._onClick}\">\n        ${docName\n          ? html`<span\n              class=\"data-view-link-column-linked-doc\"\n              @click=\"${this.openDoc}\"\n              >${docName}</span\n            >`\n          : html` <affine-database-link-node\n              .link=\"${linkText}\"\n            ></affine-database-link-node>`}\n      </div>\n      ${docName || linkText\n        ? html` <div class=\"affine-database-link-icon\" @click=\"${this._onEdit}\">\n            ${EditIcon()}\n          </div>`\n        : nothing}\n    `;\n  }\n\n  override updated() {\n    if (this.value !== this.preValue) {\n      const std = this.std;\n      this.preValue = this.value;\n      if (!this.value || !isValidUrl(this.value)) {\n        this.docId = undefined;\n        return;\n      }\n\n      this.docId =\n        std?.getOptional(ParseDocUrlProvider)?.parseDocUrl(this.value)?.docId ??\n        undefined;\n    }\n  }\n\n  @state()\n  accessor docId: string | undefined = undefined;\n}\n\nexport class LinkCellEditing extends BaseCellRenderer<string> {\n  static override styles = css`\n    affine-database-link-cell-editing {\n      width: 100%;\n      cursor: text;\n    }\n\n    .affine-database-link-editing {\n      display: flex;\n      align-items: center;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      word-break: break-all;\n    }\n\n    .affine-database-link-editing:focus {\n      outline: none;\n    }\n  `;\n\n  private _focusEnd = () => {\n    const end = this._container.value.length;\n    this._container.focus();\n    this._container.setSelectionRange(end, end);\n  };\n\n  private _onKeydown = (e: KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.isComposing) {\n      this._setValue();\n      setTimeout(() => {\n        this.selectCurrentCell(false);\n      });\n    }\n  };\n\n  private _setValue = (value: string = this._container.value) => {\n    let url = value;\n    if (isValidUrl(value)) {\n      url = normalizeUrl(value);\n    }\n\n    this.onChange(url);\n    this._container.value = url;\n  };\n\n  override firstUpdated() {\n    this._focusEnd();\n  }\n\n  override onExitEditMode() {\n    this._setValue();\n  }\n\n  override render() {\n    const linkText = this.value ?? '';\n\n    return html`<input\n      class=\"affine-database-link-editing link\"\n      .value=\"${linkText}\"\n      @keydown=\"${this._onKeydown}\"\n      @pointerdown=\"${stopPropagation}\"\n    />`;\n  }\n\n  @query('.affine-database-link-editing')\n  private accessor _container!: HTMLInputElement;\n}\n\nexport const linkColumnConfig = linkColumnModelConfig.createPropertyMeta({\n  icon: createIcon('LinkIcon'),\n  cellRenderer: {\n    view: createFromBaseCellRenderer(LinkCell),\n    edit: createFromBaseCellRenderer(LinkCellEditing),\n  },\n});\n"]}