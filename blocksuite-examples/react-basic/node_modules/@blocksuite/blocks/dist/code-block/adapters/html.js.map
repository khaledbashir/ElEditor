{"version":3,"file":"html.js","sourceRoot":"","sources":["../../../src/code-block/adapters/html.ts"],"names":[],"mappings":"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","sourcesContent":["import { CodeBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockHtmlAdapterExtension,\n  type BlockHtmlAdapterMatcher,\n  HastUtils,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\nimport { bundledLanguagesInfo, codeToHast } from 'shiki';\n\nexport const codeBlockHtmlAdapterMatcher: BlockHtmlAdapterMatcher = {\n  flavour: CodeBlockSchema.model.flavour,\n  toMatch: o => HastUtils.isElement(o.node) && o.node.tagName === 'pre',\n  fromMatch: o => o.node.flavour === 'affine:code',\n  toBlockSnapshot: {\n    enter: (o, context) => {\n      if (!HastUtils.isElement(o.node)) {\n        return;\n      }\n      const code = HastUtils.querySelector(o.node, 'code');\n      if (!code) {\n        return;\n      }\n\n      const codeText =\n        code.children.length === 1 && code.children[0].type === 'text'\n          ? code.children[0]\n          : { ...code, tagName: 'div' };\n      let codeLang = Array.isArray(code.properties?.className)\n        ? code.properties.className.find(\n            className =>\n              typeof className === 'string' && className.startsWith('code-')\n          )\n        : undefined;\n      codeLang =\n        typeof codeLang === 'string'\n          ? codeLang.replace('code-', '')\n          : undefined;\n\n      const { walkerContext, deltaConverter } = context;\n      walkerContext\n        .openNode(\n          {\n            type: 'block',\n            id: nanoid(),\n            flavour: 'affine:code',\n            props: {\n              language: codeLang ?? 'Plain Text',\n              text: {\n                '$blocksuite:internal:text$': true,\n                delta: deltaConverter.astToDelta(codeText, {\n                  trim: false,\n                  pre: true,\n                }),\n              },\n            },\n            children: [],\n          },\n          'children'\n        )\n        .closeNode();\n      walkerContext.skipAllChildren();\n    },\n  },\n  fromBlockSnapshot: {\n    enter: async (o, context) => {\n      const { walkerContext } = context;\n      const rawLang = o.node.props.language as string | null;\n      const matchedLang = rawLang\n        ? (bundledLanguagesInfo.find(\n            info =>\n              info.id === rawLang ||\n              info.name === rawLang ||\n              info.aliases?.includes(rawLang)\n          )?.id ?? 'text')\n        : 'text';\n\n      // @ts-ignore\n      const text = o.node.props.text.delta as DeltaInsert[];\n      const code = text.map(delta => delta.insert).join('');\n      const hast = await codeToHast(code, {\n        lang: matchedLang,\n        theme: 'light-plus',\n      });\n\n      // @ts-ignore\n      walkerContext.openNode(hast, 'children').closeNode();\n    },\n  },\n};\n\nexport const CodeBlockHtmlAdapterExtension = BlockHtmlAdapterExtension(\n  codeBlockHtmlAdapterMatcher\n);\n"]}