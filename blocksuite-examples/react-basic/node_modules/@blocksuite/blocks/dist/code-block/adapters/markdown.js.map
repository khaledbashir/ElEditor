{"version":3,"file":"markdown.js","sourceRoot":"","sources":["../../../src/code-block/adapters/markdown.ts"],"names":[],"mappings":"AAGA,OAAO,EAAE,eAAe,EAAE,MAAM,0BAA0B,CAAC;AAC3D,OAAO,EACL,6BAA6B,GAG9B,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EAAE,MAAM,EAAE,MAAM,mBAAmB,CAAC;AAE3C,MAAM,UAAU,GAAG,CAAC,IAAiB,EAAgB,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,MAAM,CAAC;AAE7E,MAAM,CAAC,MAAM,+BAA+B,GAAgC;IAC1E,OAAO,EAAE,eAAe,CAAC,KAAK,CAAC,OAAO;IACtC,OAAO,EAAE,CAAC,CAAC,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC;IAChC,SAAS,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,KAAK,aAAa;IAChD,eAAe,EAAE;QACf,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;gBACxB,OAAO;YACT,CAAC;YACD,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,aAAa;iBACV,QAAQ,CACP;gBACE,IAAI,EAAE,OAAO;gBACb,EAAE,EAAE,MAAM,EAAE;gBACZ,OAAO,EAAE,aAAa;gBACtB,KAAK,EAAE;oBACL,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,IAAI,YAAY;oBACrC,IAAI,EAAE;wBACJ,4BAA4B,EAAE,IAAI;wBAClC,KAAK,EAAE;4BACL;gCACE,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK;6BACrB;yBACF;qBACF;iBACF;gBACD,QAAQ,EAAE,EAAE;aACb,EACD,UAAU,CACX;iBACA,SAAS,EAAE,CAAC;QACjB,CAAC;KACF;IACD,iBAAiB,EAAE;QACjB,KAAK,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE;YACpB,MAAM,IAAI,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,IAAI,EAAE,KAAK,EAAE,EAAE,EAAE,CAE/C,CAAC;YACF,MAAM,EAAE,aAAa,EAAE,GAAG,OAAO,CAAC;YAClC,aAAa;iBACV,QAAQ,CACP;gBACE,IAAI,EAAE,MAAM;gBACZ,IAAI,EAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,QAAmB,IAAI,IAAI;gBAC/C,IAAI,EAAE,IAAI;gBACV,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;aACtD,EACD,UAAU,CACX;iBACA,SAAS,EAAE,CAAC;QACjB,CAAC;KACF;CACF,CAAC;AAEF,MAAM,CAAC,MAAM,iCAAiC,GAAG,6BAA6B,CAC5E,+BAA+B,CAChC,CAAC","sourcesContent":["import type { DeltaInsert } from '@blocksuite/inline';\nimport type { Code } from 'mdast';\n\nimport { CodeBlockSchema } from '@blocksuite/affine-model';\nimport {\n  BlockMarkdownAdapterExtension,\n  type BlockMarkdownAdapterMatcher,\n  type MarkdownAST,\n} from '@blocksuite/affine-shared/adapters';\nimport { nanoid } from '@blocksuite/store';\n\nconst isCodeNode = (node: MarkdownAST): node is Code => node.type === 'code';\n\nexport const codeBlockMarkdownAdapterMatcher: BlockMarkdownAdapterMatcher = {\n  flavour: CodeBlockSchema.model.flavour,\n  toMatch: o => isCodeNode(o.node),\n  fromMatch: o => o.node.flavour === 'affine:code',\n  toBlockSnapshot: {\n    enter: (o, context) => {\n      if (!isCodeNode(o.node)) {\n        return;\n      }\n      const { walkerContext } = context;\n      walkerContext\n        .openNode(\n          {\n            type: 'block',\n            id: nanoid(),\n            flavour: 'affine:code',\n            props: {\n              language: o.node.lang ?? 'Plain Text',\n              text: {\n                '$blocksuite:internal:text$': true,\n                delta: [\n                  {\n                    insert: o.node.value,\n                  },\n                ],\n              },\n            },\n            children: [],\n          },\n          'children'\n        )\n        .closeNode();\n    },\n  },\n  fromBlockSnapshot: {\n    enter: (o, context) => {\n      const text = (o.node.props.text ?? { delta: [] }) as {\n        delta: DeltaInsert[];\n      };\n      const { walkerContext } = context;\n      walkerContext\n        .openNode(\n          {\n            type: 'code',\n            lang: (o.node.props.language as string) ?? null,\n            meta: null,\n            value: text.delta.map(delta => delta.insert).join(''),\n          },\n          'children'\n        )\n        .closeNode();\n    },\n  },\n};\n\nexport const CodeBlockMarkdownAdapterExtension = BlockMarkdownAdapterExtension(\n  codeBlockMarkdownAdapterMatcher\n);\n"]}