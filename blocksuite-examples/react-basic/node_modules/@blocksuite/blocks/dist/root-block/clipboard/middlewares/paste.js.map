{"version":3,"file":"paste.js","sourceRoot":"","sources":["../../../../src/root-block/clipboard/middlewares/paste.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ParagraphBlockModel } from '@blocksuite/affine-model';\nimport type { AffineTextAttributes } from '@blocksuite/affine-shared/types';\n\nimport { REFERENCE_NODE } from '@blocksuite/affine-components/rich-text';\nimport {\n  ParseDocUrlProvider,\n  type ParseDocUrlService,\n  TelemetryProvider,\n} from '@blocksuite/affine-shared/services';\nimport { referenceToNode } from '@blocksuite/affine-shared/utils';\nimport {\n  BLOCK_ID_ATTR,\n  type BlockComponent,\n  type EditorHost,\n  type TextRangePoint,\n  type TextSelection,\n} from '@blocksuite/block-std';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { assertExists } from '@blocksuite/global/utils';\nimport {\n  type BlockModel,\n  type BlockSnapshot,\n  type DeltaOperation,\n  DocCollection,\n  fromJSON,\n  type JobMiddleware,\n  type SliceSnapshot,\n  type Text,\n} from '@blocksuite/store';\n\nimport { matchFlavours } from '../../../_common/utils/index.js';\nimport { extractSearchParams } from '../../../_common/utils/url.js';\n\nfunction findLastMatchingNode(\n  root: BlockSnapshot[],\n  fn: (node: BlockSnapshot) => boolean\n): BlockSnapshot | null {\n  let lastMatchingNode: BlockSnapshot | null = null;\n\n  function traverse(node: BlockSnapshot) {\n    if (fn(node)) {\n      lastMatchingNode = node;\n    }\n    if (node.children) {\n      for (const child of node.children) {\n        traverse(child);\n      }\n    }\n  }\n\n  root.forEach(traverse);\n  return lastMatchingNode;\n}\n\n// find last child that has text as prop\nconst findLast = (snapshot: SliceSnapshot): BlockSnapshot | null => {\n  return findLastMatchingNode(snapshot.content, node => !!node.props.text);\n};\n\nclass PointState {\n  private _blockFromPath = (path: string) => {\n    const block = this.std.view.getBlock(path);\n    assertExists(block);\n    return block;\n  };\n\n  readonly block: BlockComponent;\n\n  readonly model: BlockModel;\n\n  readonly text: Text;\n\n  constructor(\n    readonly std: EditorHost['std'],\n    readonly point: TextRangePoint\n  ) {\n    this.block = this._blockFromPath(point.blockId);\n    this.model = this.block.model;\n    const text = this.model.text;\n    if (!text) {\n      console.error(this.point);\n      throw new BlockSuiteError(\n        ErrorCode.TransformerError,\n        'Text point without text model'\n      );\n    }\n    this.text = text;\n  }\n}\n\nclass PasteTr {\n  private _getDeltas = () => {\n    const firstTextSnapshot = this._textFromSnapshot(this.firstSnapshot!);\n    const lastTextSnapshot = this._textFromSnapshot(this.lastSnapshot!);\n    const fromDelta = this.pointState.text.sliceToDelta(\n      0,\n      this.pointState.point.index\n    );\n    const toDelta = this.pointState.text.sliceToDelta(\n      this.pointState.point.index + this.pointState.point.length,\n      this.pointState.text.length\n    );\n    const firstDelta = firstTextSnapshot.delta;\n    const lastDelta = lastTextSnapshot.delta;\n    return {\n      firstTextSnapshot,\n      lastTextSnapshot,\n      fromDelta,\n      toDelta,\n      firstDelta,\n      lastDelta,\n    };\n  };\n\n  private _mergeCode = () => {\n    const deltas: DeltaOperation[] = [{ retain: this.pointState.point.index }];\n    this.snapshot.content.forEach((blockSnapshot, i) => {\n      if (blockSnapshot.props.text) {\n        const text = this._textFromSnapshot(blockSnapshot);\n        if (i > 0) {\n          deltas.push({ insert: '\\n' });\n        }\n        deltas.push(...text.delta);\n      }\n    });\n    this.pointState.text.applyDelta(deltas);\n    this.snapshot.content = [];\n  };\n\n  private _mergeMultiple = () => {\n    this._updateFlavour();\n\n    const { lastTextSnapshot, toDelta, firstDelta, lastDelta } =\n      this._getDeltas();\n\n    this.pointState.text.applyDelta([\n      { retain: this.pointState.point.index },\n      this.pointState.text.length - this.pointState.point.index > 0\n        ? { delete: this.pointState.text.length - this.pointState.point.index }\n        : {},\n      ...firstDelta,\n    ]);\n\n    const removedFirstSnapshot = this.snapshot.content.shift();\n    removedFirstSnapshot?.children.map(block => {\n      this.snapshot.content.unshift(block);\n    });\n    this.pasteStartModelChildrenCount =\n      removedFirstSnapshot?.children.length ?? 0;\n\n    this._updateSnapshot();\n\n    lastTextSnapshot.delta = [...lastDelta, ...toDelta];\n  };\n\n  private _mergeSingle = () => {\n    this._updateFlavour();\n    const { firstDelta } = this._getDeltas();\n    const { index, length } = this.pointState.point;\n\n    // Pastes a link\n    if (length && firstDelta.length === 1 && firstDelta[0].attributes?.link) {\n      this.pointState.text.format(index, length, firstDelta[0].attributes);\n    } else {\n      const ops: DeltaOperation[] = [{ retain: index }];\n      if (length) ops.push({ delete: length });\n      ops.push(...firstDelta);\n\n      this.pointState.text.applyDelta(ops);\n    }\n\n    this.snapshot.content.splice(0, 1);\n    this._updateSnapshot();\n  };\n\n  private _textFromSnapshot = (snapshot: BlockSnapshot) => {\n    return (snapshot.props.text ?? { delta: [] }) as Record<\n      'delta',\n      DeltaOperation[]\n    >;\n  };\n\n  private _updateSnapshot = () => {\n    if (this.snapshot.content.length === 0) {\n      this.firstSnapshot = this.lastSnapshot = undefined;\n      return;\n    }\n    this.firstSnapshot = this.snapshot.content[0];\n    this.lastSnapshot = findLast(this.snapshot) ?? this.firstSnapshot;\n  };\n\n  private firstSnapshot?: BlockSnapshot;\n\n  private readonly firstSnapshotIsPlainText: boolean;\n\n  private lastIndex: number;\n\n  private lastSnapshot?: BlockSnapshot;\n\n  private needCleanup = false;\n\n  private pasteStartModelChildrenCount = 0;\n\n  private readonly pointState: PointState;\n\n  canMerge = () => {\n    if (this.snapshot.content.length === 0) {\n      return false;\n    }\n    if (!this.firstSnapshot!.props.text) {\n      return false;\n    }\n    const firstTextSnapshot = this._textFromSnapshot(this.firstSnapshot!);\n    const lastTextSnapshot = this._textFromSnapshot(this.lastSnapshot!);\n    return (\n      firstTextSnapshot &&\n      lastTextSnapshot &&\n      (this.pointState.text.length > 0 || this.firstSnapshotIsPlainText)\n    );\n  };\n\n  convertToLinkedDoc = () => {\n    const parseDocUrlService = this.std.getOptional(ParseDocUrlProvider);\n\n    if (!parseDocUrlService) {\n      return;\n    }\n\n    const linkToDocId = new Map<string, string | null>();\n\n    for (const blockSnapshot of this.snapshot.content) {\n      if (blockSnapshot.props.text) {\n        const [delta, transformed] = this._transformLinkDelta(\n          this._textFromSnapshot(blockSnapshot).delta,\n          linkToDocId,\n          parseDocUrlService\n        );\n        const model = this.std.doc.getBlock(blockSnapshot.id)?.model;\n        if (transformed && model) {\n          this.std.doc.captureSync();\n          this.std.doc.transact(() => {\n            const text = model.text as Text;\n            text.clear();\n            text.applyDelta(delta);\n          });\n        }\n      }\n    }\n\n    const fromPointStateText = this.pointState.model.text;\n    if (!fromPointStateText) {\n      return;\n    }\n    const [delta, transformed] = this._transformLinkDelta(\n      fromPointStateText.toDelta(),\n      linkToDocId,\n      parseDocUrlService\n    );\n    if (!transformed) {\n      return;\n    }\n    this.std.doc.captureSync();\n    this.std.doc.transact(() => {\n      fromPointStateText.clear();\n      fromPointStateText.applyDelta(delta);\n    });\n  };\n\n  focusPasted = () => {\n    const host = this.std.host;\n\n    const cursorBlock =\n      this.pointState.model.flavour === 'affine:code' || !this.lastSnapshot\n        ? this.std.doc.getBlock(this.pointState.model.id)\n        : this.std.doc.getBlock(this.lastSnapshot.id);\n    if (!cursorBlock) {\n      return;\n    }\n    const { model: cursorModel } = cursorBlock;\n\n    host.updateComplete\n      .then(() => {\n        const target = this.std.host.querySelector<BlockComponent>(\n          `[${BLOCK_ID_ATTR}=\"${cursorModel.id}\"]`\n        );\n        if (!target) {\n          return;\n        }\n        if (!cursorModel.text) {\n          if (matchFlavours(cursorModel, ['affine:image'])) {\n            const selection = this.std.selection.create('image', {\n              blockId: target.blockId,\n            });\n            this.std.selection.setGroup('note', [selection]);\n            return;\n          }\n          const selection = this.std.selection.create('block', {\n            blockId: target.blockId,\n          });\n          this.std.selection.setGroup('note', [selection]);\n          return;\n        }\n        const selection = this.std.selection.create('text', {\n          from: {\n            blockId: target.blockId,\n            index: cursorModel.text ? this.lastIndex : 0,\n            length: 0,\n          },\n          to: null,\n        });\n        this.std.selection.setGroup('note', [selection]);\n      })\n      .catch(console.error);\n  };\n\n  pasted = () => {\n    if (!(this.needCleanup || this.pointState.text.length === 0)) {\n      return;\n    }\n\n    if (this.lastSnapshot) {\n      const lastModel = this.std.doc.getBlock(this.lastSnapshot.id)?.model;\n      if (!lastModel) {\n        return;\n      }\n      this.std.doc.moveBlocks(this.pointState.model.children, lastModel);\n    }\n\n    this.std.doc.moveBlocks(\n      this.std.doc\n        .getNexts(this.pointState.model.id)\n        .slice(0, this.pasteStartModelChildrenCount),\n      this.pointState.model\n    );\n\n    if (!this.firstSnapshotIsPlainText && this.pointState.text.length == 0) {\n      this.std.doc.deleteBlock(this.pointState.model);\n    }\n  };\n\n  constructor(\n    readonly std: EditorHost['std'],\n    readonly text: TextSelection,\n    readonly snapshot: SliceSnapshot\n  ) {\n    const { from } = text;\n\n    this.pointState = new PointState(std, from);\n\n    this.firstSnapshot = snapshot.content[0];\n    this.lastSnapshot = findLast(snapshot) ?? this.firstSnapshot;\n    if (\n      this.firstSnapshot !== this.lastSnapshot &&\n      this.lastSnapshot.props.text &&\n      !matchFlavours(this.pointState.model, ['affine:code'])\n    ) {\n      const text = fromJSON(this.lastSnapshot.props.text) as Text;\n      const doc = new DocCollection.Y.Doc();\n      const temp = doc.getMap('temp');\n      temp.set('text', text.yText);\n      this.lastIndex = text.length;\n    } else {\n      this.lastIndex =\n        this.pointState.point.index +\n        this.snapshot.content\n          .map(snapshot =>\n            this._textFromSnapshot(snapshot)\n              .delta.map(op => {\n                if (op.insert) {\n                  return op.insert.length;\n                } else if (op.delete) {\n                  return -op.delete;\n                } else {\n                  return 0;\n                }\n              })\n              .reduce((a, b) => a + b, 0)\n          )\n          .reduce((a, b) => a + b + 1, -1);\n    }\n    this.firstSnapshotIsPlainText =\n      this.firstSnapshot.flavour === 'affine:paragraph' &&\n      this.firstSnapshot.props.type === 'text';\n  }\n\n  private _transformLinkDelta(\n    delta: DeltaOperation[],\n    linkToDocId: Map<string, string | null>,\n    parseDocUrlService: ParseDocUrlService\n  ): [DeltaOperation[], boolean] {\n    let transformed = false;\n    const needToConvert = new Map<DeltaOperation, string>();\n    for (const op of delta) {\n      if (op.attributes?.link) {\n        let docId = linkToDocId.get(op.attributes.link);\n        if (!docId) {\n          const searchResult = parseDocUrlService.parseDocUrl(\n            op.attributes.link\n          );\n          if (searchResult) {\n            const doc = this.std.collection.getDoc(searchResult.docId);\n            if (doc) {\n              docId = doc.id;\n              linkToDocId.set(op.attributes.link, doc.id);\n            }\n          }\n        }\n        if (docId) {\n          needToConvert.set(op, docId);\n        }\n      }\n    }\n    const newDelta = delta.map(op => {\n      if (!needToConvert.has(op)) {\n        return { ...op };\n      }\n\n      const link = op.attributes?.link;\n\n      if (!link) {\n        return { ...op };\n      }\n\n      const pageId = needToConvert.get(op);\n\n      if (!pageId) {\n        // External link\n        this.std.getOptional(TelemetryProvider)?.track('Link', {\n          page: 'doc editor',\n          category: 'pasted link',\n          other: 'external link',\n          type: 'link',\n        });\n\n        return { ...op };\n      }\n\n      const reference: AffineTextAttributes['reference'] = {\n        pageId,\n        type: 'LinkedPage',\n      };\n      // Title alias\n      if (op.insert && op.insert !== REFERENCE_NODE && op.insert !== link) {\n        reference.title = op.insert;\n      }\n\n      const extractedParams = extractSearchParams(link);\n      const isLinkedBlock = extractedParams\n        ? referenceToNode({ pageId, ...extractedParams })\n        : false;\n\n      Object.assign(reference, extractedParams);\n\n      // Internal link\n      this.std.getOptional(TelemetryProvider)?.track('LinkedDocCreated', {\n        page: 'doc editor',\n        category: 'pasted link',\n        other: 'existing doc',\n        type: isLinkedBlock ? 'block' : 'doc',\n      });\n\n      transformed = true;\n\n      return {\n        ...op,\n        attributes: { reference },\n        insert: REFERENCE_NODE,\n      };\n    });\n    return [newDelta, transformed];\n  }\n\n  private _updateFlavour() {\n    this.firstSnapshot!.flavour = this.pointState.model.flavour;\n    if (this.firstSnapshot!.props.type) {\n      this.firstSnapshot!.props.type = (\n        this.pointState.model as ParagraphBlockModel\n      ).type;\n    }\n  }\n\n  merge() {\n    if (this.pointState.model.flavour === 'affine:code') {\n      this._mergeCode();\n      return;\n    }\n\n    if (this.firstSnapshot === this.lastSnapshot) {\n      this._mergeSingle();\n      return;\n    }\n\n    this.needCleanup = true;\n    this._mergeMultiple();\n  }\n}\n\nfunction flatNote(snapshot: SliceSnapshot) {\n  if (snapshot.content[0]?.flavour === 'affine:note') {\n    snapshot.content = snapshot.content[0].children;\n  }\n}\n\nexport const pasteMiddleware = (std: EditorHost['std']): JobMiddleware => {\n  return ({ slots }) => {\n    let tr: PasteTr | undefined;\n    slots.beforeImport.on(payload => {\n      if (payload.type === 'slice') {\n        const { snapshot } = payload;\n        flatNote(snapshot);\n\n        const text = std.selection.find('text');\n        if (!text) {\n          return;\n        }\n        tr = new PasteTr(std, text, payload.snapshot);\n        if (tr.canMerge()) {\n          tr.merge();\n        }\n      }\n    });\n    slots.afterImport.on(payload => {\n      if (tr && payload.type === 'slice') {\n        tr.pasted();\n        tr.focusPasted();\n        tr.convertToLinkedDoc();\n      }\n    });\n  };\n};\n"]}