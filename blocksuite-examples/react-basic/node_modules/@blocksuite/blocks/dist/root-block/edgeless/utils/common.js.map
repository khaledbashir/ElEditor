{"version":3,"file":"common.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/utils/common.ts"],"names":[],"mappings":"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","sourcesContent":["import type { NoteChildrenFlavour } from '@blocksuite/affine-shared/types';\nimport type { BlockStdScope } from '@blocksuite/block-std';\n\nimport { focusTextModel } from '@blocksuite/affine-components/rich-text';\nimport { toast } from '@blocksuite/affine-components/toast';\nimport {\n  type AttachmentBlockProps,\n  DEFAULT_NOTE_HEIGHT,\n  DEFAULT_NOTE_WIDTH,\n  type ImageBlockProps,\n  NOTE_MIN_HEIGHT,\n  type NoteBlockModel,\n  NoteDisplayMode,\n} from '@blocksuite/affine-model';\nimport {\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '@blocksuite/affine-shared/consts';\nimport { TelemetryProvider } from '@blocksuite/affine-shared/services';\nimport {\n  handleNativeRangeAtPoint,\n  humanFileSize,\n} from '@blocksuite/affine-shared/utils';\nimport { GfxControllerIdentifier } from '@blocksuite/block-std/gfx';\nimport {\n  Bound,\n  type IPoint,\n  type IVec,\n  Point,\n  serializeXYWH,\n  Vec,\n} from '@blocksuite/global/utils';\n\nimport {\n  getFileType,\n  uploadAttachmentBlob,\n} from '../../../attachment-block/utils.js';\nimport { calcBoundByOrigin, readImageSize } from '../components/utils.js';\nimport { DEFAULT_NOTE_OFFSET_X, DEFAULT_NOTE_OFFSET_Y } from './consts.js';\nimport { addBlock } from './crud.js';\n\nexport async function addAttachments(\n  std: BlockStdScope,\n  files: File[],\n  point?: IVec\n): Promise<string[]> {\n  if (!files.length) return [];\n\n  const attachmentService = std.getService('affine:attachment');\n  const gfx = std.get(GfxControllerIdentifier);\n\n  if (!attachmentService) {\n    console.error('Attachment service not found');\n    return [];\n  }\n  const maxFileSize = attachmentService.maxFileSize;\n  const isSizeExceeded = files.some(file => file.size > maxFileSize);\n  if (isSizeExceeded) {\n    toast(\n      std.host,\n      `You can only upload files less than ${humanFileSize(\n        maxFileSize,\n        true,\n        0\n      )}`\n    );\n    return [];\n  }\n\n  let { x, y } = gfx.viewport.center;\n  if (point) [x, y] = gfx.viewport.toModelCoord(...point);\n\n  const CARD_STACK_GAP = 32;\n\n  const dropInfos: { blockId: string; file: File }[] = files.map(\n    (file, index) => {\n      const point = new Point(\n        x + index * CARD_STACK_GAP,\n        y + index * CARD_STACK_GAP\n      );\n      const center = Vec.toVec(point);\n      const bound = Bound.fromCenter(\n        center,\n        EMBED_CARD_WIDTH.cubeThick,\n        EMBED_CARD_HEIGHT.cubeThick\n      );\n      const blockId = std.doc.addBlock(\n        'affine:attachment',\n        {\n          name: file.name,\n          size: file.size,\n          type: file.type,\n          style: 'cubeThick',\n          xywh: bound.serialize(),\n        } satisfies Partial<AttachmentBlockProps>,\n        gfx.surface\n      );\n\n      return { blockId, file };\n    }\n  );\n\n  // upload file and update the attachment model\n  const uploadPromises = dropInfos.map(async ({ blockId, file }) => {\n    const filetype = await getFileType(file);\n    await uploadAttachmentBlob(std.host, blockId, file, filetype, true);\n    return blockId;\n  });\n  const blockIds = await Promise.all(uploadPromises);\n\n  gfx.selection.set({\n    elements: blockIds,\n    editing: false,\n  });\n\n  return blockIds;\n}\n\nexport async function addImages(\n  std: BlockStdScope,\n  files: File[],\n  point?: IVec\n): Promise<string[]> {\n  const imageFiles = [...files].filter(file => file.type.startsWith('image/'));\n  if (!imageFiles.length) return [];\n\n  const imageService = std.getService('affine:image');\n  const gfx = std.get(GfxControllerIdentifier);\n\n  if (!imageService) {\n    console.error('Image service not found');\n    return [];\n  }\n\n  const maxFileSize = imageService.maxFileSize;\n  const isSizeExceeded = imageFiles.some(file => file.size > maxFileSize);\n  if (isSizeExceeded) {\n    toast(\n      std.host,\n      `You can only upload files less than ${humanFileSize(\n        maxFileSize,\n        true,\n        0\n      )}`\n    );\n    return [];\n  }\n\n  let { x, y } = gfx.viewport.center;\n  if (point) [x, y] = gfx.viewport.toModelCoord(...point);\n\n  const dropInfos: { point: Point; blockId: string }[] = [];\n  const IMAGE_STACK_GAP = 32;\n  const isMultipleFiles = imageFiles.length > 1;\n  const inTopLeft = isMultipleFiles ? true : false;\n\n  // create image cards without image data\n  imageFiles.map((file, index) => {\n    const point = new Point(\n      x + index * IMAGE_STACK_GAP,\n      y + index * IMAGE_STACK_GAP\n    );\n    const center = Vec.toVec(point);\n    const bound = calcBoundByOrigin(center, inTopLeft);\n    const blockId = std.doc.addBlock(\n      'affine:image',\n      {\n        size: file.size,\n        xywh: bound.serialize(),\n      },\n      gfx.surface\n    );\n    dropInfos.push({ point, blockId });\n  });\n\n  // upload image data and update the image model\n  const uploadPromises = imageFiles.map(async (file, index) => {\n    const { point, blockId } = dropInfos[index];\n\n    const sourceId = await std.doc.blobSync.set(file);\n    const imageSize = await readImageSize(file);\n\n    const center = Vec.toVec(point);\n    const bound = calcBoundByOrigin(\n      center,\n      inTopLeft,\n      imageSize.width,\n      imageSize.height\n    );\n\n    std.doc.withoutTransact(() => {\n      gfx.updateElement(blockId, {\n        sourceId,\n        ...imageSize,\n        xywh: bound.serialize(),\n      } satisfies Partial<ImageBlockProps>);\n    });\n  });\n  await Promise.all(uploadPromises);\n\n  const blockIds = dropInfos.map(info => info.blockId);\n  gfx.selection.set({\n    elements: blockIds,\n    editing: false,\n  });\n  if (isMultipleFiles) {\n    std.command.exec('autoResizeElements');\n  }\n  return blockIds;\n}\n\nexport function addNoteAtPoint(\n  std: BlockStdScope,\n  /**\n   * The point is in browser coordinate\n   */\n  point: IPoint,\n  options: {\n    width?: number;\n    height?: number;\n    parentId?: string;\n    noteIndex?: number;\n    offsetX?: number;\n    offsetY?: number;\n    scale?: number;\n  } = {}\n) {\n  const gfx = std.get(GfxControllerIdentifier);\n  const {\n    width = DEFAULT_NOTE_WIDTH,\n    height = DEFAULT_NOTE_HEIGHT,\n    offsetX = DEFAULT_NOTE_OFFSET_X,\n    offsetY = DEFAULT_NOTE_OFFSET_Y,\n    parentId = gfx.doc.root?.id,\n    noteIndex: noteIndex,\n    scale = 1,\n  } = options;\n  const [x, y] = gfx.viewport.toModelCoord(point.x, point.y);\n  const blockId = addBlock(\n    std,\n    'affine:note',\n    {\n      xywh: serializeXYWH(\n        x - offsetX * scale,\n        y - offsetY * scale,\n        width,\n        height\n      ),\n      displayMode: NoteDisplayMode.EdgelessOnly,\n    },\n    parentId,\n    noteIndex\n  );\n\n  gfx.std.getOptional(TelemetryProvider)?.track('CanvasElementAdded', {\n    control: 'canvas:draw',\n    page: 'whiteboard editor',\n    module: 'toolbar',\n    segment: 'toolbar',\n    type: 'note',\n  });\n\n  return blockId;\n}\n\ntype NoteOptions = {\n  childFlavour: NoteChildrenFlavour;\n  childType: string | null;\n  collapse: boolean;\n};\n\nexport function addNote(\n  std: BlockStdScope,\n  point: Point,\n  options: NoteOptions,\n  width = DEFAULT_NOTE_WIDTH,\n  height = DEFAULT_NOTE_HEIGHT\n) {\n  const noteId = addNoteAtPoint(std, point, {\n    width,\n    height,\n  });\n\n  const gfx = std.get(GfxControllerIdentifier);\n  const doc = std.doc;\n\n  const blockId = doc.addBlock(\n    options.childFlavour,\n    { type: options.childType },\n    noteId\n  );\n  if (options.collapse && height > NOTE_MIN_HEIGHT) {\n    const note = doc.getBlockById(noteId) as NoteBlockModel;\n    doc.updateBlock(note, () => {\n      note.edgeless.collapse = true;\n      note.edgeless.collapsedHeight = height;\n    });\n  }\n  gfx.tool.setTool('default');\n\n  // Wait for edgelessTool updated\n  requestAnimationFrame(() => {\n    const blocks =\n      (doc.root?.children.filter(\n        child => child.flavour === 'affine:note'\n      ) as BlockSuite.EdgelessBlockModelType[]) ?? [];\n    const element = blocks.find(b => b.id === noteId);\n    if (element) {\n      gfx.selection.set({\n        elements: [element.id],\n        editing: true,\n      });\n\n      // Waiting dom updated, `note mask` is removed\n      if (blockId) {\n        focusTextModel(gfx.std, blockId);\n      } else {\n        // Cannot reuse `handleNativeRangeClick` directly here,\n        // since `retargetClick` will re-target to pervious editor\n        handleNativeRangeAtPoint(point.x, point.y);\n      }\n    }\n  });\n}\n"]}