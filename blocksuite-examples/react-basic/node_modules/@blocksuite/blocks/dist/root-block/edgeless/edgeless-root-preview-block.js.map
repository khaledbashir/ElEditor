{"version":3,"file":"edgeless-root-preview-block.js","sourceRoot":"","sources":["../../../src/root-block/edgeless/edgeless-root-preview-block.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAWA,OAAO,EACL,iBAAiB,EACjB,aAAa,GACd,MAAM,oCAAoC,CAAC;AAC5C,OAAO,EAAE,cAAc,EAAE,MAAM,uBAAuB,CAAC;AACvD,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AACxD,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAChC,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AAKjD,OAAO,EAAE,8BAA8B,EAAE,MAAM,8BAA8B,CAAC;AAC9E,OAAO,EAAE,iBAAiB,EAAE,eAAe,EAAE,MAAM,kBAAkB,CAAC;IAEzD,iCAAiC;sBAAS,cAAc;;;;;;;;;;;;;iBAAxD,iCAAkC,SAAQ,WAItD;;;sCAmCE,KAAK,CAAC,sBAAsB,CAAC;kDAsL7B,KAAK,EAAE;0CAGP,KAAK,CAAC,cAAc,CAAC;mCAGrB,KAAK,CAAC,gBAAgB,CAAC;YA3LxB,mLAAS,UAAU,6BAAV,UAAU,+FAAkB;YAsLrC,uNAAS,sBAAsB,6BAAtB,sBAAsB,uHAA+B;YAG9D,+LAAS,cAAc,6BAAd,cAAc,uGAAsB;YAG7C,0KAAS,OAAO,6BAAP,OAAO,yFAAyB;;;iBA/NzB,WAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAgC3B,AAhCqB,CAgCpB;QAGF,6BAAqC;QAArC,IAAS,UAAU,gDAAkB;QAArC,IAAS,UAAU,sDAAkB;QAiBrC,IAAI,UAAU;YACZ,OAAO,IAAI,CAAC,OAAO,EAAE,iBAAiB,CAAC;QACzC,CAAC;QAED,IAAI,iBAAiB;YACnB,OAAO,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAC7B,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,KAAK,gBAAgB,CACvB,CAAC;QACzB,CAAC;QAED,IAAI,eAAe;YACjB,IAAI,IAAI,CAAC,gBAAgB;gBAAE,OAAO,IAAI,CAAC,gBAAgB,CAAC;YACxD,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CACvC,IAAI,CAAC,sBAAsB,CACN,CAAC;YACxB,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YACpC,OAAO,IAAI,CAAC,gBAAgB,CAAC;QAC/B,CAAC;QAEO,eAAe;YACrB,IAAI,CAAC,GAAG;iBACL,GAAG,CAAC,iBAAiB,CAAC;iBACtB,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE;gBACf,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;YACzB,CAAC,CAAC;iBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAC1B,CAAC;QAEO,sBAAsB;YAC5B,MAAM,YAAY,GAAG,8BAA8B,CAAC,GAAG,EAAE;gBACvD,MAAM,MAAM,GAAG,KAAK,CAAC,IAAI,CACvB,IAAI,CAAC,cAAc,CAAC,QAA+C,CACpE,CAAC;gBAEF,MAAM,CAAC,OAAO,CAAC,CAAC,KAAwB,EAAE,EAAE;oBAC1C,KAAK,CAAC,YAAY,EAAE,EAAE,CAAC;gBACzB,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,CAAC,GAAG,CACnB,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,YAAY,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,YAAY,EAAE,CAAC,CAC/D,CAAC;QACJ,CAAC;QAEO,2BAA2B;YACjC,IAAI,KAAqB,CAAC;YAE1B,MAAM,kBAAkB,GAAG,GAAG,EAAE;gBAC9B,IAAI,KAAK,EAAE,CAAC;oBACV,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC;oBACjC,KAAK,CAAC,mBAAmB,CAAC,QAAQ,EAAE,kBAAkB,CAAC,CAAC;gBAC1D,CAAC;gBAED,KAAK,GAAG,UAAU,CAAC,gBAAgB,MAAM,CAAC,gBAAgB,OAAO,CAAC,CAAC;gBACnE,KAAK,CAAC,gBAAgB,CAAC,QAAQ,EAAE,kBAAkB,CAAC,CAAC;YACvD,CAAC,CAAC;YAEF,kBAAkB,EAAE,CAAC;YAErB,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE;gBACzB,KAAK,EAAE,mBAAmB,CAAC,QAAQ,EAAE,kBAAkB,CAAC,CAAC;YAC3D,CAAC,CAAC,CAAC;QACL,CAAC;QAEO,iBAAiB;YACvB,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;gBAC3B,OAAO;YACT,CAAC;YAED,MAAM,cAAc,GAAG,IAAI,cAAc,CAAC,CAAC,CAAwB,EAAE,EAAE;gBACrE,qDAAqD;gBACrD,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;oBACvE,OAAO,CAAC,KAAK,CAAC,mBAAmB,CAAC,CAAC;oBACnC,OAAO;gBACT,CAAC;gBACD,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,iBAAiB,CAAC,CAAC;gBACrE,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC;YACnC,CAAC,CAAC,CAAC;YAEH,cAAc,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;YAC7C,IAAI,CAAC,eAAe,EAAE,UAAU,EAAE,CAAC;YACnC,IAAI,CAAC,eAAe,GAAG,cAAc,CAAC;QACxC,CAAC;QAEO,gBAAgB;YACtB,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAC3E,CAAC;QACJ,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAE1B,IAAI,CAAC,WAAW,CAAC,iBAAiB,EAAE,GAAG,EAAE;gBACvC,MAAM,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,CAC5C,CAAC,GAAG,EAA2B,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,SAAS,CAAC,CACpD,CAAC;gBACF,IAAI,CAAC,OAAO;oBAAE,OAAO;gBAErB,MAAM,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;gBAC5D,IAAI,eAAe,CAAC,EAAE,CAAC,EAAE,CAAC;oBACxB,OAAO,IAAI,CAAC;gBACd,CAAC;gBAED,OAAO;YACT,CAAC,CAAC,CAAC;QACL,CAAC;QAEQ,oBAAoB;YAC3B,KAAK,CAAC,oBAAoB,EAAE,CAAC;YAE7B,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;gBACzB,IAAI,CAAC,eAAe,CAAC,UAAU,EAAE,CAAC;gBAClC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAC9B,CAAC;QACH,CAAC;QAEQ,YAAY;YACnB,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACxB,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACzB,IAAI,CAAC,2BAA2B,EAAE,CAAC;YACnC,IAAI,CAAC,eAAe,EAAE,CAAC;YACvB,IAAI,CAAC,sBAAsB,EAAE,CAAC;YAE9B,IAAI,CAAC,YAAY,CAAC,GAAG,CACnB,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC,GAAG,EAAE;gBAC5C,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC/B,CAAC,CAAC,CACH,CAAC;YAEF,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAC/B,CAAC;QAEQ,WAAW;YAClB,OAAO,IAAI,CAAA;;;sBAGO,IAAI,CAAC,OAAO,CAAC,QAAQ;iCACV,GAAG,EAAE;gBAC1B,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CACzC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,cAAc,EACpC;oBACE,MAAM,EAAE,IAAI;oBACZ,MAAM,EAAE,CAAC,OAAO,CAAC;iBAClB,CACF,CAAC;gBACF,OAAO,MAAM,CAAC;YAChB,CAAC;kBACO,IAAI,CAAC,IAAI;;YAEf,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,cAAc,CACrD,IAAI,CAAC,iBAAiB,CACvB;;;KAGN,CAAC;QACJ,CAAC;QAEQ,UAAU,CAAC,kBAA6C;YAC/D,IAAI,kBAAkB,CAAC,GAAG,CAAC,wBAAwB,CAAC,EAAE,CAAC;gBACrD,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC3B,CAAC;QACH,CAAC;QAGD,yCAA8D;QAA9D,IAAS,sBAAsB,4DAA+B;QAA9D,IAAS,sBAAsB,kEAA+B;QAG9D,iCAA6C;QAA7C,IAAS,cAAc,oDAAsB;QAA7C,IAAS,cAAc,0DAAsB;QAG7C,0BAAyC;QAAzC,IAAS,OAAO,6CAAyB;QAAzC,IAAS,OAAO,mDAAyB;;;YA5LhC,8FAA4B;YAE7B,0BAAqB,4DAAG,8BAA8B,CAAC,GAAG,EAAE;gBAClE,MAAM,EAAE,IAAI,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;gBAC/D,MAAM,EAAE,GAAG,EAAE,GAAG,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;gBAE9C,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,WAAW,CAC/B,qBAAqB,EACrB,GAAG,UAAU,MAAM,UAAU,IAAI,CAClC,CAAC;gBACF,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,WAAW,CAAC,iBAAiB,EAAE,GAAG,GAAG,MAAM,GAAG,IAAI,CAAC,CAAC;YAC5E,CAAC,EAAE,IAAI,CAAC,EAAC;YAED,oBAAe,GAA0B,IAAI,CAAC;YAE9C,qBAAgB,GAAuB,IAAI,CAAC;YAuK3C,8GAAyB,2BAA2B,EAAC;YAGrD,4KAAoC;YAGpC,sJAAgC;;;;;SApO9B,iCAAiC","sourcesContent":["import type {\n  SurfaceBlockComponent,\n  SurfaceBlockModel,\n} from '@blocksuite/affine-block-surface';\nimport type { RootBlockModel } from '@blocksuite/affine-model';\nimport type {\n  GfxBlockComponent,\n  SurfaceSelection,\n} from '@blocksuite/block-std';\nimport type { GfxViewportElement } from '@blocksuite/block-std/gfx';\n\nimport {\n  FontLoaderService,\n  ThemeProvider,\n} from '@blocksuite/affine-shared/services';\nimport { BlockComponent } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { query, state } from 'lit/decorators.js';\n\nimport type { EdgelessRootBlockWidgetName } from '../types.js';\nimport type { EdgelessRootService } from './edgeless-root-service.js';\n\nimport { requestThrottledConnectedFrame } from '../../_common/utils/index.js';\nimport { getBackgroundGrid, isCanvasElement } from './utils/query.js';\n\nexport class EdgelessRootPreviewBlockComponent extends BlockComponent<\n  RootBlockModel,\n  EdgelessRootService,\n  EdgelessRootBlockWidgetName\n> {\n  static override styles = css`\n    affine-edgeless-root-preview {\n      pointer-events: none;\n      -webkit-user-select: none;\n      user-select: none;\n      display: block;\n      height: 100%;\n    }\n\n    affine-edgeless-root-preview .widgets-container {\n      position: absolute;\n      left: 0;\n      top: 0;\n      contain: size layout;\n      z-index: 1;\n      height: 100%;\n    }\n\n    affine-edgeless-root-preview .edgeless-background {\n      height: 100%;\n      background-color: var(--affine-background-primary-color);\n      background-image: radial-gradient(\n        var(--affine-edgeless-grid-color) 1px,\n        var(--affine-background-primary-color) 1px\n      );\n    }\n\n    @media print {\n      .selected {\n        background-color: transparent !important;\n      }\n    }\n  `;\n\n  @query('.edgeless-background')\n  accessor background!: HTMLDivElement;\n\n  private _refreshLayerViewport = requestThrottledConnectedFrame(() => {\n    const { zoom, translateX, translateY } = this.service.viewport;\n    const { gap } = getBackgroundGrid(zoom, true);\n\n    this.background.style.setProperty(\n      'background-position',\n      `${translateX}px ${translateY}px`\n    );\n    this.background.style.setProperty('background-size', `${gap}px ${gap}px`);\n  }, this);\n\n  private _resizeObserver: ResizeObserver | null = null;\n\n  private _viewportElement: HTMLElement | null = null;\n\n  get dispatcher() {\n    return this.service?.uiEventDispatcher;\n  }\n\n  get surfaceBlockModel() {\n    return this.model.children.find(\n      child => child.flavour === 'affine:surface'\n    ) as SurfaceBlockModel;\n  }\n\n  get viewportElement(): HTMLElement {\n    if (this._viewportElement) return this._viewportElement;\n    this._viewportElement = this.host.closest(\n      this.editorViewportSelector\n    ) as HTMLElement | null;\n    assertExists(this._viewportElement);\n    return this._viewportElement;\n  }\n\n  private _initFontLoader() {\n    this.std\n      .get(FontLoaderService)\n      .ready.then(() => {\n        this.surface.refresh();\n      })\n      .catch(console.error);\n  }\n\n  private _initLayerUpdateEffect() {\n    const updateLayers = requestThrottledConnectedFrame(() => {\n      const blocks = Array.from(\n        this.gfxViewportElm.children as HTMLCollectionOf<GfxBlockComponent>\n      );\n\n      blocks.forEach((block: GfxBlockComponent) => {\n        block.updateZIndex?.();\n      });\n    });\n\n    this._disposables.add(\n      this.service.layer.slots.layerUpdated.on(() => updateLayers())\n    );\n  }\n\n  private _initPixelRatioChangeEffect() {\n    let media: MediaQueryList;\n\n    const onPixelRatioChange = () => {\n      if (media) {\n        this.service.viewport.onResize();\n        media.removeEventListener('change', onPixelRatioChange);\n      }\n\n      media = matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);\n      media.addEventListener('change', onPixelRatioChange);\n    };\n\n    onPixelRatioChange();\n\n    this._disposables.add(() => {\n      media?.removeEventListener('change', onPixelRatioChange);\n    });\n  }\n\n  private _initResizeEffect() {\n    if (!this._viewportElement) {\n      return;\n    }\n\n    const resizeObserver = new ResizeObserver((_: ResizeObserverEntry[]) => {\n      // FIXME: find a better way to get rid of empty check\n      if (!this.service || !this.service.selection || !this.service.viewport) {\n        console.error('Service not ready');\n        return;\n      }\n      this.service.selection.set(this.service.selection.surfaceSelections);\n      this.service.viewport.onResize();\n    });\n\n    resizeObserver.observe(this.viewportElement);\n    this._resizeObserver?.disconnect();\n    this._resizeObserver = resizeObserver;\n  }\n\n  private _initSlotEffects() {\n    this.disposables.add(\n      this.std.get(ThemeProvider).theme$.subscribe(() => this.surface.refresh())\n    );\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.handleEvent('selectionChange', () => {\n      const surface = this.host.selection.value.find(\n        (sel): sel is SurfaceSelection => sel.is('surface')\n      );\n      if (!surface) return;\n\n      const el = this.service.getElementById(surface.elements[0]);\n      if (isCanvasElement(el)) {\n        return true;\n      }\n\n      return;\n    });\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n\n    if (this._resizeObserver) {\n      this._resizeObserver.disconnect();\n      this._resizeObserver = null;\n    }\n  }\n\n  override firstUpdated() {\n    this._initSlotEffects();\n    this._initResizeEffect();\n    this._initPixelRatioChangeEffect();\n    this._initFontLoader();\n    this._initLayerUpdateEffect();\n\n    this._disposables.add(\n      this.service.viewport.viewportUpdated.on(() => {\n        this._refreshLayerViewport();\n      })\n    );\n\n    this._refreshLayerViewport();\n  }\n\n  override renderBlock() {\n    return html`\n      <div class=\"edgeless-background edgeless-container\">\n        <gfx-viewport\n          .viewport=${this.service.viewport}\n          .getModelsInViewport=${() => {\n            const blocks = this.service.gfx.grid.search(\n              this.service.viewport.viewportBounds,\n              {\n                useSet: true,\n                filter: ['block'],\n              }\n            );\n            return blocks;\n          }}\n          .host=${this.host}\n        >\n          ${this.renderChildren(this.model)}${this.renderChildren(\n            this.surfaceBlockModel\n          )}\n        </gfx-viewport>\n      </div>\n    `;\n  }\n\n  override willUpdate(_changedProperties: Map<PropertyKey, unknown>): void {\n    if (_changedProperties.has('editorViewportSelector')) {\n      this._initResizeEffect();\n    }\n  }\n\n  @state()\n  accessor editorViewportSelector = '.affine-edgeless-viewport';\n\n  @query('gfx-viewport')\n  accessor gfxViewportElm!: GfxViewportElement;\n\n  @query('affine-surface')\n  accessor surface!: SurfaceBlockComponent;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-edgeless-root-preview': EdgelessRootPreviewBlockComponent;\n  }\n}\n"]}