{"version":3,"file":"eraser-tool.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/gfx-tool/eraser-tool.ts"],"names":[],"mappings":"AAEA,OAAO,EACL,WAAW,EACX,OAAO,GAER,MAAM,kCAAkC,CAAC;AAC1C,OAAO,EAAE,QAAQ,EAAE,MAAM,2BAA2B,CAAC;AACrD,OAAO,EAAE,KAAK,EAAa,MAAM,0BAA0B,CAAC;AAE5D,OAAO,EAAE,gBAAgB,EAAE,MAAM,kBAAkB,CAAC;AACpD,OAAO,EAAE,eAAe,EAAE,MAAM,mBAAmB,CAAC;AAEpD,MAAM,EAAE,oBAAoB,EAAE,SAAS,EAAE,qBAAqB,EAAE,GAAG,WAAW,CAAC;AAE/E,MAAM,aAAc,SAAQ,OAAO;IAAnC;;QACE,MAAC,GAAG,EAAE,CAAC;IAQT,CAAC;IANU,MAAM,CAAC,GAA6B;QAC3C,GAAG,CAAC,WAAW,GAAG,IAAI,CAAC;QACvB,MAAM,IAAI,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAChC,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC;QACvB,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACjB,CAAC;CACF;AAED,MAAM,OAAO,UAAW,SAAQ,QAAQ;IAAxC;;QAGU,cAAS,GAAG,IAAI,GAAG,EAA4B,CAAC;QAEhD,kBAAa,GAAW,EAAE,CAAC;QAE3B,kBAAa,GAAG,IAAI,GAAG,EAA4B,CAAC;QAEpD,UAAK,GAAG,GAAG,EAAE;YACnB,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACvB,MAAM,OAAO,GAAG,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC;YAEtC,IAAI,SAAS,GAAG,KAAK,CAAC;YAEtB,IAAI,IAAI,CAAC,gBAAgB,KAAK,IAAI,CAAC,UAAU,EAAE,CAAC;gBAC9C,SAAS,GAAG,IAAI,CAAC;gBACjB,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;gBACzC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,UAAU,CAAC;YAC1C,CAAC;YACD,IAAI,OAAO,GAAG,EAAE,EAAE,CAAC;gBACjB,IAAI,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBAClC,SAAS,GAAG,IAAI,CAAC;oBACjB,IAAI,CAAC,aAAa,CAAC,MAAM,CACvB,CAAC,EACD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,GAAG,CAAC,CAC3C,CAAC;oBACF,IAAI,CAAC,UAAU,GAAG,GAAG,CAAC;gBACxB,CAAC;YACH,CAAC;YACD,IAAI,SAAS,EAAE,CAAC;gBACd,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC;gBACpC,MAAM,CAAC,GAAG,oBAAoB,CAC5B,SAAS,CAAC,IAAI,CAAC,aAAa,EAAE;oBAC5B,IAAI,EAAE,EAAE,GAAG,IAAI;oBACf,KAAK,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE;iBACvB,CAAC,CACH,CAAC;gBACF,IAAI,CAAC,QAAQ,CAAC,CAAC,GAAG,CAAC,CAAC;gBACnB,IAAI,CAAC,GAAG,CAAC,gBAA0C,EAAE,OAAO,EAAE,CAAC;YAClE,CAAC;YACD,IAAI,CAAC,MAAM,GAAG,qBAAqB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAClD,CAAC,CAAC;QAEM,aAAQ,GAAG,IAAI,aAAa,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAEvC,qBAAgB,GAAS,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QAEhC,eAAU,GAAS,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QAE1B,WAAM,GAAG,CAAC,CAAC;QAEX,eAAU,GAAG,CAAC,CAAC;IAgFzB,CAAC;aAnIiB,aAAQ,GAAG,QAAQ,AAAX,CAAY;IAqD5B,MAAM;QACZ,oBAAoB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAElC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;YACtB,OAAO;QACT,CAAC;QAGC,IAAI,CAAC,GAAG,CAAC,gBACV,EAAE,QAAQ,CAAC,aAAa,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACzC,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC;QACvB,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC;IAC7B,CAAC;IAEQ,QAAQ;QACf,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE;YACpC,IAAI,eAAe,CAAC,QAAQ,CAAC,EAAE,CAAC;gBAC9B,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;gBAChD,GAAG,IAAI,CAAE,GAAmB,CAAC,KAAK,CAAC,OAAO,GAAG,GAAG,CAAC,CAAC;YACpD,CAAC;iBAAM,CAAC;gBACN,QAAQ,CAAC,OAAO,GAAG,CAAC,CAAC;YACvB,CAAC;QACH,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,MAAM,EAAE,CAAC;IAChB,CAAC;IAEQ,OAAO,CAAC,CAAoB;QACnC,gBAAgB,CAAC,IAAI,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC;QAC3D,IAAI,CAAC,MAAM,EAAE,CAAC;QACd,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;IACzB,CAAC;IAEQ,QAAQ,CAAC,CAAoB;QACpC,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QAC1E,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE;YAChC,IAAI,QAAQ,CAAC,QAAQ,EAAE;gBAAE,OAAO;YAChC,IAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC;gBAAE,OAAO;YAC7C,IAAI,eAAe,CAAC,QAAQ,CAAC,EAAE,CAAC;gBAC9B,MAAM,KAAK,GAAG,KAAK,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;gBAC/C,IACE,qBAAqB,CAAC,IAAI,CAAC,UAAU,EAAE,YAAY,EAAE,KAAK,CAAC,MAAM,CAAC,EAClE,CAAC;oBACD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBACjC,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;oBAChD,GAAG,IAAI,CAAE,GAAmB,CAAC,KAAK,CAAC,OAAO,GAAG,KAAK,CAAC,CAAC;gBACtD,CAAC;YACH,CAAC;iBAAM,CAAC;gBACN,IACE,QAAQ,CAAC,oBAAoB,CAC3B,IAAI,CAAC,UAAkB,EACvB,YAAoB,CACrB,EACD,CAAC;oBACD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBACjC,QAAQ,CAAC,OAAO,GAAG,GAAG,CAAC;gBACzB,CAAC;YACH,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,GAAG,YAAY,CAAC;IACjC,CAAC;IAEQ,SAAS,CAAC,CAAoB;QACrC,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;QAEvB,MAAM,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;QACpB,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;QAChE,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;QAC9B,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACzB,IAAI,CAAC,SAAS,GAAG,IAAI,GAAG,CAAC;YACvB,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,cAAc;YAChC,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,MAAM;SACzB,CAAC,CAAC;QACH,IAAI,CAAC,KAAK,EAAE,CAAC;QACZ,IAAI,CAAC,GAAG,CAAC,gBAA0C,EAAE,QAAQ,CAAC,UAAU,CACvE,IAAI,CAAC,QAAQ,CACd,CAAC;IACJ,CAAC","sourcesContent":["import type { PointerEventState } from '@blocksuite/block-std';\n\nimport {\n  CommonUtils,\n  Overlay,\n  type SurfaceBlockComponent,\n} from '@blocksuite/affine-block-surface';\nimport { BaseTool } from '@blocksuite/block-std/gfx';\nimport { Bound, type IVec } from '@blocksuite/global/utils';\n\nimport { deleteElementsV2 } from '../utils/crud.js';\nimport { isTopLevelBlock } from '../utils/query.js';\n\nconst { getSvgPathFromStroke, getStroke, linePolygonIntersects } = CommonUtils;\n\nclass EraserOverlay extends Overlay {\n  d = '';\n\n  override render(ctx: CanvasRenderingContext2D): void {\n    ctx.globalAlpha = 0.33;\n    const path = new Path2D(this.d);\n    ctx.fillStyle = '#aaa';\n    ctx.fill(path);\n  }\n}\n\nexport class EraserTool extends BaseTool {\n  static override toolName = 'eraser';\n\n  private _erasable = new Set<BlockSuite.EdgelessModel>();\n\n  private _eraserPoints: IVec[] = [];\n\n  private _eraseTargets = new Set<BlockSuite.EdgelessModel>();\n\n  private _loop = () => {\n    const now = Date.now();\n    const elapsed = now - this._timestamp;\n\n    let didUpdate = false;\n\n    if (this._prevEraserPoint !== this._prevPoint) {\n      didUpdate = true;\n      this._eraserPoints.push(this._prevPoint);\n      this._prevEraserPoint = this._prevPoint;\n    }\n    if (elapsed > 32) {\n      if (this._eraserPoints.length > 1) {\n        didUpdate = true;\n        this._eraserPoints.splice(\n          0,\n          Math.ceil(this._eraserPoints.length * 0.1)\n        );\n        this._timestamp = now;\n      }\n    }\n    if (didUpdate) {\n      const zoom = this.gfx.viewport.zoom;\n      const d = getSvgPathFromStroke(\n        getStroke(this._eraserPoints, {\n          size: 16 / zoom,\n          start: { taper: true },\n        })\n      );\n      this._overlay.d = d;\n      (this.gfx.surfaceComponent as SurfaceBlockComponent)?.refresh();\n    }\n    this._timer = requestAnimationFrame(this._loop);\n  };\n\n  private _overlay = new EraserOverlay(this.gfx);\n\n  private _prevEraserPoint: IVec = [0, 0];\n\n  private _prevPoint: IVec = [0, 0];\n\n  private _timer = 0;\n\n  private _timestamp = 0;\n\n  private _reset() {\n    cancelAnimationFrame(this._timer);\n\n    if (!this.gfx.surface) {\n      return;\n    }\n\n    (\n      this.gfx.surfaceComponent as SurfaceBlockComponent\n    )?.renderer.removeOverlay(this._overlay);\n    this._erasable.clear();\n    this._eraseTargets.clear();\n  }\n\n  override activate(): void {\n    this._eraseTargets.forEach(erasable => {\n      if (isTopLevelBlock(erasable)) {\n        const ele = this.std.view.getBlock(erasable.id);\n        ele && ((ele as HTMLElement).style.opacity = '1');\n      } else {\n        erasable.opacity = 1;\n      }\n    });\n    this._reset();\n  }\n\n  override dragEnd(_: PointerEventState): void {\n    deleteElementsV2(this.gfx, Array.from(this._eraseTargets));\n    this._reset();\n    this.doc.captureSync();\n  }\n\n  override dragMove(e: PointerEventState): void {\n    const currentPoint = this.gfx.viewport.toModelCoord(e.point.x, e.point.y);\n    this._erasable.forEach(erasable => {\n      if (erasable.isLocked()) return;\n      if (this._eraseTargets.has(erasable)) return;\n      if (isTopLevelBlock(erasable)) {\n        const bound = Bound.deserialize(erasable.xywh);\n        if (\n          linePolygonIntersects(this._prevPoint, currentPoint, bound.points)\n        ) {\n          this._eraseTargets.add(erasable);\n          const ele = this.std.view.getBlock(erasable.id);\n          ele && ((ele as HTMLElement).style.opacity = '0.3');\n        }\n      } else {\n        if (\n          erasable.getLineIntersections(\n            this._prevPoint as IVec,\n            currentPoint as IVec\n          )\n        ) {\n          this._eraseTargets.add(erasable);\n          erasable.opacity = 0.3;\n        }\n      }\n    });\n\n    this._prevPoint = currentPoint;\n  }\n\n  override dragStart(e: PointerEventState): void {\n    this.doc.captureSync();\n\n    const { point } = e;\n    const [x, y] = this.gfx.viewport.toModelCoord(point.x, point.y);\n    this._eraserPoints = [[x, y]];\n    this._prevPoint = [x, y];\n    this._erasable = new Set([\n      ...this.gfx.layer.canvasElements,\n      ...this.gfx.layer.blocks,\n    ]);\n    this._loop();\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.renderer.addOverlay(\n      this._overlay\n    );\n  }\n}\n\ndeclare module '@blocksuite/block-std/gfx' {\n  interface GfxToolsMap {\n    eraser: EraserTool;\n  }\n}\n"]}