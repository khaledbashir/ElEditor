{"version":3,"file":"crud.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/utils/crud.ts"],"names":[],"mappings":"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","sourcesContent":["import type { SurfaceBlockModel } from '@blocksuite/affine-block-surface';\nimport type { BlockStdScope } from '@blocksuite/block-std';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport { EditPropsStore } from '@blocksuite/affine-shared/services';\nimport {\n  type GfxController,\n  GfxControllerIdentifier,\n} from '@blocksuite/block-std/gfx';\n\nimport type { Connectable } from '../../../_common/utils/index.js';\nimport type { EdgelessRootBlockComponent } from '../index.js';\n\nimport { getLastPropsKey } from './get-last-props-key.js';\nimport { isConnectable, isNoteBlock } from './query.js';\n\n/**\n * Use deleteElementsV2 instead.\n * @deprecated\n */\nexport function deleteElements(\n  edgeless: EdgelessRootBlockComponent,\n  elements: BlockSuite.EdgelessModel[]\n) {\n  const set = new Set(elements);\n  const { service } = edgeless;\n\n  elements.forEach(element => {\n    if (isConnectable(element)) {\n      const connectors = service.getConnectors(element as Connectable);\n      connectors.forEach(connector => set.add(connector));\n    }\n  });\n\n  set.forEach(element => {\n    if (isNoteBlock(element)) {\n      const children = edgeless.doc.root?.children ?? [];\n      // FIXME: should always keep at least 1 note\n      if (children.length > 1) {\n        edgeless.doc.deleteBlock(element);\n      }\n    } else {\n      service.removeElement(element.id);\n    }\n  });\n}\n\nexport function deleteElementsV2(\n  gfx: GfxController,\n  elements: BlockSuite.EdgelessModel[]\n) {\n  const set = new Set(elements);\n\n  elements.forEach(element => {\n    if (isConnectable(element)) {\n      const connectors = (gfx.surface as SurfaceBlockModel).getConnectors(\n        element.id\n      );\n      connectors.forEach(connector => set.add(connector));\n    }\n  });\n\n  set.forEach(element => {\n    if (isNoteBlock(element)) {\n      const children = gfx.doc.root?.children ?? [];\n      if (children.length > 1) {\n        gfx.doc.deleteBlock(element);\n      }\n    } else {\n      gfx.deleteElement(element.id);\n    }\n  });\n}\n\nexport function addBlock(\n  std: BlockStdScope,\n  flavour: BlockSuite.EdgelessModelKeys,\n  props: Record<string, unknown>,\n  parentId?: string | BlockModel,\n  parentIndex?: number\n) {\n  const gfx = std.get(GfxControllerIdentifier);\n  const key = getLastPropsKey(flavour as BlockSuite.EdgelessModelKeys, props);\n  if (key) {\n    props = std.get(EditPropsStore).applyLastProps(key, props);\n  }\n\n  const nProps = {\n    ...props,\n    index: gfx.layer.generateIndex(),\n  };\n\n  return std.doc.addBlock(flavour as never, nProps, parentId, parentIndex);\n}\n"]}