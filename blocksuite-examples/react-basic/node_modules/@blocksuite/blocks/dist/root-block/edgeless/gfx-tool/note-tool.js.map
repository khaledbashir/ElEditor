{"version":3,"file":"note-tool.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/gfx-tool/note-tool.ts"],"names":[],"mappings":"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","sourcesContent":["import type { SurfaceBlockComponent } from '@blocksuite/affine-block-surface';\nimport type { PointerEventState } from '@blocksuite/block-std';\n\nimport {\n  DEFAULT_NOTE_HEIGHT,\n  DEFAULT_NOTE_WIDTH,\n} from '@blocksuite/affine-model';\nimport { EditPropsStore } from '@blocksuite/affine-shared/services';\nimport { BaseTool } from '@blocksuite/block-std/gfx';\nimport { Point } from '@blocksuite/global/utils';\nimport { effect } from '@preact/signals-core';\n\nimport {\n  hasClassNameInList,\n  type NoteChildrenFlavour,\n} from '../../../_common/utils/index.js';\nimport { addNote } from '../utils/common.js';\nimport { EXCLUDING_MOUSE_OUT_CLASS_LIST } from '../utils/consts.js';\nimport { DraggingNoteOverlay, NoteOverlay } from '../utils/tool-overlay.js';\n\nexport type NoteToolOption = {\n  childFlavour: NoteChildrenFlavour;\n  childType: string | null;\n  tip: string;\n};\n\nexport class NoteTool extends BaseTool<NoteToolOption> {\n  static override toolName = 'affine:note';\n\n  private _draggingNoteOverlay: DraggingNoteOverlay | null = null;\n\n  private _noteOverlay: NoteOverlay | null = null;\n\n  // Ensure clear overlay before adding a new note\n  private _clearOverlay() {\n    this._noteOverlay = this._disposeOverlay(this._noteOverlay);\n    this._draggingNoteOverlay = this._disposeOverlay(this._draggingNoteOverlay);\n    (this.gfx.surfaceComponent as SurfaceBlockComponent).refresh();\n  }\n\n  private _disposeOverlay(overlay: NoteOverlay | null) {\n    if (!overlay) return null;\n\n    overlay.dispose();\n    (\n      this.gfx.surfaceComponent as SurfaceBlockComponent\n    )?.renderer.removeOverlay(overlay);\n    return null;\n  }\n\n  // Should hide overlay when mouse is out of viewport or on menu and toolbar\n  private _hideOverlay() {\n    if (!this._noteOverlay) return;\n\n    this._noteOverlay.globalAlpha = 0;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.refresh();\n  }\n\n  private _resize(shift = false) {\n    const { _draggingNoteOverlay } = this;\n    if (!_draggingNoteOverlay) return;\n\n    const draggingArea = this.controller.draggingArea$.peek();\n    const { startX, startY } = draggingArea;\n    let { endX, endY } = this.controller.draggingArea$.peek();\n\n    if (shift) {\n      const w = Math.abs(endX - startX);\n      const h = Math.abs(endY - startY);\n      const m = Math.max(w, h);\n      endX = startX + (endX > startX ? m : -m);\n      endY = startY + (endY > startY ? m : -m);\n    }\n\n    _draggingNoteOverlay.slots.draggingNoteUpdated.emit({\n      xywh: [\n        Math.min(startX, endX),\n        Math.min(startY, endY),\n        Math.abs(startX - endX),\n        Math.abs(startY - endY),\n      ],\n    });\n  }\n\n  private _updateOverlayPosition(x: number, y: number) {\n    if (!this._noteOverlay) return;\n    this._noteOverlay.x = x;\n    this._noteOverlay.y = y;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent).refresh();\n  }\n\n  override activate() {\n    const attributes =\n      this.std.get(EditPropsStore).lastProps$.value['affine:note'];\n    const background = attributes.background;\n    this._noteOverlay = new NoteOverlay(this.gfx, background);\n    this._noteOverlay.text = this.activatedOption.tip;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent).renderer.addOverlay(\n      this._noteOverlay\n    );\n  }\n\n  override click(e: PointerEventState): void {\n    this._clearOverlay();\n\n    const { childFlavour, childType } = this.activatedOption;\n    const options = {\n      childFlavour,\n      childType,\n      collapse: false,\n    };\n    const point = new Point(e.point.x, e.point.y);\n    addNote(this.std, point, options);\n  }\n\n  override deactivate() {\n    this._clearOverlay();\n  }\n\n  override dragEnd() {\n    if (!this._draggingNoteOverlay) return;\n\n    const { x, y, width, height } = this._draggingNoteOverlay;\n\n    this._disposeOverlay(this._draggingNoteOverlay);\n\n    const { childFlavour, childType } = this.activatedOption;\n\n    const options = {\n      childFlavour,\n      childType,\n      collapse: true,\n    };\n\n    const [viewX, viewY] = this.gfx.viewport.toViewCoord(x, y);\n\n    const point = new Point(viewX, viewY);\n\n    this.doc.captureSync();\n\n    addNote(\n      this.std,\n      point,\n      options,\n      Math.max(width, DEFAULT_NOTE_WIDTH),\n      Math.max(height, DEFAULT_NOTE_HEIGHT)\n    );\n  }\n\n  override dragMove(e: PointerEventState) {\n    if (!this._draggingNoteOverlay) return;\n\n    this._resize(e.keys.shift || this.gfx.keyboard.shiftKey$.peek());\n  }\n\n  override dragStart() {\n    this._clearOverlay();\n\n    const attributes =\n      this.std.get(EditPropsStore).lastProps$.value['affine:note'];\n    const background = attributes.background;\n    this._draggingNoteOverlay = new DraggingNoteOverlay(this.gfx, background);\n    (this.gfx.surfaceComponent as SurfaceBlockComponent).renderer.addOverlay(\n      this._draggingNoteOverlay\n    );\n  }\n\n  override mounted() {\n    this.disposable.add(\n      effect(() => {\n        const shiftPressed = this.gfx.keyboard.shiftKey$.value;\n\n        if (!this._draggingNoteOverlay) {\n          return;\n        }\n\n        this._resize(shiftPressed);\n      })\n    );\n  }\n\n  override pointerMove(e: PointerEventState) {\n    if (!this._noteOverlay) return;\n\n    // if mouse is in viewport and move, update overlay pointion and show overlay\n    if (this._noteOverlay.globalAlpha === 0) this._noteOverlay.globalAlpha = 1;\n    const [x, y] = this.gfx.viewport.toModelCoord(e.x, e.y);\n    this._updateOverlayPosition(x, y);\n  }\n\n  override pointerOut(e: PointerEventState) {\n    // should not hide the overlay when pointer on the area of other notes\n    if (\n      e.raw.relatedTarget &&\n      hasClassNameInList(\n        e.raw.relatedTarget as Element,\n        EXCLUDING_MOUSE_OUT_CLASS_LIST\n      )\n    )\n      return;\n    this._hideOverlay();\n  }\n}\n\ndeclare module '@blocksuite/block-std/gfx' {\n  interface GfxToolsMap {\n    'affine:note': NoteTool;\n  }\n\n  interface GfxToolsOption {\n    'affine:note': NoteToolOption;\n  }\n}\n"]}