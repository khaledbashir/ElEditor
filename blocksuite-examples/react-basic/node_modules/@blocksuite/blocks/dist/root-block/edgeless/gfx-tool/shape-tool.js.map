{"version":3,"file":"shape-tool.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/gfx-tool/shape-tool.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ShapeElementModel, ShapeName } from '@blocksuite/affine-model';\nimport type { PointerEventState } from '@blocksuite/block-std';\nimport type { IBound } from '@blocksuite/global/utils';\n\nimport {\n  CanvasElementType,\n  type SurfaceBlockComponent,\n} from '@blocksuite/affine-block-surface';\nimport {\n  DEFAULT_SHAPE_FILL_COLOR,\n  DEFAULT_SHAPE_STROKE_COLOR,\n  getShapeType,\n} from '@blocksuite/affine-model';\nimport {\n  EditPropsStore,\n  TelemetryProvider,\n  ThemeProvider,\n} from '@blocksuite/affine-shared/services';\nimport { BaseTool } from '@blocksuite/block-std/gfx';\nimport { Bound } from '@blocksuite/global/utils';\nimport { effect } from '@preact/signals-core';\n\nimport { hasClassNameInList } from '../../../_common/utils/index.js';\nimport {\n  EXCLUDING_MOUSE_OUT_CLASS_LIST,\n  SHAPE_OVERLAY_HEIGHT,\n  SHAPE_OVERLAY_OPTIONS,\n  SHAPE_OVERLAY_WIDTH,\n} from '../utils/consts.js';\nimport { ShapeOverlay } from '../utils/tool-overlay.js';\n\nexport type ShapeToolOption = {\n  shapeName: ShapeName;\n};\n\nexport class ShapeTool extends BaseTool<ShapeToolOption> {\n  static override toolName: string = 'shape';\n\n  private _disableOverlay = false;\n\n  private _draggingElement: ShapeElementModel | null = null;\n\n  private _draggingElementId: string | null = null;\n\n  // shape overlay\n  private _shapeOverlay: ShapeOverlay | null = null;\n\n  private _spacePressedCtx: {\n    draggingArea: IBound & {\n      endX: number;\n      endY: number;\n      startX: number;\n      startY: number;\n    };\n  } | null = null;\n\n  private _addNewShape(\n    e: PointerEventState,\n    width: number,\n    height: number\n  ): string {\n    const { viewport } = this.gfx;\n    const { shapeName } = this.activatedOption;\n    const attributes =\n      this.std.get(EditPropsStore).lastProps$.value[`shape:${shapeName}`];\n\n    if (shapeName === 'roundedRect') {\n      width += 40;\n    }\n    // create a shape block when drag start\n    const [modelX, modelY] = viewport.toModelCoord(e.point.x, e.point.y);\n    const bound = new Bound(modelX, modelY, width, height);\n\n    const id = this.gfx.surface!.addElement({\n      type: CanvasElementType.SHAPE,\n      shapeType: getShapeType(shapeName),\n      xywh: bound.serialize(),\n      radius: attributes.radius,\n    });\n\n    this.std.getOptional(TelemetryProvider)?.track('CanvasElementAdded', {\n      control: 'canvas:draw',\n      page: 'whiteboard editor',\n      module: 'toolbar',\n      segment: 'toolbar',\n      type: CanvasElementType.SHAPE,\n      other: {\n        shapeName,\n      },\n    });\n\n    return id;\n  }\n\n  private _hideOverlay() {\n    if (!this._shapeOverlay) return;\n\n    this._shapeOverlay.globalAlpha = 0;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.refresh();\n  }\n\n  private _resize(shiftPressed = false, spacePressed = false) {\n    const { _draggingElement, _draggingElementId: id, controller } = this;\n    if (!id || !_draggingElement) return;\n\n    const draggingArea = this.controller.draggingArea$.peek();\n    const { startX, startY } = draggingArea;\n    let { endX, endY } = draggingArea;\n\n    if (shiftPressed) {\n      const w = Math.abs(endX - startX);\n      const h = Math.abs(endY - startY);\n      const m = Math.max(w, h);\n\n      endX = startX + (endX > startX ? m : -m);\n      endY = startY + (endY > startY ? m : -m);\n    }\n\n    if (spacePressed && this._spacePressedCtx) {\n      const {\n        startX,\n        startY,\n        w,\n        h,\n        endX: pressedX,\n        endY: pressedY,\n      } = this._spacePressedCtx.draggingArea;\n      const curDraggingArea = controller.draggingViewArea$.peek();\n      const { endX: lastX, endY: lastY } = curDraggingArea;\n      const dx = lastX - pressedX;\n      const dy = lastY - pressedY;\n\n      this.controller.draggingViewArea$.value = {\n        ...curDraggingArea,\n        x: Math.min(startX + dx, lastX),\n        y: Math.min(startY + dy, lastY),\n        w,\n        h,\n        startX: startX + dx,\n        startY: startY + dy,\n      };\n    }\n\n    const bound = new Bound(\n      Math.min(startX, endX),\n      Math.min(startY, endY),\n      Math.abs(startX - endX),\n      Math.abs(startY - endY)\n    );\n\n    this.gfx.updateElement(_draggingElement, {\n      xywh: bound.serialize(),\n    });\n  }\n\n  private _updateOverlayPosition(x: number, y: number) {\n    if (!this._shapeOverlay) return;\n    this._shapeOverlay.x = x;\n    this._shapeOverlay.y = y;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.refresh();\n  }\n\n  override activate() {\n    this.createOverlay();\n  }\n\n  clearOverlay() {\n    if (!this._shapeOverlay) return;\n\n    this._shapeOverlay.dispose();\n    (\n      this.gfx.surfaceComponent as SurfaceBlockComponent\n    )?.renderer.removeOverlay(this._shapeOverlay);\n    this._shapeOverlay = null;\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.renderer.refresh();\n  }\n\n  override click(e: PointerEventState): void {\n    this.clearOverlay();\n    if (this._disableOverlay) return;\n\n    this.doc.captureSync();\n\n    const id = this._addNewShape(e, SHAPE_OVERLAY_WIDTH, SHAPE_OVERLAY_HEIGHT);\n\n    const element = this.gfx.getElementById(id);\n    if (!element) return;\n\n    this.gfx.tool.setTool('default');\n    this.gfx.selection.set({\n      elements: [element.id],\n      editing: false,\n    });\n  }\n\n  createOverlay() {\n    this.clearOverlay();\n    if (this._disableOverlay) return;\n    const options = SHAPE_OVERLAY_OPTIONS;\n    const { shapeName } = this.activatedOption;\n    const attributes =\n      this.std.get(EditPropsStore).lastProps$.value[`shape:${shapeName}`];\n\n    options.stroke = this.std\n      .get(ThemeProvider)\n      .getColorValue(attributes.strokeColor, DEFAULT_SHAPE_STROKE_COLOR, true);\n    options.fill = this.std\n      .get(ThemeProvider)\n      .getColorValue(attributes.fillColor, DEFAULT_SHAPE_FILL_COLOR, true);\n\n    switch (attributes.strokeStyle!) {\n      case 'dash':\n        options.strokeLineDash = [12, 12];\n        break;\n      case 'none':\n        options.strokeLineDash = [];\n        options.stroke = 'transparent';\n        break;\n      default:\n        options.strokeLineDash = [];\n    }\n    this._shapeOverlay = new ShapeOverlay(this.gfx, shapeName, options, {\n      shapeStyle: attributes.shapeStyle,\n      fillColor: attributes.fillColor,\n      strokeColor: attributes.strokeColor,\n    });\n    (this.gfx.surfaceComponent as SurfaceBlockComponent)?.renderer.addOverlay(\n      this._shapeOverlay\n    );\n  }\n\n  override deactivate() {\n    this.clearOverlay();\n  }\n\n  override dragEnd() {\n    if (this._disableOverlay) return;\n    if (this._draggingElement) {\n      const draggingElement = this._draggingElement;\n\n      draggingElement.pop('xywh');\n    }\n\n    const id = this._draggingElementId;\n    if (!id) return;\n    const draggingArea = this.controller.draggingArea$.peek();\n\n    if (draggingArea.w < 20 && draggingArea.h < 20) {\n      this.gfx.deleteElement(id);\n      return;\n    }\n\n    this._draggingElement = null;\n    this._draggingElementId = null;\n\n    this.doc.captureSync();\n\n    const element = this.gfx.getElementById(id);\n    if (!element) return;\n\n    this.controller.setTool('default');\n    this.gfx.selection.set({\n      elements: [element.id],\n    });\n  }\n\n  override dragMove(e: PointerEventState) {\n    if (this._disableOverlay || !this._draggingElementId) return;\n\n    this._resize(\n      e.keys.shift || this.gfx.keyboard.shiftKey$.peek(),\n      this.gfx.keyboard.spaceKey$.peek()\n    );\n  }\n\n  override dragStart(e: PointerEventState) {\n    if (this._disableOverlay) return;\n    this.clearOverlay();\n\n    this.doc.captureSync();\n\n    const id = this._addNewShape(e, 0, 0);\n\n    this._spacePressedCtx = null;\n    this._draggingElementId = id;\n    this._draggingElement = this.gfx.getElementById(id) as ShapeElementModel;\n    this._draggingElement.stash('xywh');\n  }\n\n  override mounted() {\n    this.disposable.add(\n      effect(() => {\n        const pressed = this.gfx.keyboard.shiftKey$.value;\n        if (!this._draggingElementId || !this.activate) {\n          return;\n        }\n\n        this._resize(pressed);\n      })\n    );\n\n    this.disposable.add(\n      effect(() => {\n        const spacePressed = this.gfx.keyboard.spaceKey$.value;\n\n        if (spacePressed && this._draggingElementId) {\n          this._spacePressedCtx = {\n            draggingArea: this.controller.draggingViewArea$.peek(),\n          };\n        }\n      })\n    );\n  }\n\n  override pointerMove(e: PointerEventState) {\n    if (!this._shapeOverlay) return;\n    // shape options, like stroke color, fill color, etc.\n    if (this._shapeOverlay.globalAlpha === 0)\n      this._shapeOverlay.globalAlpha = 1;\n    const [x, y] = this.gfx.viewport.toModelCoord(e.x, e.y);\n    this._updateOverlayPosition(x, y);\n  }\n\n  override pointerOut(e: PointerEventState) {\n    if (\n      e.raw.relatedTarget &&\n      hasClassNameInList(\n        e.raw.relatedTarget as Element,\n        EXCLUDING_MOUSE_OUT_CLASS_LIST\n      )\n    )\n      return;\n    this._hideOverlay();\n  }\n\n  setDisableOverlay(disable: boolean) {\n    this._disableOverlay = disable;\n  }\n}\n\ndeclare module '@blocksuite/block-std/gfx' {\n  interface GfxToolsMap {\n    shape: ShapeTool;\n  }\n\n  interface GfxToolsOption {\n    shape: ShapeToolOption;\n  }\n}\n"]}