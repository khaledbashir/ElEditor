{"version":3,"file":"frame-tool.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/gfx-tool/frame-tool.ts"],"names":[],"mappings":"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","sourcesContent":["import type { FrameBlockModel } from '@blocksuite/affine-model';\nimport type { PointerEventState } from '@blocksuite/block-std';\nimport type { IPoint, IVec } from '@blocksuite/global/utils';\n\nimport { OverlayIdentifier } from '@blocksuite/affine-block-surface';\nimport { TelemetryProvider } from '@blocksuite/affine-shared/services';\nimport {\n  BaseTool,\n  getTopElements,\n  GfxExtensionIdentifier,\n} from '@blocksuite/block-std/gfx';\nimport { Bound, Vec } from '@blocksuite/global/utils';\nimport { DocCollection, Text } from '@blocksuite/store';\n\nimport type { EdgelessFrameManager, FrameOverlay } from '../frame-manager.js';\n\nexport class FrameTool extends BaseTool {\n  static override toolName = 'frame';\n\n  private _frame: FrameBlockModel | null = null;\n\n  private _startPoint: IVec | null = null;\n\n  get frameManager() {\n    return this.std.get(\n      GfxExtensionIdentifier('frame-manager')\n    ) as EdgelessFrameManager;\n  }\n\n  get frameOverlay() {\n    return this.std.get(OverlayIdentifier('frame')) as FrameOverlay;\n  }\n\n  private _toModelCoord(p: IPoint): IVec {\n    return this.gfx.viewport.toModelCoord(p.x, p.y);\n  }\n\n  override dragEnd(): void {\n    if (this._frame) {\n      const frame = this._frame;\n      this.doc.transact(() => {\n        frame.pop('xywh');\n      });\n      this.gfx.tool.setTool('default');\n      this.gfx.selection.set({\n        elements: [frame.id],\n        editing: false,\n      });\n\n      this.frameManager.addElementsToFrame(\n        frame,\n        getTopElements(this.frameManager.getElementsInFrameBound(frame))\n      );\n\n      this.doc.captureSync();\n    }\n\n    this._frame = null;\n    this._startPoint = null;\n    this.frameOverlay.clear();\n  }\n\n  override dragMove(e: PointerEventState): void {\n    if (!this._startPoint) return;\n\n    const currentPoint = this._toModelCoord(e.point);\n    if (Vec.dist(this._startPoint, currentPoint) < 8 && !this._frame) return;\n\n    if (!this._frame) {\n      const frames = this.gfx.layer.blocks.filter(\n        block => block.flavour === 'affine:frame'\n      ) as FrameBlockModel[];\n      const id = this.doc.addBlock(\n        'affine:frame',\n        {\n          title: new Text(\n            new DocCollection.Y.Text(`Frame ${frames.length + 1}`)\n          ),\n          xywh: Bound.fromPoints([this._startPoint, currentPoint]).serialize(),\n          index: this.gfx.layer.generateIndex(true),\n          presentationIndex: this.frameManager.generatePresentationIndex(),\n        },\n        this.gfx.surface\n      );\n\n      this.std.getOptional(TelemetryProvider)?.track('CanvasElementAdded', {\n        control: 'canvas:draw',\n        page: 'whiteboard editor',\n        module: 'toolbar',\n        segment: 'toolbar',\n        type: 'frame',\n      });\n      this._frame = this.gfx.getElementById(id) as FrameBlockModel;\n      this._frame.stash('xywh');\n      return;\n    }\n\n    this.gfx.doc.updateBlock(this._frame, {\n      xywh: Bound.fromPoints([this._startPoint, currentPoint]).serialize(),\n    });\n\n    this.frameOverlay.highlight(this._frame, true);\n  }\n\n  override dragStart(e: PointerEventState): void {\n    this.doc.captureSync();\n    const { point } = e;\n    this._startPoint = this._toModelCoord(point);\n  }\n}\n\ndeclare module '@blocksuite/block-std/gfx' {\n  interface GfxToolsMap {\n    frame: FrameTool;\n  }\n}\n"]}