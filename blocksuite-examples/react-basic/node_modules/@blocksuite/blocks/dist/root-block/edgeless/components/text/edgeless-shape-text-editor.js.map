{"version":3,"file":"edgeless-shape-text-editor.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/text/edgeless-shape-text-editor.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RichText } from '@blocksuite/affine-components/rich-text';\nimport type { ShapeElementModel } from '@blocksuite/affine-model';\n\nimport { CommonUtils, TextUtils } from '@blocksuite/affine-block-surface';\nimport { MindmapElementModel, TextResizing } from '@blocksuite/affine-model';\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport {\n  RANGE_SYNC_EXCLUDE_ATTR,\n  ShadowlessElement,\n} from '@blocksuite/block-std';\nimport {\n  assertExists,\n  Bound,\n  Vec,\n  WithDisposable,\n} from '@blocksuite/global/utils';\nimport { DocCollection } from '@blocksuite/store';\nimport { html, nothing } from 'lit';\nimport { property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\nimport { getSelectedRect } from '../../utils/query.js';\n\nconst { toRadian } = CommonUtils;\n\nexport class EdgelessShapeTextEditor extends WithDisposable(ShadowlessElement) {\n  private _keeping = false;\n\n  private _lastXYWH = '';\n\n  private _resizeObserver: ResizeObserver | null = null;\n\n  get inlineEditor() {\n    assertExists(this.richText.inlineEditor);\n    return this.richText.inlineEditor;\n  }\n\n  get inlineEditorContainer() {\n    return this.inlineEditor.rootElement;\n  }\n\n  get isMindMapNode() {\n    return this.element.group instanceof MindmapElementModel;\n  }\n\n  private _initMindmapKeyBindings() {\n    if (!this.isMindMapNode) {\n      return;\n    }\n\n    const service = this.edgeless.service;\n\n    this._disposables.addFromEvent(this, 'keydown', evt => {\n      switch (evt.key) {\n        case 'Enter': {\n          evt.stopPropagation();\n          if (evt.shiftKey || evt.isComposing) return;\n\n          (this.ownerDocument.activeElement as HTMLElement).blur();\n          service.selection.set({\n            elements: [this.element.id],\n            editing: false,\n          });\n          break;\n        }\n        case 'Esc':\n        case 'Tab': {\n          evt.stopPropagation();\n          (this.ownerDocument.activeElement as HTMLElement).blur();\n          service.selection.set({\n            elements: [this.element.id],\n            editing: false,\n          });\n          break;\n        }\n      }\n    });\n  }\n\n  private _stashMindMapTree() {\n    if (!this.isMindMapNode) {\n      return;\n    }\n\n    const mindmap = this.element.group as MindmapElementModel;\n    const pop = mindmap.stashTree(mindmap.tree);\n\n    this._disposables.add(() => {\n      mindmap.layout();\n      pop?.();\n    });\n  }\n\n  private _unmount() {\n    this._resizeObserver?.disconnect();\n    this._resizeObserver = null;\n\n    if (this.element.text) {\n      const text = this.element.text.toString();\n      const trimed = text.trim();\n      const len = trimed.length;\n      if (len === 0) {\n        this.element.text = undefined;\n      } else if (len < text.length) {\n        this.element.text = new DocCollection.Y.Text(trimed);\n      }\n    }\n\n    this.element.textDisplay = true;\n\n    this.remove();\n    this.edgeless.service.selection.set({\n      elements: [],\n      editing: false,\n    });\n  }\n\n  private _updateElementWH() {\n    const bcr = this.richText.getBoundingClientRect();\n    const containerHeight = this.richText.offsetHeight;\n    const containerWidth = this.richText.offsetWidth;\n    const textResizing = this.element.textResizing;\n\n    if (\n      (containerHeight !== this.element.h &&\n        textResizing === TextResizing.AUTO_HEIGHT) ||\n      (textResizing === TextResizing.AUTO_WIDTH_AND_HEIGHT &&\n        (containerWidth !== this.element.w ||\n          containerHeight !== this.element.h))\n    ) {\n      const [leftTopX, leftTopY] = Vec.rotWith(\n        [this.richText.offsetLeft, this.richText.offsetTop],\n        [bcr.left + bcr.width / 2, bcr.top + bcr.height / 2],\n        toRadian(-this.element.rotate)\n      );\n\n      const [modelLeftTopX, modelLeftTopY] =\n        this.edgeless.service.viewport.toModelCoord(leftTopX, leftTopY);\n\n      this.edgeless.service.updateElement(this.element.id, {\n        xywh: new Bound(\n          modelLeftTopX,\n          modelLeftTopY,\n          textResizing === TextResizing.AUTO_WIDTH_AND_HEIGHT\n            ? containerWidth\n            : this.element.w,\n          containerHeight\n        ).serialize(),\n      });\n\n      if (this._lastXYWH !== this.element.xywh) {\n        this.requestUpdate();\n      }\n\n      if (this.isMindMapNode) {\n        const mindmap = this.element.group as MindmapElementModel;\n\n        mindmap.layout();\n      }\n\n      this.richText.style.minHeight = `${containerHeight}px`;\n    }\n\n    this.edgeless.service.selection.set({\n      elements: [this.element.id],\n      editing: true,\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override firstUpdated(): void {\n    const dispatcher = this.edgeless.dispatcher;\n    assertExists(dispatcher);\n\n    this.element.textDisplay = false;\n\n    this.disposables.add(\n      this.edgeless.service.viewport.viewportUpdated.on(() => {\n        this.requestUpdate();\n        this.updateComplete\n          .then(() => {\n            this._updateElementWH();\n          })\n          .catch(console.error);\n      })\n    );\n    this.disposables.add(\n      dispatcher.add('click', () => {\n        return true;\n      })\n    );\n    this.disposables.add(\n      dispatcher.add('doubleClick', () => {\n        return true;\n      })\n    );\n\n    this.updateComplete\n      .then(() => {\n        if (this.element.group instanceof MindmapElementModel) {\n          this.inlineEditor.selectAll();\n        } else {\n          this.inlineEditor.focusEnd();\n        }\n\n        this.disposables.add(\n          this.inlineEditor.slots.renderComplete.on(() => {\n            this._updateElementWH();\n          })\n        );\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'blur',\n          () => {\n            if (this._keeping) return;\n            this._unmount();\n          }\n        );\n      })\n      .catch(console.error);\n\n    this.disposables.addFromEvent(this, 'keydown', evt => {\n      if (evt.key === 'Escape') {\n        requestAnimationFrame(() => {\n          this.edgeless.service.selection.set({\n            elements: [this.element.id],\n            editing: false,\n          });\n        });\n\n        (this.ownerDocument.activeElement as HTMLElement).blur();\n      }\n    });\n\n    this._initMindmapKeyBindings();\n    this._stashMindMapTree();\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await this.richText?.updateComplete;\n    return result;\n  }\n\n  override render() {\n    if (!this.element.text) {\n      console.error('Failed to mount shape editor because of no text.');\n      return nothing;\n    }\n\n    const [verticalPadding, horiPadding] = this.element.padding;\n    const textResizing = this.element.textResizing;\n    const viewport = this.edgeless.service.viewport;\n    const zoom = viewport.zoom;\n    const rect = getSelectedRect([this.element]);\n    const rotate = this.element.rotate;\n    const [leftTopX, leftTopY] = Vec.rotWith(\n      [rect.left, rect.top],\n      [rect.left + rect.width / 2, rect.top + rect.height / 2],\n      toRadian(rotate)\n    );\n    const [x, y] = this.edgeless.service.viewport.toViewCoord(\n      leftTopX,\n      leftTopY\n    );\n    const autoWidth = textResizing === TextResizing.AUTO_WIDTH_AND_HEIGHT;\n    const color = this.edgeless.std\n      .get(ThemeProvider)\n      .generateColorProperty(this.element.color, '#000000');\n\n    const inlineEditorStyle = styleMap({\n      position: 'absolute',\n      left: x + 'px',\n      top: y + 'px',\n      width:\n        textResizing === TextResizing.AUTO_HEIGHT\n          ? rect.width + 'px'\n          : 'fit-content',\n      // override rich-text style (height: 100%)\n      height: 'initial',\n      minHeight:\n        textResizing === TextResizing.AUTO_WIDTH_AND_HEIGHT\n          ? '1em'\n          : `${rect.height}px`,\n      maxWidth:\n        textResizing === TextResizing.AUTO_WIDTH_AND_HEIGHT\n          ? this.element.maxWidth\n            ? `${this.element.maxWidth}px`\n            : undefined\n          : undefined,\n      boxSizing: 'border-box',\n      fontSize: this.element.fontSize + 'px',\n      fontFamily: TextUtils.wrapFontFamily(this.element.fontFamily),\n      fontWeight: this.element.fontWeight,\n      lineHeight: 'normal',\n      outline: 'none',\n      transform: `scale(${zoom}, ${zoom}) rotate(${rotate}deg)`,\n      transformOrigin: 'top left',\n      color,\n      padding: `${verticalPadding}px ${horiPadding}px`,\n      textAlign: this.element.textAlign,\n      display: 'grid',\n      gridTemplateColumns: '100%',\n      alignItems:\n        this.element.textVerticalAlign === 'center'\n          ? 'center'\n          : this.element.textVerticalAlign === 'bottom'\n            ? 'end'\n            : 'start',\n      alignContent: 'center',\n      gap: '0',\n      zIndex: '1',\n    });\n\n    this._lastXYWH = this.element.xywh;\n\n    return html` <style>\n        edgeless-shape-text-editor v-text [data-v-text] {\n          overflow-wrap: ${autoWidth ? 'normal' : 'anywhere'};\n          word-break: ${autoWidth ? 'normal' : 'break-word'} !important;\n          white-space: ${autoWidth ? 'pre' : 'pre-wrap'} !important;\n        }\n\n        edgeless-shape-text-editor .inline-editor {\n          min-width: 1px;\n        }\n      </style>\n      <rich-text\n        .yText=${this.element.text}\n        .enableFormat=${false}\n        .enableAutoScrollHorizontally=${false}\n        style=${inlineEditorStyle}\n      ></rich-text>`;\n  }\n\n  setKeeping(keeping: boolean) {\n    this._keeping = keeping;\n  }\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  @property({ attribute: false })\n  accessor element!: ShapeElementModel;\n\n  @property({ attribute: false })\n  accessor mountEditor:\n    | ((\n        element: ShapeElementModel,\n        edgeless: EdgelessRootBlockComponent\n      ) => void)\n    | undefined = undefined;\n\n  @query('rich-text')\n  accessor richText!: RichText;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-shape-text-editor': EdgelessShapeTextEditor;\n  }\n}\n"]}