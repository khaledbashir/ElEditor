{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/keyboard-toolbar/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RootBlockModel } from '@blocksuite/affine-model';\n\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport { IS_MOBILE } from '@blocksuite/global/env';\nimport { assertType } from '@blocksuite/global/utils';\nimport { signal } from '@preact/signals-core';\nimport { html, nothing } from 'lit';\n\nimport type { PageRootBlockComponent } from '../../page/page-root-block.js';\n\nimport { defaultKeyboardToolbarConfig } from './config.js';\n\nexport * from './config.js';\n\nexport const AFFINE_KEYBOARD_TOOLBAR_WIDGET = 'affine-keyboard-toolbar-widget';\n\nexport class AffineKeyboardToolbarWidget extends WidgetComponent<\n  RootBlockModel,\n  PageRootBlockComponent\n> {\n  private _close = (blur: boolean) => {\n    if (blur) {\n      if (document.activeElement === this._docTitle) {\n        this._docTitle?.blur();\n      } else if (document.activeElement === this.block.rootComponent) {\n        this.block.rootComponent?.blur();\n      }\n    }\n    this._show$.value = false;\n  };\n\n  private readonly _show$ = signal(false);\n\n  private get _docTitle(): HTMLDivElement | null {\n    const docTitle = this.std.host\n      .closest('.affine-page-viewport')\n      ?.querySelector('doc-title rich-text .inline-editor');\n    assertType<HTMLDivElement | null>(docTitle);\n    return docTitle;\n  }\n\n  get config() {\n    return {\n      ...defaultKeyboardToolbarConfig,\n      ...this.std.getConfig('affine:page')?.keyboardToolbar,\n    };\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const { rootComponent } = this.block;\n    if (rootComponent) {\n      this.disposables.addFromEvent(rootComponent, 'focus', () => {\n        this._show$.value = true;\n      });\n      this.disposables.addFromEvent(rootComponent, 'blur', () => {\n        this._show$.value = false;\n      });\n    }\n\n    if (this._docTitle) {\n      this.disposables.addFromEvent(this._docTitle, 'focus', () => {\n        this._show$.value = true;\n      });\n      this.disposables.addFromEvent(this._docTitle, 'blur', () => {\n        this._show$.value = false;\n      });\n    }\n  }\n\n  override render() {\n    if (\n      this.doc.readonly ||\n      !IS_MOBILE ||\n      !this.doc.awarenessStore.getFlag('enable_mobile_keyboard_toolbar')\n    )\n      return nothing;\n\n    if (!this._show$.value) return nothing;\n\n    if (!this.block.rootComponent) return nothing;\n\n    return html`<blocksuite-portal\n      .shadowDom=${false}\n      .template=${html`<affine-keyboard-toolbar\n        .config=${this.config}\n        .rootComponent=${this.block.rootComponent}\n        .close=${this._close}\n      ></affine-keyboard-toolbar> `}\n    ></blocksuite-portal>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_KEYBOARD_TOOLBAR_WIDGET]: AffineKeyboardToolbarWidget;\n  }\n}\n"]}