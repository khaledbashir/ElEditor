{"version":3,"file":"keyboard-toolbar.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/keyboard-toolbar/keyboard-toolbar.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  VirtualKeyboardController,\n  type VirtualKeyboardControllerConfig,\n} from '@blocksuite/affine-components/virtual-keyboard';\nimport {\n  PropTypes,\n  requiredProperties,\n  ShadowlessElement,\n} from '@blocksuite/block-std';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { ArrowLeftBigIcon, KeyboardIcon } from '@blocksuite/icons/lit';\nimport { effect, signal } from '@preact/signals-core';\nimport { html } from 'lit';\nimport { property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { when } from 'lit/directives/when.js';\n\nimport type {\n  KeyboardIconType,\n  KeyboardToolbarConfig,\n  KeyboardToolbarContext,\n  KeyboardToolbarItem,\n  KeyboardToolPanelConfig,\n} from './config.js';\n\nimport { PageRootBlockComponent } from '../../page/page-root-block.js';\nimport { keyboardToolbarStyles, TOOLBAR_HEIGHT } from './styles.js';\nimport {\n  isKeyboardSubToolBarConfig,\n  isKeyboardToolBarActionItem,\n  isKeyboardToolPanelConfig,\n} from './utils.js';\n\nexport const AFFINE_KEYBOARD_TOOLBAR = 'affine-keyboard-toolbar';\n\n@requiredProperties({\n  config: PropTypes.object,\n  rootComponent: PropTypes.instanceOf(PageRootBlockComponent),\n})\nexport class AffineKeyboardToolbar extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = keyboardToolbarStyles;\n\n  private readonly _closeToolPanel = () => {\n    if (!this._isPanelOpened) return;\n\n    this._currentPanelIndex$.value = -1;\n    this._keyboardController.show();\n  };\n\n  private readonly _currentPanelIndex$ = signal(-1);\n\n  private readonly _goPrevToolbar = () => {\n    if (!this._isSubToolbarOpened) return;\n\n    if (this._isPanelOpened) this._closeToolPanel();\n\n    this._path$.value = this._path$.value.slice(0, -1);\n  };\n\n  private readonly _handleItemClick = (\n    item: KeyboardToolbarItem,\n    index: number\n  ) => {\n    if (isKeyboardToolBarActionItem(item)) {\n      item.action &&\n        Promise.resolve(item.action(this._context)).catch(console.error);\n    } else if (isKeyboardSubToolBarConfig(item)) {\n      this._closeToolPanel();\n      this._path$.value = [...this._path$.value, index];\n    } else if (isKeyboardToolPanelConfig(item)) {\n      if (this._currentPanelIndex$.value === index) {\n        this._closeToolPanel();\n      } else {\n        this._currentPanelIndex$.value = index;\n        this._keyboardController.hide();\n        this.scrollCurrentBlockIntoView();\n      }\n    }\n    this._lastActiveItem$.value = item;\n  };\n\n  private readonly _keyboardController = new VirtualKeyboardController(this);\n\n  private readonly _lastActiveItem$ = signal<KeyboardToolbarItem | null>(null);\n\n  /** This field records the panel static height, which dose not aim to control the panel opening */\n  private readonly _panelHeight$ = signal(0);\n\n  private readonly _path$ = signal<number[]>([]);\n\n  private scrollCurrentBlockIntoView = () => {\n    const { std } = this.rootComponent;\n    std.command\n      .chain()\n      .getSelectedModels()\n      .inline(({ selectedModels }) => {\n        if (!selectedModels?.length) return;\n\n        const block = std.view.getBlock(selectedModels[0].id);\n        if (!block) return;\n\n        const { y: y1 } = this.getBoundingClientRect();\n        const { bottom: y2 } = block.getBoundingClientRect();\n        const gap = 8;\n\n        if (y2 < y1 + gap) return;\n\n        scrollTo({\n          top: window.scrollY + y2 - y1 + gap,\n          behavior: 'instant',\n        });\n      })\n      .run();\n  };\n\n  private get _context(): KeyboardToolbarContext {\n    return {\n      std: this.rootComponent.std,\n      rootComponent: this.rootComponent,\n      closeToolbar: (blur = false) => {\n        this.close(blur);\n      },\n      closeToolPanel: () => {\n        this._closeToolPanel();\n      },\n    };\n  }\n\n  private get _currentPanelConfig(): KeyboardToolPanelConfig | null {\n    if (!this._isPanelOpened) return null;\n\n    const result = this._currentToolbarItems[this._currentPanelIndex$.value];\n\n    return isKeyboardToolPanelConfig(result) ? result : null;\n  }\n\n  private get _currentToolbarItems(): KeyboardToolbarItem[] {\n    let items = this.config.items;\n    for (let i = 0; i < this._path$.value.length; i++) {\n      const index = this._path$.value[i];\n      if (isKeyboardSubToolBarConfig(items[index])) {\n        items = items[index].items;\n      } else {\n        break;\n      }\n    }\n\n    return items.filter(item =>\n      isKeyboardToolBarActionItem(item)\n        ? (item.showWhen?.(this._context) ?? true)\n        : true\n    );\n  }\n\n  private get _isPanelOpened() {\n    return this._currentPanelIndex$.value !== -1;\n  }\n\n  private get _isSubToolbarOpened() {\n    return this._path$.value.length > 0;\n  }\n\n  get virtualKeyboardControllerConfig(): VirtualKeyboardControllerConfig {\n    return {\n      useScreenHeight: this.config.useScreenHeight ?? false,\n      inputElement: this.rootComponent,\n    };\n  }\n\n  private _renderIcon(icon: KeyboardIconType) {\n    return typeof icon === 'function' ? icon(this._context) : icon;\n  }\n\n  private _renderItem(item: KeyboardToolbarItem, index: number) {\n    let icon = item.icon;\n    let style = styleMap({});\n    const disabled =\n      ('disableWhen' in item && item.disableWhen?.(this._context)) ?? false;\n\n    if (isKeyboardToolBarActionItem(item)) {\n      const background =\n        typeof item.background === 'function'\n          ? item.background(this._context)\n          : item.background;\n      if (background)\n        style = styleMap({\n          background: background,\n        });\n    } else if (isKeyboardToolPanelConfig(item)) {\n      const { activeIcon, activeBackground } = item;\n      const active = this._currentPanelIndex$.value === index;\n\n      if (active && activeIcon) icon = activeIcon;\n      if (active && activeBackground)\n        style = styleMap({ background: activeBackground });\n    }\n\n    return html`<icon-button\n      size=\"36px\"\n      style=${style}\n      ?disabled=${disabled}\n      @click=${() => {\n        this._handleItemClick(item, index);\n      }}\n    >\n      ${this._renderIcon(icon)}\n    </icon-button>`;\n  }\n\n  private _renderItems() {\n    if (document.activeElement !== this.rootComponent)\n      return html`<div class=\"item-container\"></div>`;\n\n    const goPrevToolbarAction = when(\n      this._isSubToolbarOpened,\n      () =>\n        html`<icon-button size=\"36px\" @click=${this._goPrevToolbar}>\n          ${ArrowLeftBigIcon()}\n        </icon-button>`\n    );\n\n    return html`<div class=\"item-container\">\n      ${goPrevToolbarAction}\n      ${repeat(this._currentToolbarItems, (item, index) =>\n        this._renderItem(item, index)\n      )}\n    </div>`;\n  }\n\n  private _renderKeyboardButton() {\n    return html`<div class=\"keyboard-container\">\n      <icon-button\n        size=\"36px\"\n        @click=${() => {\n          this.close(true);\n        }}\n      >\n        ${KeyboardIcon()}\n      </icon-button>\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    // prevent editor blur when click item in toolbar\n    this.disposables.addFromEvent(this, 'pointerdown', e => {\n      e.preventDefault();\n    });\n\n    this.disposables.add(\n      effect(() => {\n        if (this._keyboardController.opened) {\n          this._panelHeight$.value = this._keyboardController.keyboardHeight;\n        } else if (this._isPanelOpened && this._panelHeight$.peek() === 0) {\n          this._panelHeight$.value = 260;\n        }\n      })\n    );\n\n    this.disposables.add(\n      effect(() => {\n        if (this._keyboardController.opened && !this.config.useScreenHeight) {\n          document.body.style.paddingBottom = `${this._keyboardController.keyboardHeight + TOOLBAR_HEIGHT}px`;\n        } else if (this._isPanelOpened) {\n          document.body.style.paddingBottom = `${this._panelHeight$.value + TOOLBAR_HEIGHT}px`;\n        } else {\n          document.body.style.paddingBottom = '';\n        }\n      })\n    );\n\n    this.disposables.add(\n      effect(() => {\n        const std = this.rootComponent.std;\n        std.selection.value;\n        // wait cursor updated\n        requestAnimationFrame(() => {\n          this.scrollCurrentBlockIntoView();\n        });\n      })\n    );\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    document.body.style.paddingBottom = '';\n  }\n\n  override firstUpdated() {\n    // workaround for the virtual keyboard showing transition animation\n    setTimeout(() => {\n      this.scrollCurrentBlockIntoView();\n    }, 700);\n  }\n\n  override render() {\n    this.style.bottom =\n      this.config.useScreenHeight && this._keyboardController.opened\n        ? `${-this._panelHeight$.value}px`\n        : '0px';\n\n    return html`\n      <div class=\"keyboard-toolbar\">\n        ${this._renderItems()}\n        <div class=\"divider\"></div>\n        ${this._renderKeyboardButton()}\n      </div>\n      <affine-keyboard-tool-panel\n        .config=${this._currentPanelConfig}\n        .context=${this._context}\n        height=${this._panelHeight$.value}\n      ></affine-keyboard-tool-panel>\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor close: (blur: boolean) => void = () => {};\n\n  @property({ attribute: false })\n  accessor config!: KeyboardToolbarConfig;\n\n  @property({ attribute: false })\n  accessor rootComponent!: PageRootBlockComponent;\n}\n"]}