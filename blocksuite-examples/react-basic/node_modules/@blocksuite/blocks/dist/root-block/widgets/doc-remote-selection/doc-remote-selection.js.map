{"version":3,"file":"doc-remote-selection.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/doc-remote-selection/doc-remote-selection.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UserInfo } from '@blocksuite/store';\n\nimport { matchFlavours } from '@blocksuite/affine-shared/utils';\nimport {\n  type BaseSelection,\n  BlockSelection,\n  TextSelection,\n} from '@blocksuite/block-std';\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { computed } from '@preact/signals-core';\nimport { css, html, nothing } from 'lit';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { DocRemoteSelectionConfig } from './config.js';\n\nimport { RemoteColorManager } from '../../../root-block/remote-color-manager/remote-color-manager.js';\nimport { cursorStyle, selectionStyle } from './utils.js';\n\nexport interface SelectionRect {\n  width: number;\n  height: number;\n  top: number;\n  left: number;\n  transparent?: boolean;\n}\n\nexport const AFFINE_DOC_REMOTE_SELECTION_WIDGET =\n  'affine-doc-remote-selection-widget';\n\nexport class AffineDocRemoteSelectionWidget extends WidgetComponent {\n  // avoid being unable to select text by mouse click or drag\n  static override styles = css`\n    :host {\n      pointer-events: none;\n    }\n  `;\n\n  private _abortController = new AbortController();\n\n  private _remoteColorManager: RemoteColorManager | null = null;\n\n  private _remoteSelections = computed(() => {\n    const status = this.doc.awarenessStore.getStates();\n    return [...this.std.selection.remoteSelections.entries()].map(\n      ([id, selections]) => {\n        return {\n          id,\n          selections,\n          user: status.get(id)?.user,\n        };\n      }\n    );\n  });\n\n  private _resizeObserver: ResizeObserver = new ResizeObserver(() => {\n    this.requestUpdate();\n  });\n\n  private get _config(): DocRemoteSelectionConfig {\n    const config =\n      this.std.getConfig('affine:page')?.docRemoteSelectionWidget ?? {};\n\n    return {\n      blockSelectionBackgroundTransparent: block => {\n        return (\n          matchFlavours(block, [\n            'affine:code',\n            'affine:database',\n            'affine:image',\n            'affine:attachment',\n            'affine:bookmark',\n            'affine:surface-ref',\n          ]) || /affine:embed-*/.test(block.flavour)\n        );\n      },\n      ...config,\n    };\n  }\n\n  private get _container() {\n    return this.offsetParent;\n  }\n\n  private get _containerRect() {\n    return this.offsetParent?.getBoundingClientRect();\n  }\n\n  private get _selectionManager() {\n    return this.host.selection;\n  }\n\n  private _getCursorRect(selections: BaseSelection[]): SelectionRect | null {\n    if (this.block.model.flavour !== 'affine:page') {\n      console.error('remote selection widget must be used in page component');\n      return null;\n    }\n\n    const textSelection = selections.find(\n      selection => selection instanceof TextSelection\n    ) as TextSelection | undefined;\n    const blockSelections = selections.filter(\n      selection => selection instanceof BlockSelection\n    );\n    const container = this._container;\n    const containerRect = this._containerRect;\n\n    if (textSelection) {\n      const range = this.std.range.textSelectionToRange(\n        this._selectionManager.create('text', {\n          from: {\n            blockId: textSelection.to\n              ? textSelection.to.blockId\n              : textSelection.from.blockId,\n            index: textSelection.to\n              ? textSelection.to.index + textSelection.to.length\n              : textSelection.from.index + textSelection.from.length,\n            length: 0,\n          },\n          to: null,\n        })\n      );\n\n      if (!range) {\n        return null;\n      }\n\n      const container = this._container;\n      const containerRect = this._containerRect;\n      const rangeRects = Array.from(range.getClientRects());\n      if (rangeRects.length > 0) {\n        const rect =\n          rangeRects.length === 1\n            ? rangeRects[0]\n            : rangeRects[rangeRects.length - 1];\n        return {\n          width: 2,\n          height: rect.height,\n          top:\n            rect.top - (containerRect?.top ?? 0) + (container?.scrollTop ?? 0),\n          left:\n            rect.left -\n            (containerRect?.left ?? 0) +\n            (container?.scrollLeft ?? 0),\n        };\n      }\n    } else if (blockSelections.length > 0) {\n      const lastBlockSelection = blockSelections[blockSelections.length - 1];\n\n      const block = this.host.view.getBlock(lastBlockSelection.blockId);\n      if (block) {\n        const rect = block.getBoundingClientRect();\n\n        return {\n          width: 2,\n          height: rect.height,\n          top:\n            rect.top - (containerRect?.top ?? 0) + (container?.scrollTop ?? 0),\n          left:\n            rect.left +\n            rect.width -\n            (containerRect?.left ?? 0) +\n            (container?.scrollLeft ?? 0),\n        };\n      }\n    }\n\n    return null;\n  }\n\n  private _getSelectionRect(selections: BaseSelection[]): SelectionRect[] {\n    if (this.block.model.flavour !== 'affine:page') {\n      console.error('remote selection widget must be used in page component');\n      return [];\n    }\n\n    const textSelection = selections.find(\n      selection => selection instanceof TextSelection\n    ) as TextSelection | undefined;\n    const blockSelections = selections.filter(\n      selection => selection instanceof BlockSelection\n    );\n\n    if (!textSelection && !blockSelections.length) return [];\n\n    const { selectionRects } = this.std.command.exec('getSelectionRects', {\n      textSelection,\n      blockSelections,\n    });\n\n    if (!selectionRects) return [];\n\n    return selectionRects.map(({ blockId, ...rect }) => {\n      if (!blockId) return rect;\n\n      const block = this.host.view.getBlock(blockId);\n      if (!block) return rect;\n\n      const isTransparent = this._config.blockSelectionBackgroundTransparent(\n        block.model\n      );\n\n      return {\n        ...rect,\n        transparent: isTransparent,\n      };\n    });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.handleEvent('wheel', () => {\n      this.requestUpdate();\n    });\n\n    this.disposables.addFromEvent(window, 'resize', () => {\n      this.requestUpdate();\n    });\n\n    this._remoteColorManager = new RemoteColorManager(this.std);\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._resizeObserver.disconnect();\n    this._abortController.abort();\n  }\n\n  override render() {\n    if (this._remoteSelections.value.length === 0) {\n      return nothing;\n    }\n\n    const remoteUsers = new Set<number>();\n    const selections: Array<{\n      id: number;\n      selections: BaseSelection[];\n      rects: SelectionRect[];\n      user?: UserInfo;\n    }> = this._remoteSelections.value.flatMap(({ selections, id, user }) => {\n      if (remoteUsers.has(id)) {\n        return [];\n      } else {\n        remoteUsers.add(id);\n      }\n\n      return {\n        id,\n        selections,\n        rects: this._getSelectionRect(selections),\n        user,\n      };\n    });\n\n    const remoteColorManager = this._remoteColorManager;\n    assertExists(remoteColorManager);\n    return html`<div>\n      ${selections.flatMap(selection => {\n        const color = remoteColorManager.get(selection.id);\n        if (!color) return;\n        const cursorRect = this._getCursorRect(selection.selections);\n\n        return selection.rects\n          .map(r => html`<div style=\"${selectionStyle(r, color)}\"></div>`)\n          .concat([\n            html`\n              <div\n                style=\"${cursorRect\n                  ? cursorStyle(cursorRect, color)\n                  : styleMap({\n                      display: 'none',\n                    })}\"\n              >\n                <div\n                  style=\"${styleMap({\n                    position: 'relative',\n                    height: '100%',\n                  })}\"\n                >\n                  <div\n                    style=\"${styleMap({\n                      position: 'absolute',\n                      left: '-4px',\n                      bottom: `${\n                        cursorRect?.height ? cursorRect.height - 4 : 0\n                      }px`,\n                      backgroundColor: color,\n                      color: 'white',\n                      maxWidth: '160px',\n                      padding: '0 3px',\n                      border: '1px solid var(--affine-pure-black-20)',\n                      boxShadow: '0px 1px 6px 0px rgba(0, 0, 0, 0.16)',\n                      borderRadius: '4px',\n                      fontSize: '12px',\n                      lineHeight: '18px',\n                      overflow: 'hidden',\n                      textOverflow: 'ellipsis',\n                      whiteSpace: 'nowrap',\n                      display: selection.user ? 'block' : 'none',\n                    })}\"\n                  >\n                    ${selection.user?.name}\n                  </div>\n                </div>\n              </div>\n            `,\n          ]);\n      })}\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_DOC_REMOTE_SELECTION_WIDGET]: AffineDocRemoteSelectionWidget;\n  }\n}\n"]}