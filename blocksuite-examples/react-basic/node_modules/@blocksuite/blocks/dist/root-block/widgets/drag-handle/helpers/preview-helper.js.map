{"version":3,"file":"preview-helper.js","sourceRoot":"","sources":["../../../../../src/root-block/widgets/drag-handle/helpers/preview-helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { SpecProvider } from '@blocksuite/affine-shared/utils';\nimport {\n  type BlockComponent,\n  BlockStdScope,\n  type DndEventState,\n} from '@blocksuite/block-std';\nimport { Point } from '@blocksuite/global/utils';\nimport { BlockViewType, type Query } from '@blocksuite/store';\n\nimport type { AffineDragHandleWidget } from '../drag-handle.js';\n\nimport { DragPreview } from '../components/drag-preview.js';\n\nexport class PreviewHelper {\n  private _calculatePreviewOffset = (\n    blocks: BlockComponent[],\n    state: DndEventState\n  ) => {\n    const { top, left } = blocks[0].getBoundingClientRect();\n    const previewOffset = new Point(state.raw.x - left, state.raw.y - top);\n    return previewOffset;\n  };\n\n  private _calculateQuery = (selectedIds: string[]): Query => {\n    const ids: Array<{ id: string; viewType: BlockViewType }> = selectedIds.map(\n      id => ({\n        id,\n        viewType: BlockViewType.Display,\n      })\n    );\n\n    // The ancestors of the selected blocks should be rendered as Bypass\n    selectedIds.map(block => {\n      let parent: string | null = block;\n      do {\n        if (!selectedIds.includes(parent)) {\n          ids.push({ viewType: BlockViewType.Bypass, id: parent });\n        }\n        parent = this.widget.doc.blockCollection.crud.getParent(parent);\n      } while (parent && !ids.map(({ id }) => id).includes(parent));\n    });\n\n    // The children of the selected blocks should be rendered as Display\n    const addChildren = (id: string) => {\n      const children = this.widget.doc.getBlock(id)?.model.children ?? [];\n      children.forEach(child => {\n        ids.push({ viewType: BlockViewType.Display, id: child.id });\n        addChildren(child.id);\n      });\n    };\n    selectedIds.forEach(addChildren);\n\n    return {\n      match: ids,\n      mode: 'strict',\n    };\n  };\n\n  createDragPreview = (\n    blocks: BlockComponent[],\n    state: DndEventState,\n    dragPreviewEl?: HTMLElement,\n    dragPreviewOffset?: Point\n  ): DragPreview => {\n    if (this.widget.dragPreview) {\n      this.widget.dragPreview.remove();\n    }\n\n    let dragPreview: DragPreview;\n    if (dragPreviewEl) {\n      dragPreview = new DragPreview(dragPreviewOffset);\n      dragPreview.append(dragPreviewEl);\n    } else {\n      let width = 0;\n      blocks.forEach(element => {\n        width = Math.max(width, element.getBoundingClientRect().width);\n      });\n\n      const selectedIds = blocks.map(block => block.model.id);\n\n      const query = this._calculateQuery(selectedIds);\n\n      const doc = this.widget.doc.blockCollection.getDoc({ query });\n\n      const previewSpec = SpecProvider.getInstance().getSpec('page:preview');\n      const previewStd = new BlockStdScope({\n        doc,\n        extensions: previewSpec.value,\n      });\n      const previewTemplate = previewStd.render();\n\n      const offset = this._calculatePreviewOffset(blocks, state);\n      const posX = state.raw.x - offset.x;\n      const posY = state.raw.y - offset.y;\n      const altKey = state.raw.altKey;\n\n      dragPreview = new DragPreview(offset);\n      dragPreview.template = previewTemplate;\n      dragPreview.onRemove = () => {\n        this.widget.doc.blockCollection.clearQuery(query);\n      };\n      dragPreview.style.width = `${width / this.widget.scaleInNote.peek()}px`;\n      dragPreview.style.transform = `translate(${posX}px, ${posY}px) scale(${this.widget.scaleInNote.peek()})`;\n\n      dragPreview.style.opacity = altKey ? '1' : '0.5';\n    }\n    this.widget.rootComponent.append(dragPreview);\n    return dragPreview;\n  };\n\n  removeDragPreview = () => {\n    if (this.widget.dragPreview) {\n      this.widget.dragPreview.remove();\n      this.widget.dragPreview = null;\n    }\n  };\n\n  constructor(readonly widget: AffineDragHandleWidget) {}\n}\n"]}