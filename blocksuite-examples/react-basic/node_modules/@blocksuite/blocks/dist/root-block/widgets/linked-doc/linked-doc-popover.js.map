{"version":3,"file":"linked-doc-popover.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/linked-doc/linked-doc-popover.ts"],"names":[],"mappings":"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","sourcesContent":["import { MoreHorizontalIcon } from '@blocksuite/affine-components/icons';\nimport {\n  getCurrentNativeRange,\n  getViewportElement,\n} from '@blocksuite/affine-shared/utils';\nimport { PropTypes, requiredProperties } from '@blocksuite/block-std';\nimport {\n  SignalWatcher,\n  throttle,\n  WithDisposable,\n} from '@blocksuite/global/utils';\nimport { html, LitElement, nothing } from 'lit';\nimport { property, query, queryAll, state } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { IconButton } from '../../../_common/components/button.js';\nimport type { LinkedDocContext, LinkedMenuGroup } from './config.js';\n\nimport {\n  cleanSpecifiedTail,\n  createKeydownObserver,\n  getQuery,\n} from '../../../_common/components/utils.js';\nimport { getPopperPosition } from '../../utils/position.js';\nimport { linkedDocPopoverStyles } from './styles.js';\nimport { resolveSignal } from './utils.js';\n\n@requiredProperties({\n  context: PropTypes.object,\n})\nexport class LinkedDocPopover extends SignalWatcher(\n  WithDisposable(LitElement)\n) {\n  static override styles = linkedDocPopoverStyles;\n\n  private _abort = () => {\n    // remove popover dom\n    this.context.close();\n    // clear input query\n    cleanSpecifiedTail(\n      this.context.std.host,\n      this.context.inlineEditor,\n      this.context.triggerKey + (this._query || '')\n    );\n  };\n\n  private _expanded = new Map<string, boolean>();\n\n  private _updateLinkedDocGroup = async () => {\n    const query = this._query;\n    if (this._updateLinkedDocGroupAbortController) {\n      this._updateLinkedDocGroupAbortController.abort();\n    }\n    this._updateLinkedDocGroupAbortController = new AbortController();\n\n    if (query === null) {\n      this.context.close();\n      return;\n    }\n    this._linkedDocGroup = await this.context.config.getMenus(\n      query,\n      this._abort,\n      this.context.std.host,\n      this.context.inlineEditor,\n      this._updateLinkedDocGroupAbortController.signal\n    );\n  };\n\n  private _updateLinkedDocGroupAbortController: AbortController | null = null;\n\n  private get _actionGroup() {\n    return this._linkedDocGroup.map(group => {\n      return {\n        ...group,\n        items: this._getActionItems(group),\n      };\n    });\n  }\n\n  private get _flattenActionList() {\n    return this._actionGroup\n      .map(group =>\n        group.items.map(item => ({ ...item, groupName: group.name }))\n      )\n      .flat();\n  }\n\n  private get _query() {\n    return getQuery(this.context.inlineEditor, this.context.startRange);\n  }\n\n  private _getActionItems(group: LinkedMenuGroup) {\n    const isExpanded = !!this._expanded.get(group.name);\n    const items = resolveSignal(group.items);\n    if (isExpanded) {\n      return items;\n    }\n    const isOverflow = !!group.maxDisplay && items.length > group.maxDisplay;\n    if (isOverflow) {\n      return items.slice(0, group.maxDisplay).concat({\n        key: `${group.name} More`,\n        name: group.overflowText || 'more',\n        icon: MoreHorizontalIcon,\n        action: () => {\n          this._expanded.set(group.name, true);\n          this.requestUpdate();\n        },\n      });\n    }\n    return items;\n  }\n\n  private _isTextOverflowing(element: HTMLElement) {\n    return element.scrollWidth > element.clientWidth;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    // init\n    this._updateLinkedDocGroup().catch(console.error);\n    this._disposables.addFromEvent(this, 'mousedown', e => {\n      // Prevent input from losing focus\n      e.preventDefault();\n    });\n    this._disposables.addFromEvent(window, 'mousedown', e => {\n      if (e.target === this) return;\n      // We don't clear the query when clicking outside the popover\n      this.context.close();\n    });\n\n    const keydownObserverAbortController = new AbortController();\n    this._disposables.add(() => keydownObserverAbortController.abort());\n\n    const { eventSource } = this.context.inlineEditor;\n    if (!eventSource) return;\n\n    createKeydownObserver({\n      target: eventSource,\n      signal: keydownObserverAbortController.signal,\n      onInput: isComposition => {\n        this._activatedItemIndex = 0;\n        if (isComposition) {\n          this._updateLinkedDocGroup().catch(console.error);\n        } else {\n          this.context.inlineEditor.slots.renderComplete.once(\n            this._updateLinkedDocGroup\n          );\n        }\n      },\n      onPaste: () => {\n        this._activatedItemIndex = 0;\n        setTimeout(() => {\n          this._updateLinkedDocGroup().catch(console.error);\n        }, 50);\n      },\n      onDelete: () => {\n        const curRange = this.context.inlineEditor.getInlineRange();\n        if (!this.context.startRange || !curRange) {\n          return;\n        }\n        if (curRange.index < this.context.startRange.index) {\n          this.context.close();\n        }\n        this._activatedItemIndex = 0;\n        this.context.inlineEditor.slots.renderComplete.once(\n          this._updateLinkedDocGroup\n        );\n      },\n      onMove: step => {\n        const itemLen = this._flattenActionList.length;\n        this._activatedItemIndex =\n          (itemLen + this._activatedItemIndex + step) % itemLen;\n\n        // Scroll to the active item\n        const item = this._flattenActionList[this._activatedItemIndex];\n        const shadowRoot = this.shadowRoot;\n        if (!shadowRoot) {\n          console.warn('Failed to find the shadow root!', this);\n          return;\n        }\n        const ele = shadowRoot.querySelector(\n          `icon-button[data-id=\"${item.key}\"]`\n        );\n        if (!ele) {\n          console.warn('Failed to find the active item!', item);\n          return;\n        }\n        ele.scrollIntoView({\n          block: 'nearest',\n        });\n      },\n      onConfirm: () => {\n        this._flattenActionList[this._activatedItemIndex]\n          .action()\n          ?.catch(console.error);\n      },\n      onAbort: () => {\n        this.context.close();\n      },\n    });\n  }\n\n  override render() {\n    const MAX_HEIGHT = 380;\n    const style = this._position\n      ? styleMap({\n          transform: `translate(${this._position.x}, ${this._position.y})`,\n          maxHeight: `${Math.min(this._position.height, MAX_HEIGHT)}px`,\n        })\n      : styleMap({\n          visibility: 'hidden',\n        });\n\n    // XXX This is a side effect\n    let accIdx = 0;\n    return html`<div class=\"linked-doc-popover\" style=\"${style}\">\n      ${this._actionGroup\n        .filter(group => group.items.length)\n        .map((group, idx) => {\n          return html`\n            <div class=\"divider\" ?hidden=${idx === 0}></div>\n            <div class=\"group-title\">${group.name}</div>\n            <div class=\"group\" style=${group.styles ?? ''}>\n              ${group.items.map(({ key, name, icon, action }) => {\n                accIdx++;\n                const curIdx = accIdx - 1;\n                const tooltip = this._showTooltip\n                  ? html`<affine-tooltip tip-position=${'right'}\n                      >${name}</affine-tooltip\n                    >`\n                  : nothing;\n                return html`<icon-button\n                  width=\"280px\"\n                  height=\"30px\"\n                  data-id=${key}\n                  .text=${name}\n                  hover=${this._activatedItemIndex === curIdx}\n                  @click=${() => {\n                    action()?.catch(console.error);\n                  }}\n                  @mousemove=${() => {\n                    // Use `mousemove` instead of `mouseover` to avoid navigate conflict with keyboard\n                    this._activatedItemIndex = curIdx;\n                    // show tooltip whether text length overflows\n                    for (const button of this.iconButtons.values()) {\n                      if (button.dataset.id == key && button.textElement) {\n                        const isOverflowing = this._isTextOverflowing(\n                          button.textElement\n                        );\n                        this._showTooltip = isOverflowing;\n                        break;\n                      }\n                    }\n                  }}\n                >\n                  ${icon} ${tooltip}\n                </icon-button>`;\n              })}\n            </div>\n          `;\n        })}\n    </div>`;\n  }\n\n  updatePosition(position: { height: number; x: string; y: string }) {\n    this._position = position;\n  }\n\n  override willUpdate() {\n    if (!this.hasUpdated) {\n      const curRange = getCurrentNativeRange();\n      if (!curRange) return;\n\n      const updatePosition = throttle(() => {\n        const position = getPopperPosition(this, curRange);\n        this.updatePosition(position);\n      }, 10);\n\n      this.disposables.addFromEvent(window, 'resize', updatePosition);\n      const scrollContainer = getViewportElement(this.context.std.host);\n      if (scrollContainer) {\n        // Note: in edgeless mode, the scroll container is not exist!\n        this.disposables.addFromEvent(\n          scrollContainer,\n          'scroll',\n          updatePosition,\n          {\n            passive: true,\n          }\n        );\n      }\n      updatePosition();\n    }\n  }\n\n  @state()\n  private accessor _activatedItemIndex = 0;\n\n  @state()\n  private accessor _linkedDocGroup: LinkedMenuGroup[] = [];\n\n  @state()\n  private accessor _position: {\n    height: number;\n    x: string;\n    y: string;\n  } | null = null;\n\n  @state()\n  private accessor _showTooltip = false;\n\n  @property({ attribute: false })\n  accessor context!: LinkedDocContext;\n\n  @queryAll('icon-button')\n  accessor iconButtons!: NodeListOf<IconButton>;\n\n  @query('.linked-doc-popover')\n  accessor linkedDocElement: Element | null = null;\n}\n"]}