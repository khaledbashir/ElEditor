{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/linked-doc/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AffineInlineEditor } from '@blocksuite/affine-components/rich-text';\nimport type { RootBlockModel } from '@blocksuite/affine-model';\nimport type { SelectionRect } from '@blocksuite/affine-shared/commands';\nimport type { UIEventStateContext } from '@blocksuite/block-std';\nimport type { Disposable } from '@blocksuite/global/utils';\n\nimport { getInlineEditorByModel } from '@blocksuite/affine-components/rich-text';\nimport {\n  getViewportElement,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport { IS_MOBILE } from '@blocksuite/global/env';\nimport { InlineEditor, type InlineRange } from '@blocksuite/inline';\nimport { signal } from '@preact/signals-core';\nimport { html, nothing } from 'lit';\nimport { state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { PageRootBlockComponent } from '../../index.js';\n\nimport {\n  getMenus,\n  type LinkedDocContext,\n  type LinkedWidgetConfig,\n} from './config.js';\nimport { linkedDocWidgetStyles } from './styles.js';\nexport { type LinkedWidgetConfig } from './config.js';\n\nexport const AFFINE_LINKED_DOC_WIDGET = 'affine-linked-doc-widget';\n\nexport class AffineLinkedDocWidget extends WidgetComponent<\n  RootBlockModel,\n  PageRootBlockComponent\n> {\n  static override styles = linkedDocWidgetStyles;\n\n  private _disposeObserveInputRects: Disposable | null = null;\n\n  private readonly _getInlineEditor = (\n    evt?: KeyboardEvent | CompositionEvent\n  ) => {\n    if (evt && evt.target instanceof HTMLElement) {\n      const editor = (\n        evt.target.closest('.can-link-doc > .inline-editor') as {\n          inlineEditor?: AffineInlineEditor;\n        }\n      )?.inlineEditor;\n      if (editor instanceof InlineEditor) {\n        return editor;\n      }\n    }\n\n    const text = this.host.selection.value.find(selection =>\n      selection.is('text')\n    );\n    if (!text) return null;\n\n    const model = this.host.doc.getBlockById(text.blockId);\n    if (!model) return null;\n\n    if (matchFlavours(model, this.config.ignoreBlockTypes)) {\n      return null;\n    }\n\n    return getInlineEditorByModel(this.host, model);\n  };\n\n  private _inlineEditor: AffineInlineEditor | null = null;\n\n  private _observeInputRects = () => {\n    if (!this._inlineEditor) return;\n\n    const updateInputRects = () => {\n      const blockId =\n        this.std.command.exec('getSelectedModels').selectedModels?.[0]?.id;\n      if (!blockId) return;\n\n      if (!this._startRange) return;\n      const index = this._startRange.index - this._triggerKey.length;\n      if (index < 0) return;\n\n      const currentRange = this._inlineEditor?.getInlineRange();\n      if (!currentRange) return;\n      const length = currentRange.index + currentRange.length - index;\n\n      const textSelection = this.std.selection.create('text', {\n        from: { blockId, index, length },\n        to: null,\n      });\n\n      const { selectionRects } = this.std.command.exec('getSelectionRects', {\n        textSelection,\n      });\n\n      if (!selectionRects) return;\n\n      this._inputRects = selectionRects;\n    };\n\n    updateInputRects();\n    this._disposeObserveInputRects =\n      this._inlineEditor.slots.renderComplete.on(updateInputRects);\n  };\n\n  private readonly _onCompositionEnd = (ctx: UIEventStateContext) => {\n    const event = ctx.get('defaultState').event as CompositionEvent;\n\n    const key = event.data;\n\n    if (\n      !key ||\n      !this.config.triggerKeys.some(triggerKey => triggerKey.includes(key))\n    )\n      return;\n\n    this._inlineEditor = this._getInlineEditor(event);\n    if (!this._inlineEditor) return;\n\n    this._handleInput(true);\n  };\n\n  private readonly _onKeyDown = (ctx: UIEventStateContext) => {\n    const eventState = ctx.get('keyboardState');\n    const event = eventState.raw;\n\n    const key = event.key;\n    if (\n      key === undefined || // in mac os, the key may be undefined\n      key === 'Process' ||\n      event.isComposing\n    )\n      return;\n\n    if (!this.config.triggerKeys.some(triggerKey => triggerKey.includes(key)))\n      return;\n\n    this._inlineEditor = this._getInlineEditor(event);\n    if (!this._inlineEditor) return;\n\n    const inlineRange = this._inlineEditor.getInlineRange();\n    if (!inlineRange) return;\n\n    if (inlineRange.length > 0) {\n      // When select text and press `[[` should not trigger transform,\n      // since it will break the bracket complete.\n      // Expected `[[selected text]]` instead of `@selected text]]`\n      return;\n    }\n\n    this._handleInput(false);\n  };\n\n  private readonly _renderLinkedDocMenu = () => {\n    if (!this.block.rootComponent) return nothing;\n\n    return html`<affine-mobile-linked-doc-menu\n      .context=${this._context}\n      .rootComponent=${this.block.rootComponent}\n    ></affine-mobile-linked-doc-menu>`;\n  };\n\n  private readonly _renderLinkedDocPopover = () => {\n    return html`<affine-linked-doc-popover\n      .context=${this._context}\n    ></affine-linked-doc-popover>`;\n  };\n\n  private readonly _show$ = signal<'desktop' | 'mobile' | 'none'>('none');\n\n  private _startRange: InlineRange | null = null;\n\n  close = () => {\n    this._disposeObserveInputRects?.dispose();\n    this._disposeObserveInputRects = null;\n    this._inlineEditor = null;\n    this._triggerKey = '';\n    this._show$.value = 'none';\n    this._startRange = null;\n  };\n\n  show = (mode: 'desktop' | 'mobile' = 'desktop') => {\n    if (this._inlineEditor === null) {\n      this._inlineEditor = this._getInlineEditor();\n    }\n    if (this._triggerKey === '') {\n      this._triggerKey = this.config.triggerKeys[0];\n    }\n\n    this._startRange = this._inlineEditor?.getInlineRange() ?? null;\n\n    const enableMobile = this.doc.awarenessStore.getFlag(\n      'enable_mobile_linked_doc_menu'\n    );\n\n    this._observeInputRects();\n\n    this._show$.value = enableMobile ? mode : 'desktop';\n  };\n\n  private get _context(): LinkedDocContext {\n    return {\n      std: this.std,\n      inlineEditor: this._inlineEditor!,\n      startRange: this._startRange!,\n      triggerKey: this._triggerKey,\n      config: this.config,\n      close: this.close,\n    };\n  }\n\n  get config(): LinkedWidgetConfig {\n    return {\n      triggerKeys: ['@', '[[', '【【'],\n      ignoreBlockTypes: ['affine:code'],\n      convertTriggerKey: true,\n      getMenus,\n      mobile: {\n        useScreenHeight: false,\n        scrollContainer: getViewportElement(this.std.host) ?? window,\n        scrollTopOffset: 46,\n      },\n      ...this.std.getConfig('affine:page')?.linkedWidget,\n    };\n  }\n\n  private _handleInput(isCompositionEnd: boolean) {\n    const primaryTriggerKey = this.config.triggerKeys[0];\n\n    const inlineEditor = this._inlineEditor;\n    if (!inlineEditor) return;\n\n    const inlineRangeApplyCallback = (callback: () => void) => {\n      // the inline ranged updated in compositionEnd event before this event callback\n      if (isCompositionEnd) callback();\n      else inlineEditor.slots.inlineRangeSync.once(callback);\n    };\n\n    inlineRangeApplyCallback(() => {\n      const inlineRange = inlineEditor.getInlineRange();\n      if (!inlineRange) return;\n      const textPoint = inlineEditor.getTextPoint(inlineRange.index);\n      if (!textPoint) return;\n      const [leafStart, offsetStart] = textPoint;\n\n      const text = leafStart.textContent\n        ? leafStart.textContent.slice(0, offsetStart)\n        : '';\n\n      const matchedKey = this.config.triggerKeys.find(triggerKey =>\n        text.endsWith(triggerKey)\n      );\n      if (!matchedKey) return;\n\n      if (this.config.convertTriggerKey && primaryTriggerKey !== matchedKey) {\n        const inlineRange = inlineEditor.getInlineRange();\n        if (!inlineRange) return;\n\n        // Convert to the primary trigger key\n        // e.g. [[ -> @\n        this._triggerKey = primaryTriggerKey;\n        const startIdxBeforeMatchKey = inlineRange.index - matchedKey.length;\n        inlineEditor.deleteText({\n          index: startIdxBeforeMatchKey,\n          length: matchedKey.length,\n        });\n        inlineEditor.insertText(\n          { index: startIdxBeforeMatchKey, length: 0 },\n          primaryTriggerKey\n        );\n        inlineEditor.setInlineRange({\n          index: startIdxBeforeMatchKey + primaryTriggerKey.length,\n          length: 0,\n        });\n        inlineEditor.slots.inlineRangeSync.once(() => {\n          this.show(IS_MOBILE ? 'mobile' : 'desktop');\n        });\n        return;\n      } else {\n        this._triggerKey = matchedKey;\n        this.show(IS_MOBILE ? 'mobile' : 'desktop');\n      }\n    });\n  }\n\n  private _renderInputMask() {\n    return html`${repeat(\n      this._inputRects,\n      ({ top, left, width, height }, index) => {\n        const last = index === this._inputRects.length - 1;\n        const padding = 2;\n        return html`<div\n          class=\"input-mask\"\n          style=${styleMap({\n            top: `${top - padding}px`,\n            left: `${left}px`,\n            width: `${width + (last ? 10 : 0)}px`,\n            height: `${height + 2 * padding}px`,\n          })}\n        ></div>`;\n      }\n    )}`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.handleEvent('keyDown', this._onKeyDown);\n    this.handleEvent('compositionEnd', this._onCompositionEnd);\n  }\n\n  override render() {\n    if (this._show$.value === 'none') return nothing;\n\n    return html`${this._renderInputMask()}\n      <blocksuite-portal\n        .shadowDom=${false}\n        .template=${choose(\n          this._show$.value,\n          [\n            ['desktop', this._renderLinkedDocPopover],\n            ['mobile', this._renderLinkedDocMenu],\n          ],\n          () => html`${nothing}`\n        )}\n      ></blocksuite-portal>`;\n  }\n\n  @state()\n  private accessor _inputRects: SelectionRect[] = [];\n\n  @state()\n  private accessor _triggerKey = '';\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_LINKED_DOC_WIDGET]: AffineLinkedDocWidget;\n  }\n}\n"]}