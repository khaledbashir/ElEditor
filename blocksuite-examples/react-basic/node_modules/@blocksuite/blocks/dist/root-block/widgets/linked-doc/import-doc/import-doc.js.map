{"version":3,"file":"import-doc.js","sourceRoot":"","sources":["../../../../../src/root-block/widgets/linked-doc/import-doc/import-doc.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DocCollection } from '@blocksuite/store';\n\nimport {\n  CloseIcon,\n  ExportToHTMLIcon,\n  ExportToMarkdownIcon,\n  HelpIcon,\n  NewIcon,\n  NotionIcon,\n} from '@blocksuite/affine-components/icons';\nimport { WithDisposable } from '@blocksuite/global/utils';\nimport { html, LitElement, type PropertyValues } from 'lit';\nimport { query, state } from 'lit/decorators.js';\n\nimport { HtmlTransformer } from '../../../../_common/transformers/html.js';\nimport { MarkdownTransformer } from '../../../../_common/transformers/markdown.js';\nimport { NotionHtmlTransformer } from '../../../../_common/transformers/notion-html.js';\nimport { openFileOrFiles } from '../../../../_common/utils/index.js';\nimport { styles } from './styles.js';\n\nexport type OnSuccessHandler = (\n  pageIds: string[],\n  options: { isWorkspaceFile: boolean; importedCount: number }\n) => void;\n\nexport type OnFailHandler = (message: string) => void;\n\nconst SHOW_LOADING_SIZE = 1024 * 200;\n\nexport class ImportDoc extends WithDisposable(LitElement) {\n  static override styles = styles;\n\n  constructor(\n    private collection: DocCollection,\n    private onSuccess?: OnSuccessHandler,\n    private onFail?: OnFailHandler,\n    private abortController = new AbortController()\n  ) {\n    super();\n\n    this._loading = false;\n\n    this.x = 0;\n    this.y = 0;\n    this._startX = 0;\n    this._startY = 0;\n\n    this._onMouseMove = this._onMouseMove.bind(this);\n  }\n\n  private async _importHtml() {\n    const files = await openFileOrFiles({ acceptType: 'Html', multiple: true });\n    if (!files) return;\n    const pageIds: string[] = [];\n    for (const file of files) {\n      const text = await file.text();\n      const needLoading = file.size > SHOW_LOADING_SIZE;\n      const fileName = file.name.split('.').slice(0, -1).join('.');\n      if (needLoading) {\n        this.hidden = false;\n        this._loading = true;\n      } else {\n        this.abortController.abort();\n      }\n      const pageId = await HtmlTransformer.importHTMLToDoc({\n        collection: this.collection,\n        html: text,\n        fileName,\n      });\n      needLoading && this.abortController.abort();\n      if (pageId) {\n        pageIds.push(pageId);\n      }\n    }\n    this._onImportSuccess(pageIds);\n  }\n\n  private async _importMarkDown() {\n    const files = await openFileOrFiles({\n      acceptType: 'Markdown',\n      multiple: true,\n    });\n    if (!files) return;\n    const pageIds: string[] = [];\n    for (const file of files) {\n      const text = await file.text();\n      const fileName = file.name.split('.').slice(0, -1).join('.');\n      const needLoading = file.size > SHOW_LOADING_SIZE;\n      if (needLoading) {\n        this.hidden = false;\n        this._loading = true;\n      } else {\n        this.abortController.abort();\n      }\n      const pageId = await MarkdownTransformer.importMarkdownToDoc({\n        collection: this.collection,\n        markdown: text,\n        fileName,\n      });\n      needLoading && this.abortController.abort();\n      if (pageId) {\n        pageIds.push(pageId);\n      }\n    }\n    this._onImportSuccess(pageIds);\n  }\n\n  private async _importNotion() {\n    const file = await openFileOrFiles({ acceptType: 'Zip' });\n    if (!file) return;\n    const needLoading = file.size > SHOW_LOADING_SIZE;\n    if (needLoading) {\n      this.hidden = false;\n      this._loading = true;\n    } else {\n      this.abortController.abort();\n    }\n    const { entryId, pageIds, isWorkspaceFile, hasMarkdown } =\n      await NotionHtmlTransformer.importNotionZip({\n        collection: this.collection,\n        imported: file,\n      });\n    needLoading && this.abortController.abort();\n    if (hasMarkdown) {\n      this._onFail(\n        'Importing markdown files from Notion is deprecated. Please export your Notion pages as HTML.'\n      );\n      return;\n    }\n    this._onImportSuccess([entryId], {\n      isWorkspaceFile,\n      importedCount: pageIds.length,\n    });\n  }\n\n  private _onCloseClick(event: MouseEvent) {\n    event.stopPropagation();\n    this.abortController.abort();\n  }\n\n  private _onFail(message: string) {\n    this.onFail?.(message);\n  }\n\n  private _onImportSuccess(\n    pageIds: string[],\n    options: { isWorkspaceFile?: boolean; importedCount?: number } = {}\n  ) {\n    const {\n      isWorkspaceFile = false,\n      importedCount: pagesImportedCount = pageIds.length,\n    } = options;\n    this.onSuccess?.(pageIds, {\n      isWorkspaceFile,\n      importedCount: pagesImportedCount,\n    });\n  }\n\n  private _onMouseDown(event: MouseEvent) {\n    this._startX = event.clientX - this.x;\n    this._startY = event.clientY - this.y;\n    window.addEventListener('mousemove', this._onMouseMove);\n  }\n\n  private _onMouseMove(event: MouseEvent) {\n    this.x = event.clientX - this._startX;\n    this.y = event.clientY - this._startY;\n  }\n\n  private _onMouseUp() {\n    window.removeEventListener('mousemove', this._onMouseMove);\n  }\n\n  private _openLearnImportLink(event: MouseEvent) {\n    event.stopPropagation();\n    window.open(\n      'https://affine.pro/blog/import-your-data-from-notion-into-affine',\n      '_blank'\n    );\n  }\n\n  override render() {\n    if (this._loading) {\n      return html`\n        <div class=\"overlay-mask\"></div>\n        <div class=\"container\">\n          <header\n            class=\"loading-header\"\n            @mousedown=\"${this._onMouseDown}\"\n            @mouseup=\"${this._onMouseUp}\"\n          >\n            <div>Import</div>\n            <loader-element .width=${'50px'}></loader-element>\n          </header>\n          <div>\n            Importing the file may take some time. It depends on document size\n            and complexity.\n          </div>\n        </div>\n      `;\n    }\n    return html`\n      <div\n        class=\"overlay-mask\"\n        @click=\"${() => this.abortController.abort()}\"\n      ></div>\n      <div class=\"container\">\n        <header @mousedown=\"${this._onMouseDown}\" @mouseup=\"${this._onMouseUp}\">\n          <icon-button height=\"28px\" @click=\"${this._onCloseClick}\">\n            ${CloseIcon}\n          </icon-button>\n          <div>Import</div>\n        </header>\n        <div>\n          AFFiNE will gradually support more file formats for import.\n          <a\n            href=\"https://community.affine.pro/c/feature-requests/import-export\"\n            target=\"_blank\"\n            >Provide feedback.</a\n          >\n        </div>\n        <div class=\"button-container\">\n          <icon-button\n            class=\"button-item\"\n            text=\"Markdown\"\n            @click=\"${this._importMarkDown}\"\n          >\n            ${ExportToMarkdownIcon}\n          </icon-button>\n          <icon-button\n            class=\"button-item\"\n            text=\"HTML\"\n            @click=\"${this._importHtml}\"\n          >\n            ${ExportToHTMLIcon}\n          </icon-button>\n        </div>\n        <div class=\"button-container\">\n          <icon-button\n            class=\"button-item\"\n            text=\"Notion\"\n            @click=\"${this._importNotion}\"\n          >\n            ${NotionIcon}\n            <div\n              slot=\"suffix\"\n              class=\"button-suffix\"\n              @click=\"${this._openLearnImportLink}\"\n            >\n              ${HelpIcon}\n              <affine-tooltip>\n                Learn how to Import your Notion pages into AFFiNE.\n              </affine-tooltip>\n            </div>\n          </icon-button>\n          <icon-button class=\"button-item\" text=\"Coming soon...\" disabled>\n            ${NewIcon}\n          </icon-button>\n        </div>\n        <!-- <div class=\"footer\">\n        <div>Migrate from other versions of AFFiNE?</div>\n      </div> -->\n      </div>\n    `;\n  }\n\n  override updated(changedProps: PropertyValues) {\n    if (changedProps.has('x') || changedProps.has('y')) {\n      this.containerEl.style.transform = `translate(${this.x}px, ${this.y}px)`;\n    }\n  }\n\n  @state()\n  accessor _loading = false;\n\n  @state()\n  accessor _startX = 0;\n\n  @state()\n  accessor _startY = 0;\n\n  @query('.container')\n  accessor containerEl!: HTMLElement;\n\n  @state()\n  accessor x = 0;\n\n  @state()\n  accessor y = 0;\n}\n"]}