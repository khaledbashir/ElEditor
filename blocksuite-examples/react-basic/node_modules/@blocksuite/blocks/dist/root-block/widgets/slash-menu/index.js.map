{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/slash-menu/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UIEventStateContext } from '@blocksuite/block-std';\n\nimport {\n  type AffineInlineEditor,\n  getInlineEditorByModel,\n} from '@blocksuite/affine-components/rich-text';\nimport {\n  getCurrentNativeRange,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport {\n  assertExists,\n  assertType,\n  debounce,\n  DisposableGroup,\n  throttle,\n} from '@blocksuite/global/utils';\nimport { InlineEditor } from '@blocksuite/inline';\n\nimport type { RootBlockComponent } from '../../types.js';\n\nimport { getPopperPosition } from '../../utils/position.js';\nimport {\n  defaultSlashMenuConfig,\n  type SlashMenuActionItem,\n  type SlashMenuContext,\n  type SlashMenuGroupDivider,\n  type SlashMenuItem,\n  type SlashMenuItemGenerator,\n  type SlashMenuStaticConfig,\n  type SlashSubMenu,\n} from './config.js';\nimport { SlashMenu } from './slash-menu-popover.js';\nimport { filterEnabledSlashMenuItems } from './utils.js';\n\nexport type AffineSlashMenuContext = SlashMenuContext;\nexport type AffineSlashMenuItem = SlashMenuItem;\nexport type AffineSlashMenuActionItem = SlashMenuActionItem;\nexport type AffineSlashMenuItemGenerator = SlashMenuItemGenerator;\nexport type AffineSlashSubMenu = SlashSubMenu;\nexport type AffineSlashMenuGroupDivider = SlashMenuGroupDivider;\n\nlet globalAbortController = new AbortController();\n\nfunction closeSlashMenu() {\n  globalAbortController.abort();\n}\n\nconst showSlashMenu = debounce(\n  ({\n    context,\n    container = document.body,\n    abortController = new AbortController(),\n    config,\n    triggerKey,\n  }: {\n    context: SlashMenuContext;\n    container?: HTMLElement;\n    abortController?: AbortController;\n    config: SlashMenuStaticConfig;\n    triggerKey: string;\n  }) => {\n    const curRange = getCurrentNativeRange();\n    if (!curRange) return;\n\n    globalAbortController = abortController;\n    const disposables = new DisposableGroup();\n    abortController.signal.addEventListener('abort', () =>\n      disposables.dispose()\n    );\n\n    const inlineEditor = getInlineEditorByModel(\n      context.rootComponent.host,\n      context.model\n    );\n    if (!inlineEditor) return;\n    const slashMenu = new SlashMenu(inlineEditor, abortController);\n    disposables.add(() => slashMenu.remove());\n    slashMenu.context = context;\n    slashMenu.config = config;\n    slashMenu.triggerKey = triggerKey;\n\n    // Handle position\n    const updatePosition = throttle(() => {\n      const slashMenuElement = slashMenu.slashMenuElement;\n      assertExists(\n        slashMenuElement,\n        'You should render the slash menu node even if no position'\n      );\n      const position = getPopperPosition(slashMenuElement, curRange);\n      slashMenu.updatePosition(position);\n    }, 10);\n\n    disposables.addFromEvent(window, 'resize', updatePosition);\n\n    // FIXME(Flrande): It is not a best practice,\n    // but merely a temporary measure for reusing previous components.\n    // Mount\n    container.append(slashMenu);\n    // Wait for the Node to be mounted\n    setTimeout(updatePosition);\n    return slashMenu;\n  },\n  100\n);\n\nexport const AFFINE_SLASH_MENU_WIDGET = 'affine-slash-menu-widget';\n\nexport class AffineSlashMenuWidget extends WidgetComponent {\n  static DEFAULT_CONFIG = defaultSlashMenuConfig;\n\n  private _getInlineEditor = (evt: KeyboardEvent | CompositionEvent) => {\n    if (evt.target instanceof HTMLElement) {\n      const editor = (\n        evt.target.closest('.inline-editor') as {\n          inlineEditor?: AffineInlineEditor;\n        }\n      )?.inlineEditor;\n      if (editor instanceof InlineEditor) {\n        return editor;\n      }\n    }\n\n    const textSelection = this.host.selection.find('text');\n    if (!textSelection) return;\n\n    const model = this.host.doc.getBlock(textSelection.blockId)?.model;\n    if (!model) return;\n\n    return getInlineEditorByModel(this.host, model);\n  };\n\n  private _handleInput = (\n    inlineEditor: InlineEditor,\n    isCompositionEnd: boolean\n  ) => {\n    const inlineRangeApplyCallback = (callback: () => void) => {\n      // the inline ranged updated in compositionEnd event before this event callback\n      if (isCompositionEnd) callback();\n      else inlineEditor.slots.inlineRangeSync.once(callback);\n    };\n\n    const rootComponent = this.block;\n    if (rootComponent.model.flavour !== 'affine:page') {\n      console.error('SlashMenuWidget should be used in RootBlock');\n      return;\n    }\n    assertType<RootBlockComponent>(rootComponent);\n\n    inlineRangeApplyCallback(() => {\n      const textSelection = this.host.selection.find('text');\n      if (!textSelection) return;\n\n      const model = this.host.doc.getBlock(textSelection.blockId)?.model;\n      if (!model) return;\n\n      if (matchFlavours(model, this.config.ignoreBlockTypes)) return;\n\n      const inlineRange = inlineEditor.getInlineRange();\n      if (!inlineRange) return;\n\n      const textPoint = inlineEditor.getTextPoint(inlineRange.index);\n      if (!textPoint) return;\n\n      const [leafStart, offsetStart] = textPoint;\n\n      const text = leafStart.textContent\n        ? leafStart.textContent.slice(0, offsetStart)\n        : '';\n\n      const matchedKey = this.config.triggerKeys.find(triggerKey =>\n        text.endsWith(triggerKey)\n      );\n      if (!matchedKey) return;\n\n      const config: SlashMenuStaticConfig = {\n        ...this.config,\n        items: filterEnabledSlashMenuItems(this.config.items, {\n          model,\n          rootComponent,\n        }),\n      };\n\n      closeSlashMenu();\n      showSlashMenu({\n        context: {\n          model,\n          rootComponent,\n        },\n        triggerKey: matchedKey,\n        config,\n      });\n    });\n  };\n\n  private _onCompositionEnd = (ctx: UIEventStateContext) => {\n    const event = ctx.get('defaultState').event as CompositionEvent;\n\n    if (\n      !this.config.triggerKeys.some(triggerKey =>\n        triggerKey.includes(event.data)\n      )\n    )\n      return;\n\n    const inlineEditor = this._getInlineEditor(event);\n    if (!inlineEditor) return;\n\n    this._handleInput(inlineEditor, true);\n  };\n\n  private _onKeyDown = (ctx: UIEventStateContext) => {\n    const eventState = ctx.get('keyboardState');\n    const event = eventState.raw;\n\n    const key = event.key;\n\n    // check event is not composing\n    if (\n      key === undefined || // in mac os, the key may be undefined\n      key === 'Process' ||\n      event.isComposing\n    )\n      return;\n\n    if (!this.config.triggerKeys.some(triggerKey => triggerKey.includes(key)))\n      return;\n\n    const inlineEditor = this._getInlineEditor(event);\n    if (!inlineEditor) return;\n\n    this._handleInput(inlineEditor, false);\n  };\n\n  config = AffineSlashMenuWidget.DEFAULT_CONFIG;\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this.config.triggerKeys.some(key => key.length === 0)) {\n      console.error('Trigger key of slash menu should not be empty string');\n      return;\n    }\n\n    // this.handleEvent('beforeInput', this._onBeforeInput);\n    this.handleEvent('keyDown', this._onKeyDown);\n    this.handleEvent('compositionEnd', this._onCompositionEnd);\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_SLASH_MENU_WIDGET]: AffineSlashMenuWidget;\n  }\n}\n"]}