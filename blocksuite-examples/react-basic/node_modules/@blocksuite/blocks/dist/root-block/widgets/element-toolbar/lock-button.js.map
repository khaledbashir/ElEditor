{"version":3,"file":"lock-button.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/element-toolbar/lock-button.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockStdScope } from '@blocksuite/block-std';\nimport type { GfxModel } from '@blocksuite/block-std/gfx';\n\nimport {\n  GroupElementModel,\n  MindmapElementModel,\n} from '@blocksuite/affine-model';\nimport {\n  type ElementLockEvent,\n  TelemetryProvider,\n} from '@blocksuite/affine-shared/services';\nimport { SignalWatcher, WithDisposable } from '@blocksuite/global/utils';\nimport { LockIcon, UnlockIcon } from '@blocksuite/icons/lit';\nimport { html, LitElement, nothing } from 'lit';\nimport { property } from 'lit/decorators.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless/index.js';\n\nexport class EdgelessLockButton extends SignalWatcher(\n  WithDisposable(LitElement)\n) {\n  private get _selectedElements() {\n    const elements = new Set<GfxModel>();\n    this.edgeless.service.selection.selectedElements.forEach(element => {\n      if (element.group instanceof MindmapElementModel) {\n        elements.add(element.group);\n      } else {\n        elements.add(element);\n      }\n    });\n    return [...elements];\n  }\n\n  private _lock() {\n    const { service, doc, std } = this.edgeless;\n\n    doc.captureSync();\n\n    // get most top selected elements(*) from tree, like in a tree below\n    //         G0\n    //        /  \\\n    //      E1*  G1\n    //          /  \\\n    //        E2*  E3*\n    //\n    // (*) selected elements, [E1, E2, E3]\n    // return [E1]\n\n    const selectedElements = this._selectedElements;\n    const levels = selectedElements.map(element => element.groups.length);\n    const topElement = selectedElements[levels.indexOf(Math.min(...levels))];\n    const otherElements = selectedElements.filter(\n      element => element !== topElement\n    );\n\n    // release other elements from their groups and group with top element\n    otherElements.forEach(element => {\n      // eslint-disable-next-line unicorn/prefer-dom-node-remove\n      element.group?.removeChild(element);\n      topElement.group?.addChild(element);\n    });\n\n    if (otherElements.length === 0) {\n      topElement.lock();\n      this.edgeless.gfx.selection.set({\n        editing: false,\n        elements: [topElement.id],\n      });\n      track(std, topElement, 'lock');\n      return;\n    }\n\n    const groupId = service.createGroup([topElement, ...otherElements]);\n\n    if (groupId) {\n      const group = service.getElementById(groupId);\n      if (group) {\n        group.lock();\n        this.edgeless.gfx.selection.set({\n          editing: false,\n          elements: [groupId],\n        });\n        track(std, group, 'group-lock');\n        return;\n      }\n    }\n\n    selectedElements.forEach(e => {\n      e.lock();\n      track(std, e, 'lock');\n    });\n\n    this.edgeless.gfx.selection.set({\n      editing: false,\n      elements: selectedElements.map(e => e.id),\n    });\n  }\n\n  private _unlock() {\n    const { service, doc } = this.edgeless;\n    doc.captureSync();\n\n    this._selectedElements.forEach(element => {\n      if (element instanceof GroupElementModel) {\n        service.ungroup(element);\n      } else {\n        element.lockedBySelf = false;\n      }\n      track(this.edgeless.std, element, 'unlock');\n    });\n  }\n\n  override render() {\n    const hasLocked = this._selectedElements.some(element =>\n      element.isLocked()\n    );\n\n    this.dataset.locked = hasLocked ? 'true' : 'false';\n\n    const icon = hasLocked ? UnlockIcon : LockIcon;\n\n    return html`<editor-icon-button\n      @click=${hasLocked ? this._unlock : this._lock}\n    >\n      ${icon({ width: '20px', height: '20px' })}\n      ${hasLocked\n        ? html`<span class=\"label medium\">Click to unlock</span>`\n        : nothing}\n    </editor-icon-button>`;\n  }\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n}\n\nfunction track(\n  std: BlockStdScope,\n  element: GfxModel,\n  control: ElementLockEvent['control']\n) {\n  const type =\n    'flavour' in element\n      ? (element.flavour.split(':')[1] ?? element.flavour)\n      : element.type;\n\n  std.getOptional(TelemetryProvider)?.track('EdgelessElementLocked', {\n    page: 'whiteboard editor',\n    segment: 'element toolbar',\n    module: 'element toolbar',\n    control,\n    type,\n  });\n}\n"]}