{"version":3,"file":"edgeless-watcher.js","sourceRoot":"","sources":["../../../../../src/root-block/widgets/drag-handle/watchers/edgeless-watcher.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DndEventState } from '@blocksuite/block-std';\n\nimport {\n  GfxControllerIdentifier,\n  type GfxToolsFullOptionValue,\n} from '@blocksuite/block-std/gfx';\nimport { type IVec, Rect } from '@blocksuite/global/utils';\nimport { effect } from '@preact/signals-core';\n\nimport type {\n  EdgelessRootBlockComponent,\n  EdgelessRootService,\n} from '../../../edgeless/index.js';\nimport type { AffineDragHandleWidget } from '../drag-handle.js';\n\nimport {\n  getSelectedRect,\n  isTopLevelBlock,\n} from '../../../edgeless/utils/query.js';\nimport {\n  DRAG_HANDLE_CONTAINER_OFFSET_LEFT_TOP_LEVEL,\n  DRAG_HANDLE_CONTAINER_WIDTH_TOP_LEVEL,\n  DRAG_HANDLE_GRABBER_BORDER_RADIUS,\n  DRAG_HANDLE_GRABBER_WIDTH_HOVERED,\n  HOVER_AREA_RECT_PADDING_TOP_LEVEL,\n} from '../config.js';\n\nexport class EdgelessWatcher {\n  private _handleEdgelessToolUpdated = (newTool: GfxToolsFullOptionValue) => {\n    if (newTool.type === 'default') {\n      this.checkTopLevelBlockSelection();\n    } else {\n      this.widget.hide();\n    }\n  };\n\n  private _handleEdgelessViewPortUpdated = ({\n    zoom,\n    center,\n  }: {\n    zoom: number;\n    center: IVec;\n  }) => {\n    if (this.widget.scale.peek() !== zoom) {\n      this.widget.scale.value = zoom;\n      this._updateDragPreviewOnViewportUpdate();\n    }\n\n    if (\n      this.widget.center[0] !== center[0] &&\n      this.widget.center[1] !== center[1]\n    ) {\n      this.widget.center = [...center];\n      this.widget.updateDropIndicatorOnScroll();\n    }\n\n    if (this.widget.isTopLevelDragHandleVisible) {\n      this._showDragHandleOnTopLevelBlocks().catch(console.error);\n      this._updateDragHoverRectTopLevelBlock();\n    } else {\n      this.widget.hide();\n    }\n  };\n\n  private _showDragHandleOnTopLevelBlocks = async () => {\n    if (this.widget.mode === 'page') return;\n    const { edgelessRoot } = this;\n    await edgelessRoot.surface.updateComplete;\n\n    if (!this.widget.anchorBlockId) return;\n\n    const container = this.widget.dragHandleContainer;\n    const grabber = this.widget.dragHandleGrabber;\n    if (!container || !grabber) return;\n\n    const area = this.hoverAreaTopLevelBlock;\n    if (!area) return;\n\n    const height = area.height;\n\n    const posLeft = area.left;\n\n    const posTop = (area.top += area.padding);\n\n    container.style.transition = 'none';\n    container.style.paddingTop = `0px`;\n    container.style.paddingBottom = `0px`;\n    container.style.width = `${area.containerWidth}px`;\n    container.style.left = `${posLeft}px`;\n    container.style.top = `${posTop}px`;\n    container.style.display = 'flex';\n    container.style.height = `${height}px`;\n\n    grabber.style.width = `${DRAG_HANDLE_GRABBER_WIDTH_HOVERED * this.widget.scale.peek()}px`;\n    grabber.style.borderRadius = `${\n      DRAG_HANDLE_GRABBER_BORDER_RADIUS * this.widget.scale.peek()\n    }px`;\n\n    this.widget.handleAnchorModelDisposables();\n\n    this.widget.isTopLevelDragHandleVisible = true;\n  };\n\n  private _updateDragHoverRectTopLevelBlock = () => {\n    if (!this.widget.dragHoverRect) return;\n\n    this.widget.dragHoverRect = this.hoverAreaRectTopLevelBlock;\n  };\n\n  private _updateDragPreviewOnViewportUpdate = () => {\n    if (this.widget.dragPreview && this.widget.lastDragPointerState) {\n      this.updateDragPreviewPosition(this.widget.lastDragPointerState);\n    }\n  };\n\n  checkTopLevelBlockSelection = () => {\n    if (!this.widget.isConnected) return;\n\n    if (this.widget.doc.readonly || this.widget.mode === 'page') {\n      this.widget.hide();\n      return;\n    }\n\n    const { edgelessRoot } = this;\n    const editing = edgelessRoot.service.selection.editing;\n    const selectedElements = edgelessRoot.service.selection.selectedElements;\n    if (editing || selectedElements.length !== 1) {\n      this.widget.hide();\n      return;\n    }\n\n    const selectedElement = selectedElements[0];\n    if (!isTopLevelBlock(selectedElement)) {\n      this.widget.hide();\n      return;\n    }\n\n    const flavour = selectedElement.flavour;\n    const dragHandleOptions = this.widget.optionRunner.getOption(flavour);\n    if (!dragHandleOptions || !dragHandleOptions.edgeless) {\n      this.widget.hide();\n      return;\n    }\n\n    this.widget.anchorBlockId.value = selectedElement.id;\n\n    this._showDragHandleOnTopLevelBlocks().catch(console.error);\n  };\n\n  updateDragPreviewPosition = (state: DndEventState) => {\n    if (!this.widget.dragPreview) return;\n\n    const offsetParentRect =\n      this.widget.dragHandleContainerOffsetParent.getBoundingClientRect();\n\n    const dragPreviewOffset = this.widget.dragPreview.offset;\n\n    const posX = state.raw.x - dragPreviewOffset.x - offsetParentRect.left;\n\n    const posY = state.raw.y - dragPreviewOffset.y - offsetParentRect.top;\n\n    this.widget.dragPreview.style.transform = `translate(${posX}px, ${posY}px) scale(${this.widget.scaleInNote.peek()})`;\n\n    const altKey = state.raw.altKey;\n    this.widget.dragPreview.style.opacity = altKey ? '1' : '0.5';\n  };\n\n  get edgelessRoot() {\n    return this.widget.rootComponent as EdgelessRootBlockComponent;\n  }\n\n  get hoverAreaRectTopLevelBlock() {\n    const area = this.hoverAreaTopLevelBlock;\n    if (!area) return null;\n\n    return new Rect(area.left, area.top, area.right, area.bottom);\n  }\n\n  get hoverAreaTopLevelBlock() {\n    const edgelessElement = this.widget.anchorEdgelessElement.peek();\n\n    if (!edgelessElement) return null;\n\n    const { edgelessRoot } = this;\n    const rect = getSelectedRect([edgelessElement]);\n    let [left, top] = edgelessRoot.service.viewport.toViewCoord(\n      rect.left,\n      rect.top\n    );\n    const scale = this.widget.scale.peek();\n    const width = rect.width * scale;\n    const height = rect.height * scale;\n\n    let [right, bottom] = [left + width, top + height];\n\n    const padding = HOVER_AREA_RECT_PADDING_TOP_LEVEL * scale;\n\n    const containerWidth = DRAG_HANDLE_CONTAINER_WIDTH_TOP_LEVEL * scale;\n    const offsetLeft = DRAG_HANDLE_CONTAINER_OFFSET_LEFT_TOP_LEVEL * scale;\n\n    left -= containerWidth + offsetLeft;\n    top -= padding;\n    right += padding;\n    bottom += padding;\n\n    return {\n      left,\n      top,\n      right,\n      bottom,\n      width,\n      height,\n      padding,\n      containerWidth,\n    };\n  }\n\n  constructor(readonly widget: AffineDragHandleWidget) {}\n\n  watch() {\n    const { disposables, std } = this.widget;\n    const gfxController = std.get(GfxControllerIdentifier);\n    const { viewport } = gfxController;\n    const edgelessService = std.getService(\n      'affine:page'\n    ) as EdgelessRootService;\n    const edgelessSlots = edgelessService.slots;\n\n    disposables.add(\n      viewport.viewportUpdated.on(this._handleEdgelessViewPortUpdated)\n    );\n\n    disposables.add(\n      edgelessService.selection.slots.updated.on(() => {\n        this.checkTopLevelBlockSelection();\n      })\n    );\n\n    disposables.add(\n      effect(() => {\n        const value = gfxController.tool.currentToolOption$.value;\n\n        value && this._handleEdgelessToolUpdated(value);\n      })\n    );\n\n    disposables.add(\n      edgelessSlots.readonlyUpdated.on(() => {\n        this.checkTopLevelBlockSelection();\n      })\n    );\n\n    disposables.add(\n      edgelessSlots.draggingAreaUpdated.on(() => {\n        this.checkTopLevelBlockSelection();\n      })\n    );\n\n    disposables.add(\n      edgelessSlots.elementResizeStart.on(() => {\n        this.widget.hide();\n      })\n    );\n\n    disposables.add(\n      edgelessSlots.elementResizeEnd.on(() => {\n        this.checkTopLevelBlockSelection();\n      })\n    );\n  }\n}\n"]}