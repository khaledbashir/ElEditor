{"version":3,"file":"drag-event-watcher.js","sourceRoot":"","sources":["../../../../../src/root-block/widgets/drag-handle/watchers/drag-event-watcher.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EmbedCardStyle, NoteBlockModel } from '@blocksuite/affine-model';\n\nimport {\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '@blocksuite/affine-shared/consts';\nimport {\n  DndApiExtensionIdentifier,\n  DocModeProvider,\n  TelemetryProvider,\n} from '@blocksuite/affine-shared/services';\nimport {\n  captureEventTarget,\n  getBlockComponentsExcludeSubtrees,\n  getClosestBlockComponentByPoint,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\nimport {\n  type BlockComponent,\n  type DndEventState,\n  isGfxBlockComponent,\n  type UIEventHandler,\n  type UIEventStateContext,\n} from '@blocksuite/block-std';\nimport { GfxControllerIdentifier } from '@blocksuite/block-std/gfx';\nimport { Bound, Point } from '@blocksuite/global/utils';\nimport { Job, Slice, type SliceSnapshot } from '@blocksuite/store';\n\nimport type { EdgelessRootBlockComponent } from '../../../edgeless/index.js';\nimport type { AffineDragHandleWidget } from '../drag-handle.js';\n\nimport {\n  HtmlAdapter,\n  MarkdownAdapter,\n} from '../../../../_common/adapters/index.js';\nimport {\n  calcDropTarget,\n  type DropResult,\n} from '../../../../_common/utils/index.js';\nimport { addNoteAtPoint } from '../../../edgeless/utils/common.js';\nimport { DropIndicator } from '../components/drop-indicator.js';\nimport { AFFINE_DRAG_HANDLE_WIDGET } from '../consts.js';\nimport { newIdCrossDoc } from '../middleware/new-id-cross-doc.js';\nimport { surfaceRefToEmbed } from '../middleware/surface-ref-to-embed.js';\nimport { containBlock, includeTextSelection } from '../utils.js';\n\nexport class DragEventWatcher {\n  private _computeEdgelessBound = (\n    x: number,\n    y: number,\n    width: number,\n    height: number\n  ) => {\n    const controller = this._std.get(GfxControllerIdentifier);\n    const border = 2;\n    const noteScale = this.widget.noteScale.peek();\n    const { viewport } = controller;\n    const { left: viewportLeft, top: viewportTop } = viewport;\n    const currentViewBound = new Bound(\n      x - viewportLeft,\n      y - viewportTop,\n      width + border / noteScale,\n      height + border / noteScale\n    );\n    const currentModelBound = viewport.toModelBound(currentViewBound);\n    return new Bound(\n      currentModelBound.x,\n      currentModelBound.y,\n      width * noteScale,\n      height * noteScale\n    );\n  };\n\n  private _createDropIndicator = () => {\n    if (!this.widget.dropIndicator) {\n      this.widget.dropIndicator = new DropIndicator();\n      this.widget.rootComponent.append(this.widget.dropIndicator);\n    }\n  };\n\n  private _dragEndHandler: UIEventHandler = () => {\n    this.widget.clearRaf();\n    this.widget.hide(true);\n  };\n\n  private _dragMoveHandler: UIEventHandler = ctx => {\n    if (\n      this.widget.isHoverDragHandleVisible ||\n      this.widget.isTopLevelDragHandleVisible\n    ) {\n      this.widget.hide();\n    }\n\n    if (!this.widget.dragging || this.widget.draggingElements.length === 0) {\n      return false;\n    }\n\n    ctx.get('defaultState').event.preventDefault();\n    const state = ctx.get('dndState');\n\n    // call default drag move handler if no option return true\n    return this._onDragMove(state);\n  };\n\n  /**\n   * When start dragging, should set dragging elements and create drag preview\n   */\n  private _dragStartHandler: UIEventHandler = ctx => {\n    const state = ctx.get('dndState');\n    // If not click left button to start dragging, should do nothing\n    const { button } = state.raw;\n    if (button !== 0) {\n      return false;\n    }\n\n    return this._onDragStart(state);\n  };\n\n  private _dropHandler = (context: UIEventStateContext) => {\n    this._onDrop(context);\n    this._std.selection.setGroup('gfx', []);\n    this.widget.clearRaf();\n    this.widget.hide(true);\n  };\n\n  private _onDragMove = (state: DndEventState) => {\n    this.widget.clearRaf();\n\n    this.widget.rafID = requestAnimationFrame(() => {\n      this.widget.edgelessWatcher.updateDragPreviewPosition(state);\n      this.widget.updateDropIndicator(state, true);\n    });\n    return true;\n  };\n\n  private _onDragStart = (state: DndEventState) => {\n    // Get current hover block element by path\n    const hoverBlock = this.widget.anchorBlockComponent.peek();\n    if (!hoverBlock) return false;\n\n    const element = captureEventTarget(state.raw.target);\n    const dragByHandle = !!element?.closest(AFFINE_DRAG_HANDLE_WIDGET);\n    const isInSurface = isGfxBlockComponent(hoverBlock);\n\n    if (isInSurface && dragByHandle) {\n      this._startDragging([hoverBlock], state);\n      return true;\n    }\n\n    const selectBlockAndStartDragging = () => {\n      this._std.selection.setGroup('note', [\n        this._std.selection.create('block', {\n          blockId: hoverBlock.blockId,\n        }),\n      ]);\n      this._startDragging([hoverBlock], state);\n    };\n\n    if (this.widget.draggingElements.length === 0) {\n      const dragByBlock =\n        hoverBlock.contains(element) && !hoverBlock.model.text;\n\n      const canDragByBlock =\n        matchFlavours(hoverBlock.model, [\n          'affine:attachment',\n          'affine:bookmark',\n        ]) || hoverBlock.model.flavour.startsWith('affine:embed-');\n\n      if (!isInSurface && dragByBlock && canDragByBlock) {\n        selectBlockAndStartDragging();\n        return true;\n      }\n    }\n\n    // Should only start dragging when pointer down on drag handle\n    // And current mouse button is left button\n    if (!dragByHandle) {\n      this.widget.hide();\n      return false;\n    }\n\n    if (this.widget.draggingElements.length === 1) {\n      if (!isInSurface) {\n        selectBlockAndStartDragging();\n        return true;\n      }\n    }\n\n    if (!this.widget.isHoverDragHandleVisible) return false;\n\n    let selections = this.widget.selectionHelper.selectedBlocks;\n\n    // When current selection is TextSelection\n    // Should set BlockSelection for the blocks in native range\n    if (selections.length > 0 && includeTextSelection(selections)) {\n      const nativeSelection = document.getSelection();\n      const rangeManager = this._std.range;\n      if (nativeSelection && nativeSelection.rangeCount > 0 && rangeManager) {\n        const range = nativeSelection.getRangeAt(0);\n        const blocks = rangeManager.getSelectedBlockComponentsByRange(range, {\n          match: el => el.model.role === 'content',\n          mode: 'highest',\n        });\n        this.widget.selectionHelper.setSelectedBlocks(blocks);\n        selections = this.widget.selectionHelper.selectedBlocks;\n      }\n    }\n\n    // When there is no selected blocks\n    // Or selected blocks not including current hover block\n    // Set current hover block as selected\n    if (\n      selections.length === 0 ||\n      !containBlock(\n        selections.map(selection => selection.blockId),\n        this.widget.anchorBlockId.peek()!\n      )\n    ) {\n      const block = this.widget.anchorBlockComponent.peek();\n      if (block) {\n        this.widget.selectionHelper.setSelectedBlocks([block]);\n      }\n    }\n\n    const blocks = this.widget.selectionHelper.selectedBlockComponents;\n\n    // This could be skipped if we can ensure that all selected blocks are on the same level\n    // Which means not selecting parent block and child block at the same time\n    const blocksExcludingChildren = getBlockComponentsExcludeSubtrees(\n      blocks\n    ) as BlockComponent[];\n\n    if (blocksExcludingChildren.length === 0) return false;\n\n    this._startDragging(blocksExcludingChildren, state);\n    this.widget.hide();\n    return true;\n  };\n\n  private _onDrop = (context: UIEventStateContext) => {\n    const state = context.get('dndState');\n\n    const event = state.raw;\n    event.preventDefault();\n\n    const { clientX, clientY } = event;\n    const point = new Point(clientX, clientY);\n    const element = getClosestBlockComponentByPoint(point.clone());\n    if (!element) {\n      const target = captureEventTarget(event.target);\n      const isEdgelessContainer =\n        target?.classList.contains('edgeless-container');\n      if (!isEdgelessContainer) return;\n\n      // drop to edgeless container\n      this._onDropOnEdgelessCanvas(context);\n      return;\n    }\n    const model = element.model;\n    const parent = this._std.doc.getParent(model.id);\n    if (!parent) return;\n    if (matchFlavours(parent, ['affine:surface'])) {\n      return;\n    }\n    const result: DropResult | null = calcDropTarget(point, model, element);\n    if (!result) return;\n\n    const index =\n      parent.children.indexOf(model) + (result.type === 'before' ? 0 : 1);\n\n    if (matchFlavours(parent, ['affine:note'])) {\n      const snapshot = this._deserializeSnapshot(state);\n      if (snapshot) {\n        const [first] = snapshot.content;\n        if (first.flavour === 'affine:note') {\n          if (parent.id !== first.id) {\n            this._onDropNoteOnNote(snapshot, parent.id, index);\n          }\n          return;\n        }\n      }\n    }\n\n    this._deserializeData(state, parent.id, index).catch(console.error);\n  };\n\n  private _onDropNoteOnNote = (\n    snapshot: SliceSnapshot,\n    parent?: string,\n    index?: number\n  ) => {\n    const [first] = snapshot.content;\n    const id = first.id;\n\n    const std = this._std;\n    const job = this._getJob();\n    const snapshotWithoutNote = {\n      ...snapshot,\n      content: first.children,\n    };\n    job\n      .snapshotToSlice(snapshotWithoutNote, std.doc, parent, index)\n      .then(() => {\n        const block = std.doc.getBlock(id)?.model;\n        if (block) {\n          std.doc.deleteBlock(block);\n        }\n      })\n      .catch(console.error);\n  };\n\n  private _onDropOnEdgelessCanvas = (context: UIEventStateContext) => {\n    const state = context.get('dndState');\n    // If drop a note, should do nothing\n    const snapshot = this._deserializeSnapshot(state);\n    const edgelessRoot = this.widget\n      .rootComponent as EdgelessRootBlockComponent;\n\n    if (!snapshot) {\n      return;\n    }\n\n    const [first] = snapshot.content;\n    if (first.flavour === 'affine:note') return;\n\n    if (snapshot.content.length === 1) {\n      const importToSurface = (\n        width: number,\n        height: number,\n        newBound: Bound\n      ) => {\n        first.props.xywh = newBound.serialize();\n        first.props.width = width;\n        first.props.height = height;\n\n        const std = this._std;\n        const job = this._getJob();\n        job\n          .snapshotToSlice(snapshot, std.doc, edgelessRoot.surfaceBlockModel.id)\n          .catch(console.error);\n      };\n\n      if (\n        ['affine:attachment', 'affine:bookmark'].includes(first.flavour) ||\n        first.flavour.startsWith('affine:embed-')\n      ) {\n        const style = (first.props.style ?? 'horizontal') as EmbedCardStyle;\n        const width = EMBED_CARD_WIDTH[style];\n        const height = EMBED_CARD_HEIGHT[style];\n\n        const newBound = this._computeEdgelessBound(\n          state.raw.clientX,\n          state.raw.clientY,\n          width,\n          height\n        );\n        if (!newBound) return;\n\n        if (first.flavour === 'affine:embed-linked-doc') {\n          this._trackLinkedDocCreated(first.id);\n        }\n\n        importToSurface(width, height, newBound);\n        return;\n      }\n\n      if (first.flavour === 'affine:image') {\n        const noteScale = this.widget.noteScale.peek();\n        const width = Number(first.props.width || 100) * noteScale;\n        const height = Number(first.props.height || 100) * noteScale;\n\n        const newBound = this._computeEdgelessBound(\n          state.raw.clientX,\n          state.raw.clientY,\n          width,\n          height\n        );\n        if (!newBound) return;\n\n        importToSurface(width, height, newBound);\n        return;\n      }\n    }\n\n    const { left: viewportLeft, top: viewportTop } = edgelessRoot.viewport;\n    const newNoteId = addNoteAtPoint(\n      edgelessRoot.std,\n      new Point(state.raw.x - viewportLeft, state.raw.y - viewportTop),\n      {\n        scale: this.widget.noteScale.peek(),\n      }\n    );\n    const newNoteBlock = this.widget.doc.getBlock(newNoteId)?.model as\n      | NoteBlockModel\n      | undefined;\n    if (!newNoteBlock) return;\n\n    const bound = Bound.deserialize(newNoteBlock.xywh);\n    bound.h *= this.widget.noteScale.peek();\n    bound.w *= this.widget.noteScale.peek();\n    this.widget.doc.updateBlock(newNoteBlock, {\n      xywh: bound.serialize(),\n      edgeless: {\n        ...newNoteBlock.edgeless,\n        scale: this.widget.noteScale.peek(),\n      },\n    });\n\n    this._deserializeData(state, newNoteId).catch(console.error);\n  };\n\n  private _startDragging = (\n    blocks: BlockComponent[],\n    state: DndEventState,\n    dragPreviewEl?: HTMLElement,\n    dragPreviewOffset?: Point\n  ) => {\n    if (!blocks.length) {\n      return;\n    }\n\n    this.widget.draggingElements = blocks;\n\n    this.widget.dragPreview = this.widget.previewHelper.createDragPreview(\n      blocks,\n      state,\n      dragPreviewEl,\n      dragPreviewOffset\n    );\n\n    const slice = Slice.fromModels(\n      this._std.doc,\n      blocks.map(block => block.model)\n    );\n\n    this.widget.dragging = true;\n    this._createDropIndicator();\n    this.widget.hide();\n    this._serializeData(slice, state);\n  };\n\n  private _trackLinkedDocCreated = (id: string) => {\n    const isNewBlock = !this._std.doc.hasBlock(id);\n    if (!isNewBlock) {\n      return;\n    }\n\n    const mode =\n      this._std.getOptional(DocModeProvider)?.getEditorMode() ?? 'page';\n\n    const telemetryService = this._std.getOptional(TelemetryProvider);\n    telemetryService?.track('LinkedDocCreated', {\n      control: `drop on ${mode}`,\n      module: 'drag and drop',\n      type: 'doc',\n      other: 'new doc',\n    });\n  };\n\n  private get _dndAPI() {\n    return this._std.get(DndApiExtensionIdentifier);\n  }\n\n  private get _std() {\n    return this.widget.std;\n  }\n\n  constructor(readonly widget: AffineDragHandleWidget) {}\n\n  private async _deserializeData(\n    state: DndEventState,\n    parent?: string,\n    index?: number\n  ) {\n    try {\n      const dataTransfer = state.raw.dataTransfer;\n      if (!dataTransfer) throw new Error('No data transfer');\n\n      const std = this._std;\n      const job = this._getJob();\n\n      const snapshot = this._deserializeSnapshot(state);\n      if (snapshot) {\n        if (snapshot.content.length === 1) {\n          const [first] = snapshot.content;\n          if (first.flavour === 'affine:embed-linked-doc') {\n            this._trackLinkedDocCreated(first.id);\n          }\n        }\n        // use snapshot\n        const slice = await job.snapshotToSlice(\n          snapshot,\n          std.doc,\n          parent,\n          index\n        );\n        return slice;\n      }\n\n      const html = dataTransfer.getData('text/html');\n      if (html) {\n        // use html parser;\n        const htmlAdapter = new HtmlAdapter(job);\n        const slice = await htmlAdapter.toSlice(\n          { file: html },\n          std.doc,\n          parent,\n          index\n        );\n        return slice;\n      }\n\n      const text = dataTransfer.getData('text/plain');\n      const textAdapter = new MarkdownAdapter(job);\n      const slice = await textAdapter.toSlice(\n        { file: text },\n        std.doc,\n        parent,\n        index\n      );\n      return slice;\n    } catch {\n      return null;\n    }\n  }\n\n  private _deserializeSnapshot(state: DndEventState) {\n    try {\n      const dataTransfer = state.raw.dataTransfer;\n      if (!dataTransfer) throw new Error('No data transfer');\n      const data = dataTransfer.getData(this._dndAPI.mimeType);\n      const snapshot = this._dndAPI.decodeSnapshot(data);\n\n      return snapshot;\n    } catch {\n      return null;\n    }\n  }\n\n  private _getJob() {\n    const std = this._std;\n    return new Job({\n      collection: std.collection,\n      middlewares: [newIdCrossDoc(std), surfaceRefToEmbed(std)],\n    });\n  }\n\n  private _serializeData(slice: Slice, state: DndEventState) {\n    const dataTransfer = state.raw.dataTransfer;\n    if (!dataTransfer) return;\n\n    const job = this._getJob();\n\n    const snapshot = job.sliceToSnapshot(slice);\n    if (!snapshot) return;\n\n    const data = this._dndAPI.encodeSnapshot(snapshot);\n    dataTransfer.setData(this._dndAPI.mimeType, data);\n  }\n\n  watch() {\n    this.widget.handleEvent('pointerDown', ctx => {\n      const state = ctx.get('pointerState');\n      const event = state.raw;\n      const target = captureEventTarget(event.target);\n      if (!target) return;\n\n      if (this.widget.contains(target)) {\n        return true;\n      }\n\n      return;\n    });\n\n    this.widget.handleEvent('dragStart', ctx => {\n      const state = ctx.get('pointerState');\n      const event = state.raw;\n      const target = captureEventTarget(event.target);\n      if (!target) return;\n\n      if (this.widget.contains(target)) {\n        return true;\n      }\n\n      return;\n    });\n    this.widget.handleEvent('nativeDragStart', this._dragStartHandler, {\n      global: true,\n    });\n    this.widget.handleEvent('nativeDragMove', this._dragMoveHandler, {\n      global: true,\n    });\n    this.widget.handleEvent('nativeDragEnd', this._dragEndHandler, {\n      global: true,\n    });\n    this.widget.handleEvent('nativeDrop', this._dropHandler, {\n      global: true,\n    });\n  }\n}\n"]}