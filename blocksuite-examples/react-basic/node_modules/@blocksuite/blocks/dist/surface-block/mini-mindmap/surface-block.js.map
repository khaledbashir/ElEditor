{"version":3,"file":"surface-block.js","sourceRoot":"","sources":["../../../src/surface-block/mini-mindmap/surface-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { SurfaceBlockModel } from '@blocksuite/affine-block-surface';\nimport type { Color, ShapeElementModel } from '@blocksuite/affine-model';\nimport type { Bound } from '@blocksuite/global/utils';\n\nimport {\n  CanvasRenderer,\n  elementRenderers,\n  fitContent,\n} from '@blocksuite/affine-block-surface';\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport { BlockComponent } from '@blocksuite/block-std';\nimport { GfxControllerIdentifier } from '@blocksuite/block-std/gfx';\nimport { html } from 'lit';\nimport { query } from 'lit/decorators.js';\n\nimport type { MindmapService } from './minmap-service.js';\n\nexport class MindmapSurfaceBlock extends BlockComponent<SurfaceBlockModel> {\n  renderer?: CanvasRenderer;\n\n  private get _grid() {\n    return this.std.get(GfxControllerIdentifier).grid;\n  }\n\n  private get _layer() {\n    return this.std.get(GfxControllerIdentifier).layer;\n  }\n\n  get mindmapService() {\n    return this.std.getService('affine:page') as unknown as MindmapService;\n  }\n\n  get viewport() {\n    return this.std.get(GfxControllerIdentifier).viewport;\n  }\n\n  constructor() {\n    super();\n  }\n\n  private _adjustNodeWidth() {\n    this.model.doc.transact(() => {\n      this.model.elementModels.forEach(element => {\n        if (element.type === 'shape') {\n          fitContent(element as ShapeElementModel);\n        }\n      });\n    });\n  }\n\n  private _resizeEffect() {\n    const observer = new ResizeObserver(() => {\n      this.viewport.onResize();\n    });\n\n    observer.observe(this.editorContainer);\n    this._disposables.add(() => {\n      observer.disconnect();\n    });\n  }\n\n  private _setupCenterEffect() {\n    this._disposables.add(\n      this.mindmapService.requestCenter.on(() => {\n        let bound: Bound;\n\n        this.model.elementModels.forEach(el => {\n          if (!bound) {\n            bound = el.elementBound;\n          } else {\n            bound = bound.unite(el.elementBound);\n          }\n        });\n\n        if (bound!) {\n          this.viewport.setViewportByBound(bound, [10, 10, 10, 10]);\n        }\n      })\n    );\n  }\n\n  private _setupRenderer() {\n    this._disposables.add(\n      this.model.elementUpdated.on(() => {\n        this.mindmapService.center();\n      })\n    );\n\n    this.viewport.ZOOM_MIN = 0.01;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const themeService = this.std.get(ThemeProvider);\n    this.renderer = new CanvasRenderer({\n      viewport: this.viewport,\n      layerManager: this._layer,\n      gridManager: this._grid,\n      enableStackingCanvas: true,\n      provider: {\n        selectedElements: () => [],\n        getColorScheme: () => themeService.edgelessTheme,\n        getColorValue: (color: Color, fallback?: string, real?: boolean) =>\n          themeService.getColorValue(\n            color,\n            fallback,\n            real,\n            themeService.edgelessTheme\n          ),\n        generateColorProperty: (color: Color, fallback: string) =>\n          themeService.generateColorProperty(\n            color,\n            fallback,\n            themeService.edgelessTheme\n          ),\n        getPropertyValue: (property: string) =>\n          themeService.getCssVariableColor(\n            property,\n            themeService.edgelessTheme\n          ),\n      },\n      elementRenderers,\n      surfaceModel: this.model,\n    });\n    this._disposables.add(this.renderer);\n  }\n\n  override firstUpdated(_changedProperties: Map<PropertyKey, unknown>): void {\n    this.renderer?.attach(this.editorContainer);\n\n    this._resizeEffect();\n    this._setupCenterEffect();\n    this._setupRenderer();\n    this._adjustNodeWidth();\n    this.mindmapService.center();\n  }\n\n  override render() {\n    return html`\n      <style>\n        .affine-mini-mindmap-surface {\n          width: 100%;\n          height: 100%;\n        }\n      </style>\n      <div class=\"affine-mini-mindmap-surface\">\n        <!-- attach cavnas later in renderer -->\n      </div>\n    `;\n  }\n\n  @query('.affine-mini-mindmap-surface')\n  accessor editorContainer!: HTMLDivElement;\n}\n"]}