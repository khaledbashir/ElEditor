{"version":3,"file":"embed.js","sourceRoot":"","sources":["../../src/attachment-block/embed.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  AttachmentBlockModel,\n  ImageBlockProps,\n} from '@blocksuite/affine-model';\nimport type { ExtensionType } from '@blocksuite/block-std';\nimport type { Container } from '@blocksuite/global/di';\nimport type { TemplateResult } from 'lit';\n\nimport { withTempBlobData } from '@blocksuite/affine-shared/utils';\nimport { Extension } from '@blocksuite/block-std';\nimport { createIdentifier } from '@blocksuite/global/di';\nimport { html } from 'lit';\n\nimport { transformModel } from '../root-block/utils/operations/model.js';\n\nexport type AttachmentEmbedConfig = {\n  name: string;\n  /**\n   * Check if the attachment can be turned into embed view.\n   */\n  check: (model: AttachmentBlockModel, maxFileSize: number) => boolean;\n  /**\n   * The action will be executed when the 「Turn into embed view」 button is clicked.\n   */\n  action?: (model: AttachmentBlockModel) => Promise<void> | void;\n  /**\n   * The template will be used to render the embed view.\n   */\n  template?: (model: AttachmentBlockModel, blobUrl: string) => TemplateResult;\n};\n\n// Single embed config.\nexport const AttachmentEmbedConfigIdentifier =\n  createIdentifier<AttachmentEmbedConfig>(\n    'AffineAttachmentEmbedConfigIdentifier'\n  );\n\nexport function AttachmentEmbedConfigExtension(\n  configs: AttachmentEmbedConfig[] = embedConfig\n): ExtensionType {\n  return {\n    setup: di => {\n      configs.forEach(option => {\n        di.addImpl(AttachmentEmbedConfigIdentifier(option.name), () => option);\n      });\n    },\n  };\n}\n\n// A embed config map.\nexport const AttachmentEmbedConfigMapIdentifier = createIdentifier<\n  Map<string, AttachmentEmbedConfig>\n>('AffineAttachmentEmbedConfigMapIdentifier');\n\nexport const AttachmentEmbedProvider = createIdentifier<AttachmentEmbedService>(\n  'AffineAttachmentEmbedProvider'\n);\n\nexport class AttachmentEmbedService extends Extension {\n  // 10MB\n  static MAX_EMBED_SIZE = 10 * 1024 * 1024;\n\n  get keys() {\n    return this.configs.keys();\n  }\n\n  get values() {\n    return this.configs.values();\n  }\n\n  constructor(private configs: Map<string, AttachmentEmbedConfig>) {\n    super();\n  }\n\n  static override setup(di: Container) {\n    di.addImpl(AttachmentEmbedConfigMapIdentifier, provider =>\n      provider.getAll(AttachmentEmbedConfigIdentifier)\n    );\n    di.addImpl(AttachmentEmbedProvider, AttachmentEmbedService, [\n      AttachmentEmbedConfigMapIdentifier,\n    ]);\n  }\n\n  // Converts to embed view.\n  convertTo(\n    model: AttachmentBlockModel,\n    maxFileSize = AttachmentEmbedService.MAX_EMBED_SIZE\n  ) {\n    const config = this.values.find(config => config.check(model, maxFileSize));\n    if (!config || !config.action) {\n      model.doc.updateBlock(model, { embed: true });\n      return;\n    }\n    config.action(model)?.catch(console.error);\n  }\n\n  embedded(\n    model: AttachmentBlockModel,\n    maxFileSize = AttachmentEmbedService.MAX_EMBED_SIZE\n  ) {\n    return this.values.some(config => config.check(model, maxFileSize));\n  }\n\n  render(\n    model: AttachmentBlockModel,\n    blobUrl?: string,\n    maxFileSize = AttachmentEmbedService.MAX_EMBED_SIZE\n  ) {\n    if (!model.embed || !blobUrl) return;\n\n    const config = this.values.find(config => config.check(model, maxFileSize));\n    if (!config || !config.template) {\n      console.error('No embed view template found!', model, model.type);\n      return;\n    }\n\n    return config.template(model, blobUrl);\n  }\n}\n\nconst embedConfig: AttachmentEmbedConfig[] = [\n  {\n    name: 'image',\n    check: model =>\n      model.doc.schema.flavourSchemaMap.has('affine:image') &&\n      model.type.startsWith('image/'),\n    action: model => turnIntoImageBlock(model),\n  },\n  {\n    name: 'pdf',\n    check: (model, maxFileSize) =>\n      model.type === 'application/pdf' && model.size <= maxFileSize,\n    template: (_, blobUrl) => {\n      // More options: https://tinytip.co/tips/html-pdf-params/\n      // https://chromium.googlesource.com/chromium/src/+/refs/tags/121.0.6153.1/chrome/browser/resources/pdf/open_pdf_params_parser.ts\n      const parameters = '#toolbar=0';\n      return html`<iframe\n        style=\"width: 100%; color-scheme: auto;\"\n        height=\"480\"\n        src=${blobUrl + parameters}\n        loading=\"lazy\"\n        scrolling=\"no\"\n        frameborder=\"no\"\n        allowTransparency\n        allowfullscreen\n        type=\"application/pdf\"\n      ></iframe>`;\n    },\n  },\n  {\n    name: 'video',\n    check: (model, maxFileSize) =>\n      model.type.startsWith('video/') && model.size <= maxFileSize,\n    template: (_, blobUrl) =>\n      html`<video width=\"100%;\" height=\"480\" controls src=${blobUrl}></video>`,\n  },\n  {\n    name: 'audio',\n    check: (model, maxFileSize) =>\n      model.type.startsWith('audio/') && model.size <= maxFileSize,\n    template: (_, blobUrl) =>\n      html`<audio controls src=${blobUrl} style=\"margin: 4px;\"></audio>`,\n  },\n];\n\n/**\n * Turn the attachment block into an image block.\n */\nexport function turnIntoImageBlock(model: AttachmentBlockModel) {\n  if (!model.doc.schema.flavourSchemaMap.has('affine:image')) {\n    console.error('The image flavour is not supported!');\n    return;\n  }\n\n  const sourceId = model.sourceId;\n  if (!sourceId) return;\n\n  const { saveAttachmentData, getImageData } = withTempBlobData();\n  saveAttachmentData(sourceId, { name: model.name });\n\n  const imageConvertData = model.sourceId\n    ? getImageData(model.sourceId)\n    : undefined;\n\n  const imageProp: Partial<ImageBlockProps> = {\n    sourceId,\n    caption: model.caption,\n    size: model.size,\n    ...imageConvertData,\n  };\n  transformModel(model, 'affine:image', imageProp);\n}\n"]}