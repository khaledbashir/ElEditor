{"version":3,"file":"attachment-block.js","sourceRoot":"","sources":["../../src/attachment-block/attachment-block.ts"],"names":[],"mappings":"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","sourcesContent":["import { CaptionedBlockComponent } from '@blocksuite/affine-components/caption';\nimport { HoverController } from '@blocksuite/affine-components/hover';\nimport {\n  AttachmentIcon16,\n  getAttachmentFileIcons,\n} from '@blocksuite/affine-components/icons';\nimport { Peekable } from '@blocksuite/affine-components/peek';\nimport { toast } from '@blocksuite/affine-components/toast';\nimport {\n  type AttachmentBlockModel,\n  AttachmentBlockStyles,\n} from '@blocksuite/affine-model';\nimport { ThemeProvider } from '@blocksuite/affine-shared/services';\nimport { humanFileSize } from '@blocksuite/affine-shared/utils';\nimport { Slice } from '@blocksuite/store';\nimport { flip, offset } from '@floating-ui/dom';\nimport { html, nothing } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { AttachmentBlockService } from './attachment-service.js';\n\nimport { getEmbedCardIcons } from '../_common/utils/url.js';\nimport { AttachmentOptionsTemplate } from './components/options.js';\nimport { AttachmentEmbedProvider } from './embed.js';\nimport { styles } from './styles.js';\nimport { checkAttachmentBlob, downloadAttachmentBlob } from './utils.js';\n\n@Peekable()\nexport class AttachmentBlockComponent extends CaptionedBlockComponent<\n  AttachmentBlockModel,\n  AttachmentBlockService\n> {\n  static override styles = styles;\n\n  protected _isDragging = false;\n\n  protected _isResizing = false;\n\n  protected _isSelected = false;\n\n  protected _whenHover: HoverController | null = new HoverController(\n    this,\n    ({ abortController }) => {\n      const selection = this.host.selection;\n      const textSelection = selection.find('text');\n      if (\n        !!textSelection &&\n        (!!textSelection.to || !!textSelection.from.length)\n      ) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (\n        blockSelections.length > 1 ||\n        (blockSelections.length === 1 &&\n          blockSelections[0].blockId !== this.blockId)\n      ) {\n        return null;\n      }\n\n      return {\n        template: AttachmentOptionsTemplate({\n          block: this,\n          model: this.model,\n          abortController,\n        }),\n        computePosition: {\n          referenceElement: this,\n          placement: 'top-start',\n          middleware: [flip(), offset(4)],\n          autoUpdate: true,\n        },\n      };\n    }\n  );\n\n  blockDraggable = true;\n\n  protected containerStyleMap = styleMap({\n    position: 'relative',\n    width: '100%',\n    margin: '18px 0px',\n  });\n\n  convertTo = () => {\n    return this.std\n      .get(AttachmentEmbedProvider)\n      .convertTo(this.model, this.service.maxFileSize);\n  };\n\n  copy = () => {\n    const slice = Slice.fromModels(this.doc, [this.model]);\n    this.std.clipboard.copySlice(slice).catch(console.error);\n    toast(this.host, 'Copied to clipboard');\n  };\n\n  download = () => {\n    downloadAttachmentBlob(this);\n  };\n\n  embedded = () => {\n    return this.std\n      .get(AttachmentEmbedProvider)\n      .embedded(this.model, this.service.maxFileSize);\n  };\n\n  open = () => {\n    if (!this.blobUrl) {\n      return;\n    }\n    window.open(this.blobUrl, '_blank');\n  };\n\n  refreshData = () => {\n    checkAttachmentBlob(this).catch(console.error);\n  };\n\n  protected get embedView() {\n    return this.std\n      .get(AttachmentEmbedProvider)\n      .render(this.model, this.blobUrl, this.service.maxFileSize);\n  }\n\n  private _selectBlock() {\n    const selectionManager = this.host.selection;\n    const blockSelection = selectionManager.create('block', {\n      blockId: this.blockId,\n    });\n    selectionManager.setGroup('note', [blockSelection]);\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.refreshData();\n\n    this.contentEditable = 'false';\n\n    if (!this.model.style) {\n      this.doc.withoutTransact(() => {\n        this.doc.updateBlock(this.model, {\n          style: AttachmentBlockStyles[1],\n        });\n      });\n    }\n\n    this.model.propsUpdated.on(({ key }) => {\n      if (key === 'sourceId') {\n        // Reset the blob url when the sourceId is changed\n        if (this.blobUrl) {\n          URL.revokeObjectURL(this.blobUrl);\n          this.blobUrl = undefined;\n        }\n        this.refreshData();\n      }\n    });\n\n    // Workaround for https://github.com/toeverything/blocksuite/issues/4724\n    this.disposables.add(\n      this.std.get(ThemeProvider).theme$.subscribe(() => this.requestUpdate())\n    );\n\n    // this is required to prevent iframe from capturing pointer events\n    this.disposables.add(\n      this.std.selection.slots.changed.on(() => {\n        this._isSelected =\n          !!this.selected?.is('block') || !!this.selected?.is('surface');\n\n        this._showOverlay =\n          this._isResizing || this._isDragging || !this._isSelected;\n      })\n    );\n    // this is required to prevent iframe from capturing pointer events\n    this.handleEvent('dragStart', () => {\n      this._isDragging = true;\n      this._showOverlay =\n        this._isResizing || this._isDragging || !this._isSelected;\n    });\n\n    this.handleEvent('dragEnd', () => {\n      this._isDragging = false;\n      this._showOverlay =\n        this._isResizing || this._isDragging || !this._isSelected;\n    });\n  }\n\n  override disconnectedCallback() {\n    if (this.blobUrl) {\n      URL.revokeObjectURL(this.blobUrl);\n    }\n    super.disconnectedCallback();\n  }\n\n  override firstUpdated() {\n    // lazy bindings\n    this.disposables.addFromEvent(this, 'click', this.onClick);\n  }\n\n  protected onClick(event: MouseEvent) {\n    // the peek view need handle shift + click\n    if (event.defaultPrevented) return;\n\n    event.stopPropagation();\n\n    this._selectBlock();\n  }\n\n  override renderBlock() {\n    const { name, size, style } = this.model;\n    const cardStyle = style ?? AttachmentBlockStyles[1];\n\n    const theme = this.std.get(ThemeProvider).theme;\n    const { LoadingIcon } = getEmbedCardIcons(theme);\n\n    const titleIcon = this.loading ? LoadingIcon : AttachmentIcon16;\n    const titleText = this.loading ? 'Loading...' : name;\n    const infoText = this.error ? 'File loading failed.' : humanFileSize(size);\n\n    const fileType = name.split('.').pop() ?? '';\n    const FileTypeIcon = getAttachmentFileIcons(fileType);\n\n    const embedView = this.embedView;\n\n    return html`\n      <div\n        ${this._whenHover ? ref(this._whenHover.setReference) : nothing}\n        class=\"affine-attachment-container\"\n        draggable=\"${this.blockDraggable ? 'true' : 'false'}\"\n        style=${this.containerStyleMap}\n      >\n        ${embedView\n          ? html`<div class=\"affine-attachment-embed-container\">\n              ${embedView}\n\n              <div\n                class=${classMap({\n                  'affine-attachment-iframe-overlay': true,\n                  hide: !this._showOverlay,\n                })}\n              ></div>\n            </div>`\n          : html`<div\n              class=${classMap({\n                'affine-attachment-card': true,\n                [cardStyle]: true,\n                loading: this.loading,\n                error: this.error,\n                unsynced: false,\n              })}\n            >\n              <div class=\"affine-attachment-content\">\n                <div class=\"affine-attachment-content-title\">\n                  <div class=\"affine-attachment-content-title-icon\">\n                    ${titleIcon}\n                  </div>\n\n                  <div class=\"affine-attachment-content-title-text\">\n                    ${titleText}\n                  </div>\n                </div>\n\n                <div class=\"affine-attachment-content-info\">${infoText}</div>\n              </div>\n\n              <div class=\"affine-attachment-banner\">${FileTypeIcon}</div>\n            </div>`}\n      </div>\n    `;\n  }\n\n  @state()\n  protected accessor _showOverlay = true;\n\n  @property({ attribute: false })\n  accessor allowEmbed = false;\n\n  @property({ attribute: false })\n  accessor blobUrl: string | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor downloading = false;\n\n  @property({ attribute: false })\n  accessor error = false;\n\n  @property({ attribute: false })\n  accessor loading = false;\n\n  override accessor useCaptionEditor = true;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-attachment': AttachmentBlockComponent;\n  }\n}\n"]}